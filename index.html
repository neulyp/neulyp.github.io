<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="lyp's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.jpg?v=5.0.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="lyp's blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="lyp's blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="lyp's blog">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '3188510942',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>


  <title> lyp's blog </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">lyp's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            Kategorien
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/12/juc_questions/" itemprop="url">
                  juc:locks
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2017-01-12T23:27:24+08:00" content="2017-01-12">
              2017-01-12
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>问题1  现在有T1、T2、T3三个线程，你怎样保证T2在T1执行完后执行，T3在T2执行完后执行？</strong></p>
<p>使用join。</p>
<p><strong>问题2 在Java中Lock接口比synchronized块的优势是什么？你需要实现一个高效的缓存，它允许多个用户读，但只允许一个用户写，以此来保持它的完整性，你会怎样去实现它？</strong></p>
<p>这里主要是要考察说lock与synchronized 的区别。</p>
<ol>
<li><p>利用cpu底层机制lock有读锁 与 写锁的区分。</p>
<p> synchronized这种排斥了 写/写，读/写 读/读。<br> lock读与读是多个线程可以同时读的。—-可以做为读多写少的应用<br> lock接口在多线程和并发编程中最大的优势是它们为读和写分别提供了锁，它能满足你写像ConcurrentHashMap这样的高性能数据结构和有条件的阻塞。</p>
</li>
<li><p>在于上下文的切换与锁的竞争的优化</p>
<p> 对于 synchronized 来说。他只有一个条件队列的，里面放着对应于不同类型的（也可以说是处理不同业务类型的）线程，那这时，你只能notifyall<br> ，为了保证程序的正确，把所有的线程都叫起来，不管是不是你想要的业务类型的线程。这种对于性能影响是非常大的。比如10个线程在一个条件队列上等待，那么调用notifyAll 将唤醒所有的线程<br>这个时候线程产生如下：</p>
<pre><code>a 它们会在锁上面产生竞争。
b 它们竞争完了之后大部分又大部分wait了
  这两步，会导致了大量的线程上下文切换。以及大量锁的竞争。
</code></pre><p> 但这个lock是没问题的。他可以对于 不同的条件创建wait-set ，比如生产者消费者模式，生产者生产一个对象，这时想唤醒消费者，只需要在相应的条件上面的wait set进行single.</p>
</li>
<li><p>关于死锁的避免</p>
</li>
</ol>
<p><strong>问题3 在java中wait和sleep方法的不同？</strong></p>
<ol>
<li>sleep是thread类的方法，wait是object的方法 </li>
<li>最大的不同是在等待时wait会释放锁，而sleep一直持有锁。Wait通常被用于线程间交互，sleep通常被用于暂停执行。</li>
</ol>
<p><strong>问题4 用Java实现阻塞队列</strong></p>
<p>阻塞队列与普通队列的区别在于，当队列是空的时，从队列中获取元素的操作将会被阻塞，或者当队列是满时，往队列里添加元素的操作会被阻塞。试图从空的阻塞队列中获取元素的线程将会被阻塞，直到其他的线程往空的队列插入新的元素。同样，试图往已满的阻塞队列中添加新元素的线程同样也会被阻塞，直到其他的线程使队列重新变得空闲起来，如从队列中移除一个或者多个元素，或者完全清空队列</p>
<p>1.版本1 使用wait和notify实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ex1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.LinkedList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockQueue</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> List q=<span class="keyword">new</span> LinkedList&lt;&gt;();</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> limit =<span class="number">10</span>;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">BlockQueue</span><span class="params">(<span class="keyword">int</span> limit)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.limit=limit;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Object item)</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</div><div class="line">		<span class="keyword">while</span>(<span class="keyword">this</span>.q.size()==<span class="keyword">this</span>.limit)&#123;</div><div class="line">			wait();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>.q.size()==<span class="number">0</span>)&#123;</div><div class="line">			notifyAll();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">this</span>.q.add(item);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Object  <span class="title">dequeue</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>&#123;</div><div class="line">		<span class="keyword">while</span>(<span class="keyword">this</span>.q.size()==<span class="number">0</span>)&#123;</div><div class="line">			wait();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span>(<span class="keyword">this</span>.q.size()==<span class="keyword">this</span>.limit)&#123;</div><div class="line">			notifyAll();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.q.remove(<span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.版本2 并发包</p>
<p>看源码分析（@TODO）</p>
<p><strong>问题5 用Java写代码来解决生产者——消费者问题。</strong></p>
<p>1.阻塞对列</p>
<p><strong>问题6 用Java编程一个会导致死锁的程序，你将怎么解决？</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ex1;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDeadLock</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        MyThread mt = <span class="keyword">new</span> MyThread();</div><div class="line">        <span class="keyword">new</span> Thread(mt, <span class="string">"张三"</span>).start();</div><div class="line">        <span class="keyword">new</span> Thread(mt, <span class="string">"李四"</span>).start();</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> Object o1 = <span class="keyword">new</span> Object();</div><div class="line">        <span class="keyword">private</span> Object o2 = <span class="keyword">new</span> Object();</div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</div><div class="line">         </div><div class="line"> </div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (flag) &#123;</div><div class="line">                flag = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">synchronized</span> (o1) &#123;</div><div class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" have o1"</span>);</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Thread.sleep(<span class="number">100</span>);</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">synchronized</span> (o2) &#123;</div><div class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">" have o2"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                flag = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">synchronized</span> (o2) &#123;</div><div class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">" have o2"</span>);</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Thread.sleep(<span class="number">100</span>);</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">synchronized</span> (o1) &#123;</div><div class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">" have o1"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> TestDeadLock().run();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>问题7 什么是原子操作，Java中的原子操作是什么？</strong></p>
<p>所谓原子操作,就是”不可中断的一个或一系列操作” , java中的atomic？还是说volatile synchronized？</p>
<p><strong>问题8 Java中的volatile关键是什么作用？怎样使用它？在Java中它跟synchronized方法有什么不同？</strong></p>
<ol>
<li>volatile是变量修饰符，而synchronized则作用于一段代码或方法。</li>
<li>volatile只是在线程内存和“主”内存间同步某个变量的值；而synchronized通过锁定和解锁某个监视器同步所有变量的值。显然synchronized要比volatile消耗更多资源。 </li>
</ol>
<p>我自己的理解十volatile中，当一个变量被修改后，本地的缓存写入主内存中，并使其他线程中该对象的缓存失效，直接从主存中读值。synchronized是锁住主内存。</p>
<p><strong>问题9 什么是竞争条件？你怎样发现和解决竞争？</strong></p>
<p>在Java多线程中，当两个或以上的线程对同一个数据进行操作的时候，可能会产生“竞争条件”的现象。这种现象产生的根本原因是因为多个线程在对同一个数据进行操作，此时对该数据的操作是非“原子化”的，可能前一个线程对数据的操作还没有结束，后一个线程又开始对同样的数据开始进行操作，这就可能会造成数据结果的变化未知。</p>
<p>怎么避免？使用锁。</p>
<p><strong>问题10 如何使用thread dump？ 怎么分析？</strong></p>
<p><a href="http://blog.csdn.net/rachel_luo/article/details/8920596" target="_blank" rel="external">http://blog.csdn.net/rachel_luo/article/details/8920596</a></p>
<p><strong>问题11 为什么我们调用start()方法时会执行run()方法，为什么我们不能直接调用run()方法？</strong></p>
<p>调用start 多线程！！！你将创建新的线程，并且执行在run()方法里的代码</p>
<p>调用run 只是一个普通的方法而已。它不会创建新的线程也不会执行调用线程的代码。只是执行一个run方法。并没有创建新的线程。</p>
<p><strong>问题12 Java中你怎样唤醒一个阻塞的线程？</strong></p>
<ol>
<li>wait notify？但其面向的主体是对象object</li>
<li>LockSupport，它提供的park和unpark方法分别用于阻塞和唤醒</li>
</ol>
<p>参照;<a href="http://blog.csdn.net/wangyangzhizhou/article/details/41777547" target="_blank" rel="external">http://blog.csdn.net/wangyangzhizhou/article/details/41777547</a></p>
<p><strong>问题13 在Java中CycliBarriar和CountdownLatch有什么区别？</strong></p>
<p>这个线程问题主要用来检测你是否熟悉JDK5中的并发包。这两个的区别是CyclicBarrier可以重复使用已经通过的障碍，而CountdownLatch不能重复使用。</p>
<p><strong>问题14 什么是不可变对象，它对写并发应用有什么帮助？</strong></p>
<ol>
<li>不可变对象：如果一个对象，在它创建完成之后，不能再改变它的状态，那么这个对象就是不可变的。不能改变状态的意思是，不能改变对象内的成员变量，包括基本数据类型的值不能改变，引用类型的变量不能指向其他的对象，引用类型指向的对象的状态也不能改变。</li>
<li>String为什么是不可变？String类其实就是对字符数组的封装。value是String封装的数组，offset是String在这个value数组中的起始位置，count是String所占的字符的个数。不提供更改方法，所以是不可变的。</li>
</ol>
<p><strong>问题15 线程与进程的区别？</strong></p>
<p>进程可以包含很多线程</p>
<p><strong>问题16 什么是多线程中的上下文切换？</strong></p>
<p>上下文切换是存储和恢复CPU状态的过程，它使得线程执行能够从中断点恢复执行。上下文切换是多任务操作系统和多线程环境的基本特征。<br>同一进程中的两个线程之间的切换</p>
<p><strong>问题17 死锁与活锁的区别，死锁与饥饿的区别？</strong></p>
<p>死锁发生在当一些进程请求其它进程占有的资源而被阻塞时。</p>
<p>另外一方面，活锁不会被阻塞，而是不停检测一个永远不可能为真的条件。除去进程本身持有的资源外，活锁状态的进程会持续耗费宝贵的CPU时间。</p>
<p>最后，进程会处于饥饿状态是因为持续地有其它优先级更高的进程请求相同的资源。不像死锁或者活锁，饥饿能够被解开。例如，当其它高优先级的进程都终止时并且没有更高优先级的进程到达。</p>
<p><strong>问题18 Java中用到的线程调度算法是什么？</strong></p>
<p>抢占 和协同？？</p>
<p><strong>问题19 为什么使用Executor框架比使用应用创建和管理线程好？</strong></p>
<p><a href="http://www.tuicool.com/articles/ayIvq2Z" target="_blank" rel="external">http://www.tuicool.com/articles/ayIvq2Z</a></p>
<p><strong>问题10 在Java中Executor和Executors的区别？</strong></p>
<p>Executor是Java线程池的顶级接口</p>
<p>Executors是一个类，Executors类提供了若干个静态方法，用于生成不同类型的线程池。</p>
<p><strong>问题20 如何在Windows和Linux上查找哪个线程使用的CPU时间最长？</strong></p>
<p>windows上面用任务管理器看，linux下可以用top 这个工具看。</p>
<p>当然如果你要查找具体的进程，可以用ps命令,比如查找java：<br>ps -ef |grep java<br>linux 获取项目的pid，jps或者ps -ef | grep java</p>
<p><strong>问题21 线程池底层如何实现？</strong></p>
<p>详见前几章介绍</p>
<p>撒花！！！！ 完结。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/12/juc_executor2/" itemprop="url">
                  juc:collections-ConcurrentMap
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2017-01-12T19:27:24+08:00" content="2017-01-12">
              2017-01-12
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要介绍线程池的实现原理（面试重点啊！！） 分分钟要搞清楚的</p>
<h3 id="线程池数据结构和线程构造方法"><a href="#线程池数据结构和线程构造方法" class="headerlink" title="线程池数据结构和线程构造方法"></a>线程池数据结构和线程构造方法</h3><p>从threadpoolThread 中很容易看到线程池的数据结构如下：<br><img src="http://i.imgur.com/HEtEdUP.png" alt=""></p>
<p>对于ThreadPoolExecutor而言，一个线程就是一个Worker对象，它与一个线程绑定，当Worker执行完毕就是线程执行完毕。</p>
<p>线程的构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ThreadFactory</span> </span>&#123;</div><div class="line">    <span class="function">Thread <span class="title">newThread</span><span class="params">(Runnable r)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ThreadPoolExecutor使用一个线程工厂来构造线程。线程池都是提交一个任务Runnable，然后在某一个线程Thread中执行，ThreadFactory 负责如何创建一个新线程。</p>
<p>在J.U.C中有一个通用的线程工厂java.util.concurrent.Executors.DefaultThreadFactory，它的构造方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultThreadFactory</span> <span class="keyword">implements</span> <span class="title">ThreadFactory</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger poolNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line">    <span class="keyword">final</span> ThreadGroup group;</div><div class="line">    <span class="keyword">final</span> AtomicInteger threadNumber = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line">    <span class="keyword">final</span> String namePrefix;</div><div class="line">    DefaultThreadFactory() &#123;</div><div class="line">        SecurityManager s = System.getSecurityManager();</div><div class="line">        group = (s != <span class="keyword">null</span>)? s.getThreadGroup() :</div><div class="line">                             Thread.currentThread().getThreadGroup();</div><div class="line">        namePrefix = <span class="string">"pool-"</span> +</div><div class="line">                      poolNumber.getAndIncrement() +</div><div class="line">                     <span class="string">"-thread-"</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</div><div class="line">        Thread t = <span class="keyword">new</span> Thread(group, r,</div><div class="line">                              namePrefix + threadNumber.getAndIncrement(),</div><div class="line">                              <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (t.isDaemon())</div><div class="line">            t.setDaemon(<span class="keyword">false</span>);</div><div class="line">        <span class="keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY)</div><div class="line">            t.setPriority(Thread.NORM_PRIORITY);</div><div class="line">        <span class="keyword">return</span> t;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://i.imgur.com/YToHSNz.png" alt=""></p>
<h3 id="线程池任务执行流程"><a href="#线程池任务执行流程" class="headerlink" title="线程池任务执行流程"></a>线程池任务执行流程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Executes the given task sometime in the future.  The task</div><div class="line">     * may execute in a new thread or in an existing pooled thread.</div><div class="line">     *</div><div class="line">     * If the task cannot be submitted for execution, either because this</div><div class="line">     * executor has been shutdown or because its capacity has been reached,</div><div class="line">     * the task is handled by the current &#123;<span class="doctag">@code</span> RejectedExecutionHandler&#125;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> command the task to execute</div><div class="line">     * <span class="doctag">@throws</span> RejectedExecutionException at discretion of</div><div class="line">     *         &#123;<span class="doctag">@code</span> RejectedExecutionHandler&#125;, if the task</div><div class="line">     *         cannot be accepted for execution</div><div class="line">     * <span class="doctag">@throws</span> NullPointerException if &#123;<span class="doctag">@code</span> command&#125; is null</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (command == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Proceed in 3 steps:</div><div class="line">         *</div><div class="line">         * 1. If fewer than corePoolSize threads are running, try to</div><div class="line">         * start a new thread with the given command as its first</div><div class="line">         * task.  The call to addWorker atomically checks runState and</div><div class="line">         * workerCount, and so prevents false alarms that would add</div><div class="line">         * threads when it shouldn't, by returning false.</div><div class="line">         *</div><div class="line">         * 2. If a task can be successfully queued, then we still need</div><div class="line">         * to double-check whether we should have added a thread</div><div class="line">         * (because existing ones died since last checking) or that</div><div class="line">         * the pool shut down since entry into this method. So we</div><div class="line">         * recheck state and if necessary roll back the enqueuing if</div><div class="line">         * stopped, or start a new thread if there are none.</div><div class="line">         *</div><div class="line">         * 3. If we cannot queue task, then we try to add a new</div><div class="line">         * thread.  If it fails, we know we are shut down or saturated</div><div class="line">         * and so reject the task.</div><div class="line">         */</div><div class="line">        <span class="keyword">int</span> c = ctl.get();</div><div class="line">        <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</div><div class="line">            <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            c = ctl.get();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</div><div class="line">            <span class="keyword">int</span> recheck = ctl.get();</div><div class="line">            <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</div><div class="line">                reject(command);</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</div><div class="line">                addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</div><div class="line">            reject(command);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>主要步骤：</p>
<ol>
<li>如果任务command为空，则抛出空指针异常，返回。否则进行2。</li>
<li>如果当前线程池大小 大于或等于 核心线程池大小，进行4。否则进行3。</li>
<li>创建一个新工作队列（线程，参考上一节），成功直接返回，失败进行</li>
<li>如果线程池正在运行并且任务加入线程池队列成功，进行5，否则进行7。</li>
<li>如果线程池已经关闭或者线程池大小为0，进行6，否则直接返回。</li>
<li>如果线程池已经关闭则执行拒绝策略返回，否则启动一个新线程来进行执行任务，返回。</li>
<li>如果线程池大小 不大于 最大线程池数量，则启动新线程来进行执行，否则进行拒绝策略，结束。</li>
</ol>
<p><img src="http://i.imgur.com/CyLlYaA.png" alt=""></p>
<p>那么什么时候一个任务被立即执行呢？</p>
<p>在线程池运行状态下，如果线程池大小 小于 核心线程池大小或者线程池已满（任务队列已满）并且线程池大小 小于 最大线程池大小（此时线程池大小 大于 核心线程池大小的）。</p>
<p>上面的条件就是一个任务能够被立即执行的条件。</p>
<p>有了execute的基础，我们再来看ExecutorService中的几个submit方法的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</div><div class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    RunnableFuture&lt;Object&gt; ftask = newTaskFor(task, <span class="keyword">null</span>);</div><div class="line">    execute(ftask);</div><div class="line">    <span class="keyword">return</span> ftask;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Runnable task, T result)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    RunnableFuture&lt;T&gt; ftask = newTaskFor(task, result);</div><div class="line">    execute(ftask);</div><div class="line">    <span class="keyword">return</span> ftask;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Future&lt;T&gt; <span class="title">submit</span><span class="params">(Callable&lt;T&gt; task)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</div><div class="line">    execute(ftask);</div><div class="line">    <span class="keyword">return</span> ftask;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="线程池任务执行结果"><a href="#线程池任务执行结果" class="headerlink" title="线程池任务执行结果"></a>线程池任务执行结果</h3><p>为了解决之前获取线程结果会阻塞主线程并且任务不能被取消，线程池中提出了future接口。</p>
<p><img src="http://i.imgur.com/zccXej5.png" alt=""></p>
<p>在Future接口中提供了5个方法。</p>
<p><img src="http://i.imgur.com/g0Q1FYe.png" alt=""></p>
<p>在Future接口中提供了5个方法。</p>
<ul>
<li>V get() throws InterruptedException, ExecutionException： 等待计算完成，然后获取其结果。</li>
<li>V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException。最多等待为使计算完成所给定的时间之后，获取其结果（如果结果可用）。</li>
<li>boolean cancel(boolean mayInterruptIfRunning)：试图取消对此任务的执行。</li>
<li>boolean isCancelled()：如果在任务正常完成前将其取消，则返回 true。</li>
<li>boolean isDone()：如果任务已完成，则返回 true。 可能由于正常终止、异常或取消而完成，在所有这些情况中，此方法都将返回 true。</li>
</ul>
<p>API看起来容易，来研究下异常吧。</p>
<p>get()请求获取一个结果会阻塞当前进程，并且可能抛出以下三种异常：</p>
<ul>
<li>InterruptedException：执行任务的线程被中断则会抛出此异常，此时不能知道任务是否执行完毕，因此其结果是无用的，必须处理此异常。</li>
<li>ExecutionException：任务执行过程中(Runnable#run()）方法可能抛出RuntimeException，如果提交的是一个java.util.concurrent.Callable<v>接口任务，那么java.util.concurrent.Callable.call()方法有可能抛出任意异常。</v></li>
<li>CancellationException：实际上get()方法还可能抛出一个CancellationException的RuntimeException，也就是任务被取消了但是依然去获取结果。</li>
</ul>
<p>对于get(long timeout, TimeUnit unit)而言，除了get()方法的异常外，由于有超时机制，因此还可能得到一个TimeoutException。</p>
<p>boolean cancel(boolean mayInterruptIfRunning)方法比较复杂，各种情况比较多：</p>
<ul>
<li>如果任务已经执行完毕，那么返回false。</li>
<li>如果任务已经取消，那么返回false。</li>
<li>循环直到设置任务为取消状态，对于未启动的任务将永远不再执行，对于正在运行的任务，将根据mayInterruptIfRunning是否中断其运行，如果不中断那么任务将继续运行直到结束。</li>
<li>此方法返回后任务要么处于运行结束状态，要么处于取消状态。isDone()将永远返回true，如果cancel()方法返回true，isCancelled()始终返回true。</li>
</ul>
<h3 id="延迟、周期性任务调度的实现"><a href="#延迟、周期性任务调度的实现" class="headerlink" title="延迟、周期性任务调度的实现"></a>延迟、周期性任务调度的实现</h3><p>java.util.concurrent.ScheduledThreadPoolExecutor是默认的延迟、周期性任务调度的实现。</p>
<p>有了整个线程池的实现，再回头来看延迟、周期性任务调度的实现应该就很简单了，因为所谓的延迟、周期性任务调度，无非添加一系列有序的任务队列，然后按照执行顺序的先后来处理整个任务队列。如果是周期性任务，那么在执行完毕的时候加入下一个时间点的任务即可。</p>
<p>由此可见，ScheduledThreadPoolExecutor和ThreadPoolExecutor的唯一区别在于任务是有序（按照执行时间顺序）的，并且需要到达时间点（临界点）才能执行，并不是任务队列中有任务就需要执行的。也就是说唯一不同的就是任务队列BlockingQueue<runnable> workQueue不一样。ScheduledThreadPoolExecutor的任务队列是java.util.concurrent.ScheduledThreadPoolExecutor.DelayedWorkQueue，它是基于java.util.concurrent.DelayQueue<runnablescheduledfuture>队列的实现。</runnablescheduledfuture></runnable></p>
<p>DelayQueue是基于有序队列PriorityQueue实现的。PriorityQueue 也叫优先级队列，按照自然顺序对元素进行排序，类似于TreeMap/Collections.sort一样。</p>
<p>同样是有序队列，DelayQueue和PriorityQueue区别在什么地方？</p>
<p>由于DelayQueue在获取元素时需要检测元素是否“可用”，也就是任务是否达到“临界点”（指定时间点），因此加入元素和移除元素会有一些额外的操作。</p>
<p>典型的，移除元素需要检测元素是否达到“临界点”，增加元素的时候如果有一个元素比“头元素”更早达到临界点，那么就需要通知任务队列。因此这需要一个条件变量final Condition available 。</p>
<p>移除元素（出队列）的过程是这样的：</p>
<ul>
<li>总是检测队列的头元素（顺序最小元素，也是最先达到临界点的元素）</li>
<li>检测头元素与当前时间的差，如果大于0，表示还未到底临界点，因此等待响应时间（使用条件变量available)</li>
<li>如果小于或者等于0，说明已经到底临界点或者已经过了临界点，那么就移除头元素，并且唤醒其它等待任务队列的线程。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/11/juc_executor/" itemprop="url">
                  juc:locks
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2017-01-11T19:27:24+08:00" content="2017-01-11">
              2017-01-11
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="http://i.imgur.com/lwUE2XO.png" alt=""></p>
<p>文章主要介绍executor模块下面的内容。</p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>并发执行任务的一个很重要前提是拆分任务。把一个大的过程或者任务拆分成很多小的工作单元，每一个工作单元可能相关、也可能无关，这些单元在一定程度上可以充分利用CPU的特性并发的执行，从而提高并发性（性能、响应时间、吞吐量等）。</p>
<p>任务的执行策略包括4W3H部分：</p>
<ul>
<li>任务在什么（What）线程中执行</li>
<li>任务以什么（What）顺序执行（FIFO/LIFO/优先级等）</li>
<li>同时有多少个（How Many）任务并发执行</li>
<li>允许有多少个（How Many）个任务进入执行队列</li>
<li>系统过载时选择放弃哪一个（Which）任务，如何（How）通知应用程序这个动作</li>
<li>任务执行的开始、结束应该做什么（What）处理</li>
</ul>
<h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><p><img src="http://i.imgur.com/1votuwr.png" alt=""></p>
<p>Java里面线程池的顶级接口是Executor，但是严格意义上讲Executor并不是一个线程池，而只是一个执行线程的工具。真正的线程池接口是ExecutorService。</p>
<p><strong>1.executor</strong></p>
<p>只有一个执行方法 executor()</p>
<p><strong>2.ExecutorService</strong></p>
<p><img src="http://i.imgur.com/el6QC9K.png" alt=""></p>
<p>主要方法如下：</p>
<p>Future&lt;?&gt; submit(Runnable task)</p>
<p><t> Future<t> submit(Callable<t> task)</t></t></t></p>
<p>这两个方法都是向线程池中提交任务，它们的区别在于Runnable在执行完毕后没有结果，Callable执行完毕后有一个结果。这在多个线程中传递状态和结果是非常有用的。另外他们的相同点在于都返回一个Future对象。Future对象可以阻塞线程直到运行完毕（获取结果，如果有的话），也可以取消任务执行，当然也能够检测任务是否被取消或者是否执行完毕。</p>
<p><strong>3.AbstractExecutorService</strong></p>
<p>是一个抽象类，继承实现了ExecutorService接口。</p>
<p><strong>4.ThreadPoolExecutor</strong></p>
<p>继承抽象类AbstractExecutorService。是ExecutorService的默认实现。</p>
<p><strong>5.ScheduledThreadPoolExecutor</strong></p>
<p>ScheduledThreadPoolExecutor是继承ThreadPoolExecutor的ScheduledExecutorService接口实现，周期性任务调度的类实现。</p>
<p><strong>5.Executors</strong></p>
<ul>
<li>要配置一个线程池是比较复杂的，尤其是对于线程池的原理不是很清楚的情况下，很有可能配置的线程池不是较优的，因此在Executors类里面提供了一些静态工厂，生成一些常用的线程池。</li>
<li>newSingleThreadExecutor：创建一个单线程的线程池。这个线程池只有一个线程在工作，也就是相当于单线程串行执行所有任务。如果这个唯一的线程因为异常结束，那么会有一个新的线程来替代它。此线程池保证所有任务的执行顺序按照任务的提交顺序执行。<br>newFixedThreadPool：创建固定大小的线程池。每次提交一个任务就创建一个线程，直到线程达到线程池的最大大小。线程池的大小一旦达到最大值就会保持不变，如果某个线程因为执行异常而结束，那么线程池会补充一个新线程。</li>
<li>newCachedThreadPool：创建一个可缓存的线程池。如果线程池的大小超过了处理任务所需要的线程，那么就会回收部分空闲（60秒不执行任务）的线程，当任务数增加时，此线程池又可以智能的添加新线程来处理任务。此线程池不会对线程池大小做限制，线程池大小完全依赖于操作系统（或者说JVM）能够创建的最大线程大小。</li>
<li>newScheduledThreadPool：创建一个大小无限的线程池。此线程池支持定时以及周期性执行任务的需求。</li>
<li>newSingleThreadScheduledExecutor：创建一个单线程的线程池。此线程池支持定时以及周期性执行任务的需求。</li>
</ul>
<h3 id="Executor生命周期"><a href="#Executor生命周期" class="headerlink" title="Executor生命周期"></a>Executor生命周期</h3><p><img src="http://i.imgur.com/FDDMmd2.png" alt=""></p>
<ul>
<li>线程池在构造前（new操作）是初始状态，一旦构造完成线程池就进入了执行状态RUNNING。严格意义上讲线程池构造完成后并没有线程被立即启动，只有进行“预启动”或者接收到任务的时候才会启动线程。这个会后面线程池的原理会详细分析。但是线程池是出于运行状态，随时准备接受任务来执行。</li>
<li>线程池运行中可以通过shutdown()和shutdownNow()来改变运行状态。shutdown()是一个平缓的关闭过程，线程池停止接受新的任务，同时等待已经提交的任务执行完毕，包括那些进入队列还没有开始的任务，这时候线程池处于SHUTDOWN状态；shutdownNow()是一个立即关闭过程，线程池停止接受新的任务，同时线程池取消所有执行的任务和已经进入队列但是还没有执行的任务，这时候线程池处于STOP状态。</li>
<li>一旦shutdown()或者shutdownNow()执行完毕，线程池就进入TERMINATED状态，此时线程池就结束了。</li>
<li>isTerminating()描述的是SHUTDOWN和STOP两种状态。</li>
<li>isShutdown()描述的是非RUNNING状态，也就是SHUTDOWN/STOP/TERMINATED三种状态。</li>
</ul>
<p>对于关闭线程池期间发生的任务提交情况就会触发一个拒绝执行的操作：<br>这是java.util.concurrent.RejectedExecutionHandler描述的任务操作。（下一小节进行介绍）</p>
<p>总结：</p>
<ul>
<li>线程池有运行、关闭、停止、结束四种状态，结束后就会释放所有资源</li>
<li>平缓关闭线程池使用shutdown()</li>
<li>立即关闭线程池使用shutdownNow()，同时得到未执行的任务列表</li>
<li>检测线程池是否正处于关闭中，使用isShutdown()</li>
<li>检测线程池是否已经关闭使用isTerminated()</li>
<li>定时或者永久等待线程池关闭结束使用awaitTermination()操作</li>
</ul>
<h3 id="线程池任务拒绝策略"><a href="#线程池任务拒绝策略" class="headerlink" title="线程池任务拒绝策略"></a>线程池任务拒绝策略</h3><p>RejectedExecutionHandler提供了四种方式来处理任务拒绝策略。</p>
<ul>
<li>callerRunPolicy 不用线程池线程执行</li>
<li>DiscardPolicy 直接丢弃任务</li>
<li>AbortPolicy 跑出异常</li>
<li>DiscardOldestPolicy 丢弃队列中最旧任务 </li>
</ul>
<p>设置策略：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ThreadPoolExecutor pool = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, TimeUnit.SECONDS,</div><div class="line">                <span class="keyword">new</span> ArrayBlockingQueue&lt;Runnable&gt;(<span class="number">1</span>));</div><div class="line">        pool.setRejectedExecutionHandler(<span class="keyword">new</span> ThreadPoolExecutor.DiscardPolicy());</div></pre></td></tr></table></figure>
<h3 id="周期性任务调度"><a href="#周期性任务调度" class="headerlink" title="周期性任务调度"></a>周期性任务调度</h3><p>java.util.concurrent.ScheduledExecutorService</p>
<p><img src="http://i.imgur.com/qIPJARw.png" alt=""></p>
<ul>
<li>schedule(Runnable command,long delay, TimeUnit unit)：在指定的延迟时间一次性启动任务（Runnable），没有返回值。</li>
<li>schedule(Callable<v> callable, long delay, TimeUnit unit)：在指定的延迟时间一次性启动任务（Callable），携带一个结果。</v></li>
<li>scheduleAtFixedRate(Runnable command,long initialDelay,long period,TimeUnit unit)：建并执行一个在给定初始延迟后首次启用的定期操作，后续操作具有给定的周期；也就是将在 initialDelay 后开始执行，然后在 initialDelay+period 后执行，接着在 initialDelay + 2 * period 后执行，依此类推。如果任务的任何一个执行遇到异常，则后续执行都会被取消。否则，只能通过执行程序的取消或终止方法来终止该任务。如果此任务的任何一个执行要花费比其周期更长的时间，则将推迟后续执行，但不会同时执行。</li>
<li>scheduleWithFixedDelay(Runnable command,long initialDelay,long delay,TimeUnit unit)：创建并执行一个在给定初始延迟后首次启用的定期操作，随后，在每一次执行终止和下一次执行开始之间都存在给定的延迟。如果任务的任一执行遇到异常，就会取消后续执行。否则，只能通过执行程序的取消或终止方法来终止该任务。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/09/并发编程-1线程/" itemprop="url">
                  并发编程1-线程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2017-01-09T19:27:24+08:00" content="2017-01-09">
              2017-01-09
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-线程"><a href="#1-线程" class="headerlink" title="1.线程"></a>1.线程</h3><h4 id="1-线程状态"><a href="#1-线程状态" class="headerlink" title="1.线程状态"></a>1.线程状态</h4><p><img src="http://i.imgur.com/0HZmNIu.png" alt=""></p>
<p><img src="http://i.imgur.com/ZK1PN0H.png" alt=""></p>
<p>由图4-1中可以看到，线程创建之后，调用start()方法开始运行。当线程执行wait()方法之<br>后，线程进入等待状态。进入等待状态的线程需要依靠其他线程的通知才能够返回到运行状<br>态，而超时等待状态相当于在等待状态的基础上增加了超时限制，也就是超时时间到达时将<br>会返回到运行状态。当线程调用同步方法时，在没有获取到锁的情况下，线程将会进入到阻塞<br>状态。线程在执行Runnable的run()方法之后将会进入到终止状态。</p>
<h4 id="2-daemon"><a href="#2-daemon" class="headerlink" title="2.daemon"></a>2.daemon</h4><p>Daemon线程是一种支持型线程，因为它主要被用作程序中后台调度以及支持性工作。这<br>意味着，当一个Java虚拟机中不存在非Daemon线程的时候，Java虚拟机将会退出。可以通过调<br>用Thread.setDaemon(true)将线程设置为Daemon线程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ex1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Daemon</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> DaemonRunner(), <span class="string">"DaemonRunner"</span>);</div><div class="line">		thread.setDaemon(<span class="keyword">true</span>);</div><div class="line">		thread.start();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonRunner</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				TimeUnit.SECONDS.sleep(<span class="number">10</span>);</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125; <span class="keyword">finally</span> &#123;</div><div class="line">				System.out.println(<span class="string">"DaemonThread finally run."</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>执行结果 不打印任何东西。</p>
<h4 id="3-线程方法"><a href="#3-线程方法" class="headerlink" title="3.线程方法"></a>3.线程方法</h4><ol>
<li>start</li>
<li>run</li>
<li>suspend() 暂停 不释放资源进入睡眠，容易引起思索</li>
<li>resume() 恢复</li>
<li>stop() 停止 不保证线程资源的正常释放</li>
<li>interrupt() 中断</li>
<li>join() 当前线程A等待thread线程终止之后才从thread.join()返回。</li>
</ol>
<p>等待和通知方法是任意java对象具备的，定义在object上，</p>
<ol>
<li>notifyAll：使所有原来在该对象上等待被notify的线程统统退出wait的状态，变成等待该对象上的锁，一旦该对象被解锁，他们就会去竞争。</li>
<li>notify：notify则文明得多他只是选择一个wait状态线程进行通知，并使它获得该对象上的锁，但不惊动其他同样在等待被该对象notify的线程们，当第一个线程运行完毕以后释放对象上的锁此时如果该对象没有再次使用notify语句，则即便该对象已经空闲，其他wait状态等待的线程由于没有得到该对象的通知，继续处在wait状态，直到这个对象发出一个notify或notifyAll，它们等待的是被notify或notifyAll，而不是锁。</li>
<li>wait()</li>
<li>wait(long)</li>
<li>wait(lonhg,int)</li>
</ol>
<p>总结：</p>
<ul>
<li>1）使用wait()、notify()和notifyAll()时需要先对调用对象加锁。</li>
<li>2）调用wait()方法后，线程状态由RUNNING变为WAITING，并将当前线程放置到对象的等待队列。</li>
<li>3）notify()或notifyAll()方法调用后，等待线程依旧不会从wait()返回，需要调用notify()或notifAll()的线程释放锁之后，等待线程才有机会从wait()返回。</li>
<li>4）notify()方法将等待队列中的一个等待线程从等待队列中移到同步队列中，而notifyAll()方法则是将等待队列中所有的线程全部移到同步队列，被移动的线程状态WAITING变为BLOCKED。</li>
<li>5）从wait()方法返回的前提是获得了调用对象的锁</li>
</ul>
<p>等待/通知的经典范式：<br>等待方（消费者）和通知方（生产者）</p>
<p>等待方：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">synchronized</span>(对象) &#123;</div><div class="line"><span class="keyword">while</span>(条件不满足) &#123;</div><div class="line">对象.wait();</div><div class="line">&#125; 对</div><div class="line">应的处理逻辑</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通知者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">synchronized</span>(对象) &#123;</div><div class="line">改变条件</div><div class="line">对象.notifyAll();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-管道输入-输出流"><a href="#4-管道输入-输出流" class="headerlink" title="4.管道输入/输出流"></a>4.管道输入/输出流</h4><p>管道输入/输出流和普通的文件输入/输出流或者网络输入/输出流不同之处在于，它主要用于线程之间的数据传输，而传输的媒介为内存。</p>
<p>管道输入/输出流主要包括了如下4种具体实现：PipedOutputStream、PipedInputStream、PipedReader和PipedWriter，前两种面向字节，而后两种面向字符</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Piped</span> </span>&#123;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">PipedWriter out = <span class="keyword">new</span> PipedWriter();</div><div class="line">PipedReader in = <span class="keyword">new</span> PipedReader();</div><div class="line"><span class="comment">// 将输出流和输入流进行连接，否则在使用时会抛出IOException</span></div><div class="line">out.connect(in);</div><div class="line">Thread printThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Print(in), <span class="string">"PrintThread"</span>);</div><div class="line">printThread.start();</div><div class="line"><span class="keyword">int</span> receive = <span class="number">0</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">while</span> ((receive = System.in.read()) != -<span class="number">1</span>) &#123;</div><div class="line">out.write(receive);</div><div class="line">&#125;</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">out.close();</div><div class="line">&#125;</div><div class="line">&#125;s</div><div class="line">tatic <span class="class"><span class="keyword">class</span> <span class="title">Print</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"><span class="keyword">private</span> PipedReader in;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Print</span><span class="params">(PipedReader in)</span> </span>&#123;</div><div class="line"><span class="keyword">this</span>.in = in;</div><div class="line">&#125;<span class="function">p</span></div><div class="line">ublic <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> &#123;</div><div class="line"><span class="keyword">int</span> receive = <span class="number">0</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line"><span class="keyword">while</span> ((receive = in.read()) != -<span class="number">1</span>) &#123;</div><div class="line">System.out.print((<span class="keyword">char</span>) receive);</div><div class="line">&#125;</div><div class="line">&#125; <span class="keyword">catch</span> (IOException ex) &#123;&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/09/juc_lock/" itemprop="url">
                  juc:locks
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2017-01-09T19:27:24+08:00" content="2017-01-09">
              2017-01-09
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="locks"><a href="#locks" class="headerlink" title="locks"></a>locks</h2><p><img src="http://i.imgur.com/lwUE2XO.png" alt=""></p>
<h3 id="lock"><a href="#lock" class="headerlink" title="lock"></a>lock</h3><p>java.util.concurrent.locks.Lock api</p>
<p><img src="http://i.imgur.com/VmlNAsr.png" alt=""></p>
<h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><p>重入锁ReentrantLock，顾名思义，就是支持重进入的锁，它表示该锁能够支持一个线程对资源的重复加锁。除此之外，该锁的还支持获取锁时的公平和非公平性选择。</p>
<p>这里提到一个锁获取的公平性问题，如果在绝对时间上，先对锁进行获取的请求一定先被满足，那么这个锁是公平的，反之，是不公平的。公平的获取锁，也就是等待时间最长的线程最优先获取锁，也可以说锁获取是顺序的。ReentrantLock提供了一个构造函数，能够控制锁是否是公平的。</p>
<p>锁重入需要解决两个问题：</p>
<ul>
<li>1）线程再次获取锁。锁需要去识别获取锁的线程是否为当前占据锁的线程，如果是，则再<br>次成功获取。</li>
<li>2）锁的最终释放。线程重复n次获取了锁，随后在第n次释放该锁后，其他线程能够获取到该锁。锁的最终释放要求锁对于获取进行计数自增，计数表示当前锁被重复获取的次数，而锁被释放时，计数自减，当计数等于0时表示锁已经成功释放。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> Thread current = Thread.currentThread();</div><div class="line">            <span class="keyword">int</span> c = getState();</div><div class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</div><div class="line">                    setExclusiveOwnerThread(current);</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</div><div class="line">                <span class="keyword">int</span> nextc = c + acquires;</div><div class="line">                <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line">                setState(nextc);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>该方法增加了再次获取同步状态的处理逻辑：通过判断当前线程是否为获取锁的线程来决定获取操作是否成功，如果是获取锁的线程再次请求，则将同步状态值进行增加并返回true，表示获取同步状态成功。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</div><div class="line">            <span class="keyword">int</span> c = getState() - releases;</div><div class="line">            <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</div><div class="line">            <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">                free = <span class="keyword">true</span>;</div><div class="line">                setExclusiveOwnerThread(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">            setState(c);</div><div class="line">            <span class="keyword">return</span> free;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>如果该锁被获取了n次，那么前(n-1)次tryRelease(int releases)方法必须返回false，而只有同<br>步状态完全释放了，才能返回true。可以看到，该方法将同步状态是否为0作为最终释放的条<br>件，当同步状态为0时，将占有线程设置为null，并返回true，表示释放成功。</p>
<p><strong>公平与非公平获取锁的区别</strong></p>
<p>公平性与否是针对获取锁而言的，如果一个锁是公平的，那么锁的获取顺序就应该符合请求的绝对时间顺序，也就是FIFO.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> Thread current = Thread.currentThread();</div><div class="line">            <span class="keyword">int</span> c = getState();</div><div class="line">            <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</div><div class="line">                    compareAndSetState(<span class="number">0</span>, acquires)) &#123;</div><div class="line">                    setExclusiveOwnerThread(current);</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</div><div class="line">                <span class="keyword">int</span> nextc = c + acquires;</div><div class="line">                <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line">                setState(nextc);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>该方法与nonfairTryAcquire(int acquires)比较，唯一不同的位置为判断条件多了<strong>hasQueuedPredecessors()</strong>方法，即加入了同步队列中当前节点是否有前驱节点的判断，如果该方法返回true，则表示有线程比当前线程更早地请求获取锁，因此需要等待前驱线程获取并释<br>放锁之后才能继续获取锁。</p>
<h3 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h3><p>ReentrantLock 实现了标准的互斥操作，也就是一次只能有一个线程持有锁，也即所谓独占锁的概念。前面的章节中一直在强调这个特点。显然这个特点在一定程度上面减低了吞吐量，实际上独占锁是一种保守的锁策略，在这种情况下任何“读/读”，“写/读”，“写/写”操作都不能同时发生。但是同样需要强调的一个概念是，锁是有一定的开销的，当并发比较大的时候，锁的开销就比较客观了。所以如果可能的话就尽量少用锁，非要用锁的话就尝试看能否改造为读写锁。</p>
<p>ReadWriteLock描述的是：一个资源能够被多个读线程访问，或者被一个写线程访问，但是不能同时存在读写线程。也就是说读写锁使用的场合是一个共享资源被大量读取操作，而只有少量的写操作（修改数据）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ReadWriteLock</span> </span>&#123;</div><div class="line">    <span class="function">Lock <span class="title">readLock</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">Lock <span class="title">writeLock</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ReadWriteLock看起来有两个锁：readLock/writeLock。<br>事实上在ReentrantReadWriteLock里锁的实现是靠java.util.concurrent.locks.ReentrantReadWriteLock.Sync完成的。同样它也有两种实现：公平锁和非公平锁，也就是java.util.concurrent.locks.ReentrantReadWriteLock.FairSync和java.util.concurrent.locks.ReentrantReadWriteLock.NonfairSync。</p>
<p>在ReentrantReadWriteLock里面的锁主体就是一个Sync，也就是上面提到的FairSync或者NonfairSync，所以说实际上只有一个锁，只是在获取读取锁和写入锁的方式上不一样</p>
<h4 id="写锁的获取和释放"><a href="#写锁的获取和释放" class="headerlink" title="写锁的获取和释放"></a>写锁的获取和释放</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</div><div class="line">Thread current = Thread.currentThread();</div><div class="line"><span class="keyword">int</span> c = getState();</div><div class="line"><span class="keyword">int</span> w = exclusiveCount(c);</div><div class="line"><span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</div><div class="line"><span class="comment">// 存在读锁或者当前获取线程不是已经获取写锁的线程</span></div><div class="line"><span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line"><span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line">setState(c + acquires);</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;<span class="function">i</span></div><div class="line"><span class="title">f</span> <span class="params">(writerShouldBlock()</span> || !<span class="title">compareAndSetState</span><span class="params">(c, c + acquires)</span>) &#123;</div><div class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;<span class="function">s</span></div><div class="line"><span class="title">etExclusiveOwnerThread</span><span class="params">(current)</span>;</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法除了重入条件（当前线程为获取了写锁的线程）之外，增加了一个读锁是否存在的判断。如果存在读锁，则写锁不能被获取，原因在于：读写锁要确保写锁的操作对读锁可见，如果允许读锁在已被获取的情况下对写锁的获取，那么正在运行的其他读线程就无法感知到当前写线程的操作。因此，只有等待其他读线程都释放了读锁，写锁才能被当前线程获取，而写锁一旦被获取，则其他读写线程的后续访问均被阻塞。</p>
<p>写锁的释放和ReentrantLock释放类似、</p>
<h4 id="读锁的获取和释放"><a href="#读锁的获取和释放" class="headerlink" title="读锁的获取和释放"></a>读锁的获取和释放</h4><p>读锁是一个支持重进入的共享锁，它能够被多个线程同时获取，在没有其他写线程访问（或者写状态为0）时，读锁总会被成功地获取，而所做的也只是（线程安全的）增加读状态。如果当前线程已经获取了读锁，则增加读状态。如果当前线程在获取读锁时，写锁已被其他线程获取，则进入等待状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</div><div class="line"><span class="keyword">for</span> (;;) &#123;</div><div class="line"><span class="keyword">int</span> c = getState();</div><div class="line"><span class="keyword">int</span> nextc = c + (<span class="number">1</span> &lt;&lt; <span class="number">16</span>);</div><div class="line"><span class="keyword">if</span> (nextc &lt; c)</div><div class="line"><span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</div><div class="line"><span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp; owner != Thread.currentThread())</div><div class="line"><span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line"><span class="keyword">if</span> (compareAndSetState(c, nextc))</div><div class="line"><span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>读锁的每次释放（线程安全的，可能有多个读线程同时释放读锁）均减少读状态，减少的值是（1&lt;&lt;16）。</p>
<p>总结一下：</p>
<p>ReentrantReadWriteLock有以下几个特性：</p>
<ul>
<li>公平性<ul>
<li>非公平锁（默认） 这个和独占锁的非公平性一样，由于读线程之间没有锁竞争，所以读操作没有公平性和非公平性，写操作时，由于写操作可能立即获取到锁，所以会推迟一个或多个读操作或者写操作。因此非公平锁的吞吐量要高于公平锁。</li>
<li>公平锁 利用AQS的CLH队列，释放当前保持的锁（读锁或者写锁）时，优先为等待时间最长的那个写线程分配写入锁，当前前提是写线程的等待时间要比所有读线程的等待时间要长。同样一个线程持有写入锁或者有一个写线程已经在等待了，那么试图获取公平锁的（非重入）所有线程（包括读写线程）都将被阻塞，直到最先的写线程释放锁。如果读线程的等待时间比写线程的等待时间还有长，那么一旦上一个写线程释放锁，这一组读线程将获取锁。</li>
</ul>
</li>
<li>重入性<ul>
<li>读写锁允许读线程和写线程按照请求锁的顺序重新获取读取锁或者写入锁。当然了只有写线程释放了锁，读线程才能获取重入锁。</li>
<li>写线程获取写入锁后可以再次获取读取锁，但是读线程获取读取锁后却不能获取写入锁。</li>
<li>另外读写锁最多支持65535个递归写入锁和65535个递归读取锁。</li>
</ul>
</li>
<li>锁降级<ul>
<li>写线程获取写入锁后可以获取读取锁，然后释放写入锁，这样就从写入锁变成了读取锁，从而实现锁降级的特性。</li>
</ul>
</li>
<li>锁获取中断<ul>
<li>读取锁和写入锁都支持获取锁期间被中断。这个和独占锁一致。</li>
</ul>
</li>
<li>条件变量<ul>
<li>写入锁提供了条件变量(Condition)的支持，这个和独占锁一致，但是读取锁却不允许获取条件变量，将得到一个UnsupportedOperationException异常。</li>
</ul>
</li>
<li>重入数<ul>
<li>读取锁和写入锁的数量最大分别只能是65535（包括重入数）。</li>
</ul>
</li>
</ul>
<h3 id="LockSupport"><a href="#LockSupport" class="headerlink" title="LockSupport"></a>LockSupport</h3><p>java.util.concurrent.locks.LockSupport</p>
<p>LockSupport定义了一组的公共静态方法，这些方法提供了最基本的线程阻塞和唤醒功能，而LockSupport也成为构建同步组件的基础工具。</p>
<p><img src="http://i.imgur.com/1U2e6HD.png" alt=""></p>
<h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><p>Condition接口也提供了类似Object的监视器方法，与Lock配合可以实现等待/通知模式</p>
<p><img src="http://i.imgur.com/QVxzTNX.png" alt=""></p>
<p>Condition对象是由Lock对象（调用Lock对象的newCondition()方法）创建出来的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">Condition condition = lock.newCondition();</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">conditionWait</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">lock.lock();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">condition.await();</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">lock.unlock();</div><div class="line">&#125;</div><div class="line">&#125;<span class="function">p</span></div><div class="line">ublic <span class="keyword">void</span> <span class="title">conditionSignal</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</div><div class="line">lock.lock();</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">condition.signal();</div><div class="line">&#125; <span class="keyword">finally</span> &#123;</div><div class="line">lock.unlock();</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://i.imgur.com/XIhZOml.png" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/08/并发编程1/" itemprop="url">
                  并发编程1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2017-01-08T19:27:24+08:00" content="2017-01-08">
              2017-01-08
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-重排序"><a href="#1-重排序" class="headerlink" title="1.重排序"></a>1.重排序</h3><p>重排序是指编译器和处理器为了优化程序性能而对指令序列进行重新排序的一种手段。</p>
<p>如果两个操作访问同一个变量，且这两个操作中有一个为写操作，此时这两个操作之间就存在数据依赖性。</p>
<ul>
<li>写后读</li>
<li>写后写</li>
<li>读后写</li>
</ul>
<p>上面3种情况，只要重排序两个操作的执行顺序，程序的执行结果就会被改变。编译器和处理器在重排序时，会遵守数据依赖性，编译器和处理器不会改变存在数据依赖关系的两个操作的执行顺序。</p>
<p>这里所说的数据依赖性仅针对单个处理器中执行的指令序列和单个线程中执行的操作，不同处理器之间和不同线程之间的数据依赖性不被编译器和处理器考虑。</p>
<p><strong>这里所说的数据依赖性仅针对单个处理器中执行的指令序列和单个线程中执行的操作，<br>不同处理器之间和不同线程之间的数据依赖性不被编译器和处理器考虑</strong></p>
<h3 id="2-as-if-serial语义"><a href="#2-as-if-serial语义" class="headerlink" title="2.as-if-serial语义"></a>2.as-if-serial语义</h3><p>as-if-serial语义的意思是：不管怎么重排序（编译器和处理器为了提高并行度），（单线程）程序的执行结果不能被改变。为了遵守as-if-serial语义，编译器和处理器不会对存在数据依赖关系的操作做重排序，因为这种重排序会改变执行结果。但是，如果操作之间不存在数据依赖关系，这些操作就可能被编译器和处理器重排序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">double</span> pi = <span class="number">3.14</span>; <span class="comment">// A</span></div><div class="line"><span class="keyword">double</span> r = <span class="number">1.0</span>; <span class="comment">// B</span></div><div class="line"><span class="keyword">double</span> area = pi * r * r; <span class="comment">// C</span></div></pre></td></tr></table></figure>
<p>a依赖于c b依赖于c ab可以重排序，c在ab后面。</p>
<h3 id="3-happens-before语义"><a href="#3-happens-before语义" class="headerlink" title="3.happens-before语义"></a>3.happens-before语义</h3><ol>
<li>A happens-before B。</li>
<li>B happens-before C。</li>
<li>A happens-before C</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReorderExample</span> </span>&#123;</div><div class="line"><span class="keyword">int</span> a = <span class="number">0</span>;</div><div class="line"><span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span> </span>&#123;</div><div class="line">a = <span class="number">1</span>; <span class="comment">// 1</span></div><div class="line">flag = <span class="keyword">true</span>; <span class="comment">// 2</span></div><div class="line">&#125; <span class="function">P</span></div><div class="line">ublic <span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span> &#123;</div><div class="line"><span class="keyword">if</span> (f?lag) &#123; <span class="comment">// 3</span></div><div class="line"><span class="keyword">int</span> i = a * a; <span class="comment">// 4</span></div><div class="line">……</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>flag变量是个标记，用来标识变量a是否已被写入。这里假设有两个线程A和B，A首先执行<br>writer()方法，随后B线程接着执行reader()方法。线程B在执行操作4时，能否看到线程A在操作<br>1对共享变量a的写入呢？</p>
<p><strong>答案是：不一定能看到。</strong></p>
<h3 id="4-volatile内存语义"><a href="#4-volatile内存语义" class="headerlink" title="4.volatile内存语义"></a>4.volatile内存语义</h3><p>可见性。对一个volatile变量的读，总是能看到（任意线程）对这个volatile变量最后的写入</p>
<p>原子性：对任意单个volatile变量的读/写具有原子性，但类似于volatile++这种复合操作不具有原子性.</p>
<p>volatile读的内存语义:<br>当读一个volatile变量时，JMM会把该线程对应的本地内存置为无效。线程接下来将从主内存中读取共享变量.</p>
<p>总结：<br>线程A写一个volatile变量，实质上是线程A向接下来将要读这个volatile变量的某个线程<br>发出了（其对共享变量所做修改的）消息。<br>·线程B读一个volatile变量，实质上是线程B接收了之前某个线程发出的（在写这个volatile<br>变量之前对共享变量所做修改的）消息。<br>·线程A写一个volatile变量，随后线程B读这个volatile变量，这个过程实质上是线程A通过<br>主内存向线程B发送消息。</p>
<h3 id="4-锁的内存语义"><a href="#4-锁的内存语义" class="headerlink" title="4.锁的内存语义"></a>4.锁的内存语义</h3><p>锁是Java并发编程中最重要的同步机制。锁除了让临界区互斥执行外，还可以让释放锁的线程向获取同一个锁的线程发送消息。</p>
<p>对比锁释放-获取的内存语义与volatile写-读的内存语义可以看出：锁释放与volatile写有相同的内存语义；锁获取与volatile读有相同的内存语义。</p>
<p>下面对锁释放和锁获取的内存语义做个总结。</p>
<p>·线程A释放一个锁，实质上是线程A向接下来将要获取这个锁的某个线程发出了（线程A对共享变量所做修改的）消息。</p>
<p>·线程B获取一个锁，实质上是线程B接收了之前某个线程发出的（在释放这个锁之前对共享变量所做修改的）消息。</p>
<p>·线程A释放锁，随后线程B获取这个锁，这个过程实质上是线程A通过主内存向线程B发送消息。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/2016总结/" itemprop="url">
                  2016总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2016-12-31T12:14:17+08:00" content="2016-12-31">
              2016-12-31
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="阅读书籍"><a href="#阅读书籍" class="headerlink" title="阅读书籍"></a>阅读书籍</h3><p>2016.06-2016.12</p>
<ul>
<li>深入理解java虚拟机 （总结：感觉要在温故一遍，其实最后几章有些没有认真阅读和思考 jvm内存模型？ 类加载过程？ 类加载器？ 类加载其顺序 垃圾回收算法？ minorgc和fullgc）</li>
<li>数据结构与算法分析 （总结：好吧，其实看完当时有收获，时间久了忘了也差不多了）</li>
<li>effective java （总结：一些模棱两可的问题更加清楚了）</li>
<li>hadoop应用开发技术详解（总结：其实蛮有意思的，大数据）</li>
<li>深入剖析tomact （总结：未完，讲道理，以前对于web编程只会写，一些原理不很清楚，感觉很有用去分析一下tomact源码）</li>
</ul>
<p>2017.01.01-2017.02.28（计划）</p>
<ul>
<li>java并发编程的艺术（线程池底层如何实现？ 如何模拟一个线程池？synchronized和lock的优缺点？）</li>
<li>pro spring（待定，其实是想找一本书好好理一下spring的源码实现 aop ioc？ springmvc流程？）</li>
<li>mybatis实现原理</li>
<li>深入浅出设计模式（观察者模式如何实现？ 单例模式两种的优缺点）</li>
<li>java基础（NIO：new io思想是什么？ hashmap内部实现？ 距离finally代码不执行？system。exit nio堆外内存？ hashmap和hashset关系？ 哪些类有serialVersionUID？futuretask类有什么作用 java访问数据库过程 jdbc？ cuncurrenthashmap读写加不加锁？）</li>
<li>redis（基本应用）</li>
<li>servlet（生命周期？过滤器和监听器用到的设计模式？ 单例多线程还是多利多线程？）</li>
<li>socket网络编程</li>
<li>网络相关 TCP、ip协议（tcp三次握手？ 常用http响应码含义？）</li>
<li>算法题（二叉树？ 快排？链表 堆 （10亿个数找topk））</li>
<li>软件工程（软件的设计原则）</li>
<li>js(prototype是什么 isNAN是什么意思)</li>
<li>jsp（两种include区别）</li>
<li>jstp（常用标签）</li>
<li>mysql（常用引擎？ 事务隔离级别？ sqlserver mysql oracle分页语句？ sql92和sql99写一个a和b表关联的语句？ 复合索引？）</li>
<li>linux（常用linux命令 复制一个文件 linux实时查看日志命令）</li>
<li>maven(maven命令)</li>
</ul>
<p>ps：怎么越写越多。。。以上是要付息或者预习的。</p>
<h3 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h3><ul>
<li>机器学习</li>
<li>spark</li>
<li>python</li>
</ul>
<h3 id="实习"><a href="#实习" class="headerlink" title="实习"></a>实习</h3><p>没什么写的。有一定收获。</p>
<ul>
<li>中科院 （2016.10-至今）</li>
<li>上海卯仕（2016.06-2016.09）</li>
<li>ibm （2015.09-2016.09）</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/tomact8源码分析/" itemprop="url">
                  tomact8源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2016-12-31T12:08:12+08:00" content="2016-12-31">
              2016-12-31
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><h4 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h4><p>Tomcat作为JavaWeb领域的Web容器，现在基本上所有线上业务系统都是部署在Tomcat上。为了对平时开发的Web系统有更深入的理解，于是仔细研究了下Tomcat的源码。Servlet规范是Java领域中为服务端编程制定的规范，对于我们开发者只是关注了Servlet规范中提供的编程组件(ServletContextListener,Filer,Servlet) 等 ，但是规范中还有一些我们经常使用的接口（ServletContext,ServletRequest,ServletResponse,FilterChain）等都是由Tomcat去实现的，并且我们开发者实现的编程组件只是被Tomcat去回调而已。所以看Tomcat源码实现也有助于我们更好的理解Servlet规范及系统如何在容器中运行(一些开源的MVC框架如Struts2,Webx,SpringMVC本质无非就是这个)</p>
<p>本文内容主要参考深入剖析tomact。由于这本书是基于tomcat4的，但是tomcat的核心思想应该是没有变的，最主要的两个组件还是连接器和容器。</p>
<p>本文分析内容为tomact8.0版本。</p>
<h4 id="2-tomact8-0源码目录"><a href="#2-tomact8-0源码目录" class="headerlink" title="2.tomact8.0源码目录"></a>2.tomact8.0源码目录</h4><p><img src="http://i.imgur.com/zkkS3tQ.png" alt=""></p>
<p>简单的包介绍：</p>
<ul>
<li>javax:servlet规范的api</li>
<li>org.apache.catalina：tomact自身架构（分析重点）</li>
<li>org.apache.coyote：http,ajp协议实现相关的类</li>
<li>org.apache.el :实现el规范</li>
<li>org.apache.jasper：实现jsp规范，编译jsp文件</li>
<li>org.apache.juli ：tomact的日志系统</li>
<li>org.apache.naming ： jndi实现</li>
<li>org.apache.tomact：tomact的工具包、net、digester xml解析器</li>
</ul>
<h4 id="3-tomact体系结构"><a href="#3-tomact体系结构" class="headerlink" title="3.tomact体系结构"></a>3.tomact体系结构</h4><p>为了后面的理解，先大致说一下Tomcat的整体架构，Tomcat主要有两个组件，<strong>连接器和容器</strong>，所谓连接器就是一个http请求过来了，连接器负责接收这个请求，然后转发给容器。容器即servlet容器，容器有很多层，分别是Engine，Host，Context，Wrapper。最大的容器Engine，代表一个servlet 引擎，接下来是Host，代表一个虚拟机，然后是Context，代表一个应用，Wrapper对应一个servlet。从连接器传过来连接后，容器便会顺序经过上面的容器，最后到达特定的servlet。</p>
<p><img src="http://i.imgur.com/irZpmOV.png" alt=""></p>
<p>一个server可以有多个service，一个service包含多个连接器和一个容器，一个Engine可以由多个虚拟主机Host组成，每一个Host下面又可以由多个Web应用Context构成，每一个的Context下面可以包含多个Wrapper（Servlet的包装器）组成。如图所示</p>
<p><img src="http://i.imgur.com/TnOdb8R.png" alt=""></p>
<p>Tomcat将Engine，Host，Context，Wrapper统一抽象成Container。一个抽象的Container模块可以包含各种服务。例如，Manager管理器（Session管理），Pipeline管道（ 维护管道阀门Value ）等。Lifecycle接口统一定义了容器的生命周期，通过事件机制实现各个容器间的内部通讯。</p>
<p>而容器的核心接口Container的抽象实现中定义了一个Pipeline，一个Manager，一个Realm以及ClassLoader统一了具体容器的实现规范。</p>
<ul>
<li>连接器（Connector）组件的主要任务是为其所接收到的每一个请求（可以是HTTP协议，也可以AJP协议），委托给具体相关协议的解析类ProtocolHandler</li>
<li>解析类 ProtocolHandler，构造出Request 对象和Response 对象。然后将这两个对象传送给容器（Container）进行处理。</li>
<li>容器（Container）组件收到来自连接器（Connector）的Request 和Response对象后，负责调用Filter，最后调用Servlet的service 方法（进入我们开发的Web系统中）。</li>
</ul>
<h4 id="4-tomact，servlet规范关系"><a href="#4-tomact，servlet规范关系" class="headerlink" title="4.tomact，servlet规范关系"></a>4.tomact，servlet规范关系</h4><p>Servlet规范由一组用 Java编程语言编写的类和接口组成。Servlet规范为服务端开发人员提供了一个标准的 API以及为服务器厂商制定了相关实现规范，开发人员只需要关心Servlet规范中的编程组件（如Filter,Servlet等），其他规范接口由第三方服务器厂商(如Tomcat)去实现，三者的关系如下图，Servlet规范之于Tomcat的关系，也类似于JDBC规范与数据库驱动的关系，本质就是一套接口和一套实现的关系。对于一个Web服务器主要需要做的事情，个人认为基本由以下组件组成： [TCP连接管理] –&gt; [请求处理线程池管理] –&gt; [HTTP协议解析封装] –&gt; [Servlet规范的实现,对编程组件的回调] –&gt; [MVC框架,Web系统业务逻辑]。</p>
<p>servlet规范和web应用和web容器之间的关系</p>
<p><img src="http://i.imgur.com/LGqAoZZ.png" alt=""></p>
<p>tomact对servlet规范的实现：</p>
<p><img src="http://i.imgur.com/WU5rWPi.png" alt=""></p>
<h3 id="第一章-类加载体系"><a href="#第一章-类加载体系" class="headerlink" title="第一章 类加载体系"></a>第一章 类加载体系</h3><p>首先简单介绍下Java虚拟机规范中提到的主要类加载器：</p>
<ul>
<li>Bootstrap Loader：加载lib目录下或者System.getProperty(“sun.boot.class.path”)、或者-XBootclasspath所指定的路径或jar。</li>
<li>Extended Loader：加载lib\ext目录下或者System.getProperty(“java.ext.dirs”) 所指定的 路径或jar。在使用Java运行程序时，也可以指定其搜索路径，例如：java -Djava.ext.dirs=d:\projects\testproj\classes HelloWorld。</li>
<li>AppClass Loader：加载System.getProperty(“java.class.path”)所指定的 路径或jar。在使用Java运行程序时，也可以加上-cp来覆盖原有的Classpath设置，例如： java -cp ./lavasoft/classes HelloWorld。</li>
</ul>
<p>根据java虚拟机的双亲委派模式的原则，类加载器在加载一个类时，首先交给父类加载器加载，层层往上直到Bootstrap Loader。也就是一个类最先由Bootstrap Loader加载，如果没有加载到，则交给下一层的类加载器加载，如果没有加载到，则依次层层往下，直到最下层的类加载器。这也就是说，凡是能通过父一级类加载器加载到的类，对于子类也是可见的。因此可以利用双亲委派模式的特性，使用类加载器对不同路径下的jar包或者类进行环境隔离。</p>
<p>然后用一张图片来展示Tomcat的类加载体系：</p>
<p><img src="http://i.imgur.com/yutfn3I.png" alt=""></p>
<ul>
<li>ClassLoader：Java提供的类加载器抽象类，用户自定义的类加载器需要继承实现</li>
<li>commonLoader：Tomcat最基本的类加载器，加载路径中的class可以被Tomcat容器本身以及各个Webapp访问；</li>
<li>catalinaLoader：Tomcat容器私有的类加载器，加载路径中的class对于Webapp不可见；</li>
<li>sharedLoader：各个Webapp共享的类加载器，加载路径中的class对于所有Webapp可见，但是对于Tomcat容器不可见；</li>
<li>WebappClassLoader：各个Webapp私有的类加载器，加载路径中的class只对当前Webapp可见；</li>
</ul>
<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><p>commonLoader、catalinaLoader和sharedLoader在Tomcat容器初始化的一开始，即调用Bootstrap的init方法时创建。catalinaLoader会被设置为Tomcat主线程的线程上下文类加载器，并且使用catalinaLoader加载Tomcat容器自身容器下的class。Bootstrap的init方法的部分代码见代码清单1。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        initClassLoaders();</div><div class="line"></div><div class="line">        Thread.currentThread().setContextClassLoader(catalinaLoader);</div><div class="line"></div><div class="line">        SecurityClassLoad.securityClassLoad(catalinaLoader);</div><div class="line"></div><div class="line">        <span class="comment">// Load our startup class and call its process() method</span></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">            log.debug(<span class="string">"Loading startup class"</span>);</div><div class="line">        Class&lt;?&gt; startupClass =</div><div class="line">            catalinaLoader.loadClass</div><div class="line">            (<span class="string">"org.apache.catalina.startup.Catalina"</span>);</div><div class="line">        Object startupInstance = startupClass.newInstance();</div><div class="line"></div><div class="line">        <span class="comment">// Set the shared extensions class loader</span></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">            log.debug(<span class="string">"Setting startup class properties"</span>);</div><div class="line">        String methodName = <span class="string">"setParentClassLoader"</span>;</div><div class="line">        Class&lt;?&gt; paramTypes[] = <span class="keyword">new</span> Class[<span class="number">1</span>];</div><div class="line">        paramTypes[<span class="number">0</span>] = Class.forName(<span class="string">"java.lang.ClassLoader"</span>);</div><div class="line">        Object paramValues[] = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        paramValues[<span class="number">0</span>] = sharedLoader;</div><div class="line">        Method method =</div><div class="line">            startupInstance.getClass().getMethod(methodName, paramTypes);</div><div class="line">        method.invoke(startupInstance, paramValues);</div><div class="line"></div><div class="line">        catalinaDaemon = startupInstance;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>接下来我们关注initclassloaders方法的实现，该方法主要用来初始化commonLoader、catalinaLoader、sharedLoader。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initClassLoaders</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            commonLoader = createClassLoader(<span class="string">"common"</span>, <span class="keyword">null</span>);</div><div class="line">            <span class="keyword">if</span>( commonLoader == <span class="keyword">null</span> ) &#123;</div><div class="line">                <span class="comment">// no config file, default to this loader - we might be in a 'single' env.</span></div><div class="line">                commonLoader=<span class="keyword">this</span>.getClass().getClassLoader();</div><div class="line">            &#125;</div><div class="line">            catalinaLoader = createClassLoader(<span class="string">"server"</span>, commonLoader);</div><div class="line">            sharedLoader = createClassLoader(<span class="string">"shared"</span>, commonLoader);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            handleThrowable(t);</div><div class="line">            log.error(<span class="string">"Class loader creation threw exception"</span>, t);</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从代码中看到创建类加载器是通过调用createClassLoader方法实现的。createClassLoader的实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(String name, ClassLoader parent)</span></span></div><div class="line">        <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">        String value = CatalinaProperties.getProperty(name + <span class="string">".loader"</span>);</div><div class="line">        <span class="keyword">if</span> ((value == <span class="keyword">null</span>) || (value.equals(<span class="string">""</span>)))</div><div class="line">            <span class="keyword">return</span> parent;</div><div class="line"></div><div class="line">        value = replace(value);</div><div class="line"></div><div class="line">        List&lt;Repository&gt; repositories = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        String[] repositoryPaths = getPaths(value);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (String repository : repositoryPaths) &#123;</div><div class="line">            <span class="comment">// Check for a JAR URL repository</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</div><div class="line">                URL url = <span class="keyword">new</span> URL(repository);</div><div class="line">                repositories.add(</div><div class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.URL));</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</div><div class="line">                <span class="comment">// Ignore</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Local repository</span></div><div class="line">            <span class="keyword">if</span> (repository.endsWith(<span class="string">"*.jar"</span>)) &#123;</div><div class="line">                repository = repository.substring</div><div class="line">                    (<span class="number">0</span>, repository.length() - <span class="string">"*.jar"</span>.length());</div><div class="line">                repositories.add(</div><div class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.GLOB));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (repository.endsWith(<span class="string">".jar"</span>)) &#123;</div><div class="line">                repositories.add(</div><div class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.JAR));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                repositories.add(</div><div class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.DIR));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> ClassLoaderFactory.createClassLoader(repositories, parent);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>createClassLoader方法的执行步骤如下：</p>
<ol>
<li>获取各个类加载器相应的资源配置文件（分别为common.loader、server.loader、shared.loader），从中获取类资源路径的配置信息；</li>
<li>解析类资源路径下的各个资源位置和类型，也包括对jar资源的检查；</li>
<li>调用ClassLoaderFactory.createClassLoader(locations, types, parent)方法创建ClassLoader；</li>
</ol>
<p>我们回头看看代码清单1中的SecurityClassLoad.securityClassLoad(catalinaLoader)的实现，见代码清单4.这说明加载Tomcat容器本身的类资源的确是使用catalinaLoader来完成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> org.apache.catalina.security;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">securityClassLoad</span><span class="params">(ClassLoader loader, <span class="keyword">boolean</span> requireSecurityManager)</span></span></div><div class="line">           <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (requireSecurityManager &amp;&amp; System.getSecurityManager() == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       loadCorePackage(loader);</div><div class="line">       loadCoyotePackage(loader);</div><div class="line">       loadLoaderPackage(loader);</div><div class="line">       loadRealmPackage(loader);</div><div class="line">       loadServletsPackage(loader);</div><div class="line">       loadSessionPackage(loader);</div><div class="line">       loadUtilPackage(loader);</div><div class="line">       loadValvesPackage(loader);</div><div class="line">       loadJavaxPackage(loader);</div><div class="line">       loadConnectorPackage(loader);</div><div class="line">       loadTomcatPackage(loader);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>securityClassLoad方法主要加载Tomcat容器所需的class，包括：</p>
<ul>
<li>Tomcat核心class，即org.apache.catalina.core路径下的class；</li>
<li>loadCoyotePackage</li>
<li>org.apache.catalina.loader.WebappClassLoader$PrivilegedFindResourceByName；</li>
<li>loadRealmPackage</li>
<li>loadServletsPackage</li>
<li>Tomcat有关session的class，即org.apache.catalina.session路径下的class；</li>
<li>Tomcat工具类的class，即org.apache.catalina.util路径下的class；</li>
<li>loadValvesPackage</li>
<li>javax.servlet.http.Cookie；</li>
<li>Tomcat处理请求的class，即org.apache.catalina.connector路径下的class；</li>
<li>Tomcat其它工具类的class，也是org.apache.catalina.util路径下的class；</li>
</ul>
<p>我们以加载Tomcat核心class的loadCorePackage方法为例，其实现见代码清单5所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">loadCorePackage</span><span class="params">(ClassLoader loader)</span></span></div><div class="line">            <span class="keyword">throws</span> Exception &#123;</div><div class="line">        <span class="keyword">final</span> String basePackage = <span class="string">"org.apache.catalina.core."</span>;</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"AccessLogAdapter"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"ApplicationContextFacade$1"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"ApplicationDispatcher$PrivilegedForward"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"ApplicationDispatcher$PrivilegedInclude"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">            <span class="string">"AsyncContextImpl"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">            <span class="string">"AsyncContextImpl$DebugException"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">            <span class="string">"AsyncContextImpl$1"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">            <span class="string">"AsyncListenerWrapper"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"ContainerBase$PrivilegedAddChild"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"DefaultInstanceManager$1"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"DefaultInstanceManager$2"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"DefaultInstanceManager$3"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"DefaultInstanceManager$AnnotationCacheEntry"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"DefaultInstanceManager$AnnotationCacheEntryType"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"ApplicationHttpRequest$AttributeNamesEnumerator"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>至此，有关commonLoader、catalinaLoader和sharedLoader三个类加载器的初始化以及使用catalinaLoader加载Tomcat容器自身类资源的内容已经介绍完了，但是我们还没有看到WebappClassLoader。启动StandardContext的时候会创建WebappLoader，最终调用其startInternal方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.apache.catalina.core;</div><div class="line"></div><div class="line"><span class="comment">/** </span></div><div class="line"> * Start this component and implement the requirements </div><div class="line"> * of &#123;<span class="doctag">@link</span> LifecycleBase#startInternal()&#125;. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error </div><div class="line"> *  that prevents this component from being used </div><div class="line"> */  </div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="comment">// 省略前边的代码   </span></div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (getLoader() == <span class="keyword">null</span>) &#123;  </div><div class="line">        WebappLoader webappLoader = <span class="keyword">new</span> WebappLoader(getParentClassLoader());  </div><div class="line">        webappLoader.setDelegate(getDelegate());  </div><div class="line">        setLoader(webappLoader);  </div><div class="line">    &#125;  </div><div class="line">   <span class="comment">// 省略中间的代码   </span></div><div class="line">   <span class="comment">// Start our subordinate components, if any  </span></div><div class="line">   <span class="keyword">if</span> ((loader != <span class="keyword">null</span>) &amp;&amp; (loader <span class="keyword">instanceof</span> Lifecycle))  </div><div class="line">        ((Lifecycle) loader).start();   </div><div class="line">   <span class="comment">// 省略后边的代码   </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从代码清单6看到首先创建WebappLoader实例，然后调用WebappLoader的start方法，start又调用了startInternal方法，WebappLoader的startInternal的实现见代码清单7.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">            log.debug(sm.getString(<span class="string">"webappLoader.starting"</span>));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (context.getResources() == <span class="keyword">null</span>) &#123;</div><div class="line">            log.info(<span class="string">"No resources for "</span> + context);</div><div class="line">            setState(LifecycleState.STARTING);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Construct a class loader based on our current repositories list</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">            classLoader = createClassLoader();</div><div class="line">            classLoader.setResources(context.getResources());</div><div class="line">            classLoader.setDelegate(<span class="keyword">this</span>.delegate);</div><div class="line"></div><div class="line">            <span class="comment">// Configure our repositories</span></div><div class="line">            setClassPath();</div><div class="line"></div><div class="line">            setPermissions();</div><div class="line"></div><div class="line">            ((Lifecycle) classLoader).start();</div><div class="line"></div><div class="line">            String contextName = context.getName();</div><div class="line">            <span class="keyword">if</span> (!contextName.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">                contextName = <span class="string">"/"</span> + contextName;</div><div class="line">            &#125;</div><div class="line">            ObjectName cloname = <span class="keyword">new</span> ObjectName(context.getDomain() + <span class="string">":type="</span> +</div><div class="line">                    classLoader.getClass().getSimpleName() + <span class="string">",host="</span> +</div><div class="line">                    context.getParent().getName() + <span class="string">",context="</span> + contextName);</div><div class="line">            Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>)</div><div class="line">                .registerComponent(classLoader, cloname, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            t = ExceptionUtils.unwrapInvocationTargetException(t);</div><div class="line">            ExceptionUtils.handleThrowable(t);</div><div class="line">            log.error( <span class="string">"LifecycleException "</span>, t );</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(<span class="string">"start: "</span>, t);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setState(LifecycleState.STARTING);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>我们看到代码清单7中通过调用createClassLoader来创建类加载器，并且设置其资源路径为当前Webapp下的类资源。最后我们看看createClassLoader的实现，见代码清单8.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Create associated classLoader.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> WebappClassLoaderBase <span class="title">createClassLoader</span><span class="params">()</span></span></div><div class="line">       <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">       Class&lt;?&gt; clazz = Class.forName(loaderClass);</div><div class="line">       WebappClassLoaderBase classLoader = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (parentClassLoader == <span class="keyword">null</span>) &#123;</div><div class="line">           parentClassLoader = context.getParentClassLoader();</div><div class="line">       &#125;</div><div class="line">       Class&lt;?&gt;[] argTypes = &#123; ClassLoader.class &#125;;</div><div class="line">       Object[] args = &#123; parentClassLoader &#125;;</div><div class="line">       Constructor&lt;?&gt; constr = clazz.getConstructor(argTypes);</div><div class="line">       classLoader = (WebappClassLoaderBase) constr.newInstance(args);</div><div class="line"></div><div class="line">       <span class="keyword">return</span> classLoader;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里loaderClass的值是字符串org.apache.catalina.loader.WebappClassLoader，通过反射来实例化WebappClassLoader。由于每个Webapp下的类资源由不同的WebappClassLoader负责加载，因此各个Webapp下的类资源是独立的。至此，整个Tomcat的类加载体系构建完毕。</p>
<h3 id="第二章-server-xml文件的加载和解析"><a href="#第二章-server-xml文件的加载和解析" class="headerlink" title="第二章 server.xml文件的加载和解析"></a>第二章 server.xml文件的加载和解析</h3><p>作为Java程序员，对于Tomcat的server.xml想必都不陌生。本章主要对server.xml文件是如何加载和解析进行分析。</p>
<h4 id="1-web-xml"><a href="#1-web-xml" class="headerlink" title="1.web.xml"></a>1.web.xml</h4><p>首先让我们来查看一下web.xml内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></div><div class="line">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee</span></div><div class="line">                      http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"</div><div class="line">  <span class="attr">version</span>=<span class="string">"3.1"</span></div><div class="line">  <span class="attr">metadata-complete</span>=<span class="string">"true"</span>&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Tomcat Documentation<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">     Tomcat Documentation.</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="2-加载过程分析"><a href="#2-加载过程分析" class="headerlink" title="2.加载过程分析"></a>2.加载过程分析</h4><p>bootstrap中load方法用于加载tomact的server.xml,实际是通过反射调用Catalina的load方法.代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">    * Load daemon.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(String[] arguments)</span></span></div><div class="line">       <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">       <span class="comment">// Call the load() method</span></div><div class="line">       String methodName = <span class="string">"load"</span>;</div><div class="line">       Object param[];</div><div class="line">       Class&lt;?&gt; paramTypes[];</div><div class="line">       <span class="keyword">if</span> (arguments==<span class="keyword">null</span> || arguments.length==<span class="number">0</span>) &#123;</div><div class="line">           paramTypes = <span class="keyword">null</span>;</div><div class="line">           param = <span class="keyword">null</span>;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           paramTypes = <span class="keyword">new</span> Class[<span class="number">1</span>];</div><div class="line">           paramTypes[<span class="number">0</span>] = arguments.getClass();</div><div class="line">           param = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">           param[<span class="number">0</span>] = arguments;</div><div class="line">       &#125;</div><div class="line">       Method method =</div><div class="line">           catalinaDaemon.getClass().getMethod(methodName, paramTypes);</div><div class="line">       <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">           log.debug(<span class="string">"Calling startup class "</span> + method);</div><div class="line">       method.invoke(catalinaDaemon, param);</div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>Catalina的load方法实现如下代码所示。其中load方法主要执行如是过程：</p>
<ol>
<li>initDirs()用于对catalina.home和catalina.base的一些检查工作。</li>
<li>initNaming()给系统设置java.naming.factory.url.pkgs和java.naming.factory.initial。</li>
<li>createStartDigester();创建并配置将要用来启动的Digester实例，并且设置一些列Rule，具体映射到server.xml。</li>
<li>FileInputStream获取conf/server.xml配置文件输入流</li>
<li>将FileInputStream封装为InputSource，并且调用Digester的parse方法进行解析。</li>
<li>initStreams()对输出流、错误流重定向</li>
<li>初始化server</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Start a new server instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> t1 = System.nanoTime();</div><div class="line"></div><div class="line">        initDirs();</div><div class="line"></div><div class="line">        <span class="comment">// Before digester - it may be needed</span></div><div class="line">        initNaming();</div><div class="line"></div><div class="line">        <span class="comment">// Create and execute our Digester</span></div><div class="line">        Digester digester = createStartDigester();</div><div class="line"></div><div class="line">        InputSource inputSource = <span class="keyword">null</span>;</div><div class="line">        InputStream inputStream = <span class="keyword">null</span>;</div><div class="line">        File file = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                file = configFile();</div><div class="line">                inputStream = <span class="keyword">new</span> FileInputStream(file);</div><div class="line">                inputSource = <span class="keyword">new</span> InputSource(file.toURI().toURL().toString());</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                    log.debug(sm.getString(<span class="string">"catalina.configFail"</span>, file), e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    inputStream = getClass().getClassLoader()</div><div class="line">                        .getResourceAsStream(getConfigFile());</div><div class="line">                    inputSource = <span class="keyword">new</span> InputSource</div><div class="line">                        (getClass().getClassLoader()</div><div class="line">                         .getResource(getConfigFile()).toString());</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                        log.debug(sm.getString(<span class="string">"catalina.configFail"</span>,</div><div class="line">                                getConfigFile()), e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// This should be included in catalina.jar</span></div><div class="line">            <span class="comment">// Alternative: don't bother with xml, just create it manually.</span></div><div class="line">            <span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    inputStream = getClass().getClassLoader()</div><div class="line">                            .getResourceAsStream(<span class="string">"server-embed.xml"</span>);</div><div class="line">                    inputSource = <span class="keyword">new</span> InputSource</div><div class="line">                    (getClass().getClassLoader()</div><div class="line">                            .getResource(<span class="string">"server-embed.xml"</span>).toString());</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                        log.debug(sm.getString(<span class="string">"catalina.configFail"</span>,</div><div class="line">                                <span class="string">"server-embed.xml"</span>), e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="keyword">if</span> (inputStream == <span class="keyword">null</span> || inputSource == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span>  (file == <span class="keyword">null</span>) &#123;</div><div class="line">                    log.warn(sm.getString(<span class="string">"catalina.configFail"</span>,</div><div class="line">                            getConfigFile() + <span class="string">"] or [server-embed.xml]"</span>));</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    log.warn(sm.getString(<span class="string">"catalina.configFail"</span>,</div><div class="line">                            file.getAbsolutePath()));</div><div class="line">                    <span class="keyword">if</span> (file.exists() &amp;&amp; !file.canRead()) &#123;</div><div class="line">                        log.warn(<span class="string">"Permissions incorrect, read permission is not allowed on the file."</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                inputSource.setByteStream(inputStream);</div><div class="line">                digester.push(<span class="keyword">this</span>);</div><div class="line">                digester.parse(inputSource);</div><div class="line">            &#125; <span class="keyword">catch</span> (SAXParseException spe) &#123;</div><div class="line">                log.warn(<span class="string">"Catalina.start using "</span> + getConfigFile() + <span class="string">": "</span> +</div><div class="line">                        spe.getMessage());</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                log.warn(<span class="string">"Catalina.start using "</span> + getConfigFile() + <span class="string">": "</span> , e);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    inputStream.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    <span class="comment">// Ignore</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        getServer().setCatalina(<span class="keyword">this</span>);</div><div class="line">        getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());</div><div class="line">        getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());</div><div class="line"></div><div class="line">        <span class="comment">// Stream redirection</span></div><div class="line">        initStreams();</div><div class="line"></div><div class="line">        <span class="comment">// Start the new server</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            getServer().init();</div><div class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</div><div class="line">            <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">"org.apache.catalina.startup.EXIT_ON_INIT_FAILURE"</span>)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.Error(e);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                log.error(<span class="string">"Catalina.start"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> t2 = System.nanoTime();</div><div class="line">        <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</div><div class="line">            log.info(<span class="string">"Initialization processed in "</span> + ((t2 - t1) / <span class="number">1000000</span>) + <span class="string">" ms"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="3-规则"><a href="#3-规则" class="headerlink" title="3.规则"></a>3.规则</h4><p>在针对上述加载过程具体分析及正式介绍Digester的parse方法的解析过程前，我们先要掌握一些规则相关的内容。<br>Tomcat将server.xml文件中的所有元素上的属性都抽象为Rule，以Server元素为例，在内存中对应Server实例，Server实例的属性值就来自于Server元素的属性值。通过对规则（Rule）的应用，最终改变Server实例的属性值。</p>
<p>rule抽象类，结构如下：</p>
<p><img src="http://i.imgur.com/hQoWO8b.png" alt=""></p>
<p>主要接口介绍：</p>
<ul>
<li>getDigester：获取Digester实例；</li>
<li>setDigester：设置Digester实例；</li>
<li>getNamespaceURI：获取Rule所在的相对命名空间URI；</li>
<li>setNamespaceURI：设置Rule所在的相对命名空间URI；</li>
<li>begin(String namespace, String name, Attributes attributes)：此方法在遇到一个匹配的XML元素的开头时被调用，如：<server>。</server></li>
<li>body(String namespace, String name, String text)：在遇到匹配XML元素的body时，此方法被调用，如进入<server>标签内部时。</server></li>
<li>end(String namespace, String name)：此方法在遇到一个匹配的XML元素的末尾时被调用。如：。</li>
</ul>
<p>Rule目前有很多实现类，如：NodeCreateRule，AbsoluteOrderingRule、CallParamRule、ConnectorCreateRule等。下图展示了Rule的部分实现类：<br><img src="http://i.imgur.com/8oFCvId.png" alt=""></p>
<h4 id="4-SAX"><a href="#4-SAX" class="headerlink" title="4.SAX"></a>4.SAX</h4><p><strong>simple api for xml</strong></p>
<p>相比于 DOM 而言 SAX 是一种速度更快，更有效，占用内存更少的解析 XML 文件的方法。它是逐行扫描，可以做到边扫描边解析，因此 SAX 可以在解析文档的任意时刻停止解析。</p>
<p>SAX 是基于事件驱动的。</p>
<p>SAX 不用解析完整个文档，在按内容顺序解析文档过程中， SAX 会判断当前读到的字符是否符合 XML 文件语法中的某部分。如果符合某部分，则会触发事件。</p>
<p>所谓触发事件，就是调用一些回调方法。在用 SAX 解析 xml 文档时候，在读取到文档开始和结束标签时候就会回调一个事件，在读取到其他节点与内容时候也会回调一个事件。</p>
<p>在 SAX 接口中，事件源是 org.xml.sax 包中的 XMLReader ，它通过 parser() 方法来解析 XML 文档，并产生事件。事件处理器是 org.xml.sax 包中 ContentHander 、 DTDHander 、 ErrorHandler ，以及 EntityResolver 这 4 个接口。</p>
<p><img src="http://i.imgur.com/ZteQz4W.png" alt=""></p>
<p>我们用来做内容解析的回调方法一般都定义在 ContentHandler 接口中 。ContentHandler 接口常用的方法：</p>
<ul>
<li>startDocument() :当遇到文档的开头的时候，调用这个方法，可以在其中做一些预处理的工作。 </li>
<li>endDocument() :当文档结束的时候，调用这个方法，可以在其中做一些善后的工作。   </li>
<li>startElement(String namespaceURI, String localName,String qName, Attributes atts):当读到开始标签的时候，会调用这个方法。 namespaceURI 就是命名空间， localName 是不带命名空间前缀的标签名， qName 是带命名空间前缀的标签名。通过 atts 可以得到所有的属性名和相应的值。 </li>
<li>endElement(String uri, String localName, String name):在遇到结束标签的时候，调用这个方法。</li>
<li>characters(char[] ch, int start, int length):这个方法用来处理在 XML 文件中读到的内容。例如： <high data="30"> 主要目的是获取 high 标签中的值。</high></li>
</ul>
<p>使用 SAX 解析 XML 文件一般有以下五个步骤： </p>
<ol>
<li>创建一个 SAXParserFactory 对象； </li>
<li>调用 SAXParserFactory 中的 newSAXParser 方法创建一个 SAXParser 对象； </li>
<li>然后在调用 SAXParser 中的 getXMLReader 方法获取一个 XMLReader 对象；</li>
<li>实例化一个 DefaultHandler 对象；</li>
<li>连接事件源对象 XMLReader 到事件处理类 DefaultHandler 中；</li>
<li>调用 XMLReader 的 parse 方法从输入源中获取到的 xml 数据；</li>
<li>通过 DefaultHandler 返回我们需要的数据集合。</li>
</ol>
<h4 id="5-解析过程分析"><a href="#5-解析过程分析" class="headerlink" title="5.解析过程分析"></a>5.解析过程分析</h4><p>回顾第二小节讲的catalina中load方法执行步骤：</p>
<blockquote>
<p>Catalina的load方法实现如下代码所示。其中load方法主要执行如是过程：</p>
<ol>
<li>initDirs()用于对catalina.home和catalina.base的一些检查工作。</li>
<li>initNaming()给系统设置java.naming.factory.url.pkgs和java.naming.factory.initial。</li>
<li>createStartDigester();创建并配置将要用来启动的Digester实例，并且设置一些列Rule，具体映射到server.xml。</li>
<li>FileInputStream获取conf/server.xml配置文件输入流</li>
<li>将FileInputStream封装为InputSource，并且调用Digester的parse方法进行解析。</li>
<li>initStreams()对输出流、错误流重定向</li>
<li>初始化server</li>
</ol>
</blockquote>
<p>首先来查看createStartDigester方法。实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Create and configure the Digester we will be using for startup.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> Digester <span class="title">createStartDigester</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> t1=System.currentTimeMillis();</div><div class="line">        <span class="comment">// Initialize the digester</span></div><div class="line">        Digester digester = <span class="keyword">new</span> Digester();</div><div class="line">        digester.setValidating(<span class="keyword">false</span>);</div><div class="line">        digester.setRulesValidation(<span class="keyword">true</span>);</div><div class="line">        HashMap&lt;Class&lt;?&gt;, List&lt;String&gt;&gt; fakeAttributes = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        ArrayList&lt;String&gt; attrs = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        attrs.add(<span class="string">"className"</span>);</div><div class="line">        fakeAttributes.put(Object.class, attrs);</div><div class="line">        digester.setFakeAttributes(fakeAttributes);</div><div class="line">        digester.setUseContextClassLoader(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Configure the actions we will be using</span></div><div class="line">        digester.addObjectCreate(<span class="string">"Server"</span>,</div><div class="line">                                 <span class="string">"org.apache.catalina.core.StandardServer"</span>,</div><div class="line">                                 <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server"</span>,</div><div class="line">                            <span class="string">"setServer"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.Server"</span>);</div><div class="line"></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/GlobalNamingResources"</span>,</div><div class="line">                                 <span class="string">"org.apache.catalina.deploy.NamingResourcesImpl"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/GlobalNamingResources"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server/GlobalNamingResources"</span>,</div><div class="line">                            <span class="string">"setGlobalNamingResources"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.deploy.NamingResourcesImpl"</span>);</div><div class="line"></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/Listener"</span>,</div><div class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></div><div class="line">                                 <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/Listener"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server/Listener"</span>,</div><div class="line">                            <span class="string">"addLifecycleListener"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.LifecycleListener"</span>);</div><div class="line"></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/Service"</span>,</div><div class="line">                                 <span class="string">"org.apache.catalina.core.StandardService"</span>,</div><div class="line">                                 <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/Service"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server/Service"</span>,</div><div class="line">                            <span class="string">"addService"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.Service"</span>);</div><div class="line"></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/Service/Listener"</span>,</div><div class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></div><div class="line">                                 <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/Service/Listener"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server/Service/Listener"</span>,</div><div class="line">                            <span class="string">"addLifecycleListener"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.LifecycleListener"</span>);</div><div class="line"></div><div class="line">        <span class="comment">//Executor</span></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/Service/Executor"</span>,</div><div class="line">                         <span class="string">"org.apache.catalina.core.StandardThreadExecutor"</span>,</div><div class="line">                         <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/Service/Executor"</span>);</div><div class="line"></div><div class="line">        digester.addSetNext(<span class="string">"Server/Service/Executor"</span>,</div><div class="line">                            <span class="string">"addExecutor"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.Executor"</span>);</div><div class="line"></div><div class="line"></div><div class="line">        digester.addRule(<span class="string">"Server/Service/Connector"</span>,</div><div class="line">                         <span class="keyword">new</span> ConnectorCreateRule());</div><div class="line">        digester.addRule(<span class="string">"Server/Service/Connector"</span>,</div><div class="line">                         <span class="keyword">new</span> SetAllPropertiesRule(<span class="keyword">new</span> String[]&#123;<span class="string">"executor"</span>&#125;));</div><div class="line">        digester.addSetNext(<span class="string">"Server/Service/Connector"</span>,</div><div class="line">                            <span class="string">"addConnector"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.connector.Connector"</span>);</div><div class="line"></div><div class="line"></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/Service/Connector/Listener"</span>,</div><div class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></div><div class="line">                                 <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/Service/Connector/Listener"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server/Service/Connector/Listener"</span>,</div><div class="line">                            <span class="string">"addLifecycleListener"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.LifecycleListener"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Add RuleSets for nested elements</span></div><div class="line">        digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">"Server/GlobalNamingResources/"</span>));</div><div class="line">        digester.addRuleSet(<span class="keyword">new</span> EngineRuleSet(<span class="string">"Server/Service/"</span>));</div><div class="line">        digester.addRuleSet(<span class="keyword">new</span> HostRuleSet(<span class="string">"Server/Service/Engine/"</span>));</div><div class="line">        digester.addRuleSet(<span class="keyword">new</span> ContextRuleSet(<span class="string">"Server/Service/Engine/Host/"</span>));</div><div class="line">        addClusterRuleSet(digester, <span class="string">"Server/Service/Engine/Host/Cluster/"</span>);</div><div class="line">        digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">"Server/Service/Engine/Host/Context/"</span>));</div><div class="line"></div><div class="line">        <span class="comment">// When the 'engine' is found, set the parentClassLoader.</span></div><div class="line">        digester.addRule(<span class="string">"Server/Service/Engine"</span>,</div><div class="line">                         <span class="keyword">new</span> SetParentClassLoaderRule(parentClassLoader));</div><div class="line">        addClusterRuleSet(digester, <span class="string">"Server/Service/Engine/Cluster/"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">long</span> t2=System.currentTimeMillis();</div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">            log.debug(<span class="string">"Digester for server.xml created "</span> + ( t2-t1 ));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (digester);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>代码清单1首先创建Digester，Digester继承了DefaultHandler2，而DefaultHandler默认实现了DefaultHandler,LexicalHandler, DeclHandler, EntityResolver2 这几个接口，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultHandler2</span> <span class="keyword">extends</span> <span class="title">DefaultHandler</span></span></div><div class="line">    <span class="keyword">implements</span> <span class="title">LexicalHandler</span>, <span class="title">DeclHandler</span>, <span class="title">EntityResolver2</span></div></pre></td></tr></table></figure>
<p>如果阅读DefaultHandler的源码，发现它的所有实现都是空实现，看来要发挥解析作用，只能依靠Digester自己了，digester中部分实现如下;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Process notification of the end of the document being reached.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> SAXException if a parsing error is to be reported</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (saxLog.isDebugEnabled()) &#123;</div><div class="line">            <span class="keyword">if</span> (getCount() &gt; <span class="number">1</span>) &#123;</div><div class="line">                saxLog.debug(<span class="string">"endDocument():  "</span> + getCount() + <span class="string">" elements left"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                saxLog.debug(<span class="string">"endDocument()"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (getCount() &gt; <span class="number">1</span>) &#123;</div><div class="line">            pop();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Fire "finish" events for all defined rules</span></div><div class="line">        Iterator&lt;Rule&gt; rules = getRules().rules().iterator();</div><div class="line">        <span class="keyword">while</span> (rules.hasNext()) &#123;</div><div class="line">            Rule rule = rules.next();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                rule.finish();</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                log.error(<span class="string">"Finish event threw exception"</span>, e);</div><div class="line">                <span class="keyword">throw</span> createSAXException(e);</div><div class="line">            &#125; <span class="keyword">catch</span> (Error e) &#123;</div><div class="line">                log.error(<span class="string">"Finish event threw error"</span>, e);</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Perform final cleanup</span></div><div class="line">        clear();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Process notification of the end of an XML element being reached.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> namespaceURI - The Namespace URI, or the empty string if the</div><div class="line">     *   element has no Namespace URI or if Namespace processing is not</div><div class="line">     *   being performed.</div><div class="line">     * <span class="doctag">@param</span> localName - The local name (without prefix), or the empty</div><div class="line">     *   string if Namespace processing is not being performed.</div><div class="line">     * <span class="doctag">@param</span> qName - The qualified XML 1.0 name (with prefix), or the</div><div class="line">     *   empty string if qualified names are not available.</div><div class="line">     * <span class="doctag">@exception</span> SAXException if a parsing error is to be reported</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endElement</span><span class="params">(String namespaceURI, String localName, String qName)</span></span></div><div class="line">            <span class="keyword">throws</span> SAXException &#123;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> debug = log.isDebugEnabled();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (debug) &#123;</div><div class="line">            <span class="keyword">if</span> (saxLog.isDebugEnabled()) &#123;</div><div class="line">                saxLog.debug(<span class="string">"endElement("</span> + namespaceURI + <span class="string">","</span> + localName + <span class="string">","</span> + qName + <span class="string">")"</span>);</div><div class="line">            &#125;</div><div class="line">            log.debug(<span class="string">"  match='"</span> + match + <span class="string">"'"</span>);</div><div class="line">            log.debug(<span class="string">"  bodyText='"</span> + bodyText + <span class="string">"'"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Parse system properties</span></div><div class="line">        bodyText = updateBodyText(bodyText);</div><div class="line"></div><div class="line">        <span class="comment">// the actual element name is either in localName or qName, depending</span></div><div class="line">        <span class="comment">// on whether the parser is namespace aware</span></div><div class="line">        String name = localName;</div><div class="line">        <span class="keyword">if</span> ((name == <span class="keyword">null</span>) || (name.length() &lt; <span class="number">1</span>)) &#123;</div><div class="line">            name = qName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Fire "body" events for all relevant rules</span></div><div class="line">        List&lt;Rule&gt; rules = matches.pop();</div><div class="line">        <span class="keyword">if</span> ((rules != <span class="keyword">null</span>) &amp;&amp; (rules.size() &gt; <span class="number">0</span>)) &#123;</div><div class="line">            String bodyText = <span class="keyword">this</span>.bodyText.toString();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Rule rule = rules.get(i);</div><div class="line">                    <span class="keyword">if</span> (debug) &#123;</div><div class="line">                        log.debug(<span class="string">"  Fire body() for "</span> + rule);</div><div class="line">                    &#125;</div><div class="line">                    rule.body(namespaceURI, name, bodyText);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    log.error(<span class="string">"Body event threw exception"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> createSAXException(e);</div><div class="line">                &#125; <span class="keyword">catch</span> (Error e) &#123;</div><div class="line">                    log.error(<span class="string">"Body event threw error"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (debug) &#123;</div><div class="line">                log.debug(<span class="string">"  No rules found matching '"</span> + match + <span class="string">"'."</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (rulesValidation) &#123;</div><div class="line">                log.warn(<span class="string">"  No rules found matching '"</span> + match + <span class="string">"'."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Recover the body text from the surrounding element</span></div><div class="line">        bodyText = bodyTexts.pop();</div><div class="line"></div><div class="line">        <span class="comment">// Fire "end" events for all relevant rules in reverse order</span></div><div class="line">        <span class="keyword">if</span> (rules != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">                <span class="keyword">int</span> j = (rules.size() - i) - <span class="number">1</span>;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Rule rule = rules.get(j);</div><div class="line">                    <span class="keyword">if</span> (debug) &#123;</div><div class="line">                        log.debug(<span class="string">"  Fire end() for "</span> + rule);</div><div class="line">                    &#125;</div><div class="line">                    rule.end(namespaceURI, name);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    log.error(<span class="string">"End event threw exception"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> createSAXException(e);</div><div class="line">                &#125; <span class="keyword">catch</span> (Error e) &#123;</div><div class="line">                    log.error(<span class="string">"End event threw error"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Recover the previous match expression</span></div><div class="line">        <span class="keyword">int</span> slash = match.lastIndexOf(<span class="string">'/'</span>);</div><div class="line">        <span class="keyword">if</span> (slash &gt;= <span class="number">0</span>) &#123;</div><div class="line">            match = match.substring(<span class="number">0</span>, slash);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            match = <span class="string">""</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>代码清单1中创建完Digester后，会调用addObjectCreate、addSetProperties、addSetNext方法陆续添加很多Rule，这些方法的实现如代码清单3：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObjectCreate</span><span class="params">(String pattern, String className,  </span></span></div><div class="line">                            String attributeName) &#123;  </div><div class="line">    addRule(pattern,  </div><div class="line">            <span class="keyword">new</span> ObjectCreateRule(className, attributeName));  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSetProperties</span><span class="params">(String pattern)</span> </span>&#123;  </div><div class="line">    addRule(pattern,  </div><div class="line">            <span class="keyword">new</span> SetPropertiesRule());  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSetNext</span><span class="params">(String pattern, String methodName,  </span></span></div><div class="line">                       String paramType) &#123;  </div><div class="line">    addRule(pattern,  </div><div class="line">            <span class="keyword">new</span> SetNextRule(methodName, paramType));  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上述代码我们看到这三个方法分别创建ObjectCreateRule、SetPropertiesRule及SetNextRule。为了简化理解我们以Server相关的Rule为例，在createStartDigester中，如代码清单4：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">digester.addObjectCreate(<span class="string">"Server"</span>,  </div><div class="line">                         <span class="string">"org.apache.catalina.core.StandardServer"</span>,  </div><div class="line">                         <span class="string">"className"</span>);  </div><div class="line">digester.addSetProperties(<span class="string">"Server"</span>);  </div><div class="line">digester.addSetNext(<span class="string">"Server"</span>,  </div><div class="line">                    <span class="string">"setServer"</span>,  </div><div class="line">                    <span class="string">"org.apache.catalina.Server"</span>);</div></pre></td></tr></table></figure>
<p>根据代码清单3的实现，我们知道最终会创建ObjectCreateRule、SetPropertiesRule及SetNextRule，并且调用addRule方法。addRule方法首先调用getRules方法获取RulesBase，然后调用RulesBase的add方法。addRule方法的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRule</span><span class="params">(String pattern, Rule rule)</span> </span>&#123;  </div><div class="line">  </div><div class="line">    rule.setDigester(<span class="keyword">this</span>);  </div><div class="line">    getRules().add(pattern, rule);  </div><div class="line">  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">public</span> Rules <span class="title">getRules</span><span class="params">()</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.rules == <span class="keyword">null</span>) &#123;  </div><div class="line">        <span class="keyword">this</span>.rules = <span class="keyword">new</span> RulesBase();  </div><div class="line">        <span class="keyword">this</span>.rules.setDigester(<span class="keyword">this</span>);  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.rules);  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>RulesBase的add方法的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Register a new Rule instance matching the specified pattern.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> pattern Nesting pattern to be matched for this Rule</div><div class="line">     * <span class="doctag">@param</span> rule Rule instance to be registered</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String pattern, Rule rule)</span> </span>&#123;</div><div class="line">        <span class="comment">// to help users who accidently add '/' to the end of their patterns</span></div><div class="line">        <span class="keyword">int</span> patternLength = pattern.length();</div><div class="line">        <span class="keyword">if</span> (patternLength&gt;<span class="number">1</span> &amp;&amp; pattern.endsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">            pattern = pattern.substring(<span class="number">0</span>, patternLength-<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        List&lt;Rule&gt; list = cache.get(pattern);</div><div class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</div><div class="line">            list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            cache.put(pattern, list);</div><div class="line">        &#125;</div><div class="line">        list.add(rule);</div><div class="line">        rules.add(rule);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.digester != <span class="keyword">null</span>) &#123;</div><div class="line">            rule.setDigester(<span class="keyword">this</span>.digester);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.namespaceURI != <span class="keyword">null</span>) &#123;</div><div class="line">            rule.setNamespaceURI(<span class="keyword">this</span>.namespaceURI);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>其中，cache的数据结构为HashMap<string,list<rule>&gt;，每个键值维护一个List<rule>，由此可知，对Server标签来说，对应的Rule列表为ObjectCreateRule、SetPropertiesRule及SetNextRule。</rule></string,list<rule></p>
<p>Digester解析XML的入口是其parse方法，其处理步骤如下：</p>
<ol>
<li>创建XMLReader ；</li>
<li>使用XMLReader解析XML。</li>
</ol>
<p>parse方法的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parse</span><span class="params">(InputSource input)</span> <span class="keyword">throws</span> IOException, SAXException </span>&#123;  </div><div class="line">  </div><div class="line">    configure();  </div><div class="line">    getXMLReader().parse(input);  </div><div class="line">    <span class="keyword">return</span> (root);  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getXMLReader方法调用getParser创建SAXParser ，然后调用SAXParser 的getXMLReader方法创建XMLReader ，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Return the XMLReader to be used for parsing the input document.</div><div class="line">     *</div><div class="line">     * FIX ME: there is a bug in JAXP/XERCES that prevent the use of a</div><div class="line">     * parser that contains a schema with a DTD.</div><div class="line">     * <span class="doctag">@exception</span> SAXException if no XMLReader can be instantiated</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> XMLReader <span class="title">getXMLReader</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (reader == <span class="keyword">null</span>) &#123;</div><div class="line">            reader = getParser().getXMLReader();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        reader.setDTDHandler(<span class="keyword">this</span>);</div><div class="line">        reader.setContentHandler(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (entityResolver == <span class="keyword">null</span>) &#123;</div><div class="line">            reader.setEntityResolver(<span class="keyword">this</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            reader.setEntityResolver(entityResolver);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        reader.setProperty(<span class="string">"http://xml.org/sax/properties/lexical-handler"</span>, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">        reader.setErrorHandler(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">return</span> reader;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>getParser方法调用getFactory方法创建SAXParserFactory，然后调用SAXParserFactory的newSAXParser方法创建SAXParser ，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> SAXParser <span class="title">getParser</span><span class="params">()</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="comment">// Return the parser we already created (if any)  </span></div><div class="line">    <span class="keyword">if</span> (parser != <span class="keyword">null</span>) &#123;  </div><div class="line">        <span class="keyword">return</span> (parser);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">// Create a new parser  </span></div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        parser = getFactory().newSAXParser();  </div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </div><div class="line">        log.error(<span class="string">"Digester.getParser: "</span>, e);  </div><div class="line">        <span class="keyword">return</span> (<span class="keyword">null</span>);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">return</span> (parser);  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getFactory方法使用SAX的API生成SAXParserFactory实例，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Return the SAXParserFactory we will use, creating one if necessary.</div><div class="line">     * <span class="doctag">@throws</span> ParserConfigurationException</div><div class="line">     * <span class="doctag">@throws</span> SAXNotSupportedException</div><div class="line">     * <span class="doctag">@throws</span> SAXNotRecognizedException</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> SAXParserFactory <span class="title">getFactory</span><span class="params">()</span> <span class="keyword">throws</span> SAXNotRecognizedException, SAXNotSupportedException,</span></div><div class="line">            ParserConfigurationException &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</div><div class="line">            factory = SAXParserFactory.newInstance();</div><div class="line"></div><div class="line">            factory.setNamespaceAware(namespaceAware);</div><div class="line">            <span class="comment">// Preserve xmlns attributes</span></div><div class="line">            <span class="keyword">if</span> (namespaceAware) &#123;</div><div class="line">                factory.setFeature(<span class="string">"http://xml.org/sax/features/namespace-prefixes"</span>, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            factory.setValidating(validating);</div><div class="line">            <span class="keyword">if</span> (validating) &#123;</div><div class="line">                <span class="comment">// Enable DTD validation</span></div><div class="line">                factory.setFeature(<span class="string">"http://xml.org/sax/features/validation"</span>, <span class="keyword">true</span>);</div><div class="line">                <span class="comment">// Enable schema validation</span></div><div class="line">                factory.setFeature(<span class="string">"http://apache.org/xml/features/validation/schema"</span>, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (factory);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>XMLReader解析XML时，会生成事件，回调Digester的startDocument方法，解析的第一个元素是Server，此时回调Digester的startElement方法，入参Attributes list即Server上的属性，如port、shutdown等，入参qName即为Server。startElement方法的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Process notification of the start of an XML element being reached.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> namespaceURI The Namespace URI, or the empty string if the element</div><div class="line">     *   has no Namespace URI or if Namespace processing is not being performed.</div><div class="line">     * <span class="doctag">@param</span> localName The local name (without prefix), or the empty</div><div class="line">     *   string if Namespace processing is not being performed.</div><div class="line">     * <span class="doctag">@param</span> qName The qualified name (with prefix), or the empty</div><div class="line">     *   string if qualified names are not available.\</div><div class="line">     * <span class="doctag">@param</span> list The attributes attached to the element. If there are</div><div class="line">     *   no attributes, it shall be an empty Attributes object.</div><div class="line">     * <span class="doctag">@exception</span> SAXException if a parsing error is to be reported</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String namespaceURI, String localName, String qName, Attributes list)</span></span></div><div class="line">            <span class="keyword">throws</span> SAXException &#123;</div><div class="line">        <span class="keyword">boolean</span> debug = log.isDebugEnabled();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (saxLog.isDebugEnabled()) &#123;</div><div class="line">            saxLog.debug(<span class="string">"startElement("</span> + namespaceURI + <span class="string">","</span> + localName + <span class="string">","</span> + qName + <span class="string">")"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Parse system properties</span></div><div class="line">        list = updateAttributes(list);</div><div class="line"></div><div class="line">        <span class="comment">// Save the body text accumulated for our surrounding element</span></div><div class="line">        bodyTexts.push(bodyText);</div><div class="line">        bodyText = <span class="keyword">new</span> StringBuilder();</div><div class="line"></div><div class="line">        <span class="comment">// the actual element name is either in localName or qName, depending</span></div><div class="line">        <span class="comment">// on whether the parser is namespace aware</span></div><div class="line">        String name = localName;</div><div class="line">        <span class="keyword">if</span> ((name == <span class="keyword">null</span>) || (name.length() &lt; <span class="number">1</span>)) &#123;</div><div class="line">            name = qName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Compute the current matching rule</span></div><div class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder(match);</div><div class="line">        <span class="keyword">if</span> (match.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">            sb.append(<span class="string">'/'</span>);</div><div class="line">        &#125;</div><div class="line">        sb.append(name);</div><div class="line">        match = sb.toString();</div><div class="line">        <span class="keyword">if</span> (debug) &#123;</div><div class="line">            log.debug(<span class="string">"  New match='"</span> + match + <span class="string">"'"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Fire "begin" events for all relevant rules</span></div><div class="line">        List&lt;Rule&gt; rules = getRules().match(namespaceURI, match);</div><div class="line">        matches.push(rules);</div><div class="line">        <span class="keyword">if</span> ((rules != <span class="keyword">null</span>) &amp;&amp; (rules.size() &gt; <span class="number">0</span>)) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Rule rule = rules.get(i);</div><div class="line">                    <span class="keyword">if</span> (debug) &#123;</div><div class="line">                        log.debug(<span class="string">"  Fire begin() for "</span> + rule);</div><div class="line">                    &#125;</div><div class="line">                    rule.begin(namespaceURI, name, list);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    log.error(<span class="string">"Begin event threw exception"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> createSAXException(e);</div><div class="line">                &#125; <span class="keyword">catch</span> (Error e) &#123;</div><div class="line">                    log.error(<span class="string">"Begin event threw error"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (debug) &#123;</div><div class="line">                log.debug(<span class="string">"  No rules found matching '"</span> + match + <span class="string">"'."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>startElement方法的处理步骤如下：</p>
<ol>
<li>match刚开始为空字符串，拼接Server后变为Server。</li>
<li>调用RulesBase的match方法，返回cache中按照键值Server匹配的ObjectCreateRule、SetPropertiesRule及SetNextRule。</li>
<li>循环列表依次遍历ObjectCreateRule、SetPropertiesRule及SetNextRule，并调用它们的begin方法。</li>
</ol>
<p>ObjectCreateRule的begin方法将生成Server的实例（默认为”org.apache.catalina.core.StandardServer”，用户可以通过给Server标签指定className使用其它Server实现），最后将Server的实例压入Digester的栈中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Process the beginning of this element.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> namespace the namespace URI of the matching element, or an</div><div class="line">     *   empty string if the parser is not namespace aware or the element has</div><div class="line">     *   no namespace</div><div class="line">     * <span class="doctag">@param</span> name the local name if the parser is namespace aware, or just</div><div class="line">     *   the element name otherwise</div><div class="line">     * <span class="doctag">@param</span> attributes The attribute list for this element</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String name, Attributes attributes)</span></span></div><div class="line">            <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Identify the name of the class to instantiate</span></div><div class="line">        String realClassName = className;</div><div class="line">        <span class="keyword">if</span> (attributeName != <span class="keyword">null</span>) &#123;</div><div class="line">            String value = attributes.getValue(attributeName);</div><div class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</div><div class="line">                realClassName = value;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</div><div class="line">            digester.log.debug(<span class="string">"[ObjectCreateRule]&#123;"</span> + digester.match +</div><div class="line">                    <span class="string">"&#125;New "</span> + realClassName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (realClassName == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"No class name specified for "</span> +</div><div class="line">                    namespace + <span class="string">" "</span> + name);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Instantiate the new object and push it on the context stack</span></div><div class="line">        Class&lt;?&gt; clazz = digester.getClassLoader().loadClass(realClassName);</div><div class="line">        Object instance = clazz.newInstance();</div><div class="line">        digester.push(instance);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>SetPropertiesRule的begin方法首先将刚才压入栈中的Server实例出栈，然后给Server实例设置各个属性值，如port、shutdown等，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Process the beginning of this element.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> namespace the namespace URI of the matching element, or an</div><div class="line">     *   empty string if the parser is not namespace aware or the element has</div><div class="line">     *   no namespace</div><div class="line">     * <span class="doctag">@param</span> theName the local name if the parser is namespace aware, or just</div><div class="line">     *   the element name otherwise</div><div class="line">     * <span class="doctag">@param</span> attributes The attribute list for this element</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String theName, Attributes attributes)</span></span></div><div class="line">            <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Populate the corresponding properties of the top object</span></div><div class="line">        Object top = digester.peek();</div><div class="line">        <span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</div><div class="line">            <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">                digester.log.debug(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</div><div class="line">                                   <span class="string">"&#125; Set "</span> + top.getClass().getName() +</div><div class="line">                                   <span class="string">" properties"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                digester.log.debug(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</div><div class="line">                                   <span class="string">"&#125; Set NULL properties"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</div><div class="line">            String name = attributes.getLocalName(i);</div><div class="line">            <span class="keyword">if</span> (<span class="string">""</span>.equals(name)) &#123;</div><div class="line">                name = attributes.getQName(i);</div><div class="line">            &#125;</div><div class="line">            String value = attributes.getValue(i);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</div><div class="line">                digester.log.debug(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</div><div class="line">                        <span class="string">"&#125; Setting property '"</span> + name + <span class="string">"' to '"</span> +</div><div class="line">                        value + <span class="string">"'"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!digester.isFakeAttribute(top, name)</div><div class="line">                    &amp;&amp; !IntrospectionUtils.setProperty(top, name, value)</div><div class="line">                    &amp;&amp; digester.getRulesValidation()) &#123;</div><div class="line">                digester.log.warn(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</div><div class="line">                        <span class="string">"&#125; Setting property '"</span> + name + <span class="string">"' to '"</span> +</div><div class="line">                        value + <span class="string">"' did not find a matching property."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>SetNextRule的begin不做什么动作。当遇到Server的结束标签时，还会依次调用ObjectCreateRule、SetPropertiesRule及SetNextRule的end方法，不再赘述。所有元素的解析都与Server标签同理，最终将server.xml文件中设置的元素及其属性值，构造出Tomcat中的容器，如：Server、Service、Connector等。</p>
<p>致此，web.xml解析分析完毕。</p>
<h3 id="第三章-生命周期管理"><a href="#第三章-生命周期管理" class="headerlink" title="第三章 生命周期管理"></a>第三章 生命周期管理</h3><p>从server.xml文件解析出来的各个对象都是容器，比如：Server、Service、Connector等。这些容器都具有新建、初始化完成、启动、停止、失败、销毁等状态。Tomcat的实现提供了对这些容器的生命周期管理，本章将通过对Tomcat7.0的源码阅读，深入剖析这一过程。</p>
<h4 id="1-Tomcat生命周期类接口设计"><a href="#1-Tomcat生命周期类接口设计" class="headerlink" title="1.Tomcat生命周期类接口设计"></a>1.Tomcat生命周期类接口设计</h4><p>我们先阅读图（tomact7），从中了解Tomcat涉及生命周期管理的主要类。</p>
<p><img src="http://i.imgur.com/xmgOHR4.jpg" alt=""></p>
<p>针对图中主要类进行简单介绍：</p>
<ul>
<li>Lifecycle：定义了容器生命周期、容器状态转换及容器状态迁移事件的监听器注册和移除等主要接口；</li>
<li>LifecycleBase：作为Lifecycle接口的抽象实现类，运用抽象模板模式将所有容器的生命周期及状态转换衔接起来，此外还提供了生成LifecycleEvent事件的接口；</li>
<li>LifecycleSupport：提供有关LifecycleEvent事件的监听器注册、移除，并且使用经典的监听器模式，实现事件生成后触达监听器的实现；</li>
<li>MBeanRegistration：Java JMX框架提供的注册MBean的接口，引入此接口是为了便于使用JMX提供的管理功能；</li>
<li>LifecycleMBeanBase：Tomcat提供的对MBeanRegistration的抽象实现类，运用抽象模板模式将所有容器统一注册到JMX；</li>
</ul>
<p>lifecycle继承关系：<br><img src="http://i.imgur.com/PZsO3lD.png" alt=""></p>
<h4 id="2-JMX"><a href="#2-JMX" class="headerlink" title="2.JMX"></a>2.JMX</h4><p>简单介绍一下（细节请参考其他文献）。</p>
<p>java管理程序扩展（java management extensions，简称JMX），是一个可以为Java应用程序或系统植入远程管理功能的框架。JMX的架构，如图所示。</p>
<p><img src="http://i.imgur.com/J6nqmXU.jpg" alt=""></p>
<p>这里对三个分层进行介绍：</p>
<ul>
<li>Probe Level：负责资源的检测（获取信息），包含MBeans，通常也叫做Instrumentation Level。MX管理构件（MBean）分为四种形式，分别是标准管理构件（Standard MBean）、动态管理构件（Dynamic MBean）、开放管理构件(Open Mbean)和模型管理构件(Model MBean)。</li>
<li>Agent Level：即MBeanServer，是JMX的核心，负责连接Mbeans和应用程序。 </li>
<li>Remote Management Level：通过connectors和adaptors来远程操作MBeanServer，常用的控制台，例如JConsole、VisualVM等。</li>
</ul>
<h4 id="3-容器"><a href="#3-容器" class="headerlink" title="3.容器"></a>3.容器</h4><p>容器即servlet容器，容器有很多层，分别是Engine，Host，Context，Wrapper。最大的容器Engine，代表一个servlet 引擎，接下来是Host，代表一个虚拟机，然后是Context，代表一个应用，Wrapper对应一个servlet。从连接器传过来连接后，容器便会顺序经过上面的容器，最后到达特定的servlet。</p>
<p><img src="http://i.imgur.com/irZpmOV.png" alt=""></p>
<p>一个server可以有多个service，一个service包含多个连接器和一个容器，一个Engine可以由多个虚拟主机Host组成，每一个Host下面又可以由多个Web应用Context构成，每一个的Context下面可以包含多个Wrapper（Servlet的包装器）组成。如图所示</p>
<p><img src="http://i.imgur.com/TnOdb8R.png" alt=""></p>
<p>Tomcat将Engine，Host，Context，Wrapper统一抽象成Container。一个抽象的Container模块可以包含各种服务。例如，Manager管理器（Session管理），Pipeline管道（ 维护管道阀门Value ）等。Lifecycle接口统一定义了容器的生命周期，通过事件机制实现各个容器间的内部通讯。</p>
<p>而容器的核心接口Container的抽象实现中定义了一个Pipeline，一个Manager，一个Realm以及ClassLoader统一了具体容器的实现规范。</p>
<p><strong>容器的状态</strong>：</p>
<p>目前，Tomcat的容器具有以下状态：</p>
<ul>
<li>NEW：容器刚刚创建时，即在LifecycleBase实例构造完成时的状态。</li>
<li>INITIALIZED：容器初始化完成时的状态。</li>
<li>STARTING_PREP：容器启动前的状态。</li>
<li>STARTING：容器启动过程中的状态。</li>
<li>STARTED：容器启动完成的状态。</li>
<li>STOPPING_PREP：容器停止前的状态。</li>
<li>STOPPING：容器停止过程中的状态。</li>
<li>STOPPED：容器停止完成的状态。</li>
<li>DESTROYED：容器销毁后的状态。</li>
<li>FAILED：容器启动、停止过程中出现异常的状态。</li>
<li>MUST_STOP：此状态未使用。</li>
<li>MUST_DESTROY：此状态未使用。</li>
<li>这些状态都定义在枚举类LifecycleState中。代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LifecycleState &#123;</div><div class="line">    NEW(<span class="keyword">false</span>, <span class="keyword">null</span>),</div><div class="line">    INITIALIZING(<span class="keyword">false</span>, Lifecycle.BEFORE_INIT_EVENT),</div><div class="line">    INITIALIZED(<span class="keyword">false</span>, Lifecycle.AFTER_INIT_EVENT),</div><div class="line">    STARTING_PREP(<span class="keyword">false</span>, Lifecycle.BEFORE_START_EVENT),</div><div class="line">    STARTING(<span class="keyword">true</span>, Lifecycle.START_EVENT),</div><div class="line">    STARTED(<span class="keyword">true</span>, Lifecycle.AFTER_START_EVENT),</div><div class="line">    STOPPING_PREP(<span class="keyword">true</span>, Lifecycle.BEFORE_STOP_EVENT),</div><div class="line">    STOPPING(<span class="keyword">false</span>, Lifecycle.STOP_EVENT),</div><div class="line">    STOPPED(<span class="keyword">false</span>, Lifecycle.AFTER_STOP_EVENT),</div><div class="line">    DESTROYING(<span class="keyword">false</span>, Lifecycle.BEFORE_DESTROY_EVENT),</div><div class="line">    DESTROYED(<span class="keyword">false</span>, Lifecycle.AFTER_DESTROY_EVENT),</div><div class="line">    FAILED(<span class="keyword">false</span>, <span class="keyword">null</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@deprecated</span> Unused. Will be removed in Tomcat 8.5.x. The state transition</div><div class="line">     *             checking in &#123;<span class="doctag">@link</span> org.apache.catalina.util.LifecycleBase&#125;</div><div class="line">     *             makes it impossible to use this state. The intended behaviour</div><div class="line">     *             can be obtained by setting the state to</div><div class="line">     *             &#123;<span class="doctag">@link</span> LifecycleState#FAILED&#125; in</div><div class="line">     *             &lt;code&gt;LifecycleBase.startInternal()&lt;/code&gt;</div><div class="line">     */</div><div class="line">    <span class="meta">@Deprecated</span></div><div class="line">    MUST_STOP(<span class="keyword">true</span>, <span class="keyword">null</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@deprecated</span> Unused. Will be removed in Tomcat 8.5.x. The state transition</div><div class="line">     *             checking in &#123;<span class="doctag">@link</span> org.apache.catalina.util.LifecycleBase&#125;</div><div class="line">     *             makes it impossible to use this state. The intended behaviour</div><div class="line">     *             can be obtained by implementing &#123;<span class="doctag">@link</span> Lifecycle.SingleUse&#125;.</div><div class="line">     */</div><div class="line">    <span class="meta">@Deprecated</span></div><div class="line">    MUST_DESTROY(<span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> available;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String lifecycleEvent;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LifecycleState</span><span class="params">(<span class="keyword">boolean</span> available, String lifecycleEvent)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.available = available;</div><div class="line">        <span class="keyword">this</span>.lifecycleEvent = lifecycleEvent;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * May the public methods other than property getters/setters and lifecycle</div><div class="line">     * methods be called for a component in this state? It returns</div><div class="line">     * &lt;code&gt;true&lt;/code&gt; for any component in any of the following states:</div><div class="line">     * &lt;ul&gt;</div><div class="line">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #STARTING&#125;&lt;/li&gt;</div><div class="line">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #STARTED&#125;&lt;/li&gt;</div><div class="line">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #STOPPING_PREP&#125;&lt;/li&gt;</div><div class="line">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #MUST_STOP&#125;&lt;/li&gt;</div><div class="line">     * &lt;/ul&gt;</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> available;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     *</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLifecycleEvent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> lifecycleEvent;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-事件与监听"><a href="#4-事件与监听" class="headerlink" title="4.事件与监听"></a>4.事件与监听</h4><p>lifecycle接口结构如下：<br><img src="http://i.imgur.com/J8zYMFU.png" alt=""></p>
<p>LifecycleBase实现lifecycle接口.结构如下：<br><img src="http://i.imgur.com/fpzneEf.png" alt=""></p>
<p>lifecycleListener继承关系示意图：<br><img src="http://i.imgur.com/1IqmqEH.png" alt=""></p>
<p>每个容器由于继承自LifecycleBase，当容器状态发生变化时，都会调用fireLifecycleEvent方法，生成LifecycleEvent，并且交由此容器的事件监听器处理。LifecycleBase的fireLifecycleEvent方法的实现见代码清单1。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Used to handle firing lifecycle events. </div><div class="line"> * <span class="doctag">TODO:</span> Consider merging LifecycleSupport into this class. </div><div class="line"> */  </div><div class="line"><span class="keyword">private</span> LifecycleSupport lifecycle = <span class="keyword">new</span> LifecycleSupport(<span class="keyword">this</span>);  </div><div class="line"></div><div class="line"><span class="comment">//中间代码略</span></div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Allow sub classes to fire &#123;<span class="doctag">@link</span> Lifecycle&#125; events.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> type  Event type</div><div class="line">    * <span class="doctag">@param</span> data  Data associated with event.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</div><div class="line">       lifecycle.fireLifecycleEvent(type, data);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>LifecycleSupport的fireLifecycleEvent方法的实现，见代码清单2。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Notify all lifecycle event listeners that a particular event has</div><div class="line"> * occurred for this Container.  The default implementation performs</div><div class="line"> * this notification synchronously using the calling thread.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> type Event type</div><div class="line"> * <span class="doctag">@param</span> data Event data</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</div><div class="line">    LifecycleEvent event = <span class="keyword">new</span> LifecycleEvent(lifecycle, type, data);</div><div class="line">    <span class="keyword">for</span> (LifecycleListener listener : listeners) &#123;</div><div class="line">        listener.lifecycleEvent(event);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将事件通知给所有监听当前容器的生命周期监听器LifecycleListener，并调用LifecycleListener的lifecycleEvent方法。每个容器都维护这一个监听器缓存，其实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The list of registered LifecycleListeners for event notifications.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;LifecycleListener&gt; listeners = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div></pre></td></tr></table></figure>
<p>那么listeners中的监听器是何时添加进来的呢？每个容器在新建、初始化、启动，销毁，被添加到父容器的过程中都会调用父类LifecycleBase的addLifecycleListener方法，addLifecycleListener的实现见代码清单3。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line">    lifecycle.addLifecycleListener(listener);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LifecycleSupport的addLifecycleListener方法的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Add a lifecycle event listener to this component.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> listener The listener to add</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line">    listeners.add(listener);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在fireLifecycleEvent中，我们讲过容器会最终调用每个对此容器感兴趣的LifecycleListener的lifecycleEvent方法，那么LifecycleListener的lifecycleEvent方法会做些什么呢？为了简单起见，我们以监听器AprLifecycleListener为例AprLifecycleListener的lifecycleEvent方法的实现，间见如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Primary entry point for startup and shutdown events.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> event The event that has occurred</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (Lifecycle.BEFORE_INIT_EVENT.equals(event.getType())) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">                init();</div><div class="line">                <span class="keyword">for</span> (String msg : initInfoLogMessages) &#123;</div><div class="line">                    log.info(msg);</div><div class="line">                &#125;</div><div class="line">                initInfoLogMessages.clear();</div><div class="line">                <span class="keyword">if</span> (aprAvailable) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        initializeSSL();</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                        t = ExceptionUtils.unwrapInvocationTargetException(t);</div><div class="line">                        ExceptionUtils.handleThrowable(t);</div><div class="line">                        log.error(sm.getString(<span class="string">"aprListener.sslInit"</span>), t);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Failure to initialize FIPS mode is fatal</span></div><div class="line">                <span class="keyword">if</span> (!(<span class="keyword">null</span> == FIPSMode || <span class="string">"off"</span>.equalsIgnoreCase(FIPSMode)) &amp;&amp; !isFIPSModeActive()) &#123;</div><div class="line">                    Error e = <span class="keyword">new</span> Error(</div><div class="line">                            sm.getString(<span class="string">"aprListener.initializeFIPSFailed"</span>));</div><div class="line">                    <span class="comment">// Log here, because thrown error might be not logged</span></div><div class="line">                    log.fatal(e.getMessage(), e);</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Lifecycle.AFTER_DESTROY_EVENT.equals(event.getType())) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">                <span class="keyword">if</span> (!aprAvailable) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    terminateAPR();</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    t = ExceptionUtils.unwrapInvocationTargetException(t);</div><div class="line">                    ExceptionUtils.handleThrowable(t);</div><div class="line">                    log.info(sm.getString(<span class="string">"aprListener.aprDestroy"</span>));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="5-容器生命周期"><a href="#5-容器生命周期" class="headerlink" title="5.容器生命周期"></a>5.容器生命周期</h4><p>每个容器都会有自身的生命周期，其中也涉及状态的迁移，以及伴随的事件生成，本节详细介绍Tomcat中的容器生命周期实现。所有容器的转态转换（如新疆、初始化、启动、停止等）都是由外到内，由上到下进行，即先执行父容器的状态转换及相关操作，然后再执行子容器的转态转换，这个过程是层层迭代执行的。</p>
<h5 id="容器初始化"><a href="#容器初始化" class="headerlink" title="容器初始化"></a><strong>容器初始化</strong></h5><p>每个容器的init方法是自身初始化的入口，其初始化过程如图所示。</p>
<p><img src="http://i.imgur.com/ZU9Cikh.jpg" alt=""></p>
<p>根据图所示的初始化过程，我们对Tomcat的源码进行分析，其处理步骤如下：</p>
<ol>
<li>调用方调用容器父类LifecycleBase的init方法，LifecycleBase的init方法主要完成一些所有容器公共抽象出来的动作；</li>
<li>LifecycleBase的init方法调用具体容器的initInternal方法实现，此initInternal方法用于对容器本身真正的初始化；</li>
<li>具体容器的initInternal方法调用父类LifecycleMBeanBase的initInternal方法实现，此initInternal方法用于将容器托管到JMX，便于运维管理；</li>
<li>LifecycleMBeanBase的initInternal方法调用自身的register方法，将容器作为MBean注册到MBeanServer；</li>
<li>容器如果有子容器，会调用子容器的init方法；</li>
<li>容器初始化完毕，LifecycleBase会将容器的状态更改为初始化完毕，即LifecycleState.INITIALIZED。</li>
</ol>
<p>init()方法实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!state.equals(LifecycleState.NEW)) &#123;</div><div class="line">            invalidTransition(Lifecycle.BEFORE_INIT_EVENT);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            setStateInternal(LifecycleState.INITIALIZING, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            initInternal();</div><div class="line">            setStateInternal(LifecycleState.INITIALIZED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(t);</div><div class="line">            setStateInternal(LifecycleState.FAILED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</div><div class="line">                    sm.getString(<span class="string">"lifecycleBase.initFail"</span>,toString()), t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>上述代码说明，只有当前容器的状态处于LifecycleState.NEW的才可以被初始化，真正执行初始化的方法是initInternal，当初始化完毕，当前容器的状态会被更改为LifecycleState.INITIALIZED。为了简便起见，我们还是以StandardServer这个容器为例，StandardServer的initInternal方法的实现见代码清单7。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Invoke a pre-startup initialization. This is used to allow connectors</div><div class="line">     * to bind to restricted ports under Unix operating environments.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.initInternal();</div><div class="line"></div><div class="line">        <span class="comment">// Register global String cache</span></div><div class="line">        <span class="comment">// Note although the cache is global, if there are multiple Servers</span></div><div class="line">        <span class="comment">// present in the JVM (may happen when embedding) then the same cache</span></div><div class="line">        <span class="comment">// will be registered under multiple names</span></div><div class="line">        onameStringCache = register(<span class="keyword">new</span> StringCache(), <span class="string">"type=StringCache"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Register the MBeanFactory</span></div><div class="line">        MBeanFactory factory = <span class="keyword">new</span> MBeanFactory();</div><div class="line">        factory.setContainer(<span class="keyword">this</span>);</div><div class="line">        onameMBeanFactory = register(factory, <span class="string">"type=MBeanFactory"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Register the naming resources</span></div><div class="line">        globalNamingResources.init();</div><div class="line"></div><div class="line">        <span class="comment">// Populate the extension validator with JARs from common and shared</span></div><div class="line">        <span class="comment">// class loaders</span></div><div class="line">        <span class="keyword">if</span> (getCatalina() != <span class="keyword">null</span>) &#123;</div><div class="line">            ClassLoader cl = getCatalinal().getParentClassLoader();</div><div class="line">            <span class="comment">// Walk the class loader hierarchy. Stop at the system class loader.</span></div><div class="line">            <span class="comment">// This will add the shared (if present) and common class loaders</span></div><div class="line">            <span class="keyword">while</span> (cl != <span class="keyword">null</span> &amp;&amp; cl != ClassLoader.getSystemClassLoader()) &#123;</div><div class="line">                <span class="keyword">if</span> (cl <span class="keyword">instanceof</span> URLClassLoader) &#123;</div><div class="line">                    URL[] urls = ((URLClassLoader) cl).getURLs();</div><div class="line">                    <span class="keyword">for</span> (URL url : urls) &#123;</div><div class="line">                        <span class="keyword">if</span> (url.getProtocol().equals(<span class="string">"file"</span>)) &#123;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                File f = <span class="keyword">new</span> File (url.toURI());</div><div class="line">                                <span class="keyword">if</span> (f.isFile() &amp;&amp;</div><div class="line">                                        f.getName().endsWith(<span class="string">".jar"</span>)) &#123;</div><div class="line">                                    ExtensionValidator.addSystemResource(f);</div><div class="line">                                &#125;</div><div class="line">                            &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</div><div class="line">                                <span class="comment">// Ignore</span></div><div class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                                <span class="comment">// Ignore</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                cl = cl.getParent();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Initialize our defined Services</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">            services[i].init();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>通过分析StandardServer的initInternal方法，其处理过程如下：</p>
<ol>
<li><p>将当前容器注册到JMX<br>调用父类LifecycleBase的initInternal方法（见代码清单8），为当前容器创建DynamicMBean，并注册到JMX中。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;  </div><div class="line">      </div><div class="line">    <span class="comment">// If oname is not null then registration has already happened via jiaan  </span></div><div class="line">    <span class="comment">// preRegister().  </span></div><div class="line">    <span class="keyword">if</span> (oname == <span class="keyword">null</span>) &#123;  </div><div class="line">        mserver = Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).getMBeanServer();  </div><div class="line">          </div><div class="line">        oname = register(<span class="keyword">this</span>, getObjectNameKeyProperties());  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> String <span class="title">getObjectNameKeyProperties</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">return</span> <span class="string">"type=Server"</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>LifecycleBase的register方法会为当前容器创建对应的注册名称，以StandardServer为例，getDomain默认返回Catalina，因此StandardServer的JMX注册名称默认为Catalina:type=Server，真正的注册在registerComponent方法中实现。

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> ObjectName <span class="title">register</span><span class="params">(Object obj,  </span></span></div><div class="line">        String objectNameKeyProperties) &#123;  </div><div class="line">      </div><div class="line">    <span class="comment">// Construct an object name with the right domain  </span></div><div class="line">    StringBuilder name = <span class="keyword">new</span> StringBuilder(getDomain());  </div><div class="line">    name.append(<span class="string">':'</span>);  </div><div class="line">    name.append(objectNameKeyProperties);  </div><div class="line">  </div><div class="line">    ObjectName on = <span class="keyword">null</span>;  </div><div class="line">  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        on = <span class="keyword">new</span> ObjectName(name.toString());  </div><div class="line">          </div><div class="line">        Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(obj, on, <span class="keyword">null</span>);  </div><div class="line">    &#125; <span class="keyword">catch</span> (MalformedObjectNameException e) &#123;  </div><div class="line">        log.warn(sm.getString(<span class="string">"lifecycleMBeanBase.registerFail"</span>, obj, name),  </div><div class="line">                e);  </div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </div><div class="line">        log.warn(sm.getString(<span class="string">"lifecycleMBeanBase.registerFail"</span>, obj, name),  </div><div class="line">                e);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">return</span> on;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>

Registry的registerComponent方法会为当前容器（如StandardServer）创建DynamicMBean，并且注册到MBeanServer，见代码。

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Register a component  </span></div><div class="line"> * XXX make it private  </div><div class="line"> *  </div><div class="line"> * <span class="doctag">@param</span> bean </div><div class="line"> * <span class="doctag">@param</span> oname </div><div class="line"> * <span class="doctag">@param</span> type </div><div class="line"> * <span class="doctag">@throws</span> Exception </div><div class="line"> */   </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerComponent</span><span class="params">(Object bean, ObjectName oname, String type)</span>  </span></div><div class="line">       <span class="keyword">throws</span> Exception  </div><div class="line">&#123;  </div><div class="line">    <span class="keyword">if</span>( log.isDebugEnabled() ) &#123;  </div><div class="line">        log.debug( <span class="string">"Managed= "</span>+ oname);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span>( bean ==<span class="keyword">null</span> ) &#123;  </div><div class="line">        log.error(<span class="string">"Null component "</span> + oname );  </div><div class="line">        <span class="keyword">return</span>;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        <span class="keyword">if</span>( type==<span class="keyword">null</span> ) &#123;  </div><div class="line">            type=bean.getClass().getName();  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        ManagedBean managed = findManagedBean(bean.getClass(), type);  </div><div class="line">  </div><div class="line">        <span class="comment">// The real mbean is created and registered  </span></div><div class="line">        DynamicMBean mbean = managed.createMBean(bean);  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span>(  getMBeanServer().isRegistered( oname )) &#123;  </div><div class="line">            <span class="keyword">if</span>( log.isDebugEnabled()) &#123;  </div><div class="line">                log.debug(<span class="string">"Unregistering existing component "</span> + oname );  </div><div class="line">            &#125;  </div><div class="line">            getMBeanServer().unregisterMBean( oname );  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        getMBeanServer().registerMBean( mbean, oname);  </div><div class="line">    &#125; <span class="keyword">catch</span>( Exception ex) &#123;  </div><div class="line">        log.error(<span class="string">"Error registering "</span> + oname, ex );  </div><div class="line">        <span class="keyword">throw</span> ex;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>将StringCache、MBeanFactory、globalNamingResources注册到JMX</p>
<p> 从代码清单7中已经列出。其中StringCache的注册名为Catalina:type=StringCache，MBeanFactory的注册名为Catalina:type=MBeanFactory，globalNamingResources的注册名为Catalina:type=NamingResources。</p>
</li>
<li><p>初始化子容器</p>
<p> 从代码清单7中看到StandardServer主要对Service子容器进行初始化，默认是StandardService。注意：个别容器并不完全遵循以上的初始化过程，比如ProtocolHandler作为Connector的子容器，其初始化过程并不是由Connector的initInternal方法调用的，而是与启动过程一道被Connector的startInternal方法所调用。</p>
</li>
</ol>
<h5 id="容器启动"><a href="#容器启动" class="headerlink" title="容器启动"></a><strong>容器启动</strong></h5><p>每个容器的start方法是自身启动的入口，其启动过程如图6所示。</p>
<p><img src="http://i.imgur.com/ss0j9ut.jpg" alt=""></p>
<p>根据图所示的启动过程，我们对Tomcat的源码进行分析，其处理步骤如下：</p>
<ol>
<li>调用方调用容器父类LifecycleBase的start方法，LifecycleBase的start方法主要完成一些所有容器公共抽象出来的动作；</li>
<li>LifecycleBase的start方法先将容器状态改为LifecycleState.STARTING_PREP，然后调用具体容器的startInternal方法实现，此startInternal方法用于对容器本身真正的初始化；</li>
<li>具体容器的startInternal方法会将容器状态改为LifecycleState.STARTING，容器如果有子容器，会调用子容器的start方法启动子容器；</li>
<li>容器启动完毕，LifecycleBase会将容器的状态更改为启动完毕，即LifecycleState.STARTED。</li>
</ol>
<p>LifecycleBase的start方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (LifecycleState.STARTING_PREP.equals(state) || LifecycleState.STARTING.equals(state) ||</div><div class="line">                LifecycleState.STARTED.equals(state)) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                Exception e = <span class="keyword">new</span> LifecycleException();</div><div class="line">                log.debug(sm.getString(<span class="string">"lifecycleBase.alreadyStarted"</span>, toString()), e);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</div><div class="line">                log.info(sm.getString(<span class="string">"lifecycleBase.alreadyStarted"</span>, toString()));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (state.equals(LifecycleState.NEW)) &#123;</div><div class="line">            init();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state.equals(LifecycleState.FAILED)) &#123;</div><div class="line">            stop();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!state.equals(LifecycleState.INITIALIZED) &amp;&amp;</div><div class="line">                !state.equals(LifecycleState.STOPPED)) &#123;</div><div class="line">            invalidTransition(Lifecycle.BEFORE_START_EVENT);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            setStateInternal(LifecycleState.STARTING_PREP, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            startInternal();</div><div class="line">            <span class="keyword">if</span> (state.equals(LifecycleState.FAILED)) &#123;</div><div class="line">                <span class="comment">// This is a 'controlled' failure. The component put itself into the</span></div><div class="line">                <span class="comment">// FAILED state so call stop() to complete the clean-up.</span></div><div class="line">                stop();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!state.equals(LifecycleState.STARTING)) &#123;</div><div class="line">                <span class="comment">// Shouldn't be necessary but acts as a check that sub-classes are</span></div><div class="line">                <span class="comment">// doing what they are supposed to.</span></div><div class="line">                invalidTransition(Lifecycle.AFTER_START_EVENT);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                setStateInternal(LifecycleState.STARTED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="comment">// This is an 'uncontrolled' failure so put the component into the</span></div><div class="line">            <span class="comment">// FAILED state and throw an exception.</span></div><div class="line">            ExceptionUtils.handleThrowable(t);</div><div class="line">            setStateInternal(LifecycleState.FAILED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(sm.getString(<span class="string">"lifecycleBase.startFail"</span>, toString()), t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上述代码说明：</p>
<ol>
<li>如果当前容器已经处于启动过程（即容器状态为LifecycleState.STARTING_PREP、LifecycleState.STARTING、LifecycleState.STARTED）中，则会产生并且用日志记录LifecycleException异常并退出。</li>
<li>如果容器依然处于LifecycleState.NEW状态，则在启动之前，首先确保初始化完毕</li>
<li>如果容器启动异常导致容器进入LifecycleState.FAILED或者LifecycleState.MUST_STOP状态，则需要调用stop方法停止容器。</li>
</ol>
<p>现在我们重点分析startInternal方法，还是以StandardServer为例，其startInternal的实现见代码所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        fireLifecycleEvent(CONFIGURE_START_EVENT, <span class="keyword">null</span>);</div><div class="line">        setState(LifecycleState.STARTING);</div><div class="line"></div><div class="line">        globalNamingResources.start();</div><div class="line"></div><div class="line">        <span class="comment">// Start our defined Services</span></div><div class="line">        <span class="keyword">synchronized</span> (servicesLock) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">                services[i].start();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上述代码看到StandardServer的启动由以下步骤组成：</p>
<ol>
<li>产生CONFIGURE_START_EVENT事件；</li>
<li>将自身状态更改为LifecycleState.STARTING；</li>
<li>调用子容器Service（默认为StandardService）的start方法启动子容器。</li>
</ol>
<p>除了初始化、启动外，各个容器还有停止和销毁的生命周期，其原理与初始化、启动类似，本文不再赘述，有兴趣的读者可以自行研究。</p>
<h4 id="本章总结"><a href="#本章总结" class="headerlink" title="本章总结"></a>本章总结</h4><p>Tomcat通过将内部所有组件都抽象为容器，为容器提供统一的生命周期管理，各个子容器只需要关心各自的具体实现，这便于Tomcat以后扩展更多的容器，对于研究或者学习Tomcat的人来说，其设计清晰易懂。</p>
<h3 id="第四章-tomact的启动"><a href="#第四章-tomact的启动" class="headerlink" title="第四章 tomact的启动"></a>第四章 tomact的启动</h3><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>熟悉Tomcat的工程师们，肯定都知道Tomcat是如何启动与停止的。对于startup.sh、startup.bat、shutdown.sh、shutdown.bat等脚本或者批处理命令，大家一定知道改如何使用它，但是它们究竟是如何实现的？</p>
<p>startup.sh启动：<br><img src="http://i.imgur.com/qhuaBiA.png" alt=""></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">os400=false</div><div class="line">case "`uname`" in</div><div class="line">OS400*) os400=true;;</div><div class="line">esac</div><div class="line"></div><div class="line"># resolve links - $0 may be a softlink</div><div class="line">PRG="$0"</div><div class="line"></div><div class="line">while [ -h "$PRG" ] ; do</div><div class="line">  ls=`ls -ld "$PRG"`</div><div class="line">  link=`expr "$ls" : '.*-&gt; \(.*\)$'`</div><div class="line">  if expr "$link" : '/.*' &gt; /dev/null; then</div><div class="line">    PRG="$link"</div><div class="line">  else</div><div class="line">    PRG=`dirname "$PRG"`/"$link"</div><div class="line">  fi</div><div class="line">done</div><div class="line"></div><div class="line">PRGDIR=`dirname "$PRG"`</div><div class="line">EXECUTABLE=catalina.sh</div><div class="line"></div><div class="line"># Check that target executable exists</div><div class="line">if $os400; then</div><div class="line">  # -x will Only work on the os400 if the files are:</div><div class="line">  # 1. owned by the user</div><div class="line">  # 2. owned by the PRIMARY group of the user</div><div class="line">  # this will not work if the user belongs in secondary groups</div><div class="line">  eval</div><div class="line">else</div><div class="line">  if [ ! -x "$PRGDIR"/"$EXECUTABLE" ]; then</div><div class="line">    echo "Cannot find $PRGDIR/$EXECUTABLE"</div><div class="line">    echo "The file is absent or does not have execute permission"</div><div class="line">    echo "This file is needed to run this program"</div><div class="line">    exit 1</div><div class="line">  fi</div><div class="line">fi</div><div class="line"></div><div class="line">exec "$PRGDIR"/"$EXECUTABLE" start "$@"</div></pre></td></tr></table></figure>
<p>由上述脚本得知，执行脚本catalina.sh。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">elif [ "$1" = "start" ] ; then  </div><div class="line">  </div><div class="line"># 此处省略参数校验的脚本  </div><div class="line">  </div><div class="line">shift  </div><div class="line">touch "$CATALINA_OUT"  </div><div class="line">if [ "$1" = "-security" ] ; then  </div><div class="line">  if [ $have_tty -eq 1 ]; then  </div><div class="line">    echo "Using Security Manager"  </div><div class="line">  fi  </div><div class="line">  shift  </div><div class="line">  eval "\"$_RUNJAVA\"" "\"$LOGGING_CONFIG\"" $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \  </div><div class="line">    -Djava.endorsed.dirs="\"$JAVA_ENDORSED_DIRS\"" -classpath "\"$CLASSPATH\"" \  </div><div class="line">    -Djava.security.manager \  </div><div class="line">    -Djava.security.policy=="\"$CATALINA_BASE/conf/catalina.policy\"" \  </div><div class="line">    -Dcatalina.base="\"$CATALINA_BASE\"" \  </div><div class="line">    -Dcatalina.home="\"$CATALINA_HOME\"" \  </div><div class="line">    -Djava.io.tmpdir="\"$CATALINA_TMPDIR\"" \  </div><div class="line">    org.apache.catalina.startup.Bootstrap "$@" start \  </div><div class="line">    &gt;&gt; "$CATALINA_OUT" 2&gt;&amp;1 "&amp;"  </div><div class="line">  </div><div class="line">else  </div><div class="line">  eval "\"$_RUNJAVA\"" "\"$LOGGING_CONFIG\"" $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \  </div><div class="line">    -Djava.endorsed.dirs="\"$JAVA_ENDORSED_DIRS\"" -classpath "\"$CLASSPATH\"" \  </div><div class="line">    -Dcatalina.base="\"$CATALINA_BASE\"" \  </div><div class="line">    -Dcatalina.home="\"$CATALINA_HOME\"" \  </div><div class="line">    -Djava.io.tmpdir="\"$CATALINA_TMPDIR\"" \  </div><div class="line">    org.apache.catalina.startup.Bootstrap "$@" start \  </div><div class="line">    &gt;&gt; "$CATALINA_OUT" 2&gt;&amp;1 "&amp;"  </div><div class="line">  </div><div class="line">fi  </div><div class="line">  </div><div class="line">if [ ! -z "$CATALINA_PID" ]; then  </div><div class="line">  echo $! &gt; "$CATALINA_PID"  </div><div class="line">fi  </div><div class="line">  </div><div class="line">echo "Tomcat started."</div></pre></td></tr></table></figure>
<p>从代码清单2可以看出，最终使用Java命令执行了org.apache.catalina.startup.Bootstrap类中的main方法，参数也是start。Bootstrap的main方法的实现见代码清单3.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Main method and entry point when starting Tomcat via the provided</div><div class="line">     * scripts.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> args Command line arguments to be processed</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (daemon == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Don't set daemon until init() has completed</span></div><div class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                bootstrap.init();</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                handleThrowable(t);</div><div class="line">                t.printStackTrace();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            daemon = bootstrap;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// When running as a service the call to stop will be on a new</span></div><div class="line">            <span class="comment">// thread so make sure the correct class loader is used to prevent</span></div><div class="line">            <span class="comment">// a range of class not found exceptions.</span></div><div class="line">            Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String command = <span class="string">"start"</span>;</div><div class="line">            <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                command = args[args.length - <span class="number">1</span>];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (command.equals(<span class="string">"startd"</span>)) &#123;</div><div class="line">                args[args.length - <span class="number">1</span>] = <span class="string">"start"</span>;</div><div class="line">                daemon.load(args);</div><div class="line">                daemon.start();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stopd"</span>)) &#123;</div><div class="line">                args[args.length - <span class="number">1</span>] = <span class="string">"stop"</span>;</div><div class="line">                daemon.stop();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"start"</span>)) &#123;</div><div class="line">                daemon.setAwait(<span class="keyword">true</span>);</div><div class="line">                daemon.load(args);</div><div class="line">                daemon.start();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stop"</span>)) &#123;</div><div class="line">                daemon.stopServer(args);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"configtest"</span>)) &#123;</div><div class="line">                daemon.load(args);</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span>==daemon.getServer()) &#123;</div><div class="line">                    System.exit(<span class="number">1</span>);</div><div class="line">                &#125;</div><div class="line">                System.exit(<span class="number">0</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                log.warn(<span class="string">"Bootstrap: command \""</span> + command + <span class="string">"\" does not exist."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="comment">// Unwrap the Exception for clearer error reporting</span></div><div class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException &amp;&amp;</div><div class="line">                    t.getCause() != <span class="keyword">null</span>) &#123;</div><div class="line">                t = t.getCause();</div><div class="line">            &#125;</div><div class="line">            handleThrowable(t);</div><div class="line">            t.printStackTrace();</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从代码清单3可以看出，当传递参数start的时候，command等于start. 启动tomact</p>
<p>main方法主要执行以下步骤：</p>
<ol>
<li>初始化Bootstrap <code>bootstrap.init();</code></li>
<li>加载、解析server.xml配置文件 <code>daemon.load(args);</code></li>
<li>启动tomact <code>daemon.start();</code></li>
</ol>
<p>以下分别来详细分析三个步骤</p>
<h5 id="步骤一-初始化Bootstrap"><a href="#步骤一-初始化Bootstrap" class="headerlink" title="步骤一 初始化Bootstrap"></a>步骤一 初始化Bootstrap</h5><p>bootstrap.init执行过程如下：</p>
<ol>
<li><code>Bootstrap bootstrap = new Bootstrap();</code>构造一个bootstrap对象，会执行静态代码块，来初始化路径。</li>
<li>初始化Tomcat的类加载器，并设置线程上下文类加载器（参照第一章）</li>
<li>用反射实例化org.apache.catalina.startup.Catalina对象，并且使用反射调用其setParentClassLoader方法，给Catalina对象设置Tomcat类加载体系的顶级加载器（Java自带的三种类加载器除外）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        initClassLoaders();</div><div class="line"></div><div class="line">        Thread.currentThread().setContextClassLoader(catalinaLoader);</div><div class="line"></div><div class="line">        SecurityClassLoad.securityClassLoad(catalinaLoader);</div><div class="line"></div><div class="line">        <span class="comment">// Load our startup class and call its process() method</span></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">            log.debug(<span class="string">"Loading startup class"</span>);</div><div class="line">        Class&lt;?&gt; startupClass =</div><div class="line">            catalinaLoader.loadClass</div><div class="line">            (<span class="string">"org.apache.catalina.startup.Catalina"</span>);</div><div class="line">        Object startupInstance = startupClass.newInstance();</div><div class="line"></div><div class="line">        <span class="comment">// Set the shared extensions class loader</span></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">            log.debug(<span class="string">"Setting startup class properties"</span>);</div><div class="line">        String methodName = <span class="string">"setParentClassLoader"</span>;</div><div class="line">        Class&lt;?&gt; paramTypes[] = <span class="keyword">new</span> Class[<span class="number">1</span>];</div><div class="line">        paramTypes[<span class="number">0</span>] = Class.forName(<span class="string">"java.lang.ClassLoader"</span>);</div><div class="line">        Object paramValues[] = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        paramValues[<span class="number">0</span>] = sharedLoader;</div><div class="line">        Method method =</div><div class="line">            startupInstance.getClass().getMethod(methodName, paramTypes);</div><div class="line">        method.invoke(startupInstance, paramValues);</div><div class="line"></div><div class="line">        catalinaDaemon = startupInstance;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h5 id="步骤二-加载、解析server-xml配置文件"><a href="#步骤二-加载、解析server-xml配置文件" class="headerlink" title="步骤二 加载、解析server.xml配置文件"></a>步骤二 加载、解析server.xml配置文件</h5><p>当传递参数start的时候，会调用Bootstrap的load方法（见代码清单5），其作用是用反射调用catalinaDaemon（类型是Catalina）的load方法加载和解析server.xml配置文件。参照第二章。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Load daemon.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(String[] arguments)</span></span></div><div class="line">       <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">       <span class="comment">// Call the load() method</span></div><div class="line">       String methodName = <span class="string">"load"</span>;</div><div class="line">       Object param[];</div><div class="line">       Class&lt;?&gt; paramTypes[];</div><div class="line">       <span class="keyword">if</span> (arguments==<span class="keyword">null</span> || arguments.length==<span class="number">0</span>) &#123;</div><div class="line">           paramTypes = <span class="keyword">null</span>;</div><div class="line">           param = <span class="keyword">null</span>;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           paramTypes = <span class="keyword">new</span> Class[<span class="number">1</span>];</div><div class="line">           paramTypes[<span class="number">0</span>] = arguments.getClass();</div><div class="line">           param = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">           param[<span class="number">0</span>] = arguments;</div><div class="line">       &#125;</div><div class="line">       Method method =</div><div class="line">           catalinaDaemon.getClass().getMethod(methodName, paramTypes);</div><div class="line">       <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">           log.debug(<span class="string">"Calling startup class "</span> + method);</div><div class="line">       method.invoke(catalinaDaemon, param);</div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h5 id="步骤三-启动Tomcat"><a href="#步骤三-启动Tomcat" class="headerlink" title="步骤三 启动Tomcat"></a>步骤三 启动Tomcat</h5><p>当传递参数start的时候，调用Bootstrap的load方法之后会接着调用start方法（见代码清单6）启动Tomcat，此方法实际是用反射调用了catalinaDaemon（类型是Catalina）的start方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Start the Catalina daemon.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span></div><div class="line">    <span class="keyword">throws</span> Exception &#123;</div><div class="line">    <span class="keyword">if</span>( catalinaDaemon==<span class="keyword">null</span> ) init();</div><div class="line"></div><div class="line">    Method method = catalinaDaemon.getClass().getMethod(<span class="string">"start"</span>, (Class [] )<span class="keyword">null</span>);</div><div class="line">    method.invoke(catalinaDaemon, (Object [])<span class="keyword">null</span>);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>catalina类结构如下：</p>
<p><img src="http://i.imgur.com/msNYutk.png" alt=""></p>
<p>Catalina的start方法（见代码清单7）的执行步骤如下:</p>
<ol>
<li>验证Server容器是否已经实例化。如果没有实例化Server容器，还会再次调用Catalina的load方法加载和解析server.xml，这也说明Tomcat只允许Server容器通过配置在server.xml的方式生成，用户也可以自己实现Server接口创建自定义的Server容器以取代默认的StandardServer</li>
<li>启动Server容器，有关容器的启动过程的分析可以参考《生命周期管理》该章的内容。</li>
<li>设置关闭钩子。这么说可能有些不好理解，那就换个说法。Tomcat本身可能由于所在机器断点，程序bug甚至内存溢出导致进程退出，但是Tomcat可能需要在退出的时候做一些清理工作，比如：内存清理、对象销毁等。这些清理动作需要封装在一个Thread的实现中，然后将此Thread对象作为参数传递给Runtime的addShutdownHook方法即可。</li>
<li>最后调用Catalina的await方法循环等待接收Tomcat的shutdown命令。</li>
<li>如果Tomcat运行正常且没有收到shutdown命令，是不会向下执行stop方法的，当接收到shutdown命令，Catalina的await方法会退出循环等待，然后顺序执行stop方法停止Tomcat。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Start a new server instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (getServer() == <span class="keyword">null</span>) &#123;</div><div class="line">            load();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (getServer() == <span class="keyword">null</span>) &#123;</div><div class="line">            log.fatal(<span class="string">"Cannot start server. Server instance is not configured."</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> t1 = System.nanoTime();</div><div class="line"></div><div class="line">        <span class="comment">// Start the new server</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            getServer().start();</div><div class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</div><div class="line">            log.fatal(sm.getString(<span class="string">"catalina.serverStartFail"</span>), e);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                getServer().destroy();</div><div class="line">            &#125; <span class="keyword">catch</span> (LifecycleException e1) &#123;</div><div class="line">                log.debug(<span class="string">"destroy() failed for failed Server "</span>, e1);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> t2 = System.nanoTime();</div><div class="line">        <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</div><div class="line">            log.info(<span class="string">"Server startup in "</span> + ((t2 - t1) / <span class="number">1000000</span>) + <span class="string">" ms"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Register shutdown hook</span></div><div class="line">        <span class="keyword">if</span> (useShutdownHook) &#123;</div><div class="line">            <span class="keyword">if</span> (shutdownHook == <span class="keyword">null</span>) &#123;</div><div class="line">                shutdownHook = <span class="keyword">new</span> CatalinaShutdownHook();</div><div class="line">            &#125;</div><div class="line">            Runtime.getRuntime().addShutdownHook(shutdownHook);</div><div class="line"></div><div class="line">            <span class="comment">// If JULI is being used, disable JULI's shutdown hook since</span></div><div class="line">            <span class="comment">// shutdown hooks run in parallel and log messages may be lost</span></div><div class="line">            <span class="comment">// if JULI's hook completes before the CatalinaShutdownHook()</span></div><div class="line">            LogManager logManager = LogManager.getLogManager();</div><div class="line">            <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</div><div class="line">                ((ClassLoaderLogManager) logManager).setUseShutdownHook(</div><div class="line">                        <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (await) &#123;</div><div class="line">            await();</div><div class="line">            stop();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>Catalina的await方法（见代码清单8）实际只是代理执行了Server容器的await方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Await and shutdown.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    getServer().await();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以Server的默认实现StandardServer为例，其await方法的执行步骤如下：</p>
<ol>
<li>创建socket连接的服务端对象ServerSocket；</li>
<li>循环等待接收客户端发出的命令，如果接收到的命令与SHUTDOWN匹配（由于使用了equals，所以shutdown命令必须是大写的），那么退出循环等待。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Wait until a proper shutdown command is received, then return.</div><div class="line">     * This keeps the main thread alive - the thread pool listening for http</div><div class="line">     * connections is daemon threads.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Negative values - don't wait on port - tomcat is embedded or we just don't like ports</span></div><div class="line">        <span class="keyword">if</span>( port == -<span class="number">2</span> ) &#123;</div><div class="line">            <span class="comment">// undocumented yet - for embedding apps that are around, alive.</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>( port==-<span class="number">1</span> ) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                awaitThread = Thread.currentThread();</div><div class="line">                <span class="keyword">while</span>(!stopAwait) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Thread.sleep( <span class="number">10000</span> );</div><div class="line">                    &#125; <span class="keyword">catch</span>( InterruptedException ex ) &#123;</div><div class="line">                        <span class="comment">// continue and check the flag</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                awaitThread = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Set up a server socket to wait on</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            awaitSocket = <span class="keyword">new</span> ServerSocket(port, <span class="number">1</span>,</div><div class="line">                    InetAddress.getByName(address));</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            log.error(<span class="string">"StandardServer.await: create["</span> + address</div><div class="line">                               + <span class="string">":"</span> + port</div><div class="line">                               + <span class="string">"]: "</span>, e);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            awaitThread = Thread.currentThread();</div><div class="line"></div><div class="line">            <span class="comment">// Loop waiting for a connection and a valid command</span></div><div class="line">            <span class="keyword">while</span> (!stopAwait) &#123;</div><div class="line">                ServerSocket serverSocket = awaitSocket;</div><div class="line">                <span class="keyword">if</span> (serverSocket == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Wait for the next connection</span></div><div class="line">                Socket socket = <span class="keyword">null</span>;</div><div class="line">                StringBuilder command = <span class="keyword">new</span> StringBuilder();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    InputStream stream;</div><div class="line">                    <span class="keyword">long</span> acceptStartTime = System.currentTimeMillis();</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        socket = serverSocket.accept();</div><div class="line">                        socket.setSoTimeout(<span class="number">10</span> * <span class="number">1000</span>);  <span class="comment">// Ten seconds</span></div><div class="line">                        stream = socket.getInputStream();</div><div class="line">                    &#125; <span class="keyword">catch</span> (SocketTimeoutException ste) &#123;</div><div class="line">                        <span class="comment">// This should never happen but bug 56684 suggests that</span></div><div class="line">                        <span class="comment">// it does.</span></div><div class="line">                        log.warn(sm.getString(<span class="string">"standardServer.accept.timeout"</span>,</div><div class="line">                                Long.valueOf(System.currentTimeMillis() - acceptStartTime)), ste);</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125; <span class="keyword">catch</span> (AccessControlException ace) &#123;</div><div class="line">                        log.warn(<span class="string">"StandardServer.accept security exception: "</span></div><div class="line">                                + ace.getMessage(), ace);</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        <span class="keyword">if</span> (stopAwait) &#123;</div><div class="line">                            <span class="comment">// Wait was aborted with socket.close()</span></div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        log.error(<span class="string">"StandardServer.await: accept: "</span>, e);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// Read a set of characters from the socket</span></div><div class="line">                    <span class="keyword">int</span> expected = <span class="number">1024</span>; <span class="comment">// Cut off to avoid DoS attack</span></div><div class="line">                    <span class="keyword">while</span> (expected &lt; shutdown.length()) &#123;</div><div class="line">                        <span class="keyword">if</span> (random == <span class="keyword">null</span>)</div><div class="line">                            random = <span class="keyword">new</span> Random();</div><div class="line">                        expected += (random.nextInt() % <span class="number">1024</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">while</span> (expected &gt; <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">int</span> ch = -<span class="number">1</span>;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            ch = stream.read();</div><div class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                            log.warn(<span class="string">"StandardServer.await: read: "</span>, e);</div><div class="line">                            ch = -<span class="number">1</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// Control character or EOF (-1) terminates loop</span></div><div class="line">                        <span class="keyword">if</span> (ch &lt; <span class="number">32</span> || ch == <span class="number">127</span>) &#123;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        command.append((<span class="keyword">char</span>) ch);</div><div class="line">                        expected--;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="comment">// Close the socket now that we are done with it</span></div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</div><div class="line">                            socket.close();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        <span class="comment">// Ignore</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Match against our command string</span></div><div class="line">                <span class="keyword">boolean</span> match = command.toString().equals(shutdown);</div><div class="line">                <span class="keyword">if</span> (match) &#123;</div><div class="line">                    log.info(sm.getString(<span class="string">"standardServer.shutdownViaPort"</span>));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125; <span class="keyword">else</span></div><div class="line">                    log.warn(<span class="string">"StandardServer.await: Invalid command '"</span></div><div class="line">                            + command.toString() + <span class="string">"' received"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            ServerSocket serverSocket = awaitSocket;</div><div class="line">            awaitThread = <span class="keyword">null</span>;</div><div class="line">            awaitSocket = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="comment">// Close the server socket and return</span></div><div class="line">            <span class="keyword">if</span> (serverSocket != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    serverSocket.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    <span class="comment">// Ignore</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>本章小结</p>
<p>至此，Tomcat启动完毕。<br>以下是一个tomact启动过程时序图：</p>
<p><img src="http://i.imgur.com/mL0bxFk.png" alt=""></p>
<h3 id="第五章-tomact的停止"><a href="#第五章-tomact的停止" class="headerlink" title="第五章 tomact的停止"></a>第五章 tomact的停止</h3><p>分析：</p>
<p>我们停止Tomcat的命令如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sh shutdown.sh</div></pre></td></tr></table></figure>
<p>所以，将从shell脚本shutdown.sh开始分析Tomcat的停止过程。shutdown.sh的脚本代码见代码:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">os400=false  </div><div class="line">case "`uname`" in  </div><div class="line">OS400*) os400=true;;  </div><div class="line">esac  </div><div class="line">  </div><div class="line"># resolve links - $0 may be a softlink  </div><div class="line">PRG="$0"  </div><div class="line">  </div><div class="line">while [ -h "$PRG" ] ; do  </div><div class="line">  ls=`ls -ld "$PRG"`  </div><div class="line">  link=`expr "$ls" : '.*-&gt; .∗$'`  </div><div class="line">  if expr "$link" : '/.*' &gt; /dev/null; then  </div><div class="line">    PRG="$link"  </div><div class="line">  else  </div><div class="line">    PRG=`dirname "$PRG"`/"$link"  </div><div class="line">  fi  </div><div class="line">done  </div><div class="line">  </div><div class="line">PRGDIR=`dirname "$PRG"`  </div><div class="line">EXECUTABLE=catalina.sh  </div><div class="line">  </div><div class="line"># Check that target executable exists  </div><div class="line">if $os400; then  </div><div class="line">  # -x will Only work on the os400 if the files are:  </div><div class="line">  # 1. owned by the user  </div><div class="line">  # 2. owned by the PRIMARY group of the user  </div><div class="line">  # this will not work if the user belongs in secondary groups  </div><div class="line">  eval  </div><div class="line">else  </div><div class="line">  if [ ! -x "$PRGDIR"/"$EXECUTABLE" ]; then  </div><div class="line">    echo "Cannot find $PRGDIR/$EXECUTABLE"  </div><div class="line">    echo "The file is absent or does not have execute permission"  </div><div class="line">    echo "This file is needed to run this program"  </div><div class="line">    exit 1  </div><div class="line">  fi  </div><div class="line">fi  </div><div class="line">  </div><div class="line">exec "$PRGDIR"/"$EXECUTABLE" stop "$@"</div></pre></td></tr></table></figure>
<p>执行脚本catalina.sh</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">elif [ "$1" = "stop" ] ; then  </div><div class="line">  </div><div class="line">  #省略参数校验脚本  </div><div class="line">  </div><div class="line">  eval "\"$_RUNJAVA\"" $LOGGING_MANAGER $JAVA_OPTS \  </div><div class="line">    -Djava.endorsed.dirs="\"$JAVA_ENDORSED_DIRS\"" -classpath "\"$CLASSPATH\"" \  </div><div class="line">    -Dcatalina.base="\"$CATALINA_BASE\"" \  </div><div class="line">    -Dcatalina.home="\"$CATALINA_HOME\"" \  </div><div class="line">    -Djava.io.tmpdir="\"$CATALINA_TMPDIR\"" \  </div><div class="line">    org.apache.catalina.startup.Bootstrap "$@" stop</div></pre></td></tr></table></figure>
<p>从代码可以看出，最终使用java命令执行了org.apache.catalina.startup.Bootstrap类中的main方法，参数是stop。</p>
<p>此时main方法主要执行以下步骤</p>
<ol>
<li>初始化bootstrap（参照上一章）</li>
<li><p>停止服务</p>
<p> 通过调用Bootstrap的stopServer方法停止Tomcat，其实质是用反射调用catalinaDaemon（类型是Catalina）的stopServer方法。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Stop the standalone server.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopServer</span><span class="params">()</span></span></div><div class="line">    <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">    Method method =</div><div class="line">        catalinaDaemon.getClass().getMethod(<span class="string">"stopServer"</span>, (Class []) <span class="keyword">null</span>);</div><div class="line">    method.invoke(catalinaDaemon, (Object []) <span class="keyword">null</span>);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> Catalina的stopServer方法（见代码清单13）的执行步骤如下：</p>
<ul>
<li>创建Digester解析server.xml文件（此处只解析标签），以构造出Server容器（此时Server容器的子容器没有被实例化）；</li>
<li><p>从实例化的Server容器获取Server的socket监听端口和地址，然后创建Socket对象连接启动Tomcat时创建的ServerSocket，最后向ServerSocket发送SHUTDOWN命令。根据代码清单9的内容，ServerSocket循环等待接收到SHUTDOWN命令后，最终调用stop方法停止Tomcat。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopServer</span><span class="params">(String[] arguments)</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (arguments != <span class="keyword">null</span>) &#123;</div><div class="line">           arguments(arguments);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Server s = getServer();</div><div class="line">       <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// Create and execute our Digester</span></div><div class="line">           Digester digester = createStopDigester();</div><div class="line">           File file = configFile();</div><div class="line">           <span class="keyword">try</span> (FileInputStream fis = <span class="keyword">new</span> FileInputStream(file)) &#123;</div><div class="line">               InputSource is =</div><div class="line">                   <span class="keyword">new</span> InputSource(file.toURI().toURL().toString());</div><div class="line">               is.setByteStream(fis);</div><div class="line">               digester.push(<span class="keyword">this</span>);</div><div class="line">               digester.parse(is);</div><div class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">               log.error(<span class="string">"Catalina.stop: "</span>, e);</div><div class="line">               System.exit(<span class="number">1</span>);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// Server object already present. Must be running as a service</span></div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               s.stop();</div><div class="line">           &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</div><div class="line">               log.error(<span class="string">"Catalina.stop: "</span>, e);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Stop the existing server</span></div><div class="line">       s = getServer();</div><div class="line">       <span class="keyword">if</span> (s.getPort()&gt;<span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">try</span> (Socket socket = <span class="keyword">new</span> Socket(s.getAddress(), s.getPort());</div><div class="line">                   OutputStream stream = socket.getOutputStream()) &#123;</div><div class="line">               String shutdown = s.getShutdown();</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shutdown.length(); i++) &#123;</div><div class="line">                   stream.write(shutdown.charAt(i));</div><div class="line">               &#125;</div><div class="line">               stream.flush();</div><div class="line">           &#125; <span class="keyword">catch</span> (ConnectException ce) &#123;</div><div class="line">               log.error(sm.getString(<span class="string">"catalina.stopServer.connectException"</span>,</div><div class="line">                                      s.getAddress(),</div><div class="line">                                      String.valueOf(s.getPort())));</div><div class="line">               log.error(<span class="string">"Catalina.stop: "</span>, ce);</div><div class="line">               System.exit(<span class="number">1</span>);</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">               log.error(<span class="string">"Catalina.stop: "</span>, e);</div><div class="line">               System.exit(<span class="number">1</span>);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           log.error(sm.getString(<span class="string">"catalina.stopServer"</span>));</div><div class="line">           System.exit(<span class="number">1</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>最后，我们看看Catalina的stop方法（见代码清单14）的实现，其执行步骤如下：</p>
</li>
<li><p>将启动过程中添加的关闭钩子移除。Tomcat启动过程辛辛苦苦添加的关闭钩子为什么又要去掉呢？因为关闭钩子是为了在JVM异常退出后，进行资源的回收工作。主动停止Tomcat时调用的stop方法里已经包含了资源回收的内容，所以不再需要这个钩子了。<br>-停止Server容器。有关容器的停止内容，请阅读《T生命周期管理》一章。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Stop an existing server instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Remove the ShutdownHook first so that server.stop()</span></div><div class="line">            <span class="comment">// doesn't get invoked twice</span></div><div class="line">            <span class="keyword">if</span> (useShutdownHook) &#123;</div><div class="line">                Runtime.getRuntime().removeShutdownHook(shutdownHook);</div><div class="line"></div><div class="line">                <span class="comment">// If JULI is being used, re-enable JULI's shutdown to ensure</span></div><div class="line">                <span class="comment">// log messages are not lost</span></div><div class="line">                LogManager logManager = LogManager.getLogManager();</div><div class="line">                <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</div><div class="line">                    ((ClassLoaderLogManager) logManager).setUseShutdownHook(</div><div class="line">                            <span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(t);</div><div class="line">            <span class="comment">// This will fail on JDK 1.2. Ignoring, as Tomcat can run</span></div><div class="line">            <span class="comment">// fine without the shutdown hook.</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Shut down the server</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Server s = getServer();</div><div class="line">            LifecycleState state = s.getState();</div><div class="line">            <span class="keyword">if</span> (LifecycleState.STOPPING_PREP.compareTo(state) &lt;= <span class="number">0</span></div><div class="line">                    &amp;&amp; LifecycleState.DESTROYED.compareTo(state) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// Nothing to do. stop() was already called</span></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                s.stop();</div><div class="line">                s.destroy();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</div><div class="line">            log.error(<span class="string">"Catalina.stop"</span>, e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<p>本章小结</p>
<p>通过对Tomcat源码的分析我们了解到Tomcat的启动和停止都离不开org.apache.catalina.startup.Bootstrap。当停止Tomcat时，已经启动的Tomcat作为socket服务端，停止脚本启动的Bootstrap进程作为socket客户端向服务端发送shutdown命令，两个进程通过共享server.xml里Server标签的端口以及地址信息打通了socket的通信。</p>
<h3 id="第六章-请求原理分析-Tomcat处理请求前作的初始化和准备工作"><a href="#第六章-请求原理分析-Tomcat处理请求前作的初始化和准备工作" class="headerlink" title="第六章 请求原理分析-Tomcat处理请求前作的初始化和准备工作"></a>第六章 请求原理分析-Tomcat处理请求前作的初始化和准备工作</h3><h4 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h4><p>谈起Tomcat的诞生，最早可以追溯到1995年。近20年来，Tomcat始终是使用最广泛的Web服务器，由于其使用Java语言开发，所以广为Java程序员所熟悉。很多人早期的J2EE项目，由程序员自己实现Jsp页面或者Servlet接受请求，后来借助Struts1、Struts2、spring等中间件后，实际也是利用Filter或者Servlet处理请求，大家肯定要问了，这些Servlet处理的请求来自哪里？Tomcat作为Web服务器是怎样将HTTP请求交给Servlet的呢？</p>
<p>本章就Tomcat对HTTP的请求处理细节进行分析。</p>
<h4 id="2-connector"><a href="#2-connector" class="headerlink" title="2.connector"></a>2.connector</h4><p>根据《生命周期管理》一章的内容，我们知道Tomcat中有很多容器，包括Server、Service、Connector等。其中Connector正是与HTTP请求处理相关的容器。Service是Server的子容器，而Connector又是Service的子容器。那么这三个容器的初始化顺序为：Server-&gt;Service-&gt;Connector。Connector的实现分为以下几种：</p>
<ul>
<li>Http Connector：基于HTTP协议，负责建立HTTP连接。它又分为BIO Http Connector（是Tomcat的默认Connector）与NIO Http Connector两种，后者提供非阻塞IO与长连接Comet支持。</li>
<li>AJP Connector：基于AJP协议，AJP是专门设计用于Tomcat与HTTP服务器通信定制的协议，能提供较高的通信速度和效率。如与Apache服务器集成时，采用这个协议。</li>
<li>APR HTTP Connector：用C实现，通过JNI调用的。主要提升对静态资源（如HTML、图片、CSS、JS等）的访问性能。现在这个库已独立出来可用在任何项目中。由于APR性能较前两类有很大提升。现在我们直接来看Connector的initInternal方法吧。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.initInternal();</div><div class="line"></div><div class="line">        <span class="comment">// Initialize adapter</span></div><div class="line">        adapter = <span class="keyword">new</span> CoyoteAdapter(<span class="keyword">this</span>);</div><div class="line">        protocolHandler.setAdapter(adapter);</div><div class="line"></div><div class="line">        <span class="comment">// Make sure parseBodyMethodsSet has a default</span></div><div class="line">        <span class="keyword">if</span>( <span class="keyword">null</span> == parseBodyMethodsSet ) &#123;</div><div class="line">            setParseBodyMethods(getParseBodyMethods());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (protocolHandler.isAprRequired() &amp;&amp;</div><div class="line">                !AprLifecycleListener.isAprAvailable()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</div><div class="line">                    sm.getString(<span class="string">"coyoteConnector.protocolHandlerNoApr"</span>,</div><div class="line">                            getProtocolHandlerClassName()));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            protocolHandler.init();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</div><div class="line">                (sm.getString</div><div class="line">                 (<span class="string">"coyoteConnector.protocolHandlerInitializationFailed"</span>), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上述代码说明了Connector的初始化步骤如下：</p>
<ol>
<li><strong>步骤一 构造网络协议处理的CoyoteAdapter</strong></li>
</ol>
<p>代码中构造了CoyoteAdapter对象，并且将其设置为ProtocolHandler的Adapter。ProtocolHandler是做什么的呢？Tomcat处理HTTP请求，需要有一个ServerSocket监听网络端口来完成任务。接口ProtocolHandler被设计成控制网络端口监听组件运行，负责组件的生命周期控制，这个接口实际并没有定义网络端口监听功能的规范，而是用于负责维护组件的生命周期。从ProtocolHandler的名字来看，它应该是网络协议的处理者，但它实际不负责这个功能，而是将其交给org.apache.coyote.Adapter来完成，这么设计估计是为了方便维护和拓展新功能。</p>
<p>Http11Protocol是ProtocolHandler接口的一个实现(是Connector的默认处理协议),被设计用来处理HTTP1.1网络协议的请求,通过该类可以完成在某个网络端口上面的监听,同时以HTTP1.1的协议来解析请求内容，然后将请求传递到Connector所寄居的Container容器pipeline流水工作线上处理。</p>
<p>此处的ProtocolHandler是何时生成的呢？还记得《第三章——SERVER.XML文件的加载与解析》一文中的Digester和Rule吗？Digester在解析到标签的时候，会执行startElement方法，startElement中会调用Rule的begin(String namespace, String name, Attributes attributes)方法，Connector对应的Rule就包括了ConnectorCreateRule。ConnectorCreateRule的begin方法的实现见代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String name, Attributes attributes)</span>  </span></div><div class="line">        <span class="keyword">throws</span> Exception &#123;  </div><div class="line">    Service svc = (Service)digester.peek();  </div><div class="line">    Executor ex = <span class="keyword">null</span>;  </div><div class="line">    <span class="keyword">if</span> ( attributes.getValue(<span class="string">"executor"</span>)!=<span class="keyword">null</span> ) &#123;  </div><div class="line">        ex = svc.getExecutor(attributes.getValue(<span class="string">"executor"</span>));  </div><div class="line">    &#125;  </div><div class="line">    Connector con = <span class="keyword">new</span> Connector(attributes.getValue(<span class="string">"protocol"</span>));  </div><div class="line">    <span class="keyword">if</span> ( ex != <span class="keyword">null</span> )  _setExecutor(con,ex);  </div><div class="line">      </div><div class="line">    digester.push(con);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码调用了Connector的构造器，传递的参数为属性protocol。我们知道server.xml中默认的Connector有两个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;Connector port=<span class="string">"8080"</span> protocol=<span class="string">"HTTP/1.1"</span>   </div><div class="line">           connectionTimeout=<span class="string">"20000"</span>   </div><div class="line">           redirectPort=<span class="string">"8443"</span> /&gt;  </div><div class="line">&lt;!-- Define an AJP <span class="number">1.3</span> Connector on port <span class="number">8009</span> --&gt;  </div><div class="line">&lt;Connector port=<span class="string">"8009"</span> protocol=<span class="string">"AJP/1.3"</span> redirectPort=<span class="string">"8443"</span> /&gt;</div></pre></td></tr></table></figure>
<p>从server.xml可以看到两个Connector都有属性protocol。</p>
<p>connector的构造器如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Connector</span><span class="params">(String protocol)</span> </span>&#123;</div><div class="line">    setProtocol(protocol);</div><div class="line">    <span class="comment">// Instantiate protocol handler</span></div><div class="line">    ProtocolHandler p = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName);</div><div class="line">        p = (ProtocolHandler) clazz.newInstance();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        log.error(sm.getString(</div><div class="line">                <span class="string">"coyoteConnector.protocolHandlerInstantiationFailed"</span>), e);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">this</span>.protocolHandler = p;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!Globals.STRICT_SERVLET_COMPLIANCE) &#123;</div><div class="line">        URIEncoding = <span class="string">"UTF-8"</span>;</div><div class="line">        URIEncodingLower = URIEncoding.toLowerCase(Locale.ENGLISH);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>setProtocol方法根据protocol参数的不同，调用setProtocolHandlerClassName方法（见代码清单5）设置protocolHandlerClassName属性。以HTTP/1.1为例，由于默认情况下Apr不可用，所以protocolHandlerClassName会被设置为org.apache.coyote.http11.Http11Protocol，那么反射生成的protocolHandler就是Http11Protocol实例。Tomcat默认还会配置协议是AJP/1.3的Connector，那么此Connector的protocolHandler就是org.apache.coyote.ajp.AjpProtocol。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProtocol</span><span class="params">(String protocol)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (AprLifecycleListener.isAprAvailable()) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"HTTP/1.1"</span>.equals(protocol)) &#123;</div><div class="line">                setProtocolHandlerClassName</div><div class="line">                    (<span class="string">"org.apache.coyote.http11.Http11AprProtocol"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"AJP/1.3"</span>.equals(protocol)) &#123;</div><div class="line">                setProtocolHandlerClassName</div><div class="line">                    (<span class="string">"org.apache.coyote.ajp.AjpAprProtocol"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol != <span class="keyword">null</span>) &#123;</div><div class="line">                setProtocolHandlerClassName(protocol);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                setProtocolHandlerClassName</div><div class="line">                    (<span class="string">"org.apache.coyote.http11.Http11AprProtocol"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"HTTP/1.1"</span>.equals(protocol)) &#123;</div><div class="line">                setProtocolHandlerClassName</div><div class="line">                    (<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"AJP/1.3"</span>.equals(protocol)) &#123;</div><div class="line">                setProtocolHandlerClassName</div><div class="line">                    (<span class="string">"org.apache.coyote.ajp.AjpNioProtocol"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol != <span class="keyword">null</span>) &#123;</div><div class="line">                setProtocolHandlerClassName(protocol);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>除此之外，ProtocolHandler还有其它实现，如图1所示。</p>
<p><img src="http://i.imgur.com/xUrR6F8.png" alt=""></p>
<p>图1中有关ProtocolHandler的实现类都在org.apache.coyote包中 。前面所说的BIO Http Connector实际就是Http11Protocol，NIO Http Connector实际就是Http11NioProtocol，AJP Connector包括AjpProtocol和AjpAprProtocol，APR HTTP Connector包括AjpAprProtocol、Http11AprProtocol.</p>
<ol>
<li><strong>Connector的启动</strong></li>
</ol>
<p>根据《生命周期管理》一章的内容，我们知道Tomcat中有很多容器。ProtocolHandler的初始化稍微有些特殊，Server、Service、Connector这三个容器的初始化顺序为：Server-&gt;Service-&gt;Connector。值得注意的是，ProtocolHandler作为Connector的子容器，其初始化过程并不是由Connector的initInternal方法调用的，而是与启动过程一道被Connector的startInternal方法所调用。由于本文的目的是分析请求，所以直接从Connector的startInternal方法（见代码清单6）开始。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Begin processing requests via this Connector.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if a fatal startup error occurs</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Validate settings before starting</span></div><div class="line">        <span class="keyword">if</span> (getPort() &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(sm.getString(</div><div class="line">                    <span class="string">"coyoteConnector.invalidPort"</span>, Integer.valueOf(getPort())));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setState(LifecycleState.STARTING);</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            protocolHandler.start();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            String errPrefix = <span class="string">""</span>;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.service != <span class="keyword">null</span>) &#123;</div><div class="line">                errPrefix += <span class="string">"service.getName(): \""</span> + <span class="keyword">this</span>.service.getName() + <span class="string">"\"; "</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</div><div class="line">                (errPrefix + <span class="string">" "</span> + sm.getString</div><div class="line">                 (<span class="string">"coyoteConnector.protocolHandlerStartFailed"</span>), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>代码清单6说明了Connector的startInternal方法的执行顺序如下：</p>
<ol>
<li>将Connector容器的状态更改为启动中（LifecycleState.STARTING）；</li>
<li>初始化ProtocolHandler；</li>
<li>启动ProtocolHandler；</li>
<li>初始化MapperListener。</li>
</ol>
<h6 id="初始化ProtocolHandler"><a href="#初始化ProtocolHandler" class="headerlink" title="初始化ProtocolHandler"></a>初始化ProtocolHandler</h6><p>简单起见，我们以Http11Protocol为例剖析ProtocolHandler的init方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ------------------------------------------------------- Lifecycle methods</span></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * <span class="doctag">NOTE:</span> There is no maintenance of state or checking for valid transitions</div><div class="line">     * within this class. It is expected that the connector will maintain state</div><div class="line">     * and prevent invalid state transitions.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (getLog().isInfoEnabled())</div><div class="line">            getLog().info(sm.getString(<span class="string">"abstractProtocolHandler.init"</span>,</div><div class="line">                    getName()));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (oname == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Component not pre-registered so register it</span></div><div class="line">            oname = createObjectName();</div><div class="line">            <span class="keyword">if</span> (oname != <span class="keyword">null</span>) &#123;</div><div class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(<span class="keyword">this</span>, oname,</div><div class="line">                    <span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.domain != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                tpOname = <span class="keyword">new</span> ObjectName(domain + <span class="string">":"</span> +</div><div class="line">                        <span class="string">"type=ThreadPool,name="</span> + getName());</div><div class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(endpoint,</div><div class="line">                        tpOname, <span class="keyword">null</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                getLog().error(sm.getString(</div><div class="line">                        <span class="string">"abstractProtocolHandler.mbeanRegistrationFailed"</span>,</div><div class="line">                        tpOname, getName()), e);</div><div class="line">            &#125;</div><div class="line">            rgOname=<span class="keyword">new</span> ObjectName(domain +</div><div class="line">                    <span class="string">":type=GlobalRequestProcessor,name="</span> + getName());</div><div class="line">            Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(</div><div class="line">                    getHandler().getGlobal(), rgOname, <span class="keyword">null</span> );</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String endpointName = getName();</div><div class="line">        endpoint.setName(endpointName.substring(<span class="number">1</span>, endpointName.length()-<span class="number">1</span>));</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            endpoint.init();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">            getLog().error(sm.getString(<span class="string">"abstractProtocolHandler.initError"</span>,</div><div class="line">                    getName()), ex);</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// SSL implementation needs to be in place before end point is</span></div><div class="line">        <span class="comment">// initialized</span></div><div class="line">        sslImplementation = SSLImplementation.getInstance(sslImplementationName);</div><div class="line">        <span class="keyword">super</span>.init();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initSsl</span><span class="params">(SocketWrapper&lt;Socket&gt; socket,</span></span></div><div class="line">                Processor&lt;Socket&gt; processor) &#123;</div><div class="line">            <span class="keyword">if</span> (proto.isSSLEnabled() &amp;&amp; (proto.sslImplementation != <span class="keyword">null</span>)) &#123;</div><div class="line">                processor.setSslSupport(</div><div class="line">                        proto.sslImplementation.getSSLSupport(</div><div class="line">                                socket.getSocket()));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                processor.setSslSupport(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>从上述代码可以查看Http11Protocol的初始化步骤如下：</p>
<ol>
<li>设置JIoEndpoint的名称</li>
<li>设置JIoEndpoint的Handler</li>
<li>配置ServerSocketFactory</li>
</ol>
<h6 id="启动ProtocolHandler"><a href="#启动ProtocolHandler" class="headerlink" title="启动ProtocolHandler"></a>启动ProtocolHandler</h6><p>我们继续以Http11Protocol为例，剖析ProtocolHandler的start方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (getLog().isInfoEnabled())</div><div class="line">            getLog().info(sm.getString(<span class="string">"abstractProtocolHandler.start"</span>,</div><div class="line">                    getName()));</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            endpoint.start();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">            getLog().error(sm.getString(<span class="string">"abstractProtocolHandler.startError"</span>,</div><div class="line">                    getName()), ex);</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最后调用JIoEndpoint的start方法（见代码清单11）创建接受请求的线程池并创建一定数量的接收请求线程。 endpoint start方法执行如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="keyword">if</span> (bindState == BindState.UNBOUND) &#123;</div><div class="line">           bind();</div><div class="line">           bindState = BindState.BOUND_ON_START;</div><div class="line">       &#125;</div><div class="line">       startInternal();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (!running) &#123;</div><div class="line">           running = <span class="keyword">true</span>;</div><div class="line">           paused = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">           <span class="comment">// Create worker collection</span></div><div class="line">           <span class="keyword">if</span> (getExecutor() == <span class="keyword">null</span>) &#123;</div><div class="line">               createExecutor();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           initializeConnectionLatch();</div><div class="line"></div><div class="line">           startAcceptorThreads();</div><div class="line"></div><div class="line">           <span class="comment">// Start async timeout thread</span></div><div class="line">           setAsyncTimeout(<span class="keyword">new</span> AsyncTimeout());</div><div class="line">           Thread timeoutThread = <span class="keyword">new</span> Thread(getAsyncTimeout(), getName() + <span class="string">"-AsyncTimeout"</span>);</div><div class="line">           timeoutThread.setPriority(threadPriority);</div><div class="line">           timeoutThread.setDaemon(<span class="keyword">true</span>);</div><div class="line">           timeoutThread.start();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>从代码中可以看出上述代码主要做以下工作：</p>
<ol>
<li>创建线程池与任务队列</li>
</ol>
<p>如果JIoEndpoint尚未处于运行中（即running等于true），才会创建线程池和任务队列。如果尚未创建线程池（即调用getExecutor方法等于null），则需要调用createExecutor方法（见代码清单12）创建线程池和任务队列TaskQueue。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">    internalExecutor = <span class="keyword">true</span>;</div><div class="line">    TaskQueue taskqueue = <span class="keyword">new</span> TaskQueue();</div><div class="line">    TaskThreadFactory tf = <span class="keyword">new</span> TaskThreadFactory(getName() + <span class="string">"-exec-"</span>, daemon, getThreadPriority());</div><div class="line">    executor = <span class="keyword">new</span> ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), <span class="number">60</span>, TimeUnit.SECONDS,taskqueue, tf);</div><div class="line">    taskqueue.setParent( (ThreadPoolExecutor) executor);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>创建接收请线程</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startAcceptorThreads</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = getAcceptorThreadCount();</div><div class="line">        acceptors = <span class="keyword">new</span> Acceptor[count];</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            acceptors[i] = createAcceptor();</div><div class="line">            String threadName = getName() + <span class="string">"-Acceptor-"</span> + i;</div><div class="line">            acceptors[i].setThreadName(threadName);</div><div class="line">            Thread t = <span class="keyword">new</span> Thread(acceptors[i], threadName);</div><div class="line">            t.setPriority(getAcceptorThreadPriority());</div><div class="line">            t.setDaemon(getDaemon());</div><div class="line">            t.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>如果JIoEndpoint尚未处于运行中（即running等于true），才会创建接收请求线程。从代码可以看出接收请求线程的数量主要由acceptorThreadCount控制，代码清单9已经告诉我们acceptorThreadCount的默认值为1，但是我们可以通过给Connector增加acceptorThreadCount属性来修改接收请求线程的数量。这些接收请求线程的主要工作由Acceptor完成，Acceptor的实质是一个Runnable.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">enum</span> AcceptorState &#123;</div><div class="line">            NEW, RUNNING, PAUSED, ENDED</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">protected</span> <span class="keyword">volatile</span> AcceptorState state = AcceptorState.NEW;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AcceptorState <span class="title">getState</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> String threadName;</div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setThreadName</span><span class="params">(<span class="keyword">final</span> String threadName)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.threadName = threadName;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> String <span class="title">getThreadName</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> threadName;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>本章总结</p>
<p>至此本章结束</p>
<h3 id="第七章-Tomcat一次完整请求的处理流程"><a href="#第七章-Tomcat一次完整请求的处理流程" class="headerlink" title="第七章 Tomcat一次完整请求的处理流程"></a>第七章 Tomcat一次完整请求的处理流程</h3><h4 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h4><p>上一章介绍了请求前的准备工作，这一章讲解tomact一次完成请求的处理流程。</p>
<p>Tomcat一次完整请求处理的重点功能如下：</p>
<ol>
<li><p>接收Socket请求，把请求转发到线程池，由线程池分配一个线程来处理。</p>
</li>
<li><p>获取Socket数据包之后，解析HTTP协议，翻译成Tomcat内部的Request和Response对象，再映射相应Container。</p>
</li>
<li><p>Request和Response对象进入Tomcat中的Container容器的各级Piepline管道去流式执行，最终会流到StandardWrapperValve这个阀门。</p>
</li>
<li><p>在 StandardWrapperValve这个阀门中，把当前请求的Filter及Servlet封装成FilterChain, 最终执行FilterChain, 回调Web应用，完成响应。</p>
</li>
</ol>
<p>请求处理框架如下所示：</p>
<p><img src="http://i.imgur.com/0uqOq7A.jpg" alt=""></p>
<ul>
<li>Acceptor：负责从ServerSocket中接收新的连接，并将Socket转交给SocketProcessor处理。Acceptor是JIoEndpoint的内部类，Acceptor线程的默认数量为1，我们可以在server.xml的Connector配置中增加acceptorThreadCount的大小。</li>
<li>SocketProcessor：负责对Acceptor转交的Socket进行处理，包括给Socket设置属性、读取请求行和请求头等，最终将处理交给Engine的Pipeline处理。</li>
<li>ThreadPool：执行SocketProcessor的线程池，此线程池默认的最小线程数minSpareThreads等于10，最大线程数maxThreads等于200，我们可以在server.xml的Connector配置中调整它们的大小。</li>
<li>Pipeline：SocketProcessor线程最后会将请求进一步交给Engine容器的Pipeline，管道Pipeline包括一系列的valve，如：StandardEngineValve、AccessLogValve、ErrorReportValve、StandardHostValve、 StandardContextValve、 StandardWrapperValve，它们就像地下水管中的一个个阀门，每一个都会对请求数据做不同的处理。</li>
<li>FilterChain：管道Pipeline的最后一个valve是StandardWrapperValve，它会负责生成Servlet和Filter实例，并将它们组织成对请求处理的链条，这里正是Tomcat与J2EE规范相结合的部分。</li>
</ul>
<p>默认情况下，Tomcat只有一个Acceptor线程，Acceptor不断循环从ServerSocket中获取Socket，当并发数大的情况下，这里会不会有性能问题？我想说的是，Acceptor的实现非常轻量级，它只负责两个动作：获取Socket和将Socket转交给SocketProcessor线程处理。另外，我们可以通过在server.xml的Connector配置中增加acceptorThreadCount的值，让我们同时可以拥有多个Acceptor线程。虽然我们可以修改maxThreads配置把SocketProcessor的线程数设置的很大，但是我们需要区别对待：</p>
<p>如果你部署在Tomcat上的Web服务主要用于计算，那么CPU的开销势必会很大，那么线程数不宜设置的过大，一般以CPU核数<em>2——CPU核数</em>3最佳。当然如果计算量非常大，就已经超出了Tomcat的使用范畴，我想此时，选择离线计算框架Hadoop或者实时计算框架Storm、Spark才是更好的选择。</p>
<p>如果部署在Tomcat上的Web服务主要是为了提供数据库访问，此时I/O的开销会很大，而CPU利用率反而低，此时应该将线程数设置的大一些，但是如果设置的过大，CPU为了给成百上千个线程分配时间片，造成CPU的精力都分散在线程切换上，反而造成性能下降。具体多大，需要对系统性能调优得出。</p>
<p>原理就讲这么多，下面具体分析下Tomcat处理请求的具体实现。</p>
<h4 id="接受请求"><a href="#接受请求" class="headerlink" title="接受请求"></a>接受请求</h4><p>JIoEndpoint类结构：<br><img src="http://i.imgur.com/OjxF6fh.png" alt=""></p>
<p>JIoEndpoint的内部类Acceptor，Acceptor实现了Runnable接口。Acceptor作为后台线程不断循环，每次循环都会接收来自浏览器的Socket连接（用户在浏览器输入HTTP请求地址后，浏览器底层实际使用Socket通信的），最后将Socket交给外部类JIoEndpoint的processSocket方法处理。</p>
<p>JIoEndpoint的Acceptor线程在接收到用户的请求之后，调用processSocket方法。该方法主要是从Executor请求处理线程池中获取一个线程，然后启用一个新线程执行Socket请求，JIoEndpoint的processSocket()方法的核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Process a new connection from a new client. Wraps the socket so</div><div class="line">    * keep-alive and other attributes can be tracked and then passes the socket</div><div class="line">    * to the executor for processing.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> socket    The socket associated with the client.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@return</span>          &lt;code&gt;true&lt;/code&gt; if the socket is passed to the</div><div class="line">    *                  executor, &lt;code&gt;false&lt;/code&gt; if something went wrong or</div><div class="line">    *                  if the endpoint is shutting down. Returning</div><div class="line">    *                  &lt;code&gt;false&lt;/code&gt; is an indication to close the socket</div><div class="line">    *                  immediately.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">processSocket</span><span class="params">(Socket socket)</span> </span>&#123;</div><div class="line">       <span class="comment">// Process the request from this socket</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           SocketWrapper&lt;Socket&gt; wrapper = <span class="keyword">new</span> SocketWrapper&lt;&gt;(socket);</div><div class="line">           wrapper.setKeepAliveLeft(getMaxKeepAliveRequests());</div><div class="line">           wrapper.setSecure(isSSLEnabled());</div><div class="line">           <span class="comment">// During shutdown, executor may be null - avoid NPE</span></div><div class="line">           <span class="keyword">if</span> (!running) &#123;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">           &#125;</div><div class="line">           getExecutor().execute(<span class="keyword">new</span> SocketProcessor(wrapper));</div><div class="line">       &#125; <span class="keyword">catch</span> (RejectedExecutionException x) &#123;</div><div class="line">           log.warn(<span class="string">"Socket processing request was rejected for:"</span>+socket,x);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">           ExceptionUtils.handleThrowable(t);</div><div class="line">           <span class="comment">// This means we got an OOM or similar creating a thread, or that</span></div><div class="line">           <span class="comment">// the pool and its queue are full</span></div><div class="line">           log.error(sm.getString(<span class="string">"endpoint.process.fail"</span>), t);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>上述代码主要做以下工作：</p>
<ol>
<li>把Socket包装成SocketWrapper</li>
<li>给SocketWrapper设置连接保持时间keepAliveLeft。这个值是通过调用父类AbstractEndpoint的getMaxKeepAliveRequests方法（见代码清单2）获得的</li>
<li>创建SocketProcessor（此类也是JIoEndpoint的内部类，而且也实现了Runnable接口，见如下代码），并使用线程池。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * This class is the equivalent of the Worker, but will simply use in an</div><div class="line">     * external Executor thread pool.</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketProcessor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">protected</span> SocketWrapper&lt;Socket&gt; socket = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">protected</span> SocketStatus status = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SocketProcessor</span><span class="params">(SocketWrapper&lt;Socket&gt; socket)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (socket==<span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">            <span class="keyword">this</span>.socket = socket;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SocketProcessor</span><span class="params">(SocketWrapper&lt;Socket&gt; socket, SocketStatus status)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>(socket);</div><div class="line">            <span class="keyword">this</span>.status = status;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">boolean</span> launch = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">synchronized</span> (socket) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    SocketState state = SocketState.OPEN;</div><div class="line">                    handler.beforeHandshake(socket);</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// SSL handshake</span></div><div class="line">                        serverSocketFactory.handshake(socket.getSocket());</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                        ExceptionUtils.handleThrowable(t);</div><div class="line">                        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                            log.debug(sm.getString(<span class="string">"endpoint.err.handshake"</span>), t);</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// Tell to close the socket</span></div><div class="line">                        state = SocketState.CLOSED;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> ((state != SocketState.CLOSED)) &#123;</div><div class="line">                        <span class="keyword">if</span> (status == <span class="keyword">null</span>) &#123;</div><div class="line">                            state = handler.process(socket, SocketStatus.OPEN_READ);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            state = handler.process(socket,status);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (state == SocketState.CLOSED) &#123;</div><div class="line">                        <span class="comment">// Close socket</span></div><div class="line">                        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</div><div class="line">                            log.trace(<span class="string">"Closing socket:"</span>+socket);</div><div class="line">                        &#125;</div><div class="line">                        countDownConnection();</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            socket.getSocket().close();</div><div class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                            <span class="comment">// Ignore</span></div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.OPEN ||</div><div class="line">                            state == SocketState.UPGRADING  ||</div><div class="line">                            state == SocketState.UPGRADED)&#123;</div><div class="line">                        socket.setKeptAlive(<span class="keyword">true</span>);</div><div class="line">                        socket.access();</div><div class="line">                        launch = <span class="keyword">true</span>;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.LONG) &#123;</div><div class="line">                        socket.access();</div><div class="line">                        waitingRequests.add(socket);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (launch) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            getExecutor().execute(<span class="keyword">new</span> SocketProcessor(socket, SocketStatus.OPEN_READ));</div><div class="line">                        &#125; <span class="keyword">catch</span> (RejectedExecutionException x) &#123;</div><div class="line">                            log.warn(<span class="string">"Socket reprocessing request was rejected for:"</span>+socket,x);</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                <span class="comment">//unable to handle connection at this time</span></div><div class="line">                                handler.process(socket, SocketStatus.DISCONNECT);</div><div class="line">                            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                                countDownConnection();</div><div class="line">                            &#125;</div><div class="line"></div><div class="line"></div><div class="line">                        &#125; <span class="keyword">catch</span> (NullPointerException npe) &#123;</div><div class="line">                            <span class="keyword">if</span> (running) &#123;</div><div class="line">                                log.error(sm.getString(<span class="string">"endpoint.launch.fail"</span>),</div><div class="line">                                        npe);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            socket = <span class="keyword">null</span>;</div><div class="line">            <span class="comment">// Finish up this request</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>SocketProcessor线程专门用于处理Acceptor转交的Socket，其执行步骤如下:</p>
<ol>
<li>调用handler的process方法处理请求。当处理Http11Protocol协议时，handler默认为Http11Protocol的内部类Http11ConnectionHandler；</li>
<li>请求处理完毕后，如果state等于SocketState.CLOSED，则关闭Socket；如果state等于SocketState.OPEN，则保持连接；如果state等于SocketState.LONG，则会作为长连接对待。</li>
</ol>
<p>在Http11ConnectionHandler中会根据当前请求的协议类型去创建相应的协议处理器，我们这里分析的是HTTP协议，所以会创建Http11Processor去执行process()方法， 拿到Socket数据包后解析生成Tomcat内部的Request对象与Response对象。其中Request对象只是解析Header部分内容，请求参数等做延迟处理，接着就开始调用CoyoteAdapter类进入容器处理， </p>
<p>AbstractHttp11Processor中process方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Process pipelined HTTP requests using the specified input and output</div><div class="line">     * streams.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> socketWrapper Socket from which the HTTP requests will be read</div><div class="line">     *               and the HTTP responses will be written.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> IOException error during an I/O operation</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapper&lt;S&gt; socketWrapper)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException &#123;</div><div class="line">        RequestInfo rp = request.getRequestProcessor();</div><div class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_PARSE);</div><div class="line"></div><div class="line">        <span class="comment">// Setting up the I/O</span></div><div class="line">        setSocketWrapper(socketWrapper);</div><div class="line">        getInputBuffer().init(socketWrapper, endpoint);</div><div class="line">        getOutputBuffer().init(socketWrapper, endpoint);</div><div class="line"></div><div class="line">        <span class="comment">// Flags</span></div><div class="line">        keepAlive = <span class="keyword">true</span>;</div><div class="line">        comet = <span class="keyword">false</span>;</div><div class="line">        openSocket = <span class="keyword">false</span>;</div><div class="line">        sendfileInProgress = <span class="keyword">false</span>;</div><div class="line">        readComplete = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (endpoint.getUsePolling()) &#123;</div><div class="line">            keptAlive = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            keptAlive = socketWrapper.isKeptAlive();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (disableKeepAlive()) &#123;</div><div class="line">            socketWrapper.setKeepAliveLeft(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (!getErrorState().isError() &amp;&amp; keepAlive &amp;&amp; !comet &amp;&amp; !isAsync() &amp;&amp;</div><div class="line">                upgradeToken == <span class="keyword">null</span> &amp;&amp; !endpoint.isPaused()) &#123;</div><div class="line"></div><div class="line">            <span class="comment">// Parsing the request header</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                setRequestLineReadTimeout();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (!getInputBuffer().parseRequestLine(keptAlive)) &#123;</div><div class="line">                    <span class="keyword">if</span> (handleIncompleteRequestLineRead()) &#123;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (endpoint.isPaused()) &#123;</div><div class="line">                    <span class="comment">// 503 - Service unavailable</span></div><div class="line">                    response.setStatus(<span class="number">503</span>);</div><div class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, <span class="keyword">null</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    keptAlive = <span class="keyword">true</span>;</div><div class="line">                    <span class="comment">// Set this every time in case limit has been changed via JMX</span></div><div class="line">                    request.getMimeHeaders().setLimit(endpoint.getMaxHeaderCount());</div><div class="line">                    request.getCookies().setLimit(getMaxCookieCount());</div><div class="line">                    <span class="comment">// Currently only NIO will ever return false here</span></div><div class="line">                    <span class="keyword">if</span> (!getInputBuffer().parseHeaders()) &#123;</div><div class="line">                        <span class="comment">// We've read part of the request, don't recycle it</span></div><div class="line">                        <span class="comment">// instead associate it with the socket</span></div><div class="line">                        openSocket = <span class="keyword">true</span>;</div><div class="line">                        readComplete = <span class="keyword">false</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (!disableUploadTimeout) &#123;</div><div class="line">                        setSocketTimeout(connectionUploadTimeout);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</div><div class="line">                    getLog().debug(</div><div class="line">                            sm.getString(<span class="string">"http11processor.header.parse"</span>), e);</div><div class="line">                &#125;</div><div class="line">                setErrorState(ErrorState.CLOSE_NOW, e);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                ExceptionUtils.handleThrowable(t);</div><div class="line">                UserDataHelper.Mode logMode = userDataHelper.getNextMode();</div><div class="line">                <span class="keyword">if</span> (logMode != <span class="keyword">null</span>) &#123;</div><div class="line">                    String message = sm.getString(</div><div class="line">                            <span class="string">"http11processor.header.parse"</span>);</div><div class="line">                    <span class="keyword">switch</span> (logMode) &#123;</div><div class="line">                        <span class="keyword">case</span> INFO_THEN_DEBUG:</div><div class="line">                            message += sm.getString(</div><div class="line">                                    <span class="string">"http11processor.fallToDebug"</span>);</div><div class="line">                            <span class="comment">//$FALL-THROUGH$</span></div><div class="line">                        <span class="keyword">case</span> INFO:</div><div class="line">                            getLog().info(message, t);</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        <span class="keyword">case</span> DEBUG:</div><div class="line">                            getLog().debug(message, t);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 400 - Bad Request</span></div><div class="line">                response.setStatus(<span class="number">400</span>);</div><div class="line">                setErrorState(ErrorState.CLOSE_CLEAN, t);</div><div class="line">                getAdapter().log(request, response, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!getErrorState().isError()) &#123;</div><div class="line">                <span class="comment">// Setting up filters, and parse some request headers</span></div><div class="line">                rp.setStage(org.apache.coyote.Constants.STAGE_PREPARE);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    prepareRequest();</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    ExceptionUtils.handleThrowable(t);</div><div class="line">                    <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</div><div class="line">                        getLog().debug(sm.getString(</div><div class="line">                                <span class="string">"http11processor.request.prepare"</span>), t);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// 500 - Internal Server Error</span></div><div class="line">                    response.setStatus(<span class="number">500</span>);</div><div class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, t);</div><div class="line">                    getAdapter().log(request, response, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (maxKeepAliveRequests == <span class="number">1</span>) &#123;</div><div class="line">                keepAlive = <span class="keyword">false</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxKeepAliveRequests &gt; <span class="number">0</span> &amp;&amp;</div><div class="line">                    socketWrapper.decrementKeepAlive() &lt;= <span class="number">0</span>) &#123;</div><div class="line">                keepAlive = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Process the request in the adapter</span></div><div class="line">            <span class="keyword">if</span> (!getErrorState().isError()) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    rp.setStage(org.apache.coyote.Constants.STAGE_SERVICE);</div><div class="line">                    getAdapter().service(request, response);</div><div class="line">                    <span class="comment">// Handle when the response was committed before a serious</span></div><div class="line">                    <span class="comment">// error occurred.  Throwing a ServletException should both</span></div><div class="line">                    <span class="comment">// set the status to 500 and set the errorException.</span></div><div class="line">                    <span class="comment">// If we fail here, then the response is likely already</span></div><div class="line">                    <span class="comment">// committed, so we can't try and set headers.</span></div><div class="line">                    <span class="keyword">if</span>(keepAlive &amp;&amp; !getErrorState().isError() &amp;&amp; !isAsync() &amp;&amp;</div><div class="line">                            statusDropsConnection(response.getStatus())) &#123;</div><div class="line">                        setErrorState(ErrorState.CLOSE_CLEAN, <span class="keyword">null</span>);</div><div class="line">                    &#125;</div><div class="line">                    setCometTimeouts(socketWrapper);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedIOException e) &#123;</div><div class="line">                    setErrorState(ErrorState.CLOSE_NOW, e);</div><div class="line">                &#125; <span class="keyword">catch</span> (HeadersTooLargeException e) &#123;</div><div class="line">                    getLog().error(sm.getString(<span class="string">"http11processor.request.process"</span>), e);</div><div class="line">                    <span class="comment">// The response should not have been committed but check it</span></div><div class="line">                    <span class="comment">// anyway to be safe</span></div><div class="line">                    <span class="keyword">if</span> (response.isCommitted()) &#123;</div><div class="line">                        setErrorState(ErrorState.CLOSE_NOW, e);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        response.reset();</div><div class="line">                        response.setStatus(<span class="number">500</span>);</div><div class="line">                        setErrorState(ErrorState.CLOSE_CLEAN, e);</div><div class="line">                        response.setHeader(<span class="string">"Connection"</span>, <span class="string">"close"</span>); <span class="comment">// <span class="doctag">TODO:</span> Remove</span></div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    ExceptionUtils.handleThrowable(t);</div><div class="line">                    getLog().error(sm.getString(<span class="string">"http11processor.request.process"</span>), t);</div><div class="line">                    <span class="comment">// 500 - Internal Server Error</span></div><div class="line">                    response.setStatus(<span class="number">500</span>);</div><div class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, t);</div><div class="line">                    getAdapter().log(request, response, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Finish the handling of the request</span></div><div class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_ENDINPUT);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet) &#123;</div><div class="line">                <span class="keyword">if</span> (getErrorState().isError()) &#123;</div><div class="line">                    <span class="comment">// If we know we are closing the connection, don't drain</span></div><div class="line">                    <span class="comment">// input. This way uploading a 100GB file doesn't tie up the</span></div><div class="line">                    <span class="comment">// thread if the servlet has rejected it.</span></div><div class="line">                    getInputBuffer().setSwallowInput(<span class="keyword">false</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Need to check this again here in case the response was</span></div><div class="line">                    <span class="comment">// committed before the error that requires the connection</span></div><div class="line">                    <span class="comment">// to be closed occurred.</span></div><div class="line">                    checkExpectationAndResponseStatus();</div><div class="line">                &#125;</div><div class="line">                endRequest();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_ENDOUTPUT);</div><div class="line"></div><div class="line">            <span class="comment">// If there was an error, make sure the request is counted as</span></div><div class="line">            <span class="comment">// and error, and update the statistics counter</span></div><div class="line">            <span class="keyword">if</span> (getErrorState().isError()) &#123;</div><div class="line">                response.setStatus(<span class="number">500</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet || getErrorState().isError()) &#123;</div><div class="line">                request.updateCounters();</div><div class="line">                <span class="keyword">if</span> (getErrorState().isIoAllowed()) &#123;</div><div class="line">                    getInputBuffer().nextRequest();</div><div class="line">                    getOutputBuffer().nextRequest();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!disableUploadTimeout) &#123;</div><div class="line">                <span class="keyword">if</span>(endpoint.getSoTimeout() &gt; <span class="number">0</span>) &#123;</div><div class="line">                    setSocketTimeout(endpoint.getSoTimeout());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    setSocketTimeout(<span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (breakKeepAliveLoop(socketWrapper)) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (getErrorState().isError() || endpoint.isPaused()) &#123;</div><div class="line">            <span class="keyword">return</span> SocketState.CLOSED;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isAsync() || comet) &#123;</div><div class="line">            <span class="keyword">return</span> SocketState.LONG;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUpgrade()) &#123;</div><div class="line">            <span class="keyword">return</span> SocketState.UPGRADING;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (sendfileInProgress) &#123;</div><div class="line">                <span class="keyword">return</span> SocketState.SENDFILE;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (openSocket) &#123;</div><div class="line">                    <span class="keyword">if</span> (readComplete) &#123;</div><div class="line">                        <span class="keyword">return</span> SocketState.OPEN;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">return</span> SocketState.LONG;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">return</span> SocketState.CLOSED;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>由代码可知，Http11Processor的process方法主要执行以下操作：</p>
<ol>
<li>设置SocketWrapper  </li>
<li>获取Socket中的inputStream设置到inputBuffer,也就是设置到Request中 </li>
<li>获取Socket中的outputStream设置到outputBuffer,也就是设置到Response中</li>
<li>解析HTTP请求的method,requestURI,protocol等//parseRequestLine(keptAlive)</li>
<li>解析HTTP请求的报头headers  //parseHeaders()</li>
<li>准备Request,根据已解析的信息做一些过滤//prepareRequest();</li>
<li>调用CoyoteAdapter的service方法,传入org.apache.coyote.Request对象及org.apache.coyote.Response对象//adapter.service(request, response); </li>
</ol>
<p>service方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Service method.</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(org.apache.coyote.Request req,</span></span></div><div class="line">                        org.apache.coyote.Response res)</div><div class="line">        <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">        Request request = (Request) req.getNote(ADAPTER_NOTES);</div><div class="line">        Response response = (Response) res.getNote(ADAPTER_NOTES);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">            <span class="comment">// Create objects</span></div><div class="line">            request = connector.createRequest();</div><div class="line">            request.setCoyoteRequest(req);</div><div class="line">            response = connector.createResponse();</div><div class="line">            response.setCoyoteResponse(res);</div><div class="line"></div><div class="line">            <span class="comment">// Link objects</span></div><div class="line">            request.setResponse(response);</div><div class="line">            response.setRequest(request);</div><div class="line"></div><div class="line">            <span class="comment">// Set as notes</span></div><div class="line">            req.setNote(ADAPTER_NOTES, request);</div><div class="line">            res.setNote(ADAPTER_NOTES, response);</div><div class="line"></div><div class="line">            <span class="comment">// Set query string encoding</span></div><div class="line">            req.getParameters().setQueryStringEncoding</div><div class="line">                (connector.getURIEncoding());</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (connector.getXpoweredBy()) &#123;</div><div class="line">            response.addHeader(<span class="string">"X-Powered-By"</span>, POWERED_BY);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> comet = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">boolean</span> async = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">boolean</span> postParseSuccess = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Parse and set Catalina and configuration specific</span></div><div class="line">            <span class="comment">// request parameters</span></div><div class="line">            req.getRequestProcessor().setWorkerThreadName(THREAD_NAME.get());</div><div class="line">            postParseSuccess = postParseRequest(req, request, res, response);</div><div class="line">            <span class="keyword">if</span> (postParseSuccess) &#123;</div><div class="line">                <span class="comment">//check valves if we support async</span></div><div class="line">                request.setAsyncSupported(connector.getService().getContainer().getPipeline().isAsyncSupported());</div><div class="line">                <span class="comment">// Calling the container</span></div><div class="line">                connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (request.isComet()) &#123;</div><div class="line">                    <span class="keyword">if</span> (!response.isClosed() &amp;&amp; !response.isError()) &#123;</div><div class="line">                        comet = <span class="keyword">true</span>;</div><div class="line">                        res.action(ActionCode.COMET_BEGIN, <span class="keyword">null</span>);</div><div class="line">                        <span class="keyword">if</span> (request.getAvailable() || (request.getContentLength() &gt; <span class="number">0</span> &amp;&amp; (!request.isParametersParsed()))) &#123;</div><div class="line">                            <span class="comment">// Invoke a read event right away if there are available bytes</span></div><div class="line">                            event(req, res, SocketStatus.OPEN_READ);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">// Clear the filter chain, as otherwise it will not be reset elsewhere</span></div><div class="line">                        <span class="comment">// since this is a Comet request</span></div><div class="line">                        request.setFilterChain(<span class="keyword">null</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (request.isAsync()) &#123;</div><div class="line">                async = <span class="keyword">true</span>;</div><div class="line">                ReadListener readListener = req.getReadListener();</div><div class="line">                <span class="keyword">if</span> (readListener != <span class="keyword">null</span> &amp;&amp; request.isFinished()) &#123;</div><div class="line">                    <span class="comment">// Possible the all data may have been read during service()</span></div><div class="line">                    <span class="comment">// method so this needs to be checked here</span></div><div class="line">                    ClassLoader oldCL = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        oldCL = request.getContext().bind(<span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">                        <span class="keyword">if</span> (req.sendAllDataReadEvent()) &#123;</div><div class="line">                            req.getReadListener().onAllDataRead();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        request.getContext().unbind(<span class="keyword">false</span>, oldCL);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                Throwable throwable =</div><div class="line">                        (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</div><div class="line"></div><div class="line">                <span class="comment">// If an async request was started, is not going to end once</span></div><div class="line">                <span class="comment">// this container thread finishes and an error occurred, trigger</span></div><div class="line">                <span class="comment">// the async error process</span></div><div class="line">                <span class="keyword">if</span> (!request.isAsyncCompleting() &amp;&amp; throwable != <span class="keyword">null</span>) &#123;</div><div class="line">                    request.getAsyncContextInternal().setErrorState(throwable, <span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!comet) &#123;</div><div class="line">                request.finishRequest();</div><div class="line">                response.finishResponse();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="comment">// Ignore</span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// Access log</span></div><div class="line">            <span class="keyword">if</span> (!async &amp;&amp; !comet) &#123;</div><div class="line">                <span class="keyword">if</span> (postParseSuccess) &#123;</div><div class="line">                    <span class="comment">// Log only if processing was invoked.</span></div><div class="line">                    <span class="comment">// If postParseRequest() failed, it has already logged it.</span></div><div class="line">                    <span class="comment">// If context is null this was the start of a comet request</span></div><div class="line">                    <span class="comment">// that failed and has already been logged.</span></div><div class="line">                    request.getMappingData().context.logAccess(</div><div class="line">                            request, response,</div><div class="line">                            System.currentTimeMillis() - req.getStartTime(),</div><div class="line">                            <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            req.getRequestProcessor().setWorkerThreadName(<span class="keyword">null</span>);</div><div class="line">            AtomicBoolean error = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">            res.action(ActionCode.IS_ERROR, error);</div><div class="line"></div><div class="line">            <span class="comment">// Recycle the wrapper request and response</span></div><div class="line">            <span class="keyword">if</span> (!comet &amp;&amp; !async || error.get()) &#123;</div><div class="line">                request.recycle();</div><div class="line">                response.recycle();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Clear converters so that the minimum amount of memory</span></div><div class="line">                <span class="comment">// is used by this processor</span></div><div class="line">                request.clearEncoders();</div><div class="line">                response.clearEncoders();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上述代码可以看出，CoyoteAdapter的service方法的执行步骤如下：</p>
<ol>
<li>创建Request与Response对象并且关联起来；</li>
<li>调用postParseRequest方法（见代码清单10）对请求进行解析；//postParseSuccess = postParseRequest(req, request, res, response);  </li>
<li>将真正的请求处理交给Engine的Pipeline去处理，代码：connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);//开始调用Tomcat的容器，首先调用StandardEngine容器中管道Pipeline中的第一个Valve,传入connector.Request和connector.Response</li>
<li>完成此次请求 // request.finishRequest();  </li>
<li>完成此次响应,并提交响应信息,如果response已经提交则直接返回，否则提交response  // response.finishResponse();  </li>
</ol>
<p>其中postParseRequest()方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Perform the necessary processing after the HTTP headers have been parsed</div><div class="line">     * to enable the request/response pair to be passed to the start of the</div><div class="line">     * container pipeline for processing.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> req      The coyote request object</div><div class="line">     * <span class="doctag">@param</span> request  The catalina request object</div><div class="line">     * <span class="doctag">@param</span> res      The coyote response object</div><div class="line">     * <span class="doctag">@param</span> response The catalina response object</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> &lt;code&gt;true&lt;/code&gt; if the request should be passed on to the start</div><div class="line">     *         of the container pipeline, otherwise &lt;code&gt;false&lt;/code&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> IOException If there is insufficient space in a buffer while</div><div class="line">     *                     processing headers</div><div class="line">     * <span class="doctag">@throws</span> ServletException If the supported methods of the target servlet</div><div class="line">     *                          can not be determined</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">postParseRequest</span><span class="params">(org.apache.coyote.Request req, Request request,</span></span></div><div class="line">            org.apache.coyote.Response res, Response response) <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// If the processor has set the scheme (AJP will do this) use this to</span></div><div class="line">        <span class="comment">// set the secure flag as well. If the processor hasn't set it, use the</span></div><div class="line">        <span class="comment">// settings from the connector</span></div><div class="line">        <span class="keyword">if</span> (! req.scheme().isNull()) &#123;</div><div class="line">            <span class="comment">// use processor specified scheme to determine secure state</span></div><div class="line">            request.setSecure(req.scheme().equals(<span class="string">"https"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// use connector scheme and secure configuration, (defaults to</span></div><div class="line">            <span class="comment">// "http" and false respectively)</span></div><div class="line">            req.scheme().setString(connector.getScheme());</div><div class="line">            request.setSecure(connector.getSecure());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// At this point the Host header has been processed.</span></div><div class="line">        <span class="comment">// Override if the proxyPort/proxyHost are set</span></div><div class="line">        String proxyName = connector.getProxyName();</div><div class="line">        <span class="keyword">int</span> proxyPort = connector.getProxyPort();</div><div class="line">        <span class="keyword">if</span> (proxyPort != <span class="number">0</span>) &#123;</div><div class="line">            req.setServerPort(proxyPort);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (proxyName != <span class="keyword">null</span>) &#123;</div><div class="line">            req.serverName().setString(proxyName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        MessageBytes undecodedURI = req.requestURI();</div><div class="line"></div><div class="line">        <span class="comment">// Check for ping OPTIONS * request</span></div><div class="line">        <span class="keyword">if</span> (undecodedURI.equals(<span class="string">"*"</span>)) &#123;</div><div class="line">            <span class="keyword">if</span> (req.method().equalsIgnoreCase(<span class="string">"OPTIONS"</span>)) &#123;</div><div class="line">                StringBuilder allow = <span class="keyword">new</span> StringBuilder();</div><div class="line">                allow.append(<span class="string">"GET, HEAD, POST, PUT, DELETE"</span>);</div><div class="line">                <span class="comment">// Trace if allowed</span></div><div class="line">                <span class="keyword">if</span> (connector.getAllowTrace()) &#123;</div><div class="line">                    allow.append(<span class="string">", TRACE"</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Always allow options</span></div><div class="line">                allow.append(<span class="string">", OPTIONS"</span>);</div><div class="line">                res.setHeader(<span class="string">"Allow"</span>, allow.toString());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                res.setStatus(<span class="number">404</span>);</div><div class="line">                res.setMessage(<span class="string">"Not found"</span>);</div><div class="line">            &#125;</div><div class="line">            connector.getService().getContainer().logAccess(</div><div class="line">                    request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        MessageBytes decodedURI = req.decodedURI();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (undecodedURI.getType() == MessageBytes.T_BYTES) &#123;</div><div class="line">            <span class="comment">// Copy the raw URI to the decodedURI</span></div><div class="line">            decodedURI.duplicate(undecodedURI);</div><div class="line"></div><div class="line">            <span class="comment">// Parse the path parameters. This will:</span></div><div class="line">            <span class="comment">//   - strip out the path parameters</span></div><div class="line">            <span class="comment">//   - convert the decodedURI to bytes</span></div><div class="line">            parsePathParameters(req, request);</div><div class="line"></div><div class="line">            <span class="comment">// URI decoding</span></div><div class="line">            <span class="comment">// %xx decoding of the URL</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                req.getURLDecoder().convert(decodedURI, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</div><div class="line">                res.setStatus(<span class="number">400</span>);</div><div class="line">                res.setMessage(<span class="string">"Invalid URI: "</span> + ioe.getMessage());</div><div class="line">                connector.getService().getContainer().logAccess(</div><div class="line">                        request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Normalization</span></div><div class="line">            <span class="keyword">if</span> (!normalize(req.decodedURI())) &#123;</div><div class="line">                res.setStatus(<span class="number">400</span>);</div><div class="line">                res.setMessage(<span class="string">"Invalid URI"</span>);</div><div class="line">                connector.getService().getContainer().logAccess(</div><div class="line">                        request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Character decoding</span></div><div class="line">            convertURI(decodedURI, request);</div><div class="line">            <span class="comment">// Check that the URI is still normalized</span></div><div class="line">            <span class="keyword">if</span> (!checkNormalize(req.decodedURI())) &#123;</div><div class="line">                res.setStatus(<span class="number">400</span>);</div><div class="line">                res.setMessage(<span class="string">"Invalid URI character encoding"</span>);</div><div class="line">                connector.getService().getContainer().logAccess(</div><div class="line">                        request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">/* The URI is chars or String, and has been sent using an in-memory</span></div><div class="line">             * protocol handler. The following assumptions are made:</div><div class="line">             * - req.requestURI() has been set to the 'original' non-decoded,</div><div class="line">             *   non-normalized URI</div><div class="line">             * - req.decodedURI() has been set to the decoded, normalized form</div><div class="line">             *   of req.requestURI()</div><div class="line">             */</div><div class="line">            decodedURI.toChars();</div><div class="line">            <span class="comment">// Remove all path parameters; any needed path parameter should be set</span></div><div class="line">            <span class="comment">// using the request object rather than passing it in the URL</span></div><div class="line">            CharChunk uriCC = decodedURI.getCharChunk();</div><div class="line">            <span class="keyword">int</span> semicolon = uriCC.indexOf(<span class="string">';'</span>);</div><div class="line">            <span class="keyword">if</span> (semicolon &gt; <span class="number">0</span>) &#123;</div><div class="line">                decodedURI.setChars</div><div class="line">                    (uriCC.getBuffer(), uriCC.getStart(), semicolon);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Request mapping.</span></div><div class="line">        MessageBytes serverName;</div><div class="line">        <span class="keyword">if</span> (connector.getUseIPVHosts()) &#123;</div><div class="line">            serverName = req.localName();</div><div class="line">            <span class="keyword">if</span> (serverName.isNull()) &#123;</div><div class="line">                <span class="comment">// well, they did ask for it</span></div><div class="line">                res.action(ActionCode.REQ_LOCAL_NAME_ATTRIBUTE, <span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            serverName = req.serverName();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Version for the second mapping loop and</span></div><div class="line">        <span class="comment">// Context that we expect to get for that version</span></div><div class="line">        String version = <span class="keyword">null</span>;</div><div class="line">        Context versionContext = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">boolean</span> mapRequired = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (mapRequired) &#123;</div><div class="line">            <span class="comment">// This will map the the latest version by default</span></div><div class="line">            connector.getService().getMapper().map(serverName, decodedURI,</div><div class="line">                    version, request.getMappingData());</div><div class="line"></div><div class="line">            <span class="comment">// If there is no context at this point, it is likely no ROOT context</span></div><div class="line">            <span class="comment">// has been deployed</span></div><div class="line">            <span class="keyword">if</span> (request.getContext() == <span class="keyword">null</span>) &#123;</div><div class="line">                res.setStatus(<span class="number">404</span>);</div><div class="line">                res.setMessage(<span class="string">"Not found"</span>);</div><div class="line">                <span class="comment">// No context, so use host</span></div><div class="line">                Host host = request.getHost();</div><div class="line">                <span class="comment">// Make sure there is a host (might not be during shutdown)</span></div><div class="line">                <span class="keyword">if</span> (host != <span class="keyword">null</span>) &#123;</div><div class="line">                    host.logAccess(request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Now we have the context, we can parse the session ID from the URL</span></div><div class="line">            <span class="comment">// (if any). Need to do this before we redirect in case we need to</span></div><div class="line">            <span class="comment">// include the session id in the redirect</span></div><div class="line">            String sessionID;</div><div class="line">            <span class="keyword">if</span> (request.getServletContext().getEffectiveSessionTrackingModes()</div><div class="line">                    .contains(SessionTrackingMode.URL)) &#123;</div><div class="line"></div><div class="line">                <span class="comment">// Get the session ID if there was one</span></div><div class="line">                sessionID = request.getPathParameter(</div><div class="line">                        SessionConfig.getSessionUriParamName(</div><div class="line">                                request.getContext()));</div><div class="line">                <span class="keyword">if</span> (sessionID != <span class="keyword">null</span>) &#123;</div><div class="line">                    request.setRequestedSessionId(sessionID);</div><div class="line">                    request.setRequestedSessionURL(<span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Look for session ID in cookies and SSL session</span></div><div class="line">            parseSessionCookiesId(request);</div><div class="line">            parseSessionSslId(request);</div><div class="line"></div><div class="line">            sessionID = request.getRequestedSessionId();</div><div class="line"></div><div class="line">            mapRequired = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (version != <span class="keyword">null</span> &amp;&amp; request.getContext() == versionContext) &#123;</div><div class="line">                <span class="comment">// We got the version that we asked for. That is it.</span></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                version = <span class="keyword">null</span>;</div><div class="line">                versionContext = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                Context[] contexts = request.getMappingData().contexts;</div><div class="line">                <span class="comment">// Single contextVersion means no need to remap</span></div><div class="line">                <span class="comment">// No session ID means no possibility of remap</span></div><div class="line">                <span class="keyword">if</span> (contexts != <span class="keyword">null</span> &amp;&amp; sessionID != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// Find the context associated with the session</span></div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = (contexts.length); i &gt; <span class="number">0</span>; i--) &#123;</div><div class="line">                        Context ctxt = contexts[i - <span class="number">1</span>];</div><div class="line">                        <span class="keyword">if</span> (ctxt.getManager().findSession(sessionID) != <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="comment">// We found a context. Is it the one that has</span></div><div class="line">                            <span class="comment">// already been mapped?</span></div><div class="line">                            <span class="keyword">if</span> (!ctxt.equals(request.getMappingData().context)) &#123;</div><div class="line">                                <span class="comment">// Set version so second time through mapping</span></div><div class="line">                                <span class="comment">// the correct context is found</span></div><div class="line">                                version = ctxt.getWebappVersion();</div><div class="line">                                versionContext = ctxt;</div><div class="line">                                <span class="comment">// Reset mapping</span></div><div class="line">                                request.getMappingData().recycle();</div><div class="line">                                mapRequired = <span class="keyword">true</span>;</div><div class="line">                                <span class="comment">// Recycle cookies and session info in case the</span></div><div class="line">                                <span class="comment">// correct context is configured with different</span></div><div class="line">                                <span class="comment">// settings</span></div><div class="line">                                request.recycleSessionInfo();</div><div class="line">                                request.recycleCookieInfo(<span class="keyword">true</span>);</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!mapRequired &amp;&amp; request.getContext().getPaused()) &#123;</div><div class="line">                <span class="comment">// Found a matching context but it is paused. Mapping data will</span></div><div class="line">                <span class="comment">// be wrong since some Wrappers may not be registered at this</span></div><div class="line">                <span class="comment">// point.</span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">1000</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    <span class="comment">// Should never happen</span></div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Reset mapping</span></div><div class="line">                request.getMappingData().recycle();</div><div class="line">                mapRequired = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Possible redirect</span></div><div class="line">        MessageBytes redirectPathMB = request.getMappingData().redirectPath;</div><div class="line">        <span class="keyword">if</span> (!redirectPathMB.isNull()) &#123;</div><div class="line">            String redirectPath = URLEncoder.DEFAULT.encode(redirectPathMB.toString(), <span class="string">"UTF-8"</span>);</div><div class="line">            String query = request.getQueryString();</div><div class="line">            <span class="keyword">if</span> (request.isRequestedSessionIdFromURL()) &#123;</div><div class="line">                <span class="comment">// This is not optimal, but as this is not very common, it</span></div><div class="line">                <span class="comment">// shouldn't matter</span></div><div class="line">                redirectPath = redirectPath + <span class="string">";"</span> +</div><div class="line">                        SessionConfig.getSessionUriParamName(</div><div class="line">                            request.getContext()) +</div><div class="line">                    <span class="string">"="</span> + request.getRequestedSessionId();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (query != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// This is not optimal, but as this is not very common, it</span></div><div class="line">                <span class="comment">// shouldn't matter</span></div><div class="line">                redirectPath = redirectPath + <span class="string">"?"</span> + query;</div><div class="line">            &#125;</div><div class="line">            response.sendRedirect(redirectPath);</div><div class="line">            request.getContext().logAccess(request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Filter trace method</span></div><div class="line">        <span class="keyword">if</span> (!connector.getAllowTrace()</div><div class="line">                &amp;&amp; req.method().equalsIgnoreCase(<span class="string">"TRACE"</span>)) &#123;</div><div class="line">            Wrapper wrapper = request.getWrapper();</div><div class="line">            String header = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (wrapper != <span class="keyword">null</span>) &#123;</div><div class="line">                String[] methods = wrapper.getServletMethods();</div><div class="line">                <span class="keyword">if</span> (methods != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;methods.length; i++) &#123;</div><div class="line">                        <span class="keyword">if</span> (<span class="string">"TRACE"</span>.equals(methods[i])) &#123;</div><div class="line">                            <span class="keyword">continue</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (header == <span class="keyword">null</span>) &#123;</div><div class="line">                            header = methods[i];</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            header += <span class="string">", "</span> + methods[i];</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            res.setStatus(<span class="number">405</span>);</div><div class="line">            res.addHeader(<span class="string">"Allow"</span>, header);</div><div class="line">            res.setMessage(<span class="string">"TRACE method is not allowed"</span>);</div><div class="line">            request.getContext().logAccess(request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        doConnectorAuthenticationAuthorization(req, request);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上述代码可以看出，postParseRequest方法的执行步骤如下：</p>
<ol>
<li>解析请求url中的参数；</li>
<li>URI decoding的转换（为了保证URL的可移植、完整性、可读性，通过ASCII字符集的有限子集对任意字符或数据进行编码、解码）；</li>
<li>调用normalize方法判断请求路径中是否存在”\”, “//“, “/./“和”/../“，如果存在则处理结束；</li>
<li>调用convertURI方法将字节转换为字符；</li>
<li>调用checkNormalize方法判断uri是否存在”\”, “//“, “/./“和”/../“，如果存在则处理结束；</li>
<li>调用Connector的getMapper方法获取Mapper，然后调用Mapper的map方法（见代码清单11）对host和context进行匹配（比如<a href="http://localhost:8080/manager/status会匹配host：localhost，context：/manager），其实质是调用internalMap方法；" target="_blank" rel="external">http://localhost:8080/manager/status会匹配host：localhost，context：/manager），其实质是调用internalMap方法；</a></li>
<li>使用ApplicationSessionCookieConfig.getSessionUriParamName获取sessionid的key，然后获取sessionid；</li>
<li>调用parseSessionCookiesId和parseSessionSslId方法查找cookie或者SSL中的sessionid。</li>
</ol>
<p>现在回到CoyoteAdapter的service方法执行的第三步 3. 将真正的请求处理交给Engine的Pipeline去处理，代码：connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);//开始调用Tomcat的容器，首先调用StandardEngine容器中管道Pipeline中的第一个Valve,传入connector.Request和connector.Response</p>
<p>下面介绍一下管道：</p>
<p>管道</p>
<p>在Tomcat中管道Pipeline是一个接口，定义了使得一组阀门Valve按照顺序执行的规范，Pipeline中定义的接口如下：<br><img src="http://i.imgur.com/N2yZT8t.png" alt=""></p>
<ul>
<li>getBasic：获取管道的基础阀门；</li>
<li>setBasic：设置管道的基础阀门；</li>
<li>addValve：添加阀门；</li>
<li>getValves：获取阀门集合；</li>
<li>removeValve：移除阀门；</li>
<li>getFirst：获取第一个阀门；</li>
<li>isAsyncSupported：当管道中的所有阀门都支持异步时返回ture，否则返回false；</li>
<li>getContainer：获取管道相关联的容器，比如StandardEngine；</li>
<li>setContainer：设置管道相关联的容器。</li>
</ul>
<p>Engine、Host、Context及Wrapper等容器都定义了自身的Pipeline，每个Pipeline都包含一到多个Valve。Valve定义了各个阀门的接口规范，其类继承体系如图所示。</p>
<p><img src="http://i.imgur.com/ebCzPSy.png" alt=""></p>
<ul>
<li>Valve：定义了管道中阀门的接口规范，getNext和setNext分别用于获取或者设置当前阀门的下游阀门，invoke方法用来应用当前阀门的操作。</li>
<li>ValveBase：Valve接口的基本实现，ValveBase与Valve的具体实现采用抽象模板模式将管道中的阀门串联起来。</li>
<li>StandardEngineValve：StandardEngine中的唯一阀门，主要用于从request中选择其host映射的Host容器StandardHost。</li>
<li>AccessLogValve：StandardHost中的第一个阀门，主要用于管道执行结束之后记录日志信息。</li>
<li>ErrorReportValve：StandardHost中紧跟AccessLogValve的阀门，主要用于管道执行结束后，从request对象中获取异常信息，并封装到response中以便将问题展现给访问者。</li>
<li>StandardHostValve：StandardHost中最后的阀门，主要用于从request中选择其context映射的Context容器StandardContext以及访问request中的Session以更新会话的最后访问时间。</li>
<li>StandardContextValve：StandardContext中的唯一阀门，主要作用是禁止任何对WEB-INF或META-INF目录下资源的重定向访问，对应用程序热部署功能的实现，从request中获得StandardWrapper。</li>
<li>StandardWrapperValve：StandardWrapper中的唯一阀门，主要作用包括调用StandardWrapper的loadServlet方法生成Servlet实例和调用ApplicationFilterFactory生成Filter链。</li>
</ul>
<p>有了以上对Tomcat的管道设计的讲述，我们下面详细剖析其实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</div></pre></td></tr></table></figure>
<p>getContainer方法获取到的实际是StandardService中的StandardEngine容器,StandardEngine继承自ContainerBase，所以这里的getPipeline方法实际是ContainerBase实现的.</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Pipeline pipeline =  </div><div class="line">    CatalinaFactory.getFactory().createPipeline(<span class="keyword">this</span>);  </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Pipeline <span class="title">getPipeline</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.pipeline);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的CatalinaFactory采用单例模式实现，要获取CatalinaFactory实例，只能通过调用getFactory方法，见代码清单2。createPipeline方法中创建了StandardPipeline，StandardPipeline是Pipeline的标准实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatalinaFactory</span> </span>&#123;  </div><div class="line">      </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CatalinaFactory factory = <span class="keyword">new</span> CatalinaFactory();  </div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CatalinaFactory <span class="title">getFactory</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> factory;  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">CatalinaFactory</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="comment">// Hide the default constructor  </span></div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDefaultPipelineClassName</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> StandardPipeline.class.getName();  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> Pipeline <span class="title">createPipeline</span><span class="params">(Container container)</span> </span>&#123;  </div><div class="line">        Pipeline pipeline = <span class="keyword">new</span> StandardPipeline();  </div><div class="line">        pipeline.setContainer(container);  </div><div class="line">        <span class="keyword">return</span> pipeline;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码清单1随后调用了StandardPipeline的getFirst方法（见代码清单3）用来获取管道中的第一个Valve ，由于Tomcat并没有为StandardEngine的StandardPipeline设置first，因此将返回StandardPipeline的basic。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Valve <span class="title">getFirst</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>) &#123;  </div><div class="line">        <span class="keyword">return</span> first;  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="keyword">return</span> basic;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码清单3中的basic的类型是StandardEngineValve，那么它是何时添加到StandardEngine的StandardPipeline中的呢？还记得《server.xml文件的加载与解析》中介绍过的ObjectCreateRule？在执行ObjectCreateRule的begin方法时，会反射调用StandardEngine的构造器生成StandardEngine的实例，StandardEngine的构造器中就会给其StandardPipeline设置basic为StandardEngineValve</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Create a new StandardEngine component with the default basic Valve. </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardEngine</span><span class="params">()</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="keyword">super</span>();  </div><div class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardEngineValve());  </div><div class="line">    <span class="comment">/* Set the jmvRoute using the system property jvmRoute */</span>  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        setJvmRoute(System.getProperty(<span class="string">"jvmRoute"</span>));  </div><div class="line">    &#125; <span class="keyword">catch</span>(Exception ex) &#123;  </div><div class="line">    &#125;  </div><div class="line">    <span class="comment">// By default, the engine will hold the reloading thread  </span></div><div class="line">    backgroundProcessorDelay = <span class="number">10</span>;  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码清单1中最后调用了StandardEngineValve的invoke方法（见代码清单5）正式将请求交给管道处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Select the appropriate child Host to process this request,</div><div class="line">     * based on the requested server name.  If no matching Host can</div><div class="line">     * be found, return an appropriate HTTP error.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request Request to be processed</div><div class="line">     * <span class="doctag">@param</span> response Response to be produced</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> IOException if an input/output error occurred</div><div class="line">     * <span class="doctag">@exception</span> ServletException if a servlet error occurred</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Select the Host to be used for this Request</span></div><div class="line">        Host host = request.getHost();</div><div class="line">        <span class="keyword">if</span> (host == <span class="keyword">null</span>) &#123;</div><div class="line">            response.sendError</div><div class="line">                (HttpServletResponse.SC_BAD_REQUEST,</div><div class="line">                 sm.getString(<span class="string">"standardEngine.noHost"</span>,</div><div class="line">                              request.getServerName()));</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</div><div class="line">            request.setAsyncSupported(host.getPipeline().isAsyncSupported());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Ask this Host to process this request</span></div><div class="line">        host.getPipeline().getFirst().invoke(request, response);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上述代码首先调用request的getHost方法（实质是通过request映射的Context容器获取父容器得到，获取Host容器，</p>
<p>StandardHost默认情况下配置了ErrorReportValve阀门与StandardHostValue阀门。ErrorReportValve用于处理错误日志。StandardHostValue则选择相应的Context容器，并且把当前Web应用的WebappClassLoader设置为线程上下文类加载器，保证我们的Web应用中拿到的当前线程类加载器为此应用的类加载器， StandardHostValve的invoke()方法的核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Select the appropriate child Context to process this request,</div><div class="line">     * based on the specified request URI.  If no matching Context can</div><div class="line">     * be found, return an appropriate HTTP error.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request Request to be processed</div><div class="line">     * <span class="doctag">@param</span> response Response to be produced</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> IOException if an input/output error occurred</div><div class="line">     * <span class="doctag">@exception</span> ServletException if a servlet error occurred</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Select the Context to be used for this Request</span></div><div class="line">        Context context = request.getContext();</div><div class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</div><div class="line">            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR,</div><div class="line">                 sm.getString(<span class="string">"standardHost.noContext"</span>));</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</div><div class="line">            request.setAsyncSupported(context.getPipeline().isAsyncSupported());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> asyncAtStart = request.isAsync();</div><div class="line">        <span class="keyword">boolean</span> asyncDispatching = request.isAsyncDispatching();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            context.bind(Globals.IS_SECURITY_ENABLED, MY_CLASSLOADER);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!asyncAtStart &amp;&amp; !context.fireRequestInitEvent(request)) &#123;</div><div class="line">                <span class="comment">// Don't fire listeners during async processing (the listener</span></div><div class="line">                <span class="comment">// fired for the request that called startAsync()).</span></div><div class="line">                <span class="comment">// If a request init listener throws an exception, the request</span></div><div class="line">                <span class="comment">// is aborted.</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Ask this Context to process this request. Requests that are in</span></div><div class="line">            <span class="comment">// async mode and are not being dispatched to this resource must be</span></div><div class="line">            <span class="comment">// in error and have been routed here to check for application</span></div><div class="line">            <span class="comment">// defined error pages.</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (!asyncAtStart || asyncDispatching) &#123;</div><div class="line">                    context.getPipeline().getFirst().invoke(request, response);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Make sure this request/response is here because an error</span></div><div class="line">                    <span class="comment">// report is required.</span></div><div class="line">                    <span class="keyword">if</span> (!response.isErrorReportRequired()) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(sm.getString(<span class="string">"standardHost.asyncStateError"</span>));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                ExceptionUtils.handleThrowable(t);</div><div class="line">                container.getLogger().error(<span class="string">"Exception Processing "</span> + request.getRequestURI(), t);</div><div class="line">                <span class="comment">// If a new error occurred while trying to report a previous</span></div><div class="line">                <span class="comment">// error allow the original error to be reported.</span></div><div class="line">                <span class="keyword">if</span> (!response.isErrorReportRequired()) &#123;</div><div class="line">                    request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, t);</div><div class="line">                    throwable(request, response, t);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Now that the request/response pair is back under container</span></div><div class="line">            <span class="comment">// control lift the suspension so that the error handling can</span></div><div class="line">            <span class="comment">// complete and/or the container can flush any remaining data</span></div><div class="line">            response.setSuspended(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">            Throwable t = (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</div><div class="line"></div><div class="line">            <span class="comment">// Protect against NPEs if the context was destroyed during a</span></div><div class="line">            <span class="comment">// long running request.</span></div><div class="line">            <span class="keyword">if</span> (!context.getState().isAvailable()) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Look for (and render if found) an application level error page</span></div><div class="line">            <span class="keyword">if</span> (response.isErrorReportRequired()) &#123;</div><div class="line">                <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</div><div class="line">                    throwable(request, response, t);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    status(request, response);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!request.isAsync() &amp;&amp; (!asyncAtStart || !response.isErrorReportRequired())) &#123;</div><div class="line">                context.fireRequestDestroyEvent(request);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// Access a session (if present) to update last accessed time, based</span></div><div class="line">            <span class="comment">// on a strict interpretation of the specification</span></div><div class="line">            <span class="keyword">if</span> (ACCESS_SESSION) &#123;</div><div class="line">                request.getSession(<span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            context.unbind(Globals.IS_SECURITY_ENABLED, MY_CLASSLOADER);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上述代码主要执行以下步骤：</p>
<ol>
<li><p>得到此次请求所对应的StandardContext容器//Context context = request.getContext();</p>
</li>
<li><p>调用StandardContext容器中管道Pipeline中的第一个Valve//context.getPipeline().getFirst().invoke(request, response);</p>
</li>
</ol>
<p>StandardContext默认情况下配置了StandardContextValve阀门。对于WEB-INF与META-INF目录禁止访问的控制，之后获取一个此请求的Wrapper容器， StandardContextValve的invoke()方法核核心代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Select the appropriate child Wrapper to process this request,</div><div class="line">     * based on the specified request URI.  If no matching Wrapper can</div><div class="line">     * be found, return an appropriate HTTP error.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request Request to be processed</div><div class="line">     * <span class="doctag">@param</span> response Response to be produced</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> IOException if an input/output error occurred</div><div class="line">     * <span class="doctag">@exception</span> ServletException if a servlet error occurred</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Disallow any direct access to resources under WEB-INF or META-INF</span></div><div class="line">        MessageBytes requestPathMB = request.getRequestPathMB();</div><div class="line">        <span class="keyword">if</span> ((requestPathMB.startsWithIgnoreCase(<span class="string">"/META-INF/"</span>, <span class="number">0</span>))</div><div class="line">                || (requestPathMB.equalsIgnoreCase(<span class="string">"/META-INF"</span>))</div><div class="line">                || (requestPathMB.startsWithIgnoreCase(<span class="string">"/WEB-INF/"</span>, <span class="number">0</span>))</div><div class="line">                || (requestPathMB.equalsIgnoreCase(<span class="string">"/WEB-INF"</span>))) &#123;</div><div class="line">            response.sendError(HttpServletResponse.SC_NOT_FOUND);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Select the Wrapper to be used for this Request</span></div><div class="line">        Wrapper wrapper = request.getWrapper();</div><div class="line">        <span class="keyword">if</span> (wrapper == <span class="keyword">null</span> || wrapper.isUnavailable()) &#123;</div><div class="line">            response.sendError(HttpServletResponse.SC_NOT_FOUND);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Acknowledge the request</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            response.sendAcknowledgement();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</div><div class="line">            container.getLogger().error(sm.getString(</div><div class="line">                    <span class="string">"standardContextValve.acknowledgeException"</span>), ioe);</div><div class="line">            request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, ioe);</div><div class="line">            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</div><div class="line">            request.setAsyncSupported(wrapper.getPipeline().isAsyncSupported());</div><div class="line">        &#125;</div><div class="line">        wrapper.getPipeline().getFirst().invoke(request, response);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>得到此请求所对应的StandardWrapper容器</li>
<li>调用StandardWrapper容器中管道Pipeline中第一个Valve的invoke()方法</li>
</ol>
<p>StandardWrapper容器默认情况下配置了StandardWrapperValve阀门，主要是找到当前请求的需要拦截的过滤器Filter及初始化当前请求的Servlet对象，最终会封装在FilterChain对象中，责任链方式执行， StandardWrapperValve的invoke()方法的核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Invoke the servlet we are managing, respecting the rules regarding</div><div class="line">     * servlet lifecycle and SingleThreadModel support.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request Request to be processed</div><div class="line">     * <span class="doctag">@param</span> response Response to be produced</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> IOException if an input/output error occurred</div><div class="line">     * <span class="doctag">@exception</span> ServletException if a servlet error occurred</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Initialize local variables we may need</span></div><div class="line">        <span class="keyword">boolean</span> unavailable = <span class="keyword">false</span>;</div><div class="line">        Throwable throwable = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// This should be a Request attribute...</span></div><div class="line">        <span class="keyword">long</span> t1=System.currentTimeMillis();</div><div class="line">        requestCount.incrementAndGet();</div><div class="line">        StandardWrapper wrapper = (StandardWrapper) getContainer();</div><div class="line">        Servlet servlet = <span class="keyword">null</span>;</div><div class="line">        Context context = (Context) wrapper.getParent();</div><div class="line"></div><div class="line">        <span class="comment">// Check for the application being marked unavailable</span></div><div class="line">        <span class="keyword">if</span> (!context.getState().isAvailable()) &#123;</div><div class="line">            response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</div><div class="line">                           sm.getString(<span class="string">"standardContext.isUnavailable"</span>));</div><div class="line">            unavailable = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Check for the servlet being marked unavailable</span></div><div class="line">        <span class="keyword">if</span> (!unavailable &amp;&amp; wrapper.isUnavailable()) &#123;</div><div class="line">            container.getLogger().info(sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</div><div class="line">                    wrapper.getName()));</div><div class="line">            <span class="keyword">long</span> available = wrapper.getAvailable();</div><div class="line">            <span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</div><div class="line">                response.setDateHeader(<span class="string">"Retry-After"</span>, available);</div><div class="line">                response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</div><div class="line">                        sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</div><div class="line">                                wrapper.getName()));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</div><div class="line">                response.sendError(HttpServletResponse.SC_NOT_FOUND,</div><div class="line">                        sm.getString(<span class="string">"standardWrapper.notFound"</span>,</div><div class="line">                                wrapper.getName()));</div><div class="line">            &#125;</div><div class="line">            unavailable = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Allocate a servlet instance to process this request</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (!unavailable) &#123;</div><div class="line">                servlet = wrapper.allocate();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (UnavailableException e) &#123;</div><div class="line">            container.getLogger().error(</div><div class="line">                    sm.getString(<span class="string">"standardWrapper.allocateException"</span>,</div><div class="line">                            wrapper.getName()), e);</div><div class="line">            <span class="keyword">long</span> available = wrapper.getAvailable();</div><div class="line">            <span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</div><div class="line">                response.setDateHeader(<span class="string">"Retry-After"</span>, available);</div><div class="line">                response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</div><div class="line">                           sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</div><div class="line">                                        wrapper.getName()));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</div><div class="line">                response.sendError(HttpServletResponse.SC_NOT_FOUND,</div><div class="line">                           sm.getString(<span class="string">"standardWrapper.notFound"</span>,</div><div class="line">                                        wrapper.getName()));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">            container.getLogger().error(sm.getString(<span class="string">"standardWrapper.allocateException"</span>,</div><div class="line">                             wrapper.getName()), StandardWrapper.getRootCause(e));</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(e);</div><div class="line">            container.getLogger().error(sm.getString(<span class="string">"standardWrapper.allocateException"</span>,</div><div class="line">                             wrapper.getName()), e);</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">            servlet = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Identify if the request is Comet related now that the servlet has been allocated</span></div><div class="line">        <span class="keyword">boolean</span> comet = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (servlet <span class="keyword">instanceof</span> CometProcessor &amp;&amp; Boolean.TRUE.equals(request.getAttribute(</div><div class="line">                Globals.COMET_SUPPORTED_ATTR))) &#123;</div><div class="line">            comet = <span class="keyword">true</span>;</div><div class="line">            request.setComet(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        MessageBytes requestPathMB = request.getRequestPathMB();</div><div class="line">        DispatcherType dispatcherType = DispatcherType.REQUEST;</div><div class="line">        <span class="keyword">if</span> (request.getDispatcherType()==DispatcherType.ASYNC) dispatcherType = DispatcherType.ASYNC;</div><div class="line">        request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,dispatcherType);</div><div class="line">        request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,</div><div class="line">                requestPathMB);</div><div class="line">        <span class="comment">// Create the filter chain for this request</span></div><div class="line">        ApplicationFilterChain filterChain =</div><div class="line">                ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</div><div class="line"></div><div class="line">        <span class="comment">// Call the filter chain for this request</span></div><div class="line">        <span class="comment">// <span class="doctag">NOTE:</span> This also calls the servlet's service() method</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> ((servlet != <span class="keyword">null</span>) &amp;&amp; (filterChain != <span class="keyword">null</span>)) &#123;</div><div class="line">                <span class="comment">// Swallow output if needed</span></div><div class="line">                <span class="keyword">if</span> (context.getSwallowOutput()) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        SystemLogHandler.startCapture();</div><div class="line">                        <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</div><div class="line">                            request.getAsyncContextInternal().doInternalDispatch();</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (comet) &#123;</div><div class="line">                            filterChain.doFilterEvent(request.getEvent());</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            filterChain.doFilter(request.getRequest(),</div><div class="line">                                    response.getResponse());</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        String log = SystemLogHandler.stopCapture();</div><div class="line">                        <span class="keyword">if</span> (log != <span class="keyword">null</span> &amp;&amp; log.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">                            context.getLogger().info(log);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</div><div class="line">                        request.getAsyncContextInternal().doInternalDispatch();</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (comet) &#123;</div><div class="line">                        filterChain.doFilterEvent(request.getEvent());</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        filterChain.doFilter</div><div class="line">                            (request.getRequest(), response.getResponse());</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (ClientAbortException e) &#123;</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            container.getLogger().error(sm.getString(</div><div class="line">                    <span class="string">"standardWrapper.serviceException"</span>, wrapper.getName(),</div><div class="line">                    context.getName()), e);</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (UnavailableException e) &#123;</div><div class="line">            container.getLogger().error(sm.getString(</div><div class="line">                    <span class="string">"standardWrapper.serviceException"</span>, wrapper.getName(),</div><div class="line">                    context.getName()), e);</div><div class="line">            <span class="comment">//            throwable = e;</span></div><div class="line">            <span class="comment">//            exception(request, response, e);</span></div><div class="line">            wrapper.unavailable(e);</div><div class="line">            <span class="keyword">long</span> available = wrapper.getAvailable();</div><div class="line">            <span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</div><div class="line">                response.setDateHeader(<span class="string">"Retry-After"</span>, available);</div><div class="line">                response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</div><div class="line">                           sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</div><div class="line">                                        wrapper.getName()));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</div><div class="line">                response.sendError(HttpServletResponse.SC_NOT_FOUND,</div><div class="line">                            sm.getString(<span class="string">"standardWrapper.notFound"</span>,</div><div class="line">                                        wrapper.getName()));</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Do not save exception in 'throwable', because we</span></div><div class="line">            <span class="comment">// do not want to do exception(request, response, e) processing</span></div><div class="line">        &#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">            Throwable rootCause = StandardWrapper.getRootCause(e);</div><div class="line">            <span class="keyword">if</span> (!(rootCause <span class="keyword">instanceof</span> ClientAbortException)) &#123;</div><div class="line">                container.getLogger().error(sm.getString(</div><div class="line">                        <span class="string">"standardWrapper.serviceExceptionRoot"</span>,</div><div class="line">                        wrapper.getName(), context.getName(), e.getMessage()),</div><div class="line">                        rootCause);</div><div class="line">            &#125;</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(e);</div><div class="line">            container.getLogger().error(sm.getString(</div><div class="line">                    <span class="string">"standardWrapper.serviceException"</span>, wrapper.getName(),</div><div class="line">                    context.getName()), e);</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Release the filter chain (if any) for this request</span></div><div class="line">        <span class="keyword">if</span> (filterChain != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (request.isComet()) &#123;</div><div class="line">                <span class="comment">// If this is a Comet request, then the same chain will be used for the</span></div><div class="line">                <span class="comment">// processing of all subsequent events.</span></div><div class="line">                filterChain.reuse();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                filterChain.release();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Deallocate the allocated servlet instance</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (servlet != <span class="keyword">null</span>) &#123;</div><div class="line">                wrapper.deallocate(servlet);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(e);</div><div class="line">            container.getLogger().error(sm.getString(<span class="string">"standardWrapper.deallocateException"</span>,</div><div class="line">                             wrapper.getName()), e);</div><div class="line">            <span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</div><div class="line">                throwable = e;</div><div class="line">                exception(request, response, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If this servlet has been marked permanently unavailable,</span></div><div class="line">        <span class="comment">// unload it and release this instance</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> ((servlet != <span class="keyword">null</span>) &amp;&amp;</div><div class="line">                (wrapper.getAvailable() == Long.MAX_VALUE)) &#123;</div><div class="line">                wrapper.unload();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(e);</div><div class="line">            container.getLogger().error(sm.getString(<span class="string">"standardWrapper.unloadException"</span>,</div><div class="line">                             wrapper.getName()), e);</div><div class="line">            <span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</div><div class="line">                throwable = e;</div><div class="line">                exception(request, response, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">long</span> t2=System.currentTimeMillis();</div><div class="line"></div><div class="line">        <span class="keyword">long</span> time=t2-t1;</div><div class="line">        processingTime += time;</div><div class="line">        <span class="keyword">if</span>( time &gt; maxTime) maxTime=time;</div><div class="line">        <span class="keyword">if</span>( time &lt; minTime) minTime=time;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上述代码执行过程如下：</p>
<ol>
<li>得到StandardWrapper容器  ，每个请求都会对应相应的StandardWrapper及StandardWrapperValve对象//StandardWrapper wrapper = (StandardWrapper) getContainer();  </li>
<li>得到此请求的StandardContext对象  //Context context = (Context) wrapper.getParent();  </li>
<li>得到所请求的Servlet对象//Servlet servlet = null;  </li>
<li>从StandardWrapper容器获取一个Servlet对象, Servlet对象的创建及初始化init都在这里执行//servlet = wrapper.allocate(); </li>
<li>创建ApplicationFilterFactory对象// ApplicationFilterFactory factory = ApplicationFilterFactory.getInstance()</li>
<li>创建此次请求的ApplicationFilterChain对象，并设置所请求的Servlet对象.每个请求都会创建一个ApplicationFilterChain对象,包装了所请求的Servlet对象及一系列拦截的过滤器Filter对象//ApplicationFilterChain filterChain = factory.createFilterChain(request, wrapper, servlet);  </li>
<li>调用ApplicationFilterChain的doFilter方法.传入org.apache.catalina.connector.RequestFacade及org.apache.catalina.connector.ResponseFacade对象,开始进行请求处理 //filterChain.doFilter(request.getRequest(),response.getResponse());</li>
<li>调用ApplicationFilterChain的release方法清空对Servlet、Filter的引用。</li>
<li>执行完后把Servlet实例回收到Servlet实例池  // wrapper.deallocate(servlet);  </li>
</ol>
<p>allocate 方法执行如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Allocate an initialized instance of this Servlet that is ready to have</div><div class="line">    * its &lt;code&gt;service()&lt;/code&gt; method called.  If the servlet class does</div><div class="line">    * not implement &lt;code&gt;SingleThreadModel&lt;/code&gt;, the (only) initialized</div><div class="line">    * instance may be returned immediately.  If the servlet class implements</div><div class="line">    * &lt;code&gt;SingleThreadModel&lt;/code&gt;, the Wrapper implementation must ensure</div><div class="line">    * that this instance is not allocated again until it is deallocated by a</div><div class="line">    * call to &lt;code&gt;deallocate()&lt;/code&gt;.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@exception</span> ServletException if the servlet init() method threw</div><div class="line">    *  an exception</div><div class="line">    * <span class="doctag">@exception</span> ServletException if a loading error occurs</div><div class="line">    */</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> Servlet <span class="title">allocate</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line"></div><div class="line">       <span class="comment">// If we are currently unloading this servlet, throw an exception</span></div><div class="line">       <span class="keyword">if</span> (unloading) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(sm.getString(<span class="string">"standardWrapper.unloading"</span>, getName()));</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">boolean</span> newInstance = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">       <span class="comment">// If not SingleThreadedModel, return the same instance every time</span></div><div class="line">       <span class="keyword">if</span> (!singleThreadModel) &#123;</div><div class="line">           <span class="comment">// Load and initialize our instance if necessary</span></div><div class="line">           <span class="keyword">if</span> (instance == <span class="keyword">null</span> || !instanceInitialized) &#123;</div><div class="line">               <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                   <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">                       <span class="keyword">try</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                               log.debug(<span class="string">"Allocating non-STM instance"</span>);</div><div class="line">                           &#125;</div><div class="line"></div><div class="line">                           <span class="comment">// Note: We don't know if the Servlet implements</span></div><div class="line">                           <span class="comment">// SingleThreadModel until we have loaded it.</span></div><div class="line">                           instance = loadServlet();</div><div class="line">                           newInstance = <span class="keyword">true</span>;</div><div class="line">                           <span class="keyword">if</span> (!singleThreadModel) &#123;</div><div class="line">                               <span class="comment">// For non-STM, increment here to prevent a race</span></div><div class="line">                               <span class="comment">// condition with unload. Bug 43683, test case</span></div><div class="line">                               <span class="comment">// #3</span></div><div class="line">                               countAllocated.incrementAndGet();</div><div class="line">                           &#125;</div><div class="line">                       &#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">                           <span class="keyword">throw</span> e;</div><div class="line">                       &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                           ExceptionUtils.handleThrowable(e);</div><div class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(sm.getString(<span class="string">"standardWrapper.allocate"</span>), e);</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">if</span> (!instanceInitialized) &#123;</div><div class="line">                       initServlet(instance);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (singleThreadModel) &#123;</div><div class="line">               <span class="keyword">if</span> (newInstance) &#123;</div><div class="line">                   <span class="comment">// Have to do this outside of the sync above to prevent a</span></div><div class="line">                   <span class="comment">// possible deadlock</span></div><div class="line">                   <span class="keyword">synchronized</span> (instancePool) &#123;</div><div class="line">                       instancePool.push(instance);</div><div class="line">                       nInstances++;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</div><div class="line">                   log.trace(<span class="string">"  Returning non-STM instance"</span>);</div><div class="line">               &#125;</div><div class="line">               <span class="comment">// For new instances, count will have been incremented at the</span></div><div class="line">               <span class="comment">// time of creation</span></div><div class="line">               <span class="keyword">if</span> (!newInstance) &#123;</div><div class="line">                   countAllocated.incrementAndGet();</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span> instance;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">synchronized</span> (instancePool) &#123;</div><div class="line">           <span class="keyword">while</span> (countAllocated.get() &gt;= nInstances) &#123;</div><div class="line">               <span class="comment">// Allocate a new instance if possible, or else wait</span></div><div class="line">               <span class="keyword">if</span> (nInstances &lt; maxInstances) &#123;</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       instancePool.push(loadServlet());</div><div class="line">                       nInstances++;</div><div class="line">                   &#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">                       <span class="keyword">throw</span> e;</div><div class="line">                   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                       ExceptionUtils.handleThrowable(e);</div><div class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(sm.getString(<span class="string">"standardWrapper.allocate"</span>), e);</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       instancePool.wait();</div><div class="line">                   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                       <span class="comment">// Ignore</span></div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</div><div class="line">               log.trace(<span class="string">"  Returning allocated STM instance"</span>);</div><div class="line">           &#125;</div><div class="line">           countAllocated.incrementAndGet();</div><div class="line">           <span class="keyword">return</span> instancePool.pop();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>调用StandardWrapper的allocate方法分配org.apache.catalina.servlets.DefaultServlet的实例处理访问包括<em>.html、</em>.htm、<em>.gif、</em>.jpg、<em>.jpeg等资源的request，分配org.apache.jasper.servlet.JspServlet的实例处理访问</em>.jpg页面的request。简单提下这些Servlet实例是在StandardContext启动的时候调用StandardWrapper的load方法用反射生成的</p>
<p>根据以上分析，我们看到StandardEngine容器的Pipeline中只有一个Valve（StandardEngineValve），而StandardHost容器中有三个Valve（分别是AccessLogValve、ErrorReportValve和StandardHostValve），此外StandardContext容器中有一个Valve（StandardContextValve），StandardWrapper中也只有一个Valve（StandardWrapperValve）。这些阀门Valve通过invoke方法彼此串联起来，最终构成的执行顺序十分类似于一个管道，最终形成的管道正如图2一样，这也许是Pipeline名字的由来。</p>
<p><img src="http://i.imgur.com/UuQzlWQ.png" alt=""></p>
<p>接着上述分析。createFilterChain  方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Construct and return a FilterChain implementation that will wrap the</div><div class="line">     * execution of the specified servlet instance.  If we should not execute</div><div class="line">     * a filter chain at all, return &lt;code&gt;null&lt;/code&gt;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request The servlet request we are processing</div><div class="line">     * <span class="doctag">@param</span> servlet The servlet instance to be wrapped</div><div class="line"></div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title">createFilterChain</span></span></div><div class="line">        <span class="params">(ServletRequest request, Wrapper wrapper, Servlet servlet)</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// get the dispatcher type</span></div><div class="line">        DispatcherType dispatcher = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (request.getAttribute(Globals.DISPATCHER_TYPE_ATTR) != <span class="keyword">null</span>) &#123;</div><div class="line">            dispatcher = (DispatcherType) request.getAttribute(</div><div class="line">                    Globals.DISPATCHER_TYPE_ATTR);</div><div class="line">        &#125;</div><div class="line">        String requestPath = <span class="keyword">null</span>;</div><div class="line">        Object attribute = request.getAttribute(</div><div class="line">                Globals.DISPATCHER_REQUEST_PATH_ATTR);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (attribute != <span class="keyword">null</span>)&#123;</div><div class="line">            requestPath = attribute.toString();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If there is no servlet to execute, return null</span></div><div class="line">        <span class="keyword">if</span> (servlet == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">null</span>);</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> comet = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Create and initialize a filter chain object</span></div><div class="line">        ApplicationFilterChain filterChain = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> Request) &#123;</div><div class="line">            Request req = (Request) request;</div><div class="line">            comet = req.isComet();</div><div class="line">            <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</div><div class="line">                <span class="comment">// Security: Do not recycle</span></div><div class="line">                filterChain = <span class="keyword">new</span> ApplicationFilterChain();</div><div class="line">                <span class="keyword">if</span> (comet) &#123;</div><div class="line">                    req.setFilterChain(filterChain);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                filterChain = (ApplicationFilterChain) req.getFilterChain();</div><div class="line">                <span class="keyword">if</span> (filterChain == <span class="keyword">null</span>) &#123;</div><div class="line">                    filterChain = <span class="keyword">new</span> ApplicationFilterChain();</div><div class="line">                    req.setFilterChain(filterChain);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Request dispatcher in use</span></div><div class="line">            filterChain = <span class="keyword">new</span> ApplicationFilterChain();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        filterChain.setServlet(servlet);</div><div class="line"></div><div class="line">        filterChain.setSupport</div><div class="line">            (((StandardWrapper)wrapper).getInstanceSupport());</div><div class="line"></div><div class="line">        <span class="comment">// Acquire the filter mappings for this Context</span></div><div class="line">        StandardContext context = (StandardContext) wrapper.getParent();</div><div class="line">        FilterMap filterMaps[] = context.findFilterMaps();</div><div class="line"></div><div class="line">        <span class="comment">// If there are no filter mappings, we are done</span></div><div class="line">        <span class="keyword">if</span> ((filterMaps == <span class="keyword">null</span>) || (filterMaps.length == <span class="number">0</span>))</div><div class="line">            <span class="keyword">return</span> (filterChain);</div><div class="line"></div><div class="line">        <span class="comment">// Acquire the information we will need to match filter mappings</span></div><div class="line">        String servletName = wrapper.getName();</div><div class="line"></div><div class="line">        <span class="comment">// Add the relevant path-mapped filters to this filter chain</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!matchFiltersURL(filterMaps[i], requestPath))</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</div><div class="line">                context.findFilterConfig(filterMaps[i].getFilterName());</div><div class="line">            <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// FIXME - log configuration problem</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">boolean</span> isCometFilter = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (comet) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    isCometFilter = filterConfig.getFilter() <span class="keyword">instanceof</span> CometFilter;</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="comment">// Note: The try catch is there because getFilter has a lot of</span></div><div class="line">                    <span class="comment">// declared exceptions. However, the filter is allocated much</span></div><div class="line">                    <span class="comment">// earlier</span></div><div class="line">                    Throwable t = ExceptionUtils.unwrapInvocationTargetException(e);</div><div class="line">                    ExceptionUtils.handleThrowable(t);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (isCometFilter) &#123;</div><div class="line">                    filterChain.addFilter(filterConfig);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                filterChain.addFilter(filterConfig);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Add filters that match on servlet name second</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!matchFiltersServlet(filterMaps[i], servletName))</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</div><div class="line">                context.findFilterConfig(filterMaps[i].getFilterName());</div><div class="line">            <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// FIXME - log configuration problem</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">boolean</span> isCometFilter = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (comet) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    isCometFilter = filterConfig.getFilter() <span class="keyword">instanceof</span> CometFilter;</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="comment">// Note: The try catch is there because getFilter has a lot of</span></div><div class="line">                    <span class="comment">// declared exceptions. However, the filter is allocated much</span></div><div class="line">                    <span class="comment">// earlier</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (isCometFilter) &#123;</div><div class="line">                    filterChain.addFilter(filterConfig);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                filterChain.addFilter(filterConfig);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Return the completed filter chain</span></div><div class="line">        <span class="keyword">return</span> (filterChain);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>我们整理下整个创建Filter职责链的过程：</p>
<ol>
<li>从request中获取请求的类型（Tomcat目前提供的请求类型有REQUEST、FORWARD、INCLUDE、ASYNC及ERROR五种）与路径；</li>
<li>创建ApplicationFilterChain并设置给当前request；</li>
<li>给ApplicationFilterChain设置Servlet，即DefaultServlet；</li>
<li>从StandardContext中获取当前Context的filterMaps；</li>
<li>如果filterMaps为空，则说明当前Context没有配置Filter，否则会将filterMaps中的Filter全部添加到ApplicationFilterChain中的Filter职责链中。</li>
</ol>
<p>调用ApplicationFilterChain的doFilter方法，执行ApplicationFilterChain中维护的Filter职责链。Filter职责链是对职责链模式的经典应用，我们先通过图3来介绍其执行流程。</p>
<p><img src="http://i.imgur.com/VT42GFV.png" alt=""></p>
<p>这里对图3的执行过程进行介绍：</p>
<ol>
<li>StandardWrapperValve的invoke方法在创建完ApplicationFilterChain后，第一次调用ApplicationFilterChain的doFilter方法；</li>
<li>如果ApplicationFilterChain自身维护的Filter数组中还有没有执行的Filter，则取出此Filter并执行Filter的doFilter方法（即第3步），否则执行Servlet的service方法处理请求（即第4步）；</li>
<li>每个Filter首先执行自身的过滤功能，最后在执行结束前会回调ApplicationFilterChain的doFilter方法，此时会将执行流程交给第2步；</li>
<li>Servlet的service实际会调用自身的doGet、doHead、doPost、doPut、doDelete等方法。</li>
</ol>
<p>第2步对应了图3中M.N这个标记的M部分，第3步则对应N的部分。本文最后从源码实现级别分析Filter职责链的执行过程，首先来看ApplicationFilterChain的doFilter方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Invoke the next filter in this chain, passing the specified request</div><div class="line">     * and response.  If there are no more filters in this chain, invoke</div><div class="line">     * the &lt;code&gt;service()&lt;/code&gt; method of the servlet itself.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request The servlet request we are processing</div><div class="line">     * <span class="doctag">@param</span> response The servlet response we are creating</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> IOException if an input/output error occurs</div><div class="line">     * <span class="doctag">@exception</span> ServletException if a servlet exception occurs</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</div><div class="line">            <span class="keyword">final</span> ServletRequest req = request;</div><div class="line">            <span class="keyword">final</span> ServletResponse res = response;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                java.security.AccessController.doPrivileged(</div><div class="line">                    <span class="keyword">new</span> java.security.PrivilegedExceptionAction&lt;Void&gt;() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span></span></div><div class="line">                            <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line">                            internalDoFilter(req,res);</div><div class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                );</div><div class="line">            &#125; <span class="keyword">catch</span>( PrivilegedActionException pe) &#123;</div><div class="line">                Exception e = pe.getException();</div><div class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServletException)</div><div class="line">                    <span class="keyword">throw</span> (ServletException) e;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException)</div><div class="line">                    <span class="keyword">throw</span> (IOException) e;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException)</div><div class="line">                    <span class="keyword">throw</span> (RuntimeException) e;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e.getMessage(), e);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            internalDoFilter(request,response);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>看到ApplicationFilterChain的doFilter方法主要调用了internalDoFilter方法.方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">internalDoFilter</span><span class="params">(ServletRequest request,</span></span></div><div class="line">                               ServletResponse response)</div><div class="line">     <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">     <span class="comment">// Call the next filter if there is one</span></div><div class="line">     <span class="keyword">if</span> (pos &lt; n) &#123;</div><div class="line">         ApplicationFilterConfig filterConfig = filters[pos++];</div><div class="line">         Filter filter = <span class="keyword">null</span>;</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             filter = filterConfig.getFilter();</div><div class="line">             support.fireInstanceEvent(InstanceEvent.BEFORE_FILTER_EVENT,</div><div class="line">                                       filter, request, response);</div><div class="line"></div><div class="line">             <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="string">"false"</span>.equalsIgnoreCase(</div><div class="line">                     filterConfig.getFilterDef().getAsyncSupported())) &#123;</div><div class="line">                 request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</div><div class="line">                         Boolean.FALSE);</div><div class="line">             &#125;</div><div class="line">             <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</div><div class="line">                 <span class="keyword">final</span> ServletRequest req = request;</div><div class="line">                 <span class="keyword">final</span> ServletResponse res = response;</div><div class="line">                 Principal principal =</div><div class="line">                     ((HttpServletRequest) req).getUserPrincipal();</div><div class="line"></div><div class="line">                 Object[] args = <span class="keyword">new</span> Object[]&#123;req, res, <span class="keyword">this</span>&#125;;</div><div class="line">                 SecurityUtil.doAsPrivilege</div><div class="line">                     (<span class="string">"doFilter"</span>, filter, classType, args, principal);</div><div class="line"></div><div class="line">             &#125; <span class="keyword">else</span> &#123;</div><div class="line">                 filter.doFilter(request, response, <span class="keyword">this</span>);</div><div class="line">             &#125;</div><div class="line"></div><div class="line">             support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</div><div class="line">                                       filter, request, response);</div><div class="line">         &#125; <span class="keyword">catch</span> (IOException | ServletException | RuntimeException e) &#123;</div><div class="line">             <span class="keyword">if</span> (filter != <span class="keyword">null</span>)</div><div class="line">                 support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</div><div class="line">                                           filter, request, response, e);</div><div class="line">             <span class="keyword">throw</span> e;</div><div class="line">         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">             e = ExceptionUtils.unwrapInvocationTargetException(e);</div><div class="line">             ExceptionUtils.handleThrowable(e);</div><div class="line">             <span class="keyword">if</span> (filter != <span class="keyword">null</span>)</div><div class="line">                 support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</div><div class="line">                                           filter, request, response, e);</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> ServletException</div><div class="line">               (sm.getString(<span class="string">"filterChain.filter"</span>), e);</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">return</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// We fell off the end of the chain -- call the servlet instance</span></div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</div><div class="line">             lastServicedRequest.set(request);</div><div class="line">             lastServicedResponse.set(response);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         support.fireInstanceEvent(InstanceEvent.BEFORE_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response);</div><div class="line">         <span class="keyword">if</span> (request.isAsyncSupported()</div><div class="line">                 &amp;&amp; !support.getWrapper().isAsyncSupported()) &#123;</div><div class="line">             request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</div><div class="line">                     Boolean.FALSE);</div><div class="line">         &#125;</div><div class="line">         <span class="comment">// Use potentially wrapped request from this point</span></div><div class="line">         <span class="keyword">if</span> ((request <span class="keyword">instanceof</span> HttpServletRequest) &amp;&amp;</div><div class="line">             (response <span class="keyword">instanceof</span> HttpServletResponse)) &#123;</div><div class="line"></div><div class="line">             <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</div><div class="line">                 <span class="keyword">final</span> ServletRequest req = request;</div><div class="line">                 <span class="keyword">final</span> ServletResponse res = response;</div><div class="line">                 Principal principal =</div><div class="line">                     ((HttpServletRequest) req).getUserPrincipal();</div><div class="line">                 Object[] args = <span class="keyword">new</span> Object[]&#123;req, res&#125;;</div><div class="line">                 SecurityUtil.doAsPrivilege(<span class="string">"service"</span>,</div><div class="line">                                            servlet,</div><div class="line">                                            classTypeUsedInService,</div><div class="line">                                            args,</div><div class="line">                                            principal);</div><div class="line">             &#125; <span class="keyword">else</span> &#123;</div><div class="line">                 servlet.service(request, response);</div><div class="line">             &#125;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             servlet.service(request, response);</div><div class="line">         &#125;</div><div class="line">         support.fireInstanceEvent(InstanceEvent.AFTER_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response);</div><div class="line">     &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">         support.fireInstanceEvent(InstanceEvent.AFTER_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response, e);</div><div class="line">         <span class="keyword">throw</span> e;</div><div class="line">     &#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">         support.fireInstanceEvent(InstanceEvent.AFTER_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response, e);</div><div class="line">         <span class="keyword">throw</span> e;</div><div class="line">     &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">         support.fireInstanceEvent(InstanceEvent.AFTER_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response, e);</div><div class="line">         <span class="keyword">throw</span> e;</div><div class="line">     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">         ExceptionUtils.handleThrowable(e);</div><div class="line">         support.fireInstanceEvent(InstanceEvent.AFTER_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response, e);</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> ServletException</div><div class="line">           (sm.getString(<span class="string">"filterChain.servlet"</span>), e);</div><div class="line">     &#125; <span class="keyword">finally</span> &#123;</div><div class="line">         <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</div><div class="line">             lastServicedRequest.set(<span class="keyword">null</span>);</div><div class="line">             lastServicedResponse.set(<span class="keyword">null</span>);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>从上述代码，我们可以看到ApplicationFilterChain最后会执行Servlet的service方法，此service方法实际是所有Servlet的父类HttpServlet实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span></span></div><div class="line">    <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line"></div><div class="line">    HttpServletRequest  request;</div><div class="line">    HttpServletResponse response;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        request = (HttpServletRequest) req;</div><div class="line">        response = (HttpServletResponse) res;</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"non-HTTP request or response"</span>);</div><div class="line">    &#125;</div><div class="line">    service(request, response);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>service方法调用重载的service方法，后者通过判断HttpServletRequest对象的HTTP Method，调用不同的方法，如GET、DELETE、POST等,实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></div><div class="line">       <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line"></div><div class="line">       String method = req.getMethod();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (method.equals(METHOD_GET)) &#123;</div><div class="line">           <span class="keyword">long</span> lastModified = getLastModified(req);</div><div class="line">           <span class="keyword">if</span> (lastModified == -<span class="number">1</span>) &#123;</div><div class="line">               <span class="comment">// servlet doesn't support if-modified-since, no reason</span></div><div class="line">               <span class="comment">// to go through further expensive logic</span></div><div class="line">               doGet(req, resp);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">long</span> ifModifiedSince;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);</div><div class="line">               &#125; <span class="keyword">catch</span> (IllegalArgumentException iae) &#123;</div><div class="line">                   <span class="comment">// Invalid date header - proceed as if none was set</span></div><div class="line">                   ifModifiedSince = -<span class="number">1</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (ifModifiedSince &lt; (lastModified / <span class="number">1000</span> * <span class="number">1000</span>)) &#123;</div><div class="line">                   <span class="comment">// If the servlet mod time is later, call doGet()</span></div><div class="line">                   <span class="comment">// Round down to the nearest second for a proper compare</span></div><div class="line">                   <span class="comment">// A ifModifiedSince of -1 will always be less</span></div><div class="line">                   maybeSetLastModified(resp, lastModified);</div><div class="line">                   doGet(req, resp);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_HEAD)) &#123;</div><div class="line">           <span class="keyword">long</span> lastModified = getLastModified(req);</div><div class="line">           maybeSetLastModified(resp, lastModified);</div><div class="line">           doHead(req, resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_POST)) &#123;</div><div class="line">           doPost(req, resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_PUT)) &#123;</div><div class="line">           doPut(req, resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_DELETE)) &#123;</div><div class="line">           doDelete(req, resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_OPTIONS)) &#123;</div><div class="line">           doOptions(req,resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_TRACE)) &#123;</div><div class="line">           doTrace(req,resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//</span></div><div class="line">           <span class="comment">// Note that this means NO servlet supports whatever</span></div><div class="line">           <span class="comment">// method was requested, anywhere on this server.</span></div><div class="line">           <span class="comment">//</span></div><div class="line"></div><div class="line">           String errMsg = lStrings.getString(<span class="string">"http.method_not_implemented"</span>);</div><div class="line">           Object[] errArgs = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">           errArgs[<span class="number">0</span>] = method;</div><div class="line">           errMsg = MessageFormat.format(errMsg, errArgs);</div><div class="line"></div><div class="line">           resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>以doGet方法为例，见代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></div><div class="line">    <span class="keyword">throws</span> ServletException, IOException</div><div class="line">&#123;</div><div class="line">    String protocol = req.getProtocol();</div><div class="line">    String msg = lStrings.getString(<span class="string">"http.method_get_not_supported"</span>);</div><div class="line">    <span class="keyword">if</span> (protocol.endsWith(<span class="string">"1.1"</span>)) &#123;</div><div class="line">        resp.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, msg);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        resp.sendError(HttpServletResponse.SC_BAD_REQUEST, msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不对啊！为什么doGet方法的实现只是返回了400和405错误呢？因为这是抽象类HttpServlet的默认实现，用户必须实现自身的Servlet或者使用默认的DefaultServlet。 </p>
<p>本章小结：</p>
<p>至此，Tomcat有关请求流程的主要内容已经讲解完毕。</p>
<p>时序图如下：<br><img src="http://i.imgur.com/6cwwtkA.png" alt=""></p>
<h3 id="第八章-Tomcat中的设计模式及connector图解"><a href="#第八章-Tomcat中的设计模式及connector图解" class="headerlink" title="第八章 Tomcat中的设计模式及connector图解"></a>第八章 Tomcat中的设计模式及connector图解</h3><h4 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h4><p>Tomcat虽然代码比较庞大，但是整体还是设计的比较优雅，特别是很多组件化的设计思路，其中涉及到的一些常用的设计模式值得我们学习及借鉴：</p>
<p>单例模式<br>    详见前几章</p>
<p>工厂模式<br>    详见前几章</p>
<p>责任链模式<br>        Tomcat中有两个地方比较明显的使用了责任链模式，一、Tomcat中的ApplicationFilterChain实现了Filter拦截和实际Servlet的请求，是典型的责任链模式。其他开源框架中类似的设计还有Struts2中的DefaultActionInvocation实现Interceptor拦截和Action的调用。spring AOP中ReflectiveMethodInvocation实现MethodInceptor方法拦截和target的调用。二、Tomcat中的Pipeline-Valve模式也是责任链模式的一种变种，从Engine到Host再到Context一直到Wrapper都是通过一个链来传递请求。</p>
<p>观察者模式<br>        Tomcat通过LifecycleListener对组件生命周期组件Lifecycle进行监听就是典型的观察者模式，各个组件在其生命期中会有各种各样行为，而这些行为都会触发相应的事件，Tomcat就是通过侦听这些事件达到对这些行为进行扩展的目的。在看组件的init和start过程中会看到大量如：lifecycle.fireLifecycleEvent(AFTER_START_EVENT,null);这样的代码，这就是对某一类型事件的触发，如果你想在其中加入自己的行为，就只用注册相应类型的事件即可。</p>
<p>门面模式<br>      门面设计模式在 Tomcat 中有多处使用，在 Request 和 Response 对象封装中(RequestFacade,ResponseFacade)、ApplicationContext 到ApplicationContextFacade等都用到了这种设计模式。这种设计模式主要用在一个大的系统中有多个子系统组成时，这多个子系统肯定要涉及到相互通信，但是每个子系统又不能将自己的内部数据过多的暴露给其它系统，不然就没有必要划分子系统了。每个子系统都会设计一个门面，把别的系统感兴趣的数据封装起来，通过这个门面来进行访问。</p>
<p>模板方法模式</p>
<p>  模板方法模式是我们平时开发当中常用的一种模式，把通用的骨架抽象到父类中，子类去实现特地的某些步骤。Tomcat及Servlet规范API中也大量的使用了这种模式，比如Tomcat中的ContainerBase中对于生命周期的一些方法init,start,stop和Servlet规范API中的GenericServlet中的service抽象骨架模板方法均使用了模板方法模式。</p>
<h4 id="connector"><a href="#connector" class="headerlink" title="connector"></a>connector</h4><p> 前面也已经经介绍过，Connector组件是Service容器中的一部分。它主要是接收，解析HTTP请求，然后调用本Service下的相关Servlet。由于Tomcat从架构上采用的是一个分层结构，因此根据解析过的HTTP请求，定位到相应Servlet也是一个相对比较复杂的过程，整个Connector实现了从接收Socket到调用Servlet的全过程。先来看一下Connector的功能逻辑：</p>
<p>·        接收Socket</p>
<p>·        从Socket获取数据包，并解析成HttpServletRequest对象</p>
<p>·        从Engine容器开始走调用流程，经过各层Valve，最后调用Servlet完成业务逻辑</p>
<p>·        返回Response，关闭Socket</p>
<p>可以看出，整个Connector组件是Tomcat运行主干，目前Connector支持的协议是HTTP和AJP，本文主要是针对HTTP协议的Connector进行阐述。先来看一下Connector的配置，在server.xml里；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"80"</span> <span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span>   </span></div><div class="line"><span class="attr">connectionTimeout</span>=<span class="string">"20000"</span>   </div><div class="line"> <span class="attr">redirectPort</span>=<span class="string">"7443"</span> /&gt;</div></pre></td></tr></table></figure>
<p>熟悉的80端口不必说了。”protocol”这里是指这个Connector支持的协议。针对HTTP协议而言，这个属性可以配置的值有： </p>
<p>·        HTTP/1.1</p>
<p>·        org.apache.coyote.http11.Http11Protocol –BIO实现</p>
<p>·        org.apache.coyote.http11.Http11NioProtocol –NIO实现</p>
<p>配置”HTTP/1.1”和”org.apache.coyote.http11.Http11Protocol”的效果是一样的，因此Connector的HTTP协议实现缺省是支持BIO的。无论是BIO还是NIO都是实现一个org.apache.coyote.ProtocolHandler接口，因此如果需要定制化，也必须实现这个接口。 接下来再来看看默认状态下HTTP Connector的架构及其消息流。</p>
<p><img src="http://i.imgur.com/Wrkl7ew.png" alt=""></p>
<p> 可以看见Connector中三大块 </p>
<ul>
<li><p>Http11Protocol</p>
</li>
<li><p>Mapper</p>
</li>
<li><p>CoyoteAdapter</p>
</li>
</ul>
<p>Http11Protocol </p>
<pre><code>类完全路径org.apache.coyote.http11.Http11Protocol，这是支持HTTP的BIO实现。Http11Protocol包含了JIoEndpoint对象及Http11ConnectionHandler对象。 
</code></pre><p>Http11ConnectionHandler对象维护了一个Http11Processor对象池，Http11Processor对象会调用CoyoteAdapter完成HTTPr Request的解析和分派。<br>JIoEndpoint维护了两个线程，Acceptor请求接收线程及Executor请求处理线程池。Acceptor是接收Socket，然后从 Executor请求处理线程池中找出空闲的线程处理socket，如果 Executor请求处理线程池没有空闲线程，请求会被放入阻塞队列等待有空闲线程。</p>
<p>Mapper </p>
<pre><code>类完全路径org.apache.tomcat.util.http.mapper.Mapper，此对象维护了一个从Host到Wrapper的各级容器的快照。它主要是为了，当HTTP Request被解析后，能够将HTTP Request绑定到相应的Host,Context,Wrapper(Servlet)，进行业务处理；
</code></pre><p>CoyoteAdapter </p>
<pre><code>类完全路径org.apache.catalina.connector.CoyoteAdapter，此对象负责将http request解析成HttpServletRequest对象，之后绑定相应的容器，然后从Engine开始逐层调用Valve直至该Servlet。比如根据Request中的JSESSIONID绑定服务器端的相应Session。这个JSESSIONID按照优先级或是从Request URL中获取，或是从Cookie中获取，然后再Session池中找到相应匹配的Session对象，然后将其封装到HttpServletRequest对象，所有这些都是在CoyoteAdapter中完成的。看一下将Request解析为HttpServletRequest对象后，开始调用Servlet的代码； 
</code></pre><p>Tomcat的Connector组件工作具体序列图入下：</p>
<p><img src="http://i.imgur.com/3LHxHc4.png" alt=""></p>
<p>本章小结</p>
<p>至此本章结束</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/tomact1/" itemprop="url">
                  tomact1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2016-12-31T12:08:12+08:00" content="2016-12-31">
              2016-12-31
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文内容只要参考深入剖析tomact。由于这本书是基于tomcat4的，所以我的文章也是基于tomcat4的，但是tomcat的核心思想应该是没有变的，最主要的两个组件还是连接器和容器。本文内容主要为了学习。</p>
<h3 id="第一章：tomact服务启动"><a href="#第一章：tomact服务启动" class="headerlink" title="第一章：tomact服务启动"></a>第一章：tomact服务启动</h3><p>为了后面的理解，先大致说一下Tomcat的整体架构，Tomcat主要有两个组件，连接器和容器，所谓连接器就是一个http请求过来了，连接器负责接收这个请求，然后转发给容器。容器即servlet容器，容器有很多层，分别是Engine，Host，Context，Wrapper。最大的容器Engine，代表一个servlet 引擎，接下来是Host，代表一个虚拟机，然后是Context，代表一个应用，Wrapper对应一个servlet。从连接器传过来连接后，容器便会顺序经过上面的容器，最后到达特定的servlet。要说明的是Engine，Host两种容器在不是必须的。实际上一个简单的tomcat只要连接器和容器就可以了，但tomcat的实现为了统一管理连接器和容器等组件，额外添加了服务器组件（server）和服务组件（service）。</p>
<p>一个server可以有多个service，一个service包含多个连接器和一个容器，当然还有一些其他的东西，看下面的图就很容易理解Tomcat的架构了：</p>
<p><img src="http://i.imgur.com/irZpmOV.png" alt=""></p>
<p>一个父组件又可以包含多个子组件，这些被统一管理的组件都实现了Lifecycle接口。只要一个组件启动了，那么他的所有子组件也会跟着启动，比如一个server启动了，它的所有子service都会跟着启动，service启动了，它的所有连接器和容器等子组件也跟着启动了，这样，tomcat要启动，只要启动server就行了，其他的组件都会跟随着启动。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/27/tomact源码分析1/" itemprop="url">
                  tomact源码分析1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2016-12-27T13:33:17+08:00" content="2016-12-27">
              2016-12-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">in</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/tomact/" itemprop="url" rel="index">
                    <span itemprop="name">tomact</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="tomact源码分析1-简单的server实现"><a href="#tomact源码分析1-简单的server实现" class="headerlink" title="tomact源码分析1-简单的server实现"></a>tomact源码分析1-简单的server实现</h3><h4 id="1-HTTP-请求"><a href="#1-HTTP-请求" class="headerlink" title="1.HTTP 请求"></a>1.HTTP 请求</h4><p>一个 HTTP 请求包括三个组成部分：</p>
<ul>
<li>方法—统一资源标识符(URI)—协议/版本</li>
<li>请求的头部</li>
<li>主体内容</li>
</ul>
<p>ps:方法（7种）：GET, POST,HEAD, OPTIONS, PUT, DELETE 和 TRACE。头部结束和内容之间有一个空行</p>
<p>examples</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">POST /examples/default.jsp HTTP/1.1</div><div class="line">Accept: text/plain; text/html</div><div class="line">Accept-Language: en-gb</div><div class="line">Connection: Keep-Alive</div><div class="line">Host: localhost</div><div class="line">User-Agent: Mozilla/4.0 (compatible; MSIE 4.01; Windows 98)</div><div class="line">Content-Length: 33</div><div class="line">Content-Type: application/x-www-form-urlencoded</div><div class="line">Accept-Encoding: gzip, deflate</div><div class="line"></div><div class="line">lastName=Franks&amp;firstName=Michael</div></pre></td></tr></table></figure>
<h4 id="2-HTTP-响应"><a href="#2-HTTP-响应" class="headerlink" title="2.HTTP 响应"></a>2.HTTP 响应</h4><p>examples：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Server: Microsoft-IIS/4.0</div><div class="line">Date: Mon, 5 Jan 2004 13:13:33 GMT</div><div class="line">Content-Type: text/html</div><div class="line">Last-Modified: Mon, 5 Jan 2004 13:13:12 GMT</div><div class="line">Content-Length: 112</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>HTTP Response Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">Welcome to Brainy Software</div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="3-socket-amp-amp-ServerSocket"><a href="#3-socket-amp-amp-ServerSocket" class="headerlink" title="3.socket&amp;&amp;ServerSocket"></a>3.socket&amp;&amp;ServerSocket</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Socket</span> <span class="params">(java.lang.String host, <span class="keyword">int</span> port)</span></span></div></pre></td></tr></table></figure>
<p>socket类代表一个客户端套接字</p>
<p>serversocket是一个服务器套接字。用来等待来自客户端的连接请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ServerSocket</span><span class="params">(<span class="keyword">int</span> port, <span class="keyword">int</span> backLog, InetAddress bindingAddress)</span></span>;</div></pre></td></tr></table></figure>
<h4 id="4-server例子"><a href="#4-server例子" class="headerlink" title="4.server例子"></a>4.server例子</h4><p>该部分主要分为3个类。是一个最最基础的server实现。</p>
<p>server：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ex01;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"><span class="keyword">import</span> java.net.ServerSocket;</div><div class="line"><span class="keyword">import</span> java.net.InetAddress;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpServer</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/** WEB_ROOT is the directory where our HTML and other files reside.</span></div><div class="line">   *  For this package, WEB_ROOT is the "webroot" directory under the working</div><div class="line">   *  directory.</div><div class="line">   *  The working directory is the location in the file system</div><div class="line">   *  from where the java command was invoked.</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_ROOT =</div><div class="line">    System.getProperty(<span class="string">"user.dir"</span>) + File.separator  + <span class="string">"webroot"</span>;</div><div class="line"></div><div class="line">  <span class="comment">// shutdown command</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SHUTDOWN_COMMAND = <span class="string">"/SHUTDOWN"</span>;</div><div class="line"></div><div class="line">  <span class="comment">// the shutdown command received</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> shutdown = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    HttpServer server = <span class="keyword">new</span> HttpServer();</div><div class="line">    System.out.println(WEB_ROOT);</div><div class="line">    server.await();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</div><div class="line">    ServerSocket serverSocket = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">int</span> port = <span class="number">8080</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      serverSocket =  <span class="keyword">new</span> ServerSocket(port, <span class="number">1</span>, InetAddress.getByName(<span class="string">"127.0.0.1"</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">      System.exit(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Loop waiting for a request</span></div><div class="line">    <span class="keyword">while</span> (!shutdown) &#123;</div><div class="line">      Socket socket = <span class="keyword">null</span>;</div><div class="line">      InputStream input = <span class="keyword">null</span>;</div><div class="line">      OutputStream output = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        socket = serverSocket.accept();</div><div class="line">        input = socket.getInputStream();</div><div class="line">        output = socket.getOutputStream();</div><div class="line"></div><div class="line">        <span class="comment">// create Request object and parse</span></div><div class="line">        Request request = <span class="keyword">new</span> Request(input);</div><div class="line">        request.parse();</div><div class="line"></div><div class="line">        <span class="comment">// create Response object</span></div><div class="line">        Response response = <span class="keyword">new</span> Response(output);</div><div class="line">        response.setRequest(request);</div><div class="line">        response.sendStaticResource();</div><div class="line"></div><div class="line">        <span class="comment">// Close the socket</span></div><div class="line">        socket.close();</div><div class="line"></div><div class="line">        <span class="comment">//check if the previous URI is a shutdown command</span></div><div class="line">        shutdown = request.getUri().equals(SHUTDOWN_COMMAND);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>request:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ex01;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> InputStream input;</div><div class="line">  <span class="keyword">private</span> String uri;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(InputStream input)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.input = input;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Read a set of characters from the socket</span></div><div class="line">    StringBuffer request = <span class="keyword">new</span> StringBuffer(<span class="number">2048</span>);</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      i = input.read(buffer);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">      i = -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;i; j++) &#123;</div><div class="line">      request.append((<span class="keyword">char</span>) buffer[j]);</div><div class="line">    &#125;</div><div class="line">    System.out.print(request.toString());</div><div class="line">    uri = parseUri(request.toString());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">parseUri</span><span class="params">(String requestString)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> index1, index2;</div><div class="line">    index1 = requestString.indexOf(<span class="string">' '</span>);</div><div class="line">    <span class="keyword">if</span> (index1 != -<span class="number">1</span>) &#123;</div><div class="line">      index2 = requestString.indexOf(<span class="string">' '</span>, index1 + <span class="number">1</span>);</div><div class="line">      <span class="keyword">if</span> (index2 &gt; index1)</div><div class="line">        <span class="keyword">return</span> requestString.substring(index1 + <span class="number">1</span>, index2);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getUri</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> uri;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>response:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ex01;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.FileInputStream;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">  HTTP Response = Status-Line</div><div class="line">    *(( general-header | response-header | entity-header ) CRLF)</div><div class="line">    CRLF</div><div class="line">    [ message-body ]</div><div class="line">    Status-Line = HTTP-Version SP Status-Code SP Reason-Phrase CRLF</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1024</span>;</div><div class="line">  Request request;</div><div class="line">  OutputStream output;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(OutputStream output)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.output = output;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRequest</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.request = request;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendStaticResource</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER_SIZE];</div><div class="line">    FileInputStream fis = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      File file = <span class="keyword">new</span> File(HttpServer.WEB_ROOT, request.getUri());</div><div class="line">      <span class="keyword">if</span> (file.exists()) &#123;</div><div class="line">        fis = <span class="keyword">new</span> FileInputStream(file);</div><div class="line">        <span class="keyword">int</span> ch = fis.read(bytes, <span class="number">0</span>, BUFFER_SIZE);</div><div class="line">        <span class="keyword">while</span> (ch!=-<span class="number">1</span>) &#123;</div><div class="line">          output.write(bytes, <span class="number">0</span>, ch);</div><div class="line">          ch = fis.read(bytes, <span class="number">0</span>, BUFFER_SIZE);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// file not found</span></div><div class="line">        String errorMessage = <span class="string">"HTTP/1.1 404 File Not Found\r\n"</span> +</div><div class="line">          <span class="string">"Content-Type: text/html\r\n"</span> +</div><div class="line">          <span class="string">"Content-Length: 23\r\n"</span> +</div><div class="line">          <span class="string">"\r\n"</span> +</div><div class="line">          <span class="string">"&lt;h1&gt;File Not Found&lt;/h1&gt;"</span>;</div><div class="line">        output.write(errorMessage.getBytes());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      <span class="comment">// thrown if cannot instantiate a File object</span></div><div class="line">      System.out.println(e.toString() );</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="keyword">if</span> (fis!=<span class="keyword">null</span>)</div><div class="line">        fis.close();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Loren" />
          <p class="site-author-name" itemprop="name">Loren</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">84</span>
              <span class="site-state-item-name">Artikel</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">Kategorien</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">Tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Loren</span>
</div>

<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  

  

  

  

  


</body>
</html>
