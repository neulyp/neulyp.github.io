<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="lyp's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.jpg?v=5.0.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="lyp's blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="lyp's blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="lyp's blog">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '3188510942',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>


  <title> lyp's blog </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">lyp's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/18/hadoop笔记-备考/" itemprop="url">
                  hadoop笔记-备考
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-18T21:10:31+08:00" content="2016-12-18">
              2016-12-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="2-2"><a href="#2-2" class="headerlink" title="2.2"></a>2.2</h3><p>hadoop安装模式:</p>
<ul>
<li>单机模式</li>
<li>伪分布式</li>
<li>完全分布式</li>
</ul>
<p>namenode datanode jobtracker tasktracker secondaryNamenode</p>
<h3 id="2-3"><a href="#2-3" class="headerlink" title="2.3"></a>2.3</h3><p>1.命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">hadoop namenode -format</div><div class="line">sbin/start-all.sh</div><div class="line">sbin/stop-all.sh</div></pre></td></tr></table></figure></p>
<p>2.配置文件（考点）</p>
<p><img src="http://i.imgur.com/xm8ivA9.png" alt=""></p>
<h3 id="3-2"><a href="#3-2" class="headerlink" title="3.2"></a>3.2</h3><p>编写mapreduce函数：</p>
<ul>
<li>mapper类 </li>
<li>reducer类</li>
<li>main类</li>
</ul>
<p>详情见wordcount例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> wordcount;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.StringTokenizer;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.TextOutputFormat;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCount</span> </span>&#123;</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCountMap</span> <span class="keyword">extends</span></span></div><div class="line">			<span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; &#123;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">final</span> IntWritable one = <span class="keyword">new</span> IntWritable(<span class="number">1</span>);</div><div class="line">		<span class="keyword">private</span> Text word = <span class="keyword">new</span> Text();</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span></span></div><div class="line">				<span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">			String line = value.toString();</div><div class="line">			StringTokenizer token = <span class="keyword">new</span> StringTokenizer(line);</div><div class="line">			<span class="keyword">while</span> (token.hasMoreTokens()) &#123;</div><div class="line">				word.set(token.nextToken());</div><div class="line">				context.write(word, one);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCountReduce</span> <span class="keyword">extends</span></span></div><div class="line">			<span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">IntWritable</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; &#123;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values,</span></span></div><div class="line">				Context context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">			<span class="keyword">int</span> sum = <span class="number">0</span>;</div><div class="line">			<span class="keyword">for</span> (IntWritable val : values) &#123;</div><div class="line">				sum += val.get();</div><div class="line">			&#125;</div><div class="line">			context.write(key, <span class="keyword">new</span> IntWritable(sum));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</div><div class="line">		Job job = <span class="keyword">new</span> Job(conf);</div><div class="line">		job.setJarByClass(WordCount.class);</div><div class="line">		job.setJobName(<span class="string">"wordcount"</span>);</div><div class="line">		job.setOutputKeyClass(Text.class);</div><div class="line">		job.setOutputValueClass(IntWritable.class);</div><div class="line">		job.setMapperClass(WordCountMap.class);</div><div class="line">		job.setReducerClass(WordCountReduce.class);</div><div class="line">		job.setInputFormatClass(TextInputFormat.class);</div><div class="line">		job.setOutputFormatClass(TextOutputFormat.class);</div><div class="line">		FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</div><div class="line">		FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</div><div class="line">		job.waitForCompletion(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>configuration类：怼佢hadoop的配置文件</li>
<li>job类： 表示一个mapreduce任务</li>
</ul>
<h3 id="3-3"><a href="#3-3" class="headerlink" title="3.3"></a>3.3</h3><ul>
<li>打包：<code>wordcount -&gt;export-&gt;jar file</code> 把jar放在$hadoop_home 下</li>
<li>部署和运行： <code>hadoop fs -put /file1 /input/</code></li>
<li>运行： <code>hadoop jar wordcount.jar wordcount.WordMain /file1 /output</code></li>
<li>测试结果：_success _logs part-r-00000</li>
</ul>
<h3 id="4"><a href="#4" class="headerlink" title="4"></a>4</h3><p>hdfs的特点？</p>
<p>hdfs架构？（主从结构，一个namenode节点，多个datanode节点）</p>
<p>hadoop的rpc机制？</p>
<p>hadoop文件系统的访问/</p>
<p>```<br>hadoop fs -ls /<br>hadoop fs -mkdir /input<br>hadoop fs -put file1 /input<br>hadoop fs -text /input/file1<br>hadoop fs -get /input/file1 //复制到本地<br>hadoop fs -rm /input/file1<br>hadoop namenode -format<br>hadoop secondarynamenode<br>hadoop dfsadmin<br>hadoop job<br>hadoop version</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/15/hbase/" itemprop="url">
                  hbase
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-15T13:22:02+08:00" content="2016-12-15">
              2016-12-15
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="1-hbase"><a href="#1-hbase" class="headerlink" title="1.hbase"></a>1.hbase</h4><p>hbase是一个<strong>高可靠、高性能、面向列、可伸缩</strong>的分布式存储系统，利用hbase技术可以再廉价pc server上搭建大规模结构化存储集群。</p>
<p>hbase的特点：</p>
<ul>
<li>大</li>
<li>面向列</li>
<li>稀疏</li>
</ul>
<p>hbase访问接口：</p>
<ul>
<li>native java api</li>
<li>hbase shell</li>
<li>thrift gateway</li>
<li>rest gateway</li>
<li>pig</li>
<li>hive</li>
</ul>
<h4 id="2-hbase存储结构"><a href="#2-hbase存储结构" class="headerlink" title="2.hbase存储结构"></a>2.hbase存储结构</h4><p><img src="http://i.imgur.com/nzZrDc1.png" alt=""></p>
<ol>
<li><p>client<br>管理类操作：client与hmaster进行rpc操作。<br>数据读写类操作：client与hregionserver进行rpc操作。</p>
</li>
<li><p>zookeeper<br>zookeeper quorum中，除了存储-root-表的地址和hmaster的地址，hregion-server也会以ephemeral方式把自己注册到zookeeper中，使得hmaster可以随时的感知各个HRegionServer的健康状态。zookeeper的master election机制保证总有一个master运行</p>
</li>
<li><p>hmaster<br>hmaster主要负责table和region的管理工作。具体包含以下功能：</p>
<ul>
<li>管理用户对table的增删改查操作</li>
<li>管理hregionserver的负载均衡，调整region分布</li>
<li>在region split后，负责新region的分配</li>
<li>在hregionserver停机后，负责失效hregionserver上region迁移</li>
</ul>
</li>
<li><p>hregionserver<br>hregionserver主要负责响应用户i/o请求。向hdfs文件系统中读写数据。是hbase中最核心的模块。<br><img src="http://i.imgur.com/HsVM38Z.png" alt=""><br>hregionserver内部管理了一系列hregion对象，每个hregion对应table中的一个region，</p>
</li>
<li><p>hstore<br>hstore存储是hbase存储的核心，其中有两部分组成，一部分是memstore，一部分是storefile。用户写入的数据首先会放入memstore中，当memstore满了以后，会执行一个flush操作，变成一个storefile。当storefile增加到一定的阈值。会出发compact合并操作将多个storefile合并成一个storefile，合并过程中进行版本合并和数据删除。</p>
</li>
<li><p>hlog<br>每个hregionserver都有一个hlog对象，hlog是一个实现write ahead log的类，每次用户写入memstore同时，也会写一份数据到hlog中，hlog文件会定期回滚出新的，并删除old的文件（已经持久化到memstore）。当hregionserver意外终止的时候，hmaster汇通过zookeeper感知到，hmaster会首先处理遗留下来的hlog。将其中不同region的log数据进行拆分，分别放到相应region的目录下，然后再将失效的region重新分配。领取这些region的hregionserver在load region的过程中，会发现有历史hlog需要处理。因此会重新加载hlog中的数据到memstore中，然后保存到哦storefile，完成数据恢复。</p>
</li>
</ol>
<h4 id="3-hbase存储格式"><a href="#3-hbase存储格式" class="headerlink" title="3.hbase存储格式"></a>3.hbase存储格式</h4><ul>
<li>hfile</li>
<li>hlog file</li>
</ul>
<p>1.hfile<br><img src="http://i.imgur.com/Lqn3NUh.png" alt=""></p>
<p>2.hlogfile</p>
<p><img src="http://i.imgur.com/PYr0eFk.png" alt=""></p>
<h4 id="4-数据模型"><a href="#4-数据模型" class="headerlink" title="4.数据模型"></a>4.数据模型</h4><p><img src="http://i.imgur.com/jEb1inN.png" alt=""></p>
<ul>
<li>row key</li>
<li>列族</li>
<li>时间戳</li>
<li>cell</li>
</ul>
<p><img src="http://i.imgur.com/dmLyotO.png" alt=""></p>
<p>hbase中有两张特殊的表，-root- .meta</p>
<p>.meta. 记录用户表的region信息，可以有多个region<br>-root- 记录.meta.表的region信息，只能有一个region</p>
<p>zookeper中记录-root-表的location </p>
<p><img src="http://i.imgur.com/vBzRFlR.png" alt=""></p>
<h4 id="4-hbase红的算法和流程"><a href="#4-hbase红的算法和流程" class="headerlink" title="4.hbase红的算法和流程"></a>4.hbase红的算法和流程</h4><p>region 定位<br><img src="http://i.imgur.com/FBfy26s.png" alt=""></p>
<p>region 分配</p>
<p>region server上线和下线</p>
<p>master上线和下线</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/13/hive/" itemprop="url">
                  hive
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-13T15:44:16+08:00" content="2016-12-13">
              2016-12-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="1-hive介绍"><a href="#1-hive介绍" class="headerlink" title="1.hive介绍"></a>1.hive介绍</h4><p>hive是基于hadoop的一个数据仓库工具。</p>
<p>Hive由Facebook实现并开源，是建立在Hadoop之上的数据仓库解决方案，支持将结构化的<br>数据文件映射为一张表，提供HQL（Hive SQL）实现方便高效的数据查询，底层数据存储在<br>HDFS上。 Hive的本质是<strong>将HQL转换为MapReduce程序去执行</strong>，使不熟悉MapReduce的用<br>户很方便地利用HQL进行数据ETL操作。</p>
<p>工作原理：<br><img src="http://i.imgur.com/UpnpvV5.png" alt=""></p>
<p>hive的入口是driver，执行的sql语句首先提交大driver驱动，然后调用compiler解释驱动，最终解释成mapreduce任务执行，最后结果返回。</p>
<p>特点：</p>
<ul>
<li>更友好的接口：<br>Hive提供类SQL语法使开发人员在使用接口时几乎没有门槛。</li>
<li>更低的学习成本：<br>Hive底层自动实现SQL到MapReduce任务的转换，大大减少开发人员学习和应用MapReduce成本。</li>
<li>更好的可扩展性：<br>Hive可自由扩展集群规模而无需重启服务，此外Hive还支持用户自定义函数。</li>
<li>良好的容错性：<br>当Hive节点出现问题，SQL仍可继续无中断执行</li>
</ul>
<p>hive数据类型：</p>
<ul>
<li>基本数据类型</li>
<li>复杂数据类型</li>
</ul>
<p><img src="http://i.imgur.com/T2N79nW.png" alt=""></p>
<p>hive和关系型数据库对比：<br><img src="http://i.imgur.com/8yl4sPC.png" alt=""><br>针对比较的部分解释：</p>
<ol>
<li>查询语言：由于sql被广泛的应用在数据仓库中，专门针对hive的特性设计了类sql的查询语句。HQL。</li>
<li>数据存储位置：hive建立在hadoop之上，所有hive的数据都存储在hdfs中，而数据库则将数据保存在块设备或者本地文件系统中。</li>
<li>数据格式：hive中没有专门定义的数据结构，数据格式由用户指定，用户定义数据格式需要指定三个属性：列分割符（通常是空格 ‘\t’ ‘\x001’）行分割符（\n）以及读文件的方法（hive默认有三个文件格式textfile sequencefile rcfile）。hive在加载过程中不会对数据本身进行修改，只是将数据内容复制或者移动到相应的hdfs目录中。</li>
<li>数据更新：hive是针对数据仓库应用设计的，而数据仓库内容读多写少，因此hive不支持对数据的改写和添加。</li>
<li>索引：由于不需要对数据进行处理加载的时候，所以不用对数据中的某些key建立索引</li>
<li>执行： 通过hadoop的mapreduce执行</li>
<li>执行延迟：由于查询数据的时候没有索引，所以需要扫描整个表，因此延迟较高。另一个导致hive执行延迟高的银锁是mapreduce框架。</li>
<li>可扩展性，hive建立在hadoop上，扩展性和hadoop一致</li>
</ol>
<h4 id="2-centos7，hive安装"><a href="#2-centos7，hive安装" class="headerlink" title="2.centos7，hive安装"></a>2.centos7，hive安装</h4><p>Hive原则上可以安装在集群上的任何一台机器上面.</p>
<ol>
<li>准备工作-创建配置数据存储位置（非必须？）<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">hadoopfs-mkdir/tmp</div><div class="line">hadoopfs-mkdir/user/hive/warehouse</div><div class="line">hadoopfs-chmodg+w/tmp</div><div class="line">hadoopfs-chmodg+w/user/hive/warehouse</div></pre></td></tr></table></figure>
</li>
</ol>
<p>如果进行这一步的话，在hive-site.xml中配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">hive.metastore.warehouse.dir</div><div class="line">/user/hive/warehouse</div><div class="line">locationofdefaultdatabaseforthewarehouse</div></pre></td></tr></table></figure></p>
<ol>
<li><p>安装mysql作为元数据存储</p>
<p> CentOS7的yum源中默认好像是没有mysql的。为了解决这个问题，我们要先下载mysql的repo源。</p>
<ul>
<li>下载mysql的repo源<br><code>wget http://repo.mysql.com/mysql-community-release-el7-5.noarch.rpm</code></li>
<li>安装mysql-community-release-el7-5.noarch.rpm包<br><code>sudo rpm -ivh mysql-community-release-el7-5.noarch.rpm</code></li>
<li>安装mysql<br><code>sudo yum install mysql-server</code></li>
<li>重启mysql<br><code>sudo systemctl restart mysqld.service</code></li>
<li>设置远程登录<br><code>grant all privileges on *.* to root@&quot;%&quot; identified by &quot;password&quot; with grant option;</code><br><code>flush privileges;</code></li>
<li>为hive设置单独的账户密码登录（我认为可选吧，懒省事直接用root，反正是虚拟机实验）<br><code>create user &#39;hive&#39; identified by &#39;mysql&#39;</code><br><code>grant all privileges on *.* to &#39;hive&#39;@&#39;%&#39; with grant option</code></li>
</ul>
</li>
<li><p>hive下载，针对hadoop2.7.2 hbase1.2.4，选择版本hive2.1.1进行安装。</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget &quot;http://mirrors.cnnic.cn/apache/hive/hive-2.0.0/apache-hive-2.0.0-bin.tar.gz&quot;</div><div class="line">tar -xzvf apache-hive-2.0.0-bin.tar.gz</div></pre></td></tr></table></figure>
</code></pre></li>
<li><p>拷贝mysql驱动文件<br>下载地址：<a href="http://dev.mysql.com/downloads/connector/j/" target="_blank" rel="external">http://dev.mysql.com/downloads/connector/j/</a> ，解压后拷贝其中的mysql-connector-Java-5.1.38-bin.jar到hive的lib文件夹下。</p>
</li>
<li><p>配置环境变量</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vi /etc/profile</div><div class="line">export HIVE_HOME=/usr/hive/apache-hive-2.1.1-bin</div><div class="line">export PATH=$PATH:$HIVE_HOME/bin</div></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件</p>
</li>
</ol>
<p>hive-site.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</div><div class="line">&lt;?xml-stylesheet type="text/xsl" href="configuration.xsl"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://127.0.0.1:3306/hive?createDatabaseIfNotExist=true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>JDBC connect string for a JDBC metastore<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Driver class name for a JDBC metastore<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Username to use against metastore database<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>password to use against metastore database<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  </div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.exec.local.scratchdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/usr/hive/apache-hive-2.1.1-bin/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Local scratch space for Hive jobs<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.downloaded.resources.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/usr/hive/apache-hive-2.1.1-bin/tmp/resources<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Temporary local directory for added resources in the remote file system.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.querylog.location<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/usr/hive/apache-hive-2.1.1-bin/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Location of Hive run time structured log file<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.server2.logging.operation.log.location<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/usr/hive/apache-hive-2.1.1-bin/tmp/operation_logs<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Top level directory where operation logs are stored if logging functionality is enabled<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>修改hive-en.sh：添加jdk和hadoop根目录路径（可选）</p>
<ol>
<li>初始化数据库<br> <code>schematool -initSchema -dbType mysql</code></li>
<li>启动hive <code>bin/hive</code></li>
</ol>
<h4 id="3-hive架构"><a href="#3-hive架构" class="headerlink" title="3.hive架构"></a>3.hive架构</h4><p><img src="http://i.imgur.com/0xW0CN6.png" alt=""></p>
<p>hive的架构可以分为四个部分：</p>
<ul>
<li>用户接口</li>
<li>元数据存储</li>
<li>解释器、编译器、优化器</li>
<li>数据存储</li>
</ul>
<p>以下分别详细介绍;</p>
<p>1.hive用户接口</p>
<p>hive对外提供三种服务模式，命令行模式（CLI）hive的web模式（WUI）、hive的远程服务（client）</p>
<ul>
<li><p>hive命令行模式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./hive</div><div class="line"> hive --service cli</div></pre></td></tr></table></figure>
</li>
<li><p>hive web模式 <code>hive --service hwi</code> 默认端口是9999</p>
</li>
<li>hive远程服务 <code>nohup hive --service hiveserver &amp;</code>（默认端口10000）</li>
</ul>
<p>2.hive元数据库</p>
<p>hive将源数据存储在rdbms中，一般常用mysql和derby。hive默认存储元数据信息在derby。我们已经将其更改为mysql。</p>
<p>理由如下：</p>
<ul>
<li>hive源数据保存在内嵌的derby数据库中么只允许一个会话连接，只适合简单的测试。实际生产环境中不合适，</li>
<li>为了支持多会话，则需要一个独立的元数据库，使用mysql作为元数据库，hive内部对mysql提供了很好的支持。具体配置 参照上面hive安装</li>
</ul>
<p>3.hive的数据存储</p>
<ul>
<li>hive没有专门的数据格式，也没有为数据建立索引。</li>
<li>hive所有的数据存储在hdfs中</li>
<li>hive的数据模型包括（table,external, partition,bucket）</li>
</ul>
<p>部分详细介绍：</p>
<p>table：每一个table在hive中都有一个相应的目录存储数据，例如一个表mytest，他在hdfs中的目录为/user/hive/warehouse/mytest 其中warehouse是在hive-site.xml中<code>hive.metastore.warehouse.dir</code>配置的。所有的table（不包括external table）包含在该目录下</p>
<p>partition:对应于数据库中partition列的密集索引，在，hive中，表中一个partition对应于表下的一个目录，所有的partition的数据都存在对应的目录中，例如mytest表中优name和no两个partition，</p>
<ul>
<li>name=asd,no=4854的hdfs子目录为：<code>/warehouse/mytest/name=asd/no=4854</code></li>
</ul>
<p>buckets对指定列计算hash，根据hash切分数据，目的是并行，每一个bucket对应一个文件，将user列分先至32个bucket，首先对user列计算hash，对应：</p>
<ul>
<li>hash为0的hdfs目录：<code>/warehouse/mytest/name=asd/no=4854、part-00000</code></li>
<li>hash为20的hdfs目录：<code>/warehouse/mytest/name=asd/no=4854、part-00020</code></li>
</ul>
<p><img src="http://i.imgur.com/f3ne7LT.png" alt=""></p>
<p>4.hive解释器</p>
<ul>
<li>解析器</li>
<li>语义分析器</li>
<li>逻辑策略生成器</li>
<li>优化器</li>
</ul>
<h4 id="4-hive文件格式"><a href="#4-hive文件格式" class="headerlink" title="4.hive文件格式"></a>4.hive文件格式</h4><p>四种：textfile sequencefile rcfile 自定义</p>
<p>1.textfile格式</p>
<p>textfile为默认个事，数据不做压缩，磁盘开销大，数据解析开销大。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">create table text(str STRING)</div><div class="line">STORED AS TEXTFILE;</div><div class="line">load data local &apos;/data/test.txt&apos; into table text</div></pre></td></tr></table></figure></p>
<p>2.sequencefile格式</p>
<p>sequencefile格式是hadoop api提供的二进制文件支持。其具有使用方便，可分割，可压缩的特点。一般建议使用block压缩。</p>
<p>3.RCfile格式</p>
<p>一个集行存储和列存储优点于一身，压缩比更高，读取列更快。</p>
<h4 id="5-hive操作"><a href="#5-hive操作" class="headerlink" title="5.hive操作"></a>5.hive操作</h4><ol>
<li>表操作：感觉类似sql。不做介绍了</li>
<li>视图操作</li>
<li>分区操作</li>
<li>桶操作</li>
<li>struct类型<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> struct_test(<span class="keyword">id</span> <span class="built_in">INT</span>,info <span class="keyword">struct</span>&lt;<span class="keyword">name</span>:<span class="keyword">String</span>,age <span class="built_in">INT</span>&gt;)</div><div class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">','</span></div><div class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">':'</span>;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>准备一个文件,内容如下：<br>1,liu：30<br>2,zhang:30<br>执行<br><code>load data local inpath &#39;/test&#39; into table struct_test</code></p>
<ol>
<li>array类型<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> struct_test(<span class="keyword">id</span> <span class="built_in">INT</span>,info <span class="built_in">array</span>&lt;<span class="built_in">INT</span>&gt;)</div><div class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">','</span></div><div class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">':'</span>;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>准备一个文件,内容如下：<br>1,1:2:3<br>2,20:30<br>执行<br><code>load data local inpath &#39;/test&#39; into table struct_test</code></p>
<ol>
<li>map类型<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">test</span>(<span class="keyword">id</span> <span class="keyword">String</span>,info <span class="keyword">map</span>&lt;<span class="keyword">STRING</span>,<span class="built_in">INT</span>&gt;)</div><div class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span></div><div class="line">collection items <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">','</span></div><div class="line"><span class="keyword">map</span> <span class="keyword">keys</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">':'</span>;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>准备一个文件,内容如下：<br>1    job:80,team:60<br>2    job:30,team:60,person:100<br>执行<br><code>load data local inpath &#39;/test&#39; into table test</code></p>
<ol>
<li>join操作</li>
<li>hive函数与自定义函数</li>
<li>hive权限控制</li>
</ol>
<h4 id="5-hive优劣分析"><a href="#5-hive优劣分析" class="headerlink" title="5.hive优劣分析"></a>5.hive优劣分析</h4><p>Hive在扩展性和容错性方面有强大优势，但是在执行引擎高效化和多样化接口与可视化等方面，与传<br>统并行数据仓库还存在一定差距。此外像Tenzing、 DryadLINQ、 Dremel、 HadoopDB 等新兴数据<br>仓库，都有Hive值得借鉴的地方。 Hive的诞生带动了Hadoop开源栈系统的进一步发展，支持用户从<br>零开始快速搭建数据仓库系统，推动了整个产业链的进步。</p>
<ul>
<li>存储灵活性：<br>Hive的元数据存储在RDBMS中，所有其它数据都基于HDFS存储。Hive没有专门的数据存储格式也没有为数据建立索引。 Hive默认支持多种文件格式，也支持用户自定义格式。基于Hive的分析过程支持从不同数据源<br>装载数据</li>
<li>执行效率：Hive基于MapReduce，因此Sort和Groupby等都依赖MapReduce。MapReduce可以理解为固化了的执行算子。此外Hive对Join算子的支持不够全面。在特定应用场景下，内存拷贝和数据预处理同样可能影响Hive的执行效率</li>
<li>可扩展性：Hive的数据处理量是PB级的，因此它具备非常好的水平可扩展性，支持集群部署，支持通过简单地增加资源以支持更大的数据量和负载</li>
<li>可视化：Hive的可视化界面基本属于字符终端，对用户的技术水平要求比较高。提供个性化的可视化展现<br>（GUI），是Hive改进的重要方向。</li>
<li>容错性：Hive基于Hadoop HDFS和MapReduce构建，天然具备较好的容错性，基于Hive实的数据仓库可以部署在普通机器构建的分布式集群之上。</li>
</ul>
<h4 id="6-hive-vs-hbase"><a href="#6-hive-vs-hbase" class="headerlink" title="6.hive vs hbase"></a>6.hive vs hbase</h4><p>Hive主要是为简化编写MapReduce程序而生，而HBase是为查询而生。通过Hive的存储接口Hive和HBase可以整合使用。 Hive通过与HBase集成后能够实现快速的查询。同时，由于HBase不持类SQL语句，通过与Hive集成，Hive为HBase提供SQL语法解析的外壳。</p>
<p>Hive与HBase的整合实现是利用两者对外的API接口互相进行通信的，相互通信主要是依靠<br>hive_hbase-handler.jar工具类。在将HBase和Hive集成的过程中注意确保hbase jar包的一致性。</p>
<p>Hive集成HBase需要在Hive表和HBase表之间建立映射关系，也就是Hive表的列和列类型与HBase表的列族及列限定词建立关联。每一个在Hive表中的列都存在于HBase中，但反过来在Hive表中则不需要包含所有的HBase中的列</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/13/java并发编程实战-线程安全性/" itemprop="url">
                  java并发编程实战-线程安全性
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-13T13:01:13+08:00" content="2016-12-13">
              2016-12-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/并发编程/" itemprop="url" rel="index">
                    <span itemprop="name">并发编程</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>无状态对象是线程安全的。</p>
<p>###1.线程安全###</p>
<p>竞态条件：当某个计算的正确性取决于多个线程的交替执行时序时，那么就会发生竞态条件。</p>
<ul>
<li>先检查后执行–星巴克见面的例子</li>
<li>读取修改写入操作–计数器的例子</li>
</ul>
<p>怎么解决竞态条件呢？如果一些列符合操作是原子的话，就可以解决。我们可以采用加锁机制或者使用线程安全类来解决。</p>
<p><code>java.util.concurrrent.atomic</code>包中包含一些原子变量类。</p>
<p>内置锁：intrinsic lock， 线程在进入同步代码块之前会自动获取锁，并且在退出同步代码块的时候自动释放锁。是一种互斥锁。</p>
<p>重入：为每一个锁关联一个获取计数器和一个所有者线程。当计数器为0时，这个锁被认为是没有人持有的。当一个线程请求一个未被持有的锁，jvm会记录下锁的持有者，并且将获取计数器置为1.如果同一个线程再次获取该锁。计数器将递增。而当线程退出同步代码块时，计数器会相应的递减。当计数值为0时，这个锁将会被释放。</p>
<p>###2.对象的共享###</p>
<p>同步：</p>
<ul>
<li>实现原子性或者确定临界区</li>
<li>内存可见性，希望却摆一个线程修改了对象状态后，其他线程能够看到状态发生的变化。</li>
</ul>
<p>失效数据；<br>非原子的64位操作：jvm允许将64位的读操作和写操作分解为两个32位的操作。</p>
<p>volatile变量：当吧变量声明成volatile类型后，编译期和运行时都会注意到这个变量是共享的，因此不会将该变量上的 操作和其他内存操作一起重排序。volatile变量不会缓存在寄存器或者对其他处理器不可见的地方，因此在读取volatile类型的变量时总会返回最新写入的值。</p>
<p>发布：发布一个对象的意思是指使对象能够在当前作用于之外的代码中使用。</p>
<p>溢出：当某个不该发布的对象被发布。</p>
<p>不变性：不变的对象一定是线程安全的</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/10/javaee7/" itemprop="url">
                  Java EE 7 Tutorial分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-10T16:47:25+08:00" content="2016-12-10">
              2016-12-10
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>##分析要求##</p>
<p>install Java EE7.0 JDK<br>learn Java EE 7 Tutorial，run and analysis Javae EE7.0 Samples，include</p>
<ul>
<li>Servlet 3.1<ul>
<li>The Annotations Servlet Sample Application</li>
<li>The Absolute Ordering of Web Fragments Servlet …</li>
<li>The File Upload Servlet Sample Application</li>
</ul>
</li>
<li>JAX-RS 2.0<ul>
<li>The Asynchronous Chat JAX-RS Sample Application</li>
</ul>
</li>
<li>JSON Processing 1.0<ul>
<li>The JAX-RS JSONP Sample Application</li>
</ul>
</li>
<li>WebSocket 1.0<ul>
<li>The Echo WebSocket Sample Application</li>
<li>The Auction WebSocket Sample Application</li>
</ul>
</li>
</ul>
<p><img src="http://i.imgur.com/Ev34ZJs.png" alt=""></p>
<p>##第一章：java ee7 总览##</p>
<p>JavaEE 7提供了一个完整、全面、集成的堆栈来帮助你构建企业和Web应用程序。</p>
<p>###javaEE 容器###</p>
<p>主要就是JSF（JavaServer Faces）和EJB（Enterprise Java Bean）两大部分，JSF依赖于EJB，并且是重量级的，JSF使用了一大堆组件控制页面，跟Struts2的标签差不多；EJB目前做得不错，相比Spring，EJB完全不需要作任何配置，内部包含JPA规范，可以和Hibernate无缝接入，但是学习曲线依然很大，并且对服务器有要求，用tomcat做服务器还需要和JBoss搭配，新手学习可以使用Glassfish。</p>
<p><img src="http://i.imgur.com/HOEo1LM.png" alt=""></p>
<p>###WEB 容器###</p>
<p>这部分内容比较多，JavaEE 7新添加的为下图棕黄色的部分，即WebSocket、Concurrency Utilities、Batch、JSON-P，新添加部分主要是为HTML5提供更好的伸缩性。</p>
<p><img src="http://i.imgur.com/Yp8A2E6.png" alt=""></p>
<p>###名词 概念###</p>
<p>JWS：即Java Web Service,指与webservice相关的JavaEE技术部分，webservice是一种基于XML的独立的、跨平台的、互操作的应用程序，XML又包含XSD、DTD、XPath等相关技术，这个撇开不说。webservice平台元素主要有SOAP（简易对象访问协议）、UDDI（通用描述、发现及整理）、WSDL（WS描述语言）。</p>
<p>JAX：即Java Xml，类似地JAXB（Java Xml Binding）</p>
<p>目前JWS主要有：</p>
<ul>
<li>JAX-WS 全称JavaTM API forXML-Based Web Services 又叫JAX-RPC（远程调用），顾名思义就是基于Web Services</li>
<li>JAX-RS 全称JavaTM API forRESTful Web Services 即使用REST风格</li>
<li>JAXB</li>
<li>JAXR</li>
<li>SAAJ</li>
<li>STAX</li>
</ul>
<p>网上说关于JAX-WS与JAX-RS有这么说的： 两者是不同风格的SOA架构。前者以动词为中心，指定的是每次执行函数。而后者以名词为中心，每次执行的时候指的是资源。</p>
<p>感觉这个说法比较靠谱，JAX-WS是<strong>面向消息</strong>的，每次请求的时候指定了请求的方法。JAX-RS是<strong>面向资源</strong>的。后则将网络上的东西当做一种资源，每次请求都是对该资源进行操作，比如对资源的增删查改。</p>
<p>CDI：即Contexts Dependency Injection，和Spring的IOC差不多的东西，就是可以在组件中通过注解注入上下文、请求和响应等。</p>
<p>JTA：即Java Transaction API，使用过Hibernate和EJB的应该知道，就是事务处理，JTA依赖于所处的容器，如果不是分布式开发的话，我们一般使用本地事务，即是数据库本身的事务处理。</p>
<p>PA：即Java Persistence API，就是最常用的持久化技术，原本属于EJB中的部分，EJB3.0之后分离出来，作为一个独立的规范。作为一种ORM技术，JPA提供了基本的统一标准。</p>
<p>MS：即Java Message Service，和JDBC类似，提供了一个统一的API供其他厂商实现，主要用于客户机信息的交互，JMS主要有点到点和订阅/发布两种方式</p>
<p>##第二章：servlet 3.1技术##</p>
<p>本章主要分两部分来介绍servlet技术。</p>
<p>第一部分讲解servlet的一些知识，主要参考17章：java servlet technology。主要包含以下内容：</p>
<p>3.0新特性：</p>
<ul>
<li>开发的简易型<ul>
<li>新增注解支持</li>
</ul>
</li>
<li>可插拔性和可扩展性<ul>
<li>Web 片段是将 web 应用程序逻辑分区为 servlet、servlet-mapping、servlet-filter、filter-mapping、servlet-listener 之类的元素及其子元素</li>
</ul>
</li>
<li>异步支持<ul>
<li>将新的 API 添加到 ServletRequest 和 ServletResponse，用于挂起、恢复和查询请求的状况、启用禁用和查询响应的状况。开发人员可以分别通过 requestSuspended(), requestResumed() 和 requestCompleted() 方法使用请求的 resume、suspend 和 complete 方法通知事件</li>
</ul>
</li>
<li>安全性增强<ul>
<li>Servlet3.0方案建议提供通过编程实现登录和注销功能。HTTPServletRequest 中添加的新 API 可以启用这项功能。HTTPServletRequest 的 login 方法使应用程序或者框架强制进行以容器为中介的验证。HTTPServletRequest 和 HTTPSession 的 logout 方法允许应用程序重置请求的验证状态</li>
</ul>
</li>
<li>其它杂项变化</li>
</ul>
<p>3.1新特性：</p>
<ul>
<li>无阻塞 I/O</li>
<li>协议升级</li>
<li>安全性增强</li>
</ul>
<p>第二部分分析javaee 7 simples 下面的个例子。分为以下6个模块：</p>
<ul>
<li>最基本的操作实例<ul>
<li>cookies</li>
<li>error-mapping</li>
<li>file-upload</li>
</ul>
</li>
<li>servlet3中引入的注解的例子<ul>
<li>servlet-filters</li>
<li>event-listeners</li>
</ul>
</li>
<li>注解与web.xml并存或分片处理的例子<ul>
<li>metadata-complete</li>
<li>web-fragment</li>
</ul>
</li>
<li>异步请求处理<ul>
<li>async-servlet</li>
<li>nonblocking</li>
</ul>
</li>
<li>安全验证<ul>
<li>form-based-security</li>
<li>servlet-security</li>
</ul>
</li>
<li>资源打包<ul>
<li>resource-packaging</li>
</ul>
</li>
<li>协议操作</li>
<li>protocol-handler</li>
</ul>
<h3 id="第一部分：servlet-3-1"><a href="#第一部分：servlet-3-1" class="headerlink" title="第一部分：servlet 3.1"></a>第一部分：servlet 3.1</h3><p>####2.1.1 what is a servlet? ####</p>
<p>A servlet is a Java™ technology-based Web component, managed by a container,that generates dynamic content. —— from JSR315</p>
<p><img src="http://i.imgur.com/t7UqWCg.png" alt=""></p>
<p>The service() method is given an implementation in the HTTPServletbase class, where the doGet() and doPost() methods are called.</p>
<p><img src="http://i.imgur.com/dQTarFP.png" alt=""></p>
<p>####2.1.2 Servlet Lifecycle ####<br><img src="http://i.imgur.com/n3iYiRE.png" alt=""></p>
<p>####2.1.3 writing service methods ####<br>servletrequest:</p>
<p>ServletRequest接口中封装了客户请求信息，如客户请求方式、参数名和参数值、客户端正在使用的协议, 以及发出客户请求的远程主机信息等。</p>
<p><img src="http://i.imgur.com/qfIhhsO.png" alt=""></p>
<p>ServletResponse:</p>
<p>Defines an object to assist a servlet in sending a response to the client. </p>
<p><img src="http://i.imgur.com/0ETpjHg.png" alt=""></p>
<p>####2.1.4 filtering requests and responses ####<br>Filters are Java components—very similar to servlets—that you can use to intercept and process requests before they are sent to the servlet, or to process responses after the servlet has completed, but before the response goes back to the client.</p>
<p><img src="http://i.imgur.com/zqO4Q71.png" alt=""></p>
<ul>
<li>init()</li>
<li>doFilter()</li>
<li>destory()</li>
</ul>
<p>####2.1.5 invoking other web resources ####</p>
<p>web组件能够直接或者间接的调用其他web资源。一个web组件间接地调用其他web资源通过把一个指向另一个web组件的url嵌入到返回客户端的内容中，当他被执行的时候，一个web组件直接的调用另一个资源或者包换另一个资源的内容或者只想另一个资源的请求。</p>
<p><strong>RequestDispatcher</strong></p>
<pre><code>include（request,response）
forward()
</code></pre><p>####2.1.6 accessing the web context ####</p>
<p>web组件执行的context是一个实现servletContext接口的对象，你可以取出该对象通过getServletContext方法。web context子宫访问以下内容的访问方法：</p>
<ul>
<li>Initialization parameters</li>
<li>Resources associated with the web context</li>
<li>Object-valued attributes</li>
<li>Logging capabilities</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">setAttribute(String name, Object object) </div><div class="line"> <span class="comment">//Binds an object to a given attribute name in this ServletContext.</span></div><div class="line">getAttribute(String name)</div><div class="line"><span class="comment">//Returns the servlet container attribute with the given name, or null if there is no attribute by that name.</span></div><div class="line">getRequestDispatcher(String path) </div><div class="line"><span class="comment">//Returns a RequestDispatcher object that acts as a wrapper for the resource located at the given path. </span></div><div class="line"> log(String msg) </div><div class="line"><span class="comment">//Writes the specified message to a servlet log file, usually an event log.  </span></div><div class="line">getRealPath(String path) </div><div class="line"><span class="comment">//Gets the real path corresponding to the given virtual path.</span></div></pre></td></tr></table></figure>
<p>####2.1.7 maintaining client state ####</p>
<p>http协议是无状态的。为了支持需要获取状态的应用，java servlet 技术提供了一个管理sessions的api和允许多种实现sessions的机制。</p>
<p>getSession()：返还和request关联的session对象，没有的话，创建一个。<br>getSession(false)： 返回返还和request关联的session对象，没有的话，返回null<br>isNew(）//如果客户端还没有返回具有该sessionid的session，为true</p>
<p>####2.1.8 uploading files with java servlet technology ####</p>
<p>@MultipartConfig :支持一下属性</p>
<ul>
<li>location:文件系统中目录的绝对路径</li>
<li>fileSizeThreshold:在文件被暂时存储在disk上，文件的自己额大小，默认是0字节。</li>
<li>MaxFileSize:允许上传文件的最大大小</li>
<li>maxRequestSize:最大允许一个multipart/form-data请求的数量。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@MultipartConfig</span>(location=<span class="string">"/tmp"</span>, fileSizeThreshold=<span class="number">1024</span>*<span class="number">1024</span>,</div><div class="line">maxFileSize=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">5</span>, maxRequestSize=<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">5</span>*<span class="number">5</span>)</div></pre></td></tr></table></figure>
<ul>
<li>Collection<part> getParts()</part></li>
<li>Part getPart(String name)</li>
</ul>
<p>####2.1.9 Asynchronous Processing in Servlets ####</p>
<p>使用asyncSupported属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebServlet</span>(urlPatterns=&#123;<span class="string">"/asyncservlet"</span>&#125;, asyncSupported=<span class="keyword">true</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123; ... &#125;</div></pre></td></tr></table></figure>
<p><code>javax.servlet.AsyncContext</code>提供方法，这些方法包含你需要异步处理的功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> </span>&#123;</div><div class="line">...</div><div class="line">AsyncContext acontext = req.startAsync();</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://i.imgur.com/vc6RIea.png" alt=""></p>
<p>####2.1.10 Nonblocking I/O ####</p>
<p>java ee 对于servlets和filters提供非阻塞i/o ，当在异步模式下处理请求。下面的步骤总结了怎么使用非阻塞io来处理请求和写回复，在service方法中。</p>
<ol>
<li>Put the request in asynchronous mode as described in Asynchronous Processing.</li>
<li>Obtain an input stream and/or an output stream from the request and response<br>objects in the service method.</li>
<li>Assign a read listener to the input stream and/or a write listener to the output<br>stream.</li>
<li>Process the request and the response inside the listener’s callback methods.</li>
</ol>
<p><img src="http://i.imgur.com/rgWh3iZ.png" alt=""></p>
<h3 id="第二部分：-Examples-of-the-servlet"><a href="#第二部分：-Examples-of-the-servlet" class="headerlink" title="第二部分： Examples of the servlet"></a>第二部分： Examples of the servlet</h3><p>####2.2.1 Example 1：session-cookie-config ####</p>
<p>这个例子展示了session的获取和cookie的获取。</p>
<p>首先定义一个监听器，来初始化SessionCookieConfig对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebListener</span>()</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Receives notification that the web application initialization</div><div class="line">     * process is starting.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> sce The servlet context event</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">        SessionCookieConfig scc =</div><div class="line">            sce.getServletContext().getSessionCookieConfig();</div><div class="line">        scc.setName(<span class="string">"MYJSESSIONID"</span>);</div><div class="line">        scc.setPath(<span class="string">"/myPath"</span>);</div><div class="line">        scc.setDomain(<span class="string">"mydomain"</span>);</div><div class="line">        scc.setComment(<span class="string">"myComment"</span>);</div><div class="line">        scc.setSecure(<span class="keyword">true</span>);</div><div class="line">        scc.setHttpOnly(<span class="keyword">true</span>);</div><div class="line">        scc.setMaxAge(<span class="number">123</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">        <span class="comment">// Do nothing</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当接收到get请求的时候，我们通过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebServlet</span>(urlPatterns = <span class="string">"/"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateSession</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span></span></div><div class="line">            <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line"></div><div class="line">        req.getSession(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        String sessionCookie = res.getHeader(<span class="string">"Set-Cookie"</span>);</div><div class="line">        <span class="keyword">if</span> (sessionCookie == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Missing Set-Cookie response header"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// name</span></div><div class="line">        <span class="keyword">if</span> (sessionCookie.indexOf(<span class="string">"MYJSESSIONID="</span>) == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Missing session id"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// comment</span></div><div class="line">       <span class="comment">/* if (sessionCookie.indexOf("Comment=myComment") == -1) &#123;</span></div><div class="line">            throw new ServletException("Missing cookie comment");</div><div class="line">        &#125;*/</div><div class="line"></div><div class="line">        <span class="comment">// domain</span></div><div class="line">        <span class="keyword">if</span> (sessionCookie.indexOf(<span class="string">"domain=mydomain"</span>) == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Missing cookie domain"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// path</span></div><div class="line">        <span class="keyword">if</span> (sessionCookie.indexOf(<span class="string">"path=/myPath"</span>) == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Missing cookie path"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// secure</span></div><div class="line">        <span class="keyword">if</span> (sessionCookie.indexOf(<span class="string">"Secure"</span>) == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Missing Secure attribute"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// http-only</span></div><div class="line">        <span class="keyword">if</span> (sessionCookie.indexOf(<span class="string">"HttpOnly"</span>) == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Missing HttpOnly attribute"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// max-age</span></div><div class="line">        <span class="keyword">if</span> (sessionCookie.indexOf(<span class="string">"Max-Age=123"</span>) == -<span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Missing max-age"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        res.getWriter().println(sessionCookie);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-2-Example-2：注解的使用"><a href="#2-2-2-Example-2：注解的使用" class="headerlink" title="2.2.2 Example 2：注解的使用"></a>2.2.2 Example 2：注解的使用</h4><p>TestServlet分析：<br>Servlet3.1规范大量使用注解来声明Servlet中，过滤器，监听器和安全性。配置文件web.xml中现在是可选的。</p>
<p>servlet：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.PrintWriter;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletConfig;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.annotation.WebInitParam;</div><div class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * This class illustrate WebServlet annotation</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> Shing Wai Chan</div><div class="line"> */</div><div class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"TestServlet"</span>, urlPatterns = &#123;<span class="string">"/"</span>&#125;,</div><div class="line">            initParams = &#123;<span class="meta">@WebInitParam</span>(name = <span class="string">"message"</span>, value = <span class="string">"my servlet"</span>)&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String listenerMessage = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">        <span class="keyword">super</span>.init(config);</div><div class="line">        listenerMessage = (String) config.getServletContext().getAttribute(<span class="string">"listenerMessage"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line">        PrintWriter writer = res.getWriter();</div><div class="line">        writer.write(<span class="string">"Hello, "</span> + getInitParameter(<span class="string">"message"</span>) + <span class="string">", "</span>);</div><div class="line">        writer.write(req.getAttribute(<span class="string">"filterMessage"</span>) + <span class="string">", "</span>);</div><div class="line">        writer.write(listenerMessage + <span class="string">".\n"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebFilter</span>(filterName = <span class="string">"TestFilter"</span>, urlPatterns = &#123;<span class="string">"/"</span>&#125;,</div><div class="line">           initParams = &#123;<span class="meta">@WebInitParam</span>(name = <span class="string">"mesg"</span>, value = <span class="string">"my filter"</span>)&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">    String mesg = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">        mesg = filterConfig.getInitParameter(<span class="string">"mesg"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res,</span></span></div><div class="line">            FilterChain chain) <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line">        req.setAttribute(<span class="string">"filterMessage"</span>, mesg);</div><div class="line">        chain.doFilter(req, res);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebListener</span>()</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServletContextListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">        ServletContext context = sce.getServletContext();</div><div class="line">        String msg = <span class="string">"my listener"</span>;</div><div class="line">        context.setAttribute(<span class="string">"listenerMessage"</span>, msg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent sce)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果:<br><img src="http://i.imgur.com/ZRBC2kM.png" alt=""></p>
<h4 id="2-2-3-Example-3：文件上传"><a href="#2-2-3-Example-3：文件上传" class="headerlink" title="2.2.3 Example 3：文件上传"></a>2.2.3 Example 3：文件上传</h4><p>解释：<br>一个file是一个part，并且filename可以自己写方法解析，也可以直接调用方法part.getSubmittedFileName()。<br>写文件到本地，可以直接调用write（）方法，也可以自己实现。总的来说是一个很方便的功能。</p>
<p>@WebServlet标注使用URL模式属性来定义的servlet映射。</p>
<p>@MultipartConfig注释指示该servlet的期望请求被使用的multipart / form-data的MIME类型进行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</div><div class="line"><span class="keyword">import</span> java.io.FileOutputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line"><span class="keyword">import</span> java.util.Collection;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.annotation.MultipartConfig;</div><div class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.Part;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@author</span> Kinman Chung</div><div class="line"> * <span class="doctag">@author</span> Daniel Guo</div><div class="line"> */</div><div class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"TestServlet"</span>, urlPatterns = &#123;<span class="string">"/TestServlet"</span>&#125;)</div><div class="line"><span class="meta">@MultipartConfig</span>()</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Processes requests for both HTTP</div><div class="line">     * &lt;code&gt;GET&lt;/code&gt; and</div><div class="line">     * &lt;code&gt;POST&lt;/code&gt; methods.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request servlet request</div><div class="line">     * <span class="doctag">@param</span> response servlet response</div><div class="line">     * <span class="doctag">@throws</span> ServletException if a servlet-specific error occurs</div><div class="line">     * <span class="doctag">@throws</span> IOException if an I/O error occurs</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></div><div class="line">            <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line">    	request.setCharacterEncoding(<span class="string">"utf-8"</span>);</div><div class="line">    	Collection&lt;Part&gt; parts= request.getParts();</div><div class="line">    	System.out.println(parts.size());</div><div class="line">    	<span class="keyword">for</span>(Part part:parts)&#123;</div><div class="line">    		System.out.println(getFileName(part));</div><div class="line">    		String name=getFileName(part);</div><div class="line">    		<span class="keyword">if</span>(name==<span class="keyword">null</span>||name.equals(<span class="string">""</span>))&#123;</div><div class="line">    			<span class="comment">//do nothing</span></div><div class="line">    		&#125;<span class="keyword">else</span>&#123;</div><div class="line">    			part.write(<span class="string">"e:/a/"</span> +getFileName(part));	</div><div class="line">    		&#125;</div><div class="line">    	&#125;</div><div class="line">       request.getRequestDispatcher(<span class="string">"getParts.jsp"</span>).forward(request, response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getFileName</span><span class="params">(Part part)</span> </span>&#123;</div><div class="line">        String header = part.getHeader(<span class="string">"Content-Disposition"</span>);</div><div class="line">        String fileName = header.substring(header.indexOf(<span class="string">"filename=\""</span>) + <span class="number">10</span>, header.lastIndexOf(<span class="string">"\""</span>));</div><div class="line"></div><div class="line">        <span class="keyword">return</span> fileName;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(String fileName, Part part)</span> <span class="keyword">throws</span> IOException, FileNotFoundException </span>&#123;</div><div class="line">        InputStream in = part.getInputStream();</div><div class="line">        File file = <span class="keyword">new</span> File(<span class="string">"e:/a/"</span> + fileName);</div><div class="line">        OutputStream out = <span class="keyword">new</span> FileOutputStream(<span class="string">"e:/a/"</span> + fileName);</div><div class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</div><div class="line">        <span class="keyword">int</span> length = -<span class="number">1</span>;</div><div class="line">        <span class="keyword">while</span> ((length = in.read(buffer)) != -<span class="number">1</span>) &#123;</div><div class="line">            out.write(buffer, <span class="number">0</span>, length);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        in.close();</div><div class="line">        out.close();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// &lt;editor-fold defaultstate="collapsed" desc="HttpServlet methods. Click on the + sign on the left to edit the code."&gt;</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handles the HTTP</div><div class="line">     * &lt;code&gt;GET&lt;/code&gt; method.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request servlet request</div><div class="line">     * <span class="doctag">@param</span> response servlet response</div><div class="line">     * <span class="doctag">@throws</span> ServletException if a servlet-specific error occurs</div><div class="line">     * <span class="doctag">@throws</span> IOException if an I/O error occurs</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></div><div class="line">            <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line">        processRequest(request, response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handles the HTTP</div><div class="line">     * &lt;code&gt;POST&lt;/code&gt; method.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request servlet request</div><div class="line">     * <span class="doctag">@param</span> response servlet response</div><div class="line">     * <span class="doctag">@throws</span> ServletException if a servlet-specific error occurs</div><div class="line">     * <span class="doctag">@throws</span> IOException if an I/O error occurs</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></div><div class="line">            <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line">        processRequest(request, response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns a short description of the servlet.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> a String containing servlet description</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Short description"</span>;</div><div class="line">    &#125;<span class="comment">// &lt;/editor-fold&gt;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果：<br><img src="http://i.imgur.com/gr81LUH.png" alt=""></p>
<h4 id="2-2-4-Example-4：web模块化"><a href="#2-2-4-Example-4：web模块化" class="headerlink" title="2.2.4 Example 4：web模块化"></a>2.2.4 Example 4：web模块化</h4><p>原本一个web应用的任何配置都需要在web.xml中进行，因此会使得web.xml变得很混乱，而且灵活性差，因此Servlet 3.0可以将每个Servlet、Filter、Listener打成jar包，然后放在WEB-INF\lib中；注意各自的模块都有各自的配置文件，这个配置文件的名称为  web-fragment.xml ;</p>
<p>步骤如下：</p>
<ol>
<li>编写Servlet，并编译；</li>
<li>将此编译class文件及所在包通过jar包命令打成jar包；</li>
<li>将此jar包用winrar打开，并将其中的META-INF中的manifest删除并添加 web-fragment.xml；</li>
<li>将此jar包放入WEB-INF\lib中即可；</li>
</ol>
<p>web-fragment.xml注意点：</p>
<ol>
<li>根元素为<web-fragment>;</web-fragment></li>
<li><name></name>表示模块名称；</li>
<li><ordering></ordering>是此模块的加载顺序；</li>
<li><before><others></others></before>表示第一个加载；</li>
<li><after><name>A</name></after>表示比A后面加载；</li>
<li>可以在里面部署listener、filter、servlet</li>
</ol>
<p>针对本例子而言，<br>为了更好地进行适配，减少配置，一个web-fragment是可指定的，并包括在一个库或框架jar文件中的web.xml的一部分或全部。如果有很多个web-fragment jars时，那么人们可能会喜欢指定处理Web-fragment.xml之和注释的顺序。这个很重要。例如，过滤器可以为在web.xml中指定的顺序被执行，类似于监听。在Servlet3.1中，引入了web.xml 中的的标签和web-fragment.xml中的标签。</p>
<p>Web Fragments的顺序被指定在以下优先级：</p>
<ul>
<li>(1)在web.xml中如果存在</li>
<li>(2)如果存在于每一个web-fragment.xml</li>
<li>(3)其他未指定</li>
</ul>
<p>在web.xml的 中提供了一种方法，以指定加载web的fragment.xml之和web fragments的注释处理的顺序。代码如下:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="3.0" xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"&gt;</div><div class="line">    &lt;absolute-ordering&gt;</div><div class="line">        &lt;name&gt;A&lt;/name&gt;</div><div class="line">        &lt;others/&gt;</div><div class="line">        &lt;name&gt;B&lt;/name&gt;</div><div class="line">    &lt;/absolute-ordering&gt;</div><div class="line">&lt;/web-app&gt;</div></pre></td></tr></table></figure>
<p>另外，在上述例子中，web fragment A 将被第一个处理，web fragment B 被最后处理。名称A和B在web-fragment.xml之中的元素指定的（见下面的例子）。</p>
<p>排序是在web-fragment.xml中被指定的。如果在web.xml中没有，会查找web-fragment.xml中的。<br>仅仅在web-fragment.xml存在一个的jar包，代码如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;web-fragment&gt;</div><div class="line">            &lt;name&gt;A&lt;/name&gt;</div><div class="line">            ...</div><div class="line">            &lt;ordering&gt;</div><div class="line">                &lt;before&gt;</div><div class="line">                    &lt;others/&gt;</div><div class="line">                &lt;/before&gt;</div><div class="line">            &lt;/ordering&gt;</div><div class="line">&lt;/web-fragment&gt;</div></pre></td></tr></table></figure>
<p>在这种情况下，web-fragment A将首先被处理。<br>下面是在web-fragment.xml存在两个的示例，代码如下:<br>web-fragment A</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;web-fragment&gt;</div><div class="line">            &lt;name&gt;A&lt;/name&gt;</div><div class="line">            ...</div><div class="line">            &lt;ordering&gt;</div><div class="line">                &lt;before&gt;</div><div class="line">                    &lt;others/&gt;</div><div class="line">                &lt;/before&gt;</div><div class="line">            &lt;/ordering&gt;</div><div class="line">&lt;/web-fragment&gt;</div></pre></td></tr></table></figure>
<p>web-fragment B</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;web-fragment&gt;</div><div class="line">            &lt;name&gt;B&lt;/name&gt;</div><div class="line">            ...</div><div class="line">            &lt;ordering&gt;</div><div class="line">                &lt;before&gt;</div><div class="line">                    &lt;others/&gt;</div><div class="line">                &lt;/before&gt;</div><div class="line">            &lt;/ordering&gt;</div><div class="line">&lt;/web-fragment&gt;</div></pre></td></tr></table></figure>
<p>这时web-fragment A和web-fragment B会首先被处理。在这种情况下，人们只能保证web-fragment A和web-fragment B在其他web-fragment之前处理。但是A和B的顺序并不确定，在这种情况下这是随机的。<br>有两个包含 的jars 存在于web-fragment.xml之中，如下</p>
<p>web-fragment A</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;web-fragment&gt;</div><div class="line">            &lt;name&gt;A&lt;/name&gt;</div><div class="line">            ...</div><div class="line">            &lt;ordering&gt;</div><div class="line">                &lt;before&gt;</div><div class="line">                    &lt;others/&gt;</div><div class="line">                &lt;/before&gt;</div><div class="line">            &lt;/ordering&gt;</div><div class="line">&lt;/web-fragment&gt;</div></pre></td></tr></table></figure>
<p>web-fragment B</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;web-fragment&gt;</div><div class="line">            &lt;name&gt;B&lt;/name&gt;</div><div class="line">            ...</div><div class="line">            &lt;ordering&gt;</div><div class="line">                &lt;after&gt;</div><div class="line">                    &lt;name&gt;A&lt;/name&gt;</div><div class="line">                &lt;/after&gt;</div><div class="line">                &lt;before&gt;</div><div class="line">                    &lt;others/&gt;</div><div class="line">                &lt;/before&gt;</div><div class="line">            &lt;/ordering&gt;</div><div class="line">&lt;/web-fragment&gt;</div></pre></td></tr></table></figure>
<p>在这种情况下，A将首先被处理，其次是B，然后其他web fragments。如果想有一个确定的顺序，那么建议使用在web.xml中的absolute-ordering。<br>如何存放web fragments？如果一个框架被打包为一个jar文件，并在部署描述符的形式的元数据信息，那么Web fragments需要被放置在jar文件的META-INF/文件夹。</p>
<p>另一方面，如果一个框架，优先使用web fragment.xml这种方法，而且它增强了Web应用程序的web.xml，该框架必须在Web应用程序中被放置在的WEB-INF/ lib目录中。</p>
<p>运行结果：<br><img src="http://i.imgur.com/OvCgqQc.png" alt=""></p>
<p>##第三章：JAX-RS 2.0 技术##<br>当JAX-RS 1.0在2008年第一次由JSR-311——特别是其领导者Marc Hadley和Paul Sandoz——公之于众的时候，它就成为了第一个基于POJO/Annotation的、用于创建健壮的Web应用的框架。</p>
<p>五年后，Java EE 7已经发布并且它包含了最新的JAX-RS 2.0版本，JSR-339的实现由Marek Potociar和Santiago Pericas-Geertsen发起。与Java EE 7的核心主题相一致，JAX-RS 2.0添加了一些期待已久的特性，这些特性主要围绕Oracle所称的“简化API”。</p>
<p>本章主要介绍rest和jax-rs技术。分两个部分。</p>
<p>第一部分介绍相关知识和概念，主要参考第31章内容。主要包含以下内容：</p>
<ul>
<li>客户端API</li>
<li>异步</li>
<li>HATEOAS（超媒体）</li>
<li>注解</li>
<li>验证</li>
<li>过滤器与处理程序</li>
<li>内容协商</li>
</ul>
<p>第二部分主要介绍一些simples。</p>
<ul>
<li>async-chat</li>
<li>message-board</li>
</ul>
<p>###第一部分：JAX-RS: Advanced Topics####</p>
<ul>
<li><p>rest：</p>
<p>  REpresentational State Transfer：代表性状态传输、具象状态传输</p>
<p>  REST定义了应该如何正确地使用Web标准，例如HTTP和URI。REST并非标准，而是一种开发 Web 应用的架构风格，可以将其理解为一种设计模式。</p>
</li>
<li><p>jax-rs：</p>
<p>  Java API forRESTful WebServices旨在定义一个统一的规范，使得 Java 程序员可以使用一套固定的接口来开发 REST 应用，避免了依赖于第三方框架。是一个Java编程语言的应用程序接口，支持按照表象化状态转变 (REST)架构风格创建Web服务Web服务。</p>
<p>  与传统的 servlet 模型相比，JAX-RS 提供了一种可行的、更为简便、移植性更好的方式来在 Java 内实现 RESTful 服务。使用注释让您能够轻松提供 Java 资源的路径位置并将 Java 方法绑定到 HTTP 请求方法。一种可移植的数据绑定架构提供了一些本机的 Java 类型支持并允许进行序列化/反序列化处理的完全定制。javax.ws.rs.core.Application 子类的扩展以及 web.xml 内的相应清单表明了用最少的部署描述符配置就能进行轻松部署。</p>
<p>  JAX-RS 的具体实现由第三方提供，例如 Sun 的参考实现 Jersey、Apache 的 CXF 以及 JBoss 的 RESTEasy。</p>
</li>
</ul>
<p>####3.1.1 注解####</p>
<p>注释<br>新的注释已经嵌入，例如支持新的注入。<br>JAX-RS提供注解如下：<br><img src="http://i.imgur.com/ydDwiFZ.png" alt=""></p>
<ul>
<li><p>@Path，标注资源类或方法的相对路径</p>
</li>
<li><p>@GET，@PUT，@POST，@DELETE，标注方法是用的HTTP请求的类型，分别对应 4 种 HTTP 方法，用于对资源进行创建、检索、更新和删除的操作。</p>
<ul>
<li>若要创建资源，应该使用 POST 方法；</li>
<li>若要检索某个资源，应该使用 GET 方法；</li>
<li>若要更改资源状态或对其进行更新，应该使用 PUT 方法；</li>
<li>若要删除某个资源，应该使用 DELETE 方法。</li>
</ul>
</li>
<li><p>@Produces，标注返回的MIME媒体类型</p>
</li>
<li><p>@Consumes，标注可接受请求的MIME媒体类型</p>
</li>
<li><p>@PathParam，@QueryParam，@HeaderParam，@CookieParam，@MatrixParam，@FormParam，分别标注方法的参数来自于HTTP请求的不同位置，</p>
<ul>
<li>@PathParam来自于URL的路径，</li>
<li>@QueryParam来自于URL的查询参数，</li>
<li>@HeaderParam来自于HTTP请求的头信息，</li>
<li>@CookieParam来自于HTTP请求的Cookie。</li>
</ul>
</li>
</ul>
<p>具体例子如下：</p>
<ul>
<li><p>获取path参数：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/employees/&#123;firstname&#125;.&#123;lastname&#125;@&#123;domain&#125;.com"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmpResource</span> </span>&#123;</div><div class="line"><span class="meta">@GET</span></div><div class="line"><span class="meta">@Produces</span>(<span class="string">"text/xml"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getEmployeelastname</span><span class="params">(@PathParam(<span class="string">"lastname"</span>)</span> String lastName) </span>&#123;</div><div class="line">...</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 在这个例子中，@path注解定义了url变量(firstname lastname domain),request请求中pathparm标签从url中获取lastname属性。你也可以使用正则表达式，比如你想要求lastname只包含大小写字母，你可以定义如下。在这里，如果lastname没有匹配正则表达式，一个404 response将会被返回。<code>@Path(&quot;/employees/{firstname}.{lastname[a-zA-Z]*}@{domain}.com&quot;)</code></p>
</li>
<li><p>获取query参数：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/employees/"</span>)</div><div class="line"><span class="meta">@GET</span></div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">getEmployees</span><span class="params">(</span></span></div><div class="line">@DefaultValue(<span class="string">"2003"</span>) @<span class="title">QueryParam</span><span class="params">(<span class="string">"minyear"</span>)</span> <span class="keyword">int</span> minyear,</div><div class="line">@<span class="title">DefaultValue</span><span class="params">(<span class="string">"2013"</span>)</span> @<span class="title">QueryParam</span><span class="params">(<span class="string">"maxyear"</span>)</span> <span class="keyword">int</span> maxyear)</div><div class="line">&#123;...&#125;</div></pre></td></tr></table></figure>
<pre><code>这段代码定义了连个参数minyear和maxyear。请求如下：`GET /employees?maxyear=2013&amp;minyear=2003`我们可以得到这两个参数。
</code></pre></li>
<li><p>获取表单数据</p>
<p>  使用@formparm注解来从html forms中抽取参数。</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;FORM action=&quot;http://example.com/employees/&quot; method=&quot;post&quot;&gt;</div><div class="line">&lt;p&gt;</div><div class="line">&lt;fieldset&gt;</div><div class="line">Employee name: &lt;INPUT type=&quot;text&quot; name=&quot;empname&quot; tabindex=&quot;1&quot;&gt;</div><div class="line">Employee address: &lt;INPUT type=&quot;text&quot; name=&quot;empaddress&quot; tabindex=&quot;2&quot;&gt;</div><div class="line">Manager name: &lt;INPUT type=&quot;text&quot; name=&quot;managername&quot; tabindex=&quot;3&quot;&gt;</div><div class="line">&lt;/fieldset&gt;</div><div class="line">&lt;/p&gt;</div><div class="line">&lt;/FORM&gt;</div></pre></td></tr></table></figure>
<p>  获取指定参数：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Consumes</span>(<span class="string">"application/x-www-form-urlencoded"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(@FormParam(<span class="string">"managername"</span>)</span> String managername) </span>&#123;</div><div class="line"><span class="comment">// Store the value</span></div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  获取一个键值对map：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Consumes</span>(<span class="string">"application/x-www-form-urlencoded"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(MultivaluedMap&lt;String, String&gt; formParams)</span> </span>&#123;</div><div class="line"><span class="comment">// Store the message</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>获取java类型</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@GET</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getParams</span><span class="params">(@Context UriInfo ui)</span> </span>&#123;</div><div class="line">MultivaluedMap&lt;String, String&gt; queryParams = ui.getQueryParameters();</div><div class="line">MultivaluedMap&lt;String, String&gt; pathParams = ui.getPathParameters();</div><div class="line">&#125;</div><div class="line"><span class="meta">@GET</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getHeaders</span><span class="params">(@Context HttpHeaders hh)</span> </span>&#123;</div><div class="line">MultivaluedMap&lt;String, String&gt; headerParams = hh.getRequestHeaders();</div><div class="line">MultivaluedMap&lt;String, Cookie&gt; pathParams = hh.getCookies();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>####3.1.2 resource类和resource方法####</p>
<p>Web 资源作为一个 Resource 类来实现，对资源的请求由 Resource 方法来处理。</p>
<p>Resource 类或 Resource 方法被打上了 Path 标注，Path 标注的值是一个相对的 URI 路径，用于对资源进行定位，路径中可以包含任意的正则表达式以匹配资源。和大多数 JAX-RS 标注一样，Path 标注是可继承的，子类或实现类可以继承超类或接口中的 Path 标注。</p>
<p>Resource 类是 POJO，使用 JAX-RS 标注来实现相应的 Web 资源。</p>
<p>Resource 类分为根 Resource 类和子 Resource 类，区别在于子 Resource 类没有打在类上的 @Path 标注。</p>
<p>Resource 类的实例方法打上了@Path 标注，则为 Resource 方法或子 Resource 定位器，子 Resource 定位器上没有任何 @GET、@POST、@PUT、@DELETE 或者自定义的 @HttpMethod</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/"</span>)   </div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookkeepingService</span> </span>&#123;   </div><div class="line">    ......   </div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/person/"</span>) <span class="comment">//资源方法；若无@POST，则为子资源定位器  </span></div><div class="line">    <span class="meta">@POST</span>   </div><div class="line">    <span class="meta">@Consumes</span>(<span class="string">"application/json"</span>)   </div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">createPerson</span><span class="params">(Person person)</span> </span>&#123; <span class="comment">//JSON 格式的请求体被自动映射为实体参数person  </span></div><div class="line">        ......   </div><div class="line">    &#125;   </div><div class="line">  </div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/person/"</span>)   </div><div class="line">    <span class="meta">@PUT</span>   </div><div class="line">    <span class="meta">@Consumes</span>(<span class="string">"application/json"</span>)   </div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">updatePerson</span><span class="params">(Person person)</span> </span>&#123;   </div><div class="line">        ......   </div><div class="line">    &#125;   </div><div class="line">  </div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/person/&#123;id:\\d+&#125;/"</span>) <span class="comment">//正则表达式  </span></div><div class="line">    <span class="meta">@DELETE</span>   </div><div class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">deletePerson</span><span class="params">(@PathParam(<span class="string">"id"</span>)</span>   </span></div><div class="line">    <span class="keyword">int</span> id) &#123;   </div><div class="line">        ......   </div><div class="line">    &#125;   </div><div class="line">  </div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/person/&#123;id:\\d+&#125;/"</span>)   </div><div class="line">    <span class="meta">@GET</span>   </div><div class="line">    <span class="meta">@Produces</span>(<span class="string">"application/json"</span>)   </div><div class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">readPerson</span><span class="params">(@PathParam(<span class="string">"id"</span>)</span>   </span></div><div class="line">    <span class="keyword">int</span> id) &#123;   </div><div class="line">        ......   </div><div class="line">    &#125;   </div><div class="line">  </div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/persons/"</span>)   </div><div class="line">    <span class="meta">@GET</span>   </div><div class="line">    <span class="meta">@Produces</span>(<span class="string">"application/json"</span>)   </div><div class="line">    <span class="keyword">public</span> Person[] readAllPersons() &#123; <span class="comment">//数组类型的返回值被自动映射为 JSON 格式的响应体——？  </span></div><div class="line">        ......   </div><div class="line">    &#125;   </div><div class="line">  </div><div class="line">    <span class="meta">@Path</span>(<span class="string">"/person/&#123;name&#125;/"</span>)   </div><div class="line">    <span class="meta">@GET</span>   </div><div class="line">    <span class="meta">@Produces</span>(<span class="string">"application/json"</span>)   </div><div class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">readPersonByName</span><span class="params">(@PathParam(<span class="string">"name"</span>)</span>   </span></div><div class="line">    String name) &#123;   </div><div class="line">        ......   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Resource 方法合法的参数类型包括：</p>
<ol>
<li>原生类型</li>
<li>构造函数接收单个字符串参数，或者包含拥有一个static的valueOf(String)方法</li>
<li>List<t>，Set<t>，SortedSet<t>（T 为以上的 2 种类型）</t></t></t></li>
<li>用于映射请求体的实体参数</li>
</ol>
<p>Resource 方法合法的返回值类型包括：</p>
<ol>
<li>void：状态码 204 和空响应体</li>
<li>Response：Response 的 status 属性指定了状态码，entity 属性映射为响应体<code>return Response.status(Status.OK).entity(JsonUtils.toString(result)).build();</code></li>
<li>GenericEntity：GenericEntity 的 entity 属性映射为响应体，entity 属性为空则状态码为 204，非空则状态码为 200</li>
<li>其它类型：返回的对象实例映射为响应体，实例为空则状态码为 204，非空则状态码为 200</li>
</ol>
<p>对于错误处理，Resource 方法可以抛出非受控异常 WebApplicationException 或者返回包含了适当的错误码集合的 Response 对象。</p>
<p>####3.1.3 内容协商与数据绑定####<br>Web 资源可以有不同的表现形式，服务端与客户端之间需要一种称为内容协商（Content Negotiation）的机制：</p>
<p>作为服务端，Resource 方法的@Produces 标注用于指定响应体的数据格式（MIME 类型），@Consumes 标注用于指定请求体的数据格式；</p>
<p>作为客户端，Accept 请求头用于选择响应体的数据格式，Content-Type 请求头用于标识请求体的数据格式。</p>
<p>服务器端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@GET</span>  </div><div class="line"><span class="meta">@Path</span>(value=<span class="string">"/&#123;emailAddress:.+@.+\\.[a-z]+&#125;"</span>)  </div><div class="line"><span class="meta">@Produces</span>(value=&#123;<span class="string">"text/xml"</span>, <span class="string">"application/json"</span>&#125;)  </div><div class="line"><span class="function"><span class="keyword">public</span> ContactInfo <span class="title">getByEmailAddress</span><span class="params">(@PathParam(value=<span class="string">"emailAddress"</span>)</span>   </span></div><div class="line">    String emailAddress) &#123;  </div><div class="line">    ...  </div><div class="line">&#125;     </div><div class="line">  </div><div class="line">  </div><div class="line"><span class="meta">@POST</span>  </div><div class="line"><span class="meta">@Consumes</span>(value=&#123;<span class="string">"text/xml"</span>, <span class="string">"application/json"</span>&#125;)  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addContactInfo</span><span class="params">(ContactInfo contactInfo)</span> </span>&#123;  </div><div class="line">    ...  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>####3.1.4 bean验证####</p>
<p>一个基于注释的机制来识别参数的meta-data。例如“@NotNull shares”代表“shares”参数不允许为null。你同样可以提供传统的注释，比如保证特定的数据格式，例如邮编或者电话号码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"/createUser"</span>)</div><div class="line"><span class="meta">@Consumes</span>(MediaType.APPLICATION_FORM_URLENCODED)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createUser</span><span class="params">(@NotNull @FormParam(<span class="string">"username"</span>)</span> String username,</span></div><div class="line">@NotNull @<span class="title">FormParam</span><span class="params">(<span class="string">"firstName"</span>)</span> String firstName,</div><div class="line">@NotNull @<span class="title">FormParam</span><span class="params">(<span class="string">"lastName"</span>)</span> String lastName,</div><div class="line">@Email @<span class="title">FormParam</span><span class="params">(<span class="string">"email"</span>)</span> String email) &#123;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>也可以用到一个resource class中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/createUser"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CreateUserResource</span> </span>&#123;</div><div class="line"><span class="meta">@NotNull</span></div><div class="line"><span class="meta">@FormParam</span>(<span class="string">"username"</span>)</div><div class="line"><span class="keyword">private</span> String username;</div><div class="line"><span class="meta">@NotNull</span></div><div class="line"><span class="meta">@FormParam</span>(<span class="string">"firstName"</span>)</div><div class="line"><span class="keyword">private</span> String firstName;</div><div class="line"><span class="meta">@NotNull</span></div><div class="line"><span class="meta">@FormParam</span>(<span class="string">"lastName"</span>)</div><div class="line"><span class="keyword">private</span> String lastName;</div><div class="line"><span class="meta">@Email</span></div><div class="line"><span class="meta">@FormParam</span>(<span class="string">"email"</span>)</div><div class="line"><span class="keyword">private</span> String email;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>####3.1.5 客户端api####</p>
<p>JAX-RS 1.0是一个严格的客户端API，一些实现对客户端提供了各种等级的支持，但是通常开发人员会安装像Apache软件基Jakarte公共组件中的HttpClient 或 WizTools的 REST Client。</p>
<p>JAX-RS 2.0 为客户端调用Web服务添加了一个”构建” 工具:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Client client=ClientFactory.newClient();</div><div class="line">String shares=client.target(<span class="string">"http://.../portfolio/123"</span>)</div><div class="line">    .pathParam(<span class="string">"identifier"</span>, <span class="string">"IBM"</span>)</div><div class="line">    .queryParameter(<span class="string">"identifierType"</span>, <span class="string">"ticker"</span>)</div><div class="line">    .request(<span class="string">"text/plain).get(String.class"</span>);</div></pre></td></tr></table></figure>
<p>我们看，这个方法首先包含了一个客户端(client)，然后使用了构建模式来构造URL的所有参数，同时，允许开发人员不需要使用各种各样的URL构造器来规划URL。</p>
<p>####3.1.6 异步####<br>异步：<br>在JAX-RS 1.0中，一个要调用的客户端需要等待服务器传回的响应。2.0嵌入了异步支持。这让一个客户端能够发起一个REST的调用，并且在响应完成的时候得到一个Future或者一个InvocationCallback作为通知。</p>
<p>####3.1.7 HATEOAS####<br>根据严格的RESTafarian规范，如果你没有使用HATEOAS，你就不是在做REST！HATEOAS（作为应用状态引擎的超媒体）要求REST的生产者和客户在“每个调用返回一组链接”上达成共识，以便进行下一步。如果你认为REST是一个应用版本的Web页，那么HATEOAS就可以认为是包含一组Web页面的链接。</p>
<p>JAX-RS 2.0提供了Link和Target类，来把超链接嵌入到一个服务器端的响应当中，并把它们响应到客户端去。</p>
<p>###第二部分：Examples of the JAX-RS 2.0 ##</p>
<h4 id="3-2-1-Example-1-async-war"><a href="#3-2-1-Example-1-async-war" class="headerlink" title="3.2.1 Example 1 async-war"></a>3.2.1 Example 1 async-war</h4><p>分析：</p>
<p>chatApplication</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.HashSet;</div><div class="line"><span class="keyword">import</span> java.util.Set;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.ws.rs.ApplicationPath;</div><div class="line"><span class="keyword">import</span> javax.ws.rs.core.Application;</div><div class="line"></div><div class="line"><span class="meta">@ApplicationPath</span>(<span class="string">"/chat"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Set&lt;Class&lt;?&gt;&gt; getClasses() &#123;</div><div class="line">        <span class="keyword">final</span> Set&lt;Class&lt;?&gt;&gt; classes = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        classes.add(ChatResource.class);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> classes;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/"</span>)</div><div class="line"><span class="meta">@Singleton</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatResource</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This queue synchronizes produces/consumes operations. It contains &#123;<span class="doctag">@link</span> AsyncResponse async responses&#125; into</div><div class="line">     * which post message should be written.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;AsyncResponseWrapper&gt; suspended = <span class="keyword">new</span> ArrayBlockingQueue&lt;AsyncResponseWrapper&gt;(<span class="number">10</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Internal response wrapper which bundles response with id.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncResponseWrapper</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AsyncResponse asyncResponse;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String id;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">AsyncResponseWrapper</span><span class="params">(AsyncResponse asyncResponse, String id)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.asyncResponse = asyncResponse;</div><div class="line">            <span class="keyword">this</span>.id = id;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> AsyncResponse <span class="title">getAsyncResponse</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> asyncResponse;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> id;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handle a HTTP get message asynchronously (suspend response in order to release the container thread instead of</div><div class="line">     * blocking it on the blocking queue).</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> asyncResponse Suspended asynchronous response (injected).</div><div class="line">     * <span class="doctag">@param</span> requestId Header identifying the header.</div><div class="line">     */</div><div class="line">    <span class="meta">@GET</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getMessage</span><span class="params">(@Suspended <span class="keyword">final</span> AsyncResponse asyncResponse, <span class="keyword">final</span> @HeaderParam(<span class="string">"request-id"</span>)</span> String requestId) </span>&#123;</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">// Put actual response to the queue. This response will be later taken and resumed with</span></div><div class="line">                    <span class="comment">// the message.</span></div><div class="line">                    suspended.put(<span class="keyword">new</span> AsyncResponseWrapper(asyncResponse, requestId));</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Handle a HTTP POST method asynchronously (suspend response in order to release the container thread instead of</div><div class="line">     * blocking it on the blocking queue).</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> postAsyncResponse Suspended asynchronous response (injected).</div><div class="line">     * <span class="doctag">@param</span> message Message to be sent.</div><div class="line">     */</div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postMessage</span><span class="params">(@Suspended <span class="keyword">final</span> AsyncResponse postAsyncResponse, <span class="keyword">final</span> String message)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">// Take one response from the queue and resume it with the message. If no message is in the queue now</span></div><div class="line">                    <span class="comment">// then this method will block the thread until the response is put into queue (by GET http method).</span></div><div class="line">                    <span class="keyword">final</span> AsyncResponseWrapper responseWrapper = suspended.take();</div><div class="line">                    responseWrapper.getAsyncResponse().resume(Response.ok()</div><div class="line">                            .entity(message).header(<span class="string">"request-id"</span>, responseWrapper.getId()).build());</div><div class="line"></div><div class="line">                    <span class="comment">// Now resume response connected with the request invoking this post method just reply that the message</span></div><div class="line">                    <span class="comment">// was delivered.</span></div><div class="line">                    postAsyncResponse.resume(<span class="string">"Sent!"</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Get the string representation of internal async response queue &lt;code&gt;suspended&lt;code/&gt;.</div><div class="line">     * &lt;p/&gt;</div><div class="line">     * This resource is requested in regular intervals by clients.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> Plain text with list of request-id of async responses.</div><div class="line">     */</div><div class="line">    <span class="meta">@GET</span></div><div class="line">    <span class="meta">@Path</span>(<span class="string">"queue"</span>)</div><div class="line">    <span class="meta">@Produces</span>(<span class="string">"text/html"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getResponseQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</div><div class="line">        <span class="keyword">boolean</span> addSeparator = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">for</span> (AsyncResponseWrapper asyncResponseWrapper : suspended) &#123;</div><div class="line">            <span class="keyword">if</span> (addSeparator) &#123;</div><div class="line">                sb.append(<span class="string">", "</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                addSeparator = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            sb.append(asyncResponseWrapper.getId());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sb.toString();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-2-2-Example-2：-message-board"><a href="#3-2-2-Example-2：-message-board" class="headerlink" title="3.2.2 Example 2： message-board"></a>3.2.2 Example 2： message-board</h4><p>详情见源代码</p>
<p>##第四章：json processing 1.0 总览##</p>
<p>主要参照第19章：json processing</p>
<h3 id="第一部分：json-processing-介绍"><a href="#第一部分：json-processing-介绍" class="headerlink" title="第一部分：json processing 介绍"></a>第一部分：json processing 介绍</h3><p>####4.1.1 json####</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="attr">"firstName"</span>: <span class="string">"Duke"</span>,</div><div class="line"><span class="attr">"lastName"</span>: <span class="string">"Java"</span>,</div><div class="line"><span class="attr">"age"</span>: <span class="number">18</span>,</div><div class="line"><span class="attr">"streetAddress"</span>: <span class="string">"100 Internet Dr"</span>,</div><div class="line"><span class="attr">"city"</span>: <span class="string">"JavaTown"</span>,</div><div class="line"><span class="attr">"state"</span>: <span class="string">"JA"</span>,</div><div class="line"><span class="attr">"postalCode"</span>: <span class="string">"12345"</span>,</div><div class="line"><span class="attr">"phoneNumbers"</span>: [</div><div class="line">&#123; <span class="attr">"Mobile"</span>: <span class="string">"111-111-1111"</span> &#125;,</div><div class="line">&#123; <span class="attr">"Home"</span>: <span class="string">"222-222-2222"</span> &#125;</div><div class="line">]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>http header:<br><code>Content-Type: application/json</code></p>
<p>####4.1.2 json processing in the java ee platform####</p>
<p><img src="http://i.imgur.com/XUTrGIq.png" alt=""></p>
<p>####4.1.3 using the object model api####</p>
<p>构建json对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">JsonObject model = Json.createObjectBuilder()</div><div class="line">.add(<span class="string">"firstName"</span>, <span class="string">"Duke"</span>)</div><div class="line">.add(<span class="string">"lastName"</span>, <span class="string">"Java"</span>)</div><div class="line">.add(<span class="string">"age"</span>, <span class="number">18</span>)</div><div class="line">.add(<span class="string">"streetAddress"</span>, <span class="string">"100 Internet Dr"</span>)</div><div class="line">.add(<span class="string">"city"</span>, <span class="string">"JavaTown"</span>)</div><div class="line">.add(<span class="string">"state"</span>, <span class="string">"JA"</span>)</div><div class="line">.add(<span class="string">"postalCode"</span>, <span class="string">"12345"</span>)</div><div class="line">.add(<span class="string">"phoneNumbers"</span>, Json.createArrayBuilder()</div><div class="line">.add(Json.createObjectBuilder()</div><div class="line">.add(<span class="string">"type"</span>, <span class="string">"mobile"</span>)</div><div class="line">.add(<span class="string">"number"</span>, <span class="string">"111-111-1111"</span>))</div><div class="line">.add(Json.createObjectBuilder()</div><div class="line">.add(<span class="string">"type"</span>, <span class="string">"home"</span>)</div><div class="line">.add(<span class="string">"number"</span>, <span class="string">"222-222-2222"</span>)))</div><div class="line">.build();</div></pre></td></tr></table></figure></p>
<h3 id="第二部分：Examples-of-json-processing"><a href="#第二部分：Examples-of-json-processing" class="headerlink" title="第二部分：Examples of json processing"></a>第二部分：Examples of json processing</h3><p>jsonobject例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/object"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectResource</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> JsonBuilderFactory bf = Json.createBuilderFactory(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="meta">@GET</span></div><div class="line">    <span class="meta">@Produces</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> JsonObject <span class="title">doGet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> bf.createObjectBuilder()</div><div class="line">            .add(<span class="string">"firstName"</span>, <span class="string">"John"</span>)</div><div class="line">            .add(<span class="string">"lastName"</span>, <span class="string">"Smith"</span>)</div><div class="line">            .add(<span class="string">"age"</span>, <span class="number">25</span>)</div><div class="line">            .add(<span class="string">"address"</span>, bf.createObjectBuilder()</div><div class="line">                .add(<span class="string">"streetAddress"</span>, <span class="string">"21 2nd Street"</span>)</div><div class="line">                .add(<span class="string">"city"</span>, <span class="string">"New York"</span>)</div><div class="line">                .add(<span class="string">"state"</span>, <span class="string">"NY"</span>)</div><div class="line">                .add(<span class="string">"postalCode"</span>, <span class="string">"10021"</span>))</div><div class="line">            .add(<span class="string">"phoneNumber"</span>, bf.createArrayBuilder()</div><div class="line">                .add(bf.createObjectBuilder()</div><div class="line">                    .add(<span class="string">"type"</span>, <span class="string">"home"</span>)</div><div class="line">                    .add(<span class="string">"number"</span>, <span class="string">"212 555-1234"</span>))</div><div class="line">                .add(bf.createObjectBuilder()</div><div class="line">                    .add(<span class="string">"type"</span>, <span class="string">"fax"</span>)</div><div class="line">                    .add(<span class="string">"number"</span>, <span class="string">"646 555-4567"</span>)))</div><div class="line">            .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(JsonObject structure)</span> </span>&#123;</div><div class="line">        System.out.println(structure);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>jsonarray例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/array"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayResource</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> JsonBuilderFactory bf = Json.createBuilderFactory(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="meta">@GET</span></div><div class="line">    <span class="meta">@Produces</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> JsonArray <span class="title">doGet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> bf.createArrayBuilder()</div><div class="line">                .add(bf.createObjectBuilder()</div><div class="line">                    .add(<span class="string">"type"</span>, <span class="string">"home"</span>)</div><div class="line">                    .add(<span class="string">"number"</span>, <span class="string">"212 555-1234"</span>))</div><div class="line">                .add(bf.createObjectBuilder()</div><div class="line">                    .add(<span class="string">"type"</span>, <span class="string">"fax"</span>)</div><div class="line">                    .add(<span class="string">"number"</span>, <span class="string">"646 555-4567"</span>))</div><div class="line">                .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(JsonArray structure)</span> </span>&#123;</div><div class="line">        System.out.println(structure);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>jsonStructure</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/structure"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StructureResource</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> JsonBuilderFactory bf = Json.createBuilderFactory(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="meta">@GET</span></div><div class="line">    <span class="meta">@Produces</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> JsonStructure <span class="title">doGet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> bf.createObjectBuilder()</div><div class="line">            .add(<span class="string">"firstName"</span>, <span class="string">"John"</span>)</div><div class="line">            .add(<span class="string">"lastName"</span>, <span class="string">"Smith"</span>)</div><div class="line">            .add(<span class="string">"age"</span>, <span class="number">25</span>)</div><div class="line">            .add(<span class="string">"address"</span>, bf.createObjectBuilder()</div><div class="line">                .add(<span class="string">"streetAddress"</span>, <span class="string">"21 2nd Street"</span>)</div><div class="line">                .add(<span class="string">"city"</span>, <span class="string">"New York"</span>)</div><div class="line">                .add(<span class="string">"state"</span>, <span class="string">"NY"</span>)</div><div class="line">                .add(<span class="string">"postalCode"</span>, <span class="string">"10021"</span>))</div><div class="line">            .add(<span class="string">"phoneNumber"</span>, bf.createArrayBuilder()</div><div class="line">                .add(bf.createObjectBuilder()</div><div class="line">                    .add(<span class="string">"type"</span>, <span class="string">"home"</span>)</div><div class="line">                    .add(<span class="string">"number"</span>, <span class="string">"212 555-1234"</span>))</div><div class="line">                .add(bf.createObjectBuilder()</div><div class="line">                    .add(<span class="string">"type"</span>, <span class="string">"fax"</span>)</div><div class="line">                    .add(<span class="string">"number"</span>, <span class="string">"646 555-4567"</span>)))</div><div class="line">            .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@POST</span></div><div class="line">    <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(JsonStructure structure)</span> </span>&#123;</div><div class="line">        System.out.println(structure);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>JsonGenerator例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/generator"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GeneratorResource</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@GET</span></div><div class="line">    <span class="meta">@Produces</span>(MediaType.APPLICATION_JSON)</div><div class="line">    <span class="function"><span class="keyword">public</span> StreamingOutput <span class="title">doGet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StreamingOutput() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(OutputStream os)</span> </span>&#123;</div><div class="line">                writeWikiExample(os);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Writes wiki example JSON in a streaming fashion</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeWikiExample</span><span class="params">(OutputStream os)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span>(JsonGenerator gene = Json.createGenerator(os)) &#123;</div><div class="line">            gene.writeStartObject()</div><div class="line">                .write(<span class="string">"firstName"</span>, <span class="string">"John"</span>)</div><div class="line">                .write(<span class="string">"lastName"</span>, <span class="string">"Smith"</span>)</div><div class="line">                .write(<span class="string">"age"</span>, <span class="number">25</span>)</div><div class="line">                .writeStartObject(<span class="string">"address"</span>)</div><div class="line">                    .write(<span class="string">"streetAddress"</span>, <span class="string">"21 2nd Street"</span>)</div><div class="line">                    .write(<span class="string">"city"</span>, <span class="string">"New York"</span>)</div><div class="line">                    .write(<span class="string">"state"</span>, <span class="string">"NY"</span>)</div><div class="line">                    .write(<span class="string">"postalCode"</span>, <span class="string">"10021"</span>)</div><div class="line">                .writeEnd()</div><div class="line">                .writeStartArray(<span class="string">"phoneNumber"</span>)</div><div class="line">                    .writeStartObject()</div><div class="line">                        .write(<span class="string">"type"</span>, <span class="string">"home"</span>)</div><div class="line">                        .write(<span class="string">"number"</span>, <span class="string">"212 555-1234"</span>)</div><div class="line">                    .writeEnd()</div><div class="line">                    .writeStartObject()</div><div class="line">                        .write(<span class="string">"type"</span>, <span class="string">"fax"</span>)</div><div class="line">                        .write(<span class="string">"number"</span>, <span class="string">"646 555-4567"</span>)</div><div class="line">                    .writeEnd()</div><div class="line">                .writeEnd()</div><div class="line">            .writeEnd();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>JsonParser例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"/parser"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParserResource</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@GET</span></div><div class="line">    <span class="meta">@Produces</span>(<span class="string">"text/plain"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> StreamingOutput <span class="title">doGet</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> StreamingOutput() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(OutputStream os)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                writeTwitterFeed(os);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Parses JSON from twitter search REST API</div><div class="line">     *</div><div class="line">     * ... &#123; ... "from_user" : "xxx", ..., "text: "yyy", ... &#125; ...</div><div class="line">     *</div><div class="line">     * then writes to HTTP output stream as follows:</div><div class="line">     *</div><div class="line">     * xxx: yyy</div><div class="line">     * --------</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeTwitterFeed</span><span class="params">(OutputStream os)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://search.twitter.com/search.json?q=%23java"</span>);</div><div class="line">        <span class="keyword">try</span>(InputStream is = url.openStream();</div><div class="line">            JsonParser parser = Json.createParser(is);</div><div class="line">            PrintWriter ps = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> OutputStreamWriter(os, <span class="string">"UTF-8"</span>))) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">while</span>(parser.hasNext()) &#123;</div><div class="line">                Event e = parser.next();</div><div class="line">                <span class="keyword">if</span> (e == Event.KEY_NAME) &#123;</div><div class="line">                    <span class="keyword">if</span> (parser.getString().equals(<span class="string">"from_user"</span>)) &#123;</div><div class="line">                        parser.next();</div><div class="line">                        ps.print(parser.getString());</div><div class="line">                        ps.print(<span class="string">": "</span>);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getString().equals(<span class="string">"text"</span>)) &#123;</div><div class="line">                        parser.next();</div><div class="line">                        ps.println(parser.getString());</div><div class="line">                        ps.println(<span class="string">"---------"</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##第四章：WebSocket 1.0分析##</p>
<p>作为Html5新特性之一的WebSocket组件，在实时性有一定要求的WEB应用开发 中还是有一定用武之地，高版本的IE、Chrome、FF浏览器都支持Websocket，标准的Websocket通信是基于RFC6455实现服务器 端与客户端握手与消息接发的。如果对Websocket通信不是太理解，可以查看RFC文档即可，简单说就是通过发送HTTP请求，实现双方握手，将无状 态的HTTP通信协议进一步升级成有状态的通信协议，同时Websocket还支持子协议选项与安全传输。标准的websocket连接URL以ws开 头，如果是基于TLS的则以wss开头。</p>
<p>###第一部分:java api for websocket###</p>
<p>参考第18章：java api for websocket</p>
<p>###第二部分:Examples for websocket###</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/06/hadoop分布式文件系统详解/" itemprop="url">
                  hadoop分布式文件系统详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-06T21:11:33+08:00" content="2016-12-06">
              2016-12-06
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>###1.大数据概念 ###</p>
<blockquote>
<p>麦肯锡说：大数据指的是所涉及的数据集规模已经超过了传统<br>数据库软件的获取、存储、管理和分析的能力。<br>随着技术的不断发展，符合大数据标准的数据集容量也会增长。<br>并且大数据的定义随着不同行业也有变化。</p>
<p> IBM说：可以用3个特征相结合来定义大数据：<strong>数量（Volume），种类(Variety)，速度(Velocity)</strong>，即庞大容量，极快速度和种类丰富的数据。</p>
</blockquote>
<p>大数据的特征：大量化，快速化，多样化，价值化</p>
<p>###2.数据库VS大数据 ###</p>
<ul>
<li>1、数据规模： “池塘”的处理对象通常以MB 为基本单位，而“大<br>  海”则常常以GB，甚至是TB、PB 为基本处理单位。</li>
<li>2、数据类型：过去的“池塘”中，数据的种类单一，往往仅仅有一<br>  种或少数几种，这些数据又以结构化数据为主。而在“大海”中，数<br>  据的种类繁多，数以千计，而这些数据又包含着结构化、半结构化以<br>  及非结构化的数据，并且半结构化和非结构化数据所占份额越来越大<br>  。</li>
<li>3、模式(Schema)和数据的关系：传统的数据库都是先有模式，然后<br>  才会产生数据。这就好比是先选好合适的“池塘”，然后才会向其中<br>  投放适合在该“池塘”环境生长的“鱼”。而大数据时代很多情况下<br>  难以预先确定模式，模式只有在数据出现之后才能确定，且模式随着<br>  数据量的增长处于不断的演变之中。这就好比先有少量的鱼类，随着<br>  时间推移，鱼的种类和数量都在不断的增长。鱼的变化会使大海的成<br>  分和环境处于不断的变化之中。</li>
<li>4、处理对象：在“池塘”中捕鱼，“鱼”仅仅是其捕捞对象。而在<br>  “大海”中，“鱼”除了是捕捞对象之外，还可以通过某些“鱼”的<br>  存在来判断其他种类的“鱼”是否存在。也就是说传统数据库中数据<br>  仅作为处理对象。而在大数据时代，要将数据作为一种资源来辅助解<br>  决其他诸多领域的问题。</li>
<li>5、处理工具：捕捞“池塘”中的“鱼”，一种渔网或少数几种基本<br>  就可以应对，也就是所谓的One Size Fits All。但是在“大海”中，<br>  不可能存在一种渔网能够捕获所有的鱼类，也就是说No Size Fits All</li>
</ul>
<p>###3.Hadoop###</p>
<ul>
<li>一个分布式文件系统和并行执行环境（框架）</li>
<li>让用户便捷地处理海量数据</li>
<li>Apache软件基金会下面的一个开源项目</li>
<li>目前Yahoo!是最主要的贡献者</li>
</ul>
<p>hadoop的特点：</p>
<ul>
<li>扩容能力（Scalable）：能可靠地（reliably）存储和处理千兆字节（PB）数据。</li>
<li>成本低（Economical）：可以通过普通机器组成的服务器群来分发以及处理数据。这些服务器群总计可达数千个节点。</li>
<li>高效率（Efficient）：通过分发数据，hadoop可以在数据所在的节点上并行地（parallel）处理它们，这使得处理非常的快速。</li>
<li>可靠性（Reliable）：hadoop能自动地维护数据的多份复制，并且在任务失败后能自动地重新部署（redeploy）计算任务。</li>
</ul>
<p>hadoop生态系统：<br><img src="http://i.imgur.com/kFpATOP.png" alt=""></p>
<p>###3.Hdfs文件系统架构###</p>
<p>设计目标：</p>
<ul>
<li>为以流式数据访问模式存储超大文件而设计的文件系统<ul>
<li>超大文件<br>指的是几百MB，几百GB，几百TB，甚至几百PB</li>
<li>流式数据访问<br>HDFS建立的思想是：一次写入、多次读取模式是最高效的。</li>
<li>商用硬件<br>HDFS不需要运行在昂贵并且高可靠的硬件上。</li>
</ul>
</li>
</ul>
<p>设计基础与目标：</p>
<ul>
<li>硬件错误是常态，因此需要冗余。</li>
<li>程序采用“数据就近”原则分配节点执行。</li>
</ul>
<p>hdfs体系：<br>hdfs是一个主从结构的体系，一个hdfs集群由以下部分组成。<br>1.namenode： 一个，用来管理文件的名字空间和调节客户端访问文件的主服务器。<br>2.datanode：一个或多个，用来管理存储。提供真是文件数据的存储服务。</p>
<p><img src="http://i.imgur.com/pdHbox9.png" alt=""></p>
<p>1.机架：rack</p>
<p>2.数据块：block 64M<br>hadoop fsck / -files -blocks</p>
<p>3.元数据节点：namenode<br>namenode 决定是否将文件映射到datanode的复制块上，对于最常见的3个复制快，第一个复制快存储在同一个机架上的不同节点上，最后一个复制快存储在不同机器上的某个节点上。</p>
<p>主要功能：</p>
<p>namenode提供名称查询服务。<br>namenode保存metadate信息。具体包括;文件owership和permissions；文件包含哪些块；block保存在哪个datanode上。<br>namenode的metadate信息在启动后会加载到内存。</p>
<p>4.数据节点：datanode</p>
<ul>
<li>保存block，每个快对应一个元数据信息文件，这个文件主要描述这个块属于哪个文件，第几个块等信息。</li>
<li>启动datanode线程的时候会向namenode回报block信息。</li>
<li>通过向namenode发送心跳保持与其连系（3s一次），如果namenode10分钟没有收到datanode的心跳，认为其已经lost，并将其上的block复制到其他的datanode。</li>
</ul>
<p>5.辅助元数据节点：secondarynamenode</p>
<p><img src="http://i.imgur.com/Lrjf9Tm.png" alt=""><br>辅助元数据节点，会周期性的将editslog文件中记录对hdfs的操作合并到一个fsimage中，然后清空editslog。namenode重启就会加载最新的fsimage文件，并重新创建一个editslog文件来记录hdfs。</p>
<p>6.名字空间 namespace</p>
<p>7.数据复制</p>
<p>8.快备份原理</p>
<p><img src="http://i.imgur.com/ortzuIT.png" alt=""></p>
<p>9.机架感知</p>
<p>###4.hadoop rpc机制###</p>
<p>一般的RPC，都要考虑两个问题。对象调用方式和序列化反序列化机制<br>hadoop rpc使用java动态代理和反射实现了对象调用方式，客户端到服务器数据的序列化和反序列化由hadoop框架或用火自己实现，也就是数据组装时定制的。<br><img src="http://i.imgur.com/BWCh7o4.png" alt=""></p>
<p>文件的读和写<br><img src="http://i.imgur.com/EmUaCxm.png" alt=""></p>
<p>客户端联系NameNode,得到所有数据块信息，以及数据块对应的所有数据服务器的位置信息<br>尝试从某个数据块对应的一组数据服务器中选出一个，进行连接<br>数据被一个包一个包发送回客户端，等到整个数据块的数据都被读取完了，就会断开此链接，尝试连接下一个数据块对应的数据服务器，整个流程，依次如此反复，直到所有想读的都读取完了为止。<br>Namenode并不实际参与数据传输</p>
<p><img src="http://i.imgur.com/6M44r2f.png" alt=""></p>
<p>客户端联系namenode，在namenode命名空间中创建一个新文件，此时，namenode会检查文件是否存在和客户端是否有权限创建新文件，检查通过，就会创建一条记录。<br>然后客户端写文件时，会取得合适的3个datanodes形成一个管线DataStreamer将数据包流式的传输到管线中第一个datanode，第一个datanode存储数据包并发送的第二个datanode, 第二个datanode存储数据包并发送的第三个datanode。<br>当收到管道中所有datanodes的确认信息后对应数据包才会从确认队列中删除。<br>如此反复，直到所有的数据包，都写完，最后向namenode报告写入完成。</p>
<p>###4.hadoop ha机制###<br>如果namenode节点坏掉，将会影响整个集群。 hdfs的高可用性（high availability ha）就可以解决这个问题。通过提供选择运行在同一个集群的一个热备份的‘主/备’两个冗余的namenode，允许在机器宕机或系统维护的时候，快速的转移到另一个namenode。</p>
<p><img src="http://i.imgur.com/mdwV6S7.png" alt=""></p>
<p>###5.hdfs federation机制###</p>
<p>简单来说， hdfs federation 就是使得hdfs支持多个名字空间，并且允许在hdfs中同时存在多个namenode</p>
<p>###6.hdfs处理文件的命令###</p>
<p>hadoop fs -mkdir /input<br>hadoop fs -ls /input<br>hadoop fs - put test.txt /input/<br>hadoop fs -text /input/test.txt<br>hadoop fs -get /input/text.txt<br>hadoop fs -rm /input/text.txt</p>
<p>###7.java api 接口###</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/30/最近点问题/" itemprop="url">
                  最近点问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-11-30T12:55:50+08:00" content="2016-11-30">
              2016-11-30
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>最近点对问题定义：已知上m个点的集合，找出对接近的一对点。</p>
<p>在二维空间里，可用分治法求解最近点对问题。预处理：分别根据点的x轴和y轴坐标进行排序，得到X和Y,很显然此时X和Y中的点就是S中的点。</p>
<p>情况（1）：点数小于等于三时：</p>
<p><img src="http://i.imgur.com/kyHpBOQ.png" alt=""></p>
<p>情况（2）：点数大于三时：</p>
<p>首先划分集合S为SL和SR，使得SL中的每一个点位于SR中每一个点的左边，并且SL和SR中点数相同。分别在SL和SR中解决最近点对问题，得到DL和DR，分别表示SL和SR中的最近点对的距离。令d=min(DL,DR)。如果S中的最近点对(P1,P2)。P1、P2两点一个在SL和一个在SR中，那么P1和P2一定在以L为中心的间隙内，以L-d和L+d为界，如下图所示：</p>
<p> <img src="http://i.imgur.com/qC1h3Tu.png" alt="">             </p>
<p>如果在SL中的点P和在SR中的点Q成为最近点对，那么P和Q的距离必定小于d。因此对间隙中的每一个点，在合并步骤中，只需要检验yp+d和yp-d内的点即可。</p>
<ul>
<li>步骤1：根据点的y值和x值对S中的点排序。</li>
<li>步骤2：找出中线L将S划分为SL和SR</li>
<li>步骤3：将步骤2递归的应用解决SL和SR的最近点对问题，并令d=min(dL,dR)。</li>
<li>步骤4：将L-d~L+d内的点以y值排序，对于每一个点(x1,y1)找出y值在y1-d~y1+d内的所有点，计算距离为d’。如果d’小于d，令d=d’，最后的d值就是答案。</li>
</ul>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">package cloestpoint;</div><div class="line"></div><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.Arrays;</div><div class="line">import java.util.Collections;</div><div class="line">import java.util.Comparator;</div><div class="line"></div><div class="line">public class CloestPair &#123;</div><div class="line">	private static class Point&#123;</div><div class="line">		private double x;</div><div class="line">		private double y;</div><div class="line">		public Point()&#123;&#125;</div><div class="line">		public Point(double x,double y)&#123;this.x=x;this.y=y;&#125;	</div><div class="line">	&#125;</div><div class="line">	private static double distance(Point p1,Point p2)&#123; </div><div class="line">		return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));</div><div class="line">	&#125;</div><div class="line">		</div><div class="line">	public static double minDistance(Point[] p,int l,int r)&#123;</div><div class="line">		if(l==r)&#123;</div><div class="line">			return Double.MAX_VALUE;</div><div class="line">		&#125;</div><div class="line">		if(l+1==r)&#123;</div><div class="line">			return distance(p[l], p[r]);</div><div class="line">		&#125;</div><div class="line">		int center=(r-l)/2;</div><div class="line">		double dis1=minDistance(p, l, center);</div><div class="line">		double dis2=minDistance(p, center+1, r);</div><div class="line">		double dis=Math.min(dis1, dis2);</div><div class="line">		ArrayList&lt;Point&gt; nearPoints = new ArrayList&lt;&gt;(); </div><div class="line">		for(Point point : p)</div><div class="line">			if(Math.abs(p[center].x-point.x)&lt;=dis)</div><div class="line">				nearPoints.add(point);</div><div class="line">		Collections.sort(nearPoints, new Comparator&lt;Point&gt;() &#123;</div><div class="line">			@Override</div><div class="line">			public int compare(Point o1, Point o2) &#123;</div><div class="line">				if(o1.y&lt;o2.y) return -1;</div><div class="line">				if(o1.y&gt;o2.y) return 1;</div><div class="line">				if(o1.x&lt;o2.x) return -1;</div><div class="line">				if(o1.x&gt;o2.x) return 1;</div><div class="line">				return 0;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">		&#125;);</div><div class="line">		ArrayList&lt;Point&gt; nearL = new ArrayList&lt;&gt;(); </div><div class="line">		ArrayList&lt;Point&gt; nearR = new ArrayList&lt;&gt;();</div><div class="line">		</div><div class="line">		for(int i=0;i&lt;nearPoints.size();i++)&#123; </div><div class="line">			if(nearPoints.get(i).x&lt;p[center].x)&#123;</div><div class="line">				nearL.add(nearPoints.get(i));</div><div class="line">			&#125;else&#123;</div><div class="line">				nearR.add(nearPoints.get(i));</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		//有问题</div><div class="line">		for(int i=0;i&lt;nearL.size();i++)&#123;</div><div class="line">			for(int j=0;j&lt;nearR.size();j++)&#123;</div><div class="line">				if(Math.abs(nearR.get(j).y-nearL.get(i).y)&lt;dis)&#123;</div><div class="line">					double d=distance(nearL.get(i), nearR.get(j));</div><div class="line">					dis=d&lt;dis?d:dis;</div><div class="line">				&#125;else&#123;</div><div class="line">					break;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		return dis;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		Point p1= new Point(-2, 1);</div><div class="line">		Point p2= new Point(-1, 3);</div><div class="line">		Point p3= new Point(1, 2);</div><div class="line">		Point p4= new Point(3, 3);</div><div class="line">		Point[] ps=&#123;p1,p2,p3,p4&#125;;</div><div class="line">		System.out.println(minDistance(ps, 0,ps.length-1 ));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/24/哈夫曼编码/" itemprop="url">
                  算法总结5-哈夫曼编码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-11-24T20:13:15+08:00" content="2016-11-24">
              2016-11-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/算法/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="贪心算法"><a href="#贪心算法" class="headerlink" title="贪心算法"></a>贪心算法</h3><p>前几章的例子：dijkstra，prim，kruskal算法等</p>
<p>1.哈夫曼编码</p>
<p><img src="http://i.imgur.com/VnWxmaH.png" alt=""></p>
<p>2.算法描述</p>
<p>算法对由输组成的一个森林进行。一棵树的权等于他的树叶的频率之和。任意选取最小权的两棵树t1和t2，形成以t1和t2为子树的新树，将这样的过程进行c-1次。在算法的开始，存放c棵单节点树-每个字符一颗。在算法结束时得到一棵树，这可树就是最优哈夫曼编码树。</p>
<p><img src="http://i.imgur.com/Mpaf16W.png" alt=""></p>
<p>3.实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> hufman;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayDeque;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.PriorityQueue;</div><div class="line"><span class="keyword">import</span> java.util.Queue;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HuffmanTree</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Node</span>&lt;<span class="title">T</span>&gt;&gt;</span>&#123;</div><div class="line">		<span class="keyword">private</span> T data; <span class="comment">//节点</span></div><div class="line">		<span class="keyword">private</span> <span class="keyword">int</span> weight; <span class="comment">//权值</span></div><div class="line">		<span class="keyword">private</span> String code; <span class="comment">//编码</span></div><div class="line">		<span class="keyword">private</span> Node&lt;T&gt; left; <span class="comment">//左儿子</span></div><div class="line">		<span class="keyword">private</span> Node&lt;T&gt; right; <span class="comment">//右儿子</span></div><div class="line">		</div><div class="line">		</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(T data, <span class="keyword">int</span> weight)</span></span>&#123;</div><div class="line">			<span class="keyword">this</span>.data = data;  </div><div class="line">	        <span class="keyword">this</span>.weight = weight;</div><div class="line">	        <span class="keyword">this</span>.code=<span class="string">"0"</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(T data,String code, <span class="keyword">int</span> weight,Node&lt;T&gt; left,Node&lt;T&gt; right)</span></span>&#123;</div><div class="line">			<span class="keyword">this</span>.data = data;  </div><div class="line">	        <span class="keyword">this</span>.weight = weight;  </div><div class="line">	        <span class="keyword">this</span>.left=left;</div><div class="line">	        <span class="keyword">this</span>.right=right;</div><div class="line">	        <span class="keyword">this</span>.code=code;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Node&lt;T&gt; o)</span> </span>&#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.weight-o.weight;</div><div class="line">		&#125;	</div><div class="line">		<span class="meta">@Override</span>  </div><div class="line">	    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;  </div><div class="line">	        <span class="keyword">return</span> <span class="string">"data:"</span>+<span class="keyword">this</span>.data+<span class="string">" weight:"</span>+<span class="keyword">this</span>.weight+<span class="string">" code:"</span>+code+<span class="string">"\n"</span>;  </div><div class="line">	    &#125; </div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">Node&lt;T&gt; <span class="title">createTree</span><span class="params">(List&lt;Node&lt;T&gt;&gt; nodes)</span></span>&#123;</div><div class="line">		Queue&lt;Node&lt;T&gt;&gt; q= <span class="keyword">new</span> PriorityQueue&lt;&gt;(nodes);</div><div class="line">		<span class="keyword">while</span>(q.size()&gt;<span class="number">1</span>)&#123;</div><div class="line">			Node&lt;T&gt; left=q.poll();</div><div class="line">			Node&lt;T&gt; right=q.poll();</div><div class="line">			Node&lt;T&gt; parent=<span class="keyword">new</span> Node&lt;T&gt;(<span class="keyword">null</span>,<span class="string">"0"</span>, left.weight+right.weight, left, right);</div><div class="line">			q.offer(parent);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> q.element();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> &lt;T&gt; List&lt;Node&lt;T&gt;&gt; breadth(Node&lt;T&gt; root)&#123;</div><div class="line">		List&lt;Node&lt;T&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;Node&lt;T&gt;&gt;();  </div><div class="line">        Queue&lt;Node&lt;T&gt;&gt; queue = <span class="keyword">new</span> ArrayDeque&lt;Node&lt;T&gt;&gt;();  </div><div class="line">        <span class="keyword">if</span>(root != <span class="keyword">null</span>)&#123;  </div><div class="line">            queue.offer(root);  </div><div class="line">        &#125; </div><div class="line">        <span class="keyword">while</span>(!queue.isEmpty())&#123;  </div><div class="line">            list.add(queue.peek());  </div><div class="line">            Node&lt;T&gt; node = queue.poll();               </div><div class="line">            <span class="keyword">if</span>(node.left!= <span class="keyword">null</span>)&#123;  </div><div class="line">                queue.offer(node.left);  </div><div class="line">                node.left.code=node.code+<span class="string">"0"</span>;</div><div class="line">            &#125;  </div><div class="line">            <span class="keyword">if</span>(node.right!= <span class="keyword">null</span>)&#123;  </div><div class="line">                queue.offer(node.right);  </div><div class="line">                node.right.code=node.code+<span class="string">"1"</span>;</div><div class="line">            &#125;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">return</span> list;  	</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		HuffmanTree huffmanTree = <span class="keyword">new</span> HuffmanTree();</div><div class="line">		List&lt;Node&lt;String&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;Node&lt;String&gt;&gt;();  </div><div class="line">        list.add(<span class="keyword">new</span> Node&lt;String&gt;(<span class="string">"a"</span>,<span class="number">7</span>));  </div><div class="line">        list.add(<span class="keyword">new</span> Node&lt;String&gt;(<span class="string">"b"</span>,<span class="number">5</span>));  </div><div class="line">        list.add(<span class="keyword">new</span> Node&lt;String&gt;(<span class="string">"c"</span>,<span class="number">4</span>));  </div><div class="line">        list.add(<span class="keyword">new</span> Node&lt;String&gt;(<span class="string">"d"</span>,<span class="number">2</span>));</div><div class="line">        Node&lt;String&gt; root = huffmanTree.createTree(list); </div><div class="line">        System.out.println(huffmanTree.breadth(root));  </div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/21/算法总结之希尔排序/" itemprop="url">
                  算法总结2-希尔排序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-11-21T13:50:31+08:00" content="2016-11-21">
              2016-11-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/算法/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>参考：<a href="http://blog.csdn.net/morewindows/article/details/6668714" target="_blank" rel="external">http://blog.csdn.net/morewindows/article/details/6668714</a></p>
<h3 id="思想"><a href="#思想" class="headerlink" title="思想"></a>思想</h3><p>该方法的基本思想是：先将整个待排元素序列分割成若干个子序列（由相隔某个“增量”的元素组成的）分别进行直接插入排序，然后依次缩减增量再进行排序，待整个序列中的元素基本有序（增量足够小）时，再对全体元素进行一次直接插入排序。因为直接插入排序在元素基本有序的情况下（接近最好情况），效率是很高的，因此希尔排序在时间效率上比前两种方法有较大提高</p>
<p><img src="http://i.imgur.com/FPSyyTw.png" alt=""></p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//希尔排序</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Comparable&lt;? <span class="keyword">super</span> T&gt;&gt; <span class="function"><span class="keyword">void</span> <span class="title">shellsort</span><span class="params">(T[] a)</span></span>&#123;</div><div class="line">		<span class="keyword">int</span> j;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> gap=a.length/<span class="number">2</span>;gap&gt;<span class="number">0</span>;gap/=<span class="number">2</span>)&#123;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i=gap;i&lt;a.length;i++)&#123;</div><div class="line">				T tmp=a[i];</div><div class="line">				<span class="keyword">for</span>(j=i;j&gt;=gap&amp;&amp;tmp.compareTo(a[j-gap])&lt;<span class="number">0</span>;j-=gap)&#123;</div><div class="line">					a[j]=a[j-gap];</div><div class="line">				&#125;</div><div class="line">				a[j]=tmp;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/21/算法总结之插入排序/" itemprop="url">
                  算法总结1-插入排序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-11-21T13:20:54+08:00" content="2016-11-21">
              2016-11-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/算法/" itemprop="url" rel="index">
                    <span itemprop="name">算法</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="思想"><a href="#思想" class="headerlink" title="思想"></a>思想</h3><p>直接插入排序(Insertion Sort)的基本思想是：每次将一个待排序的记录，按其关键字大小插入到前面已经排好序的子序列中的适当位置，直到全部记录插入完成为止。</p>
<p>设数组为a[0…n-1]。</p>
<ol>
<li><p>初始时，a[0]自成1个有序区，无序区为a[1..n-1]。令i=1</p>
</li>
<li><p>将a[i]并入当前的有序区a[0…i-1]中形成a[0…i]的有序区间。</p>
</li>
<li><p>i++并重复第二步直到i==n-1。排序完成。</p>
</li>
</ol>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//插入排序</span></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Comparable&lt;? <span class="keyword">super</span> T&gt;&gt; <span class="function"><span class="keyword">void</span> <span class="title">insertionSort</span><span class="params">(T[] a)</span></span>&#123;</div><div class="line">		<span class="keyword">int</span> j;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;a.length;i++)&#123;</div><div class="line">			T tmp=a[i];</div><div class="line">			<span class="keyword">for</span>(j=i;j&gt;<span class="number">0</span>&amp;&amp;tmp.compareTo(a[j-<span class="number">1</span>])&lt;<span class="number">0</span>;j--)&#123;</div><div class="line">				a[j]=a[j-<span class="number">1</span>];</div><div class="line">			&#125;</div><div class="line">			a[j]=tmp;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Loren" />
          <p class="site-author-name" itemprop="name">Loren</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">59</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Loren</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  

  

  

  

  


</body>
</html>
