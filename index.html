<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
    
  
  <link href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="lyp's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.jpg?v=5.0.2" />






<meta property="og:type" content="website">
<meta property="og:title" content="lyp's blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="lyp's blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="lyp's blog">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '3188510942',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>


  <title> lyp's blog </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">lyp's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/2016总结/" itemprop="url">
                  2016总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-31T12:14:17+08:00" content="2016-12-31">
              2016-12-31
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="阅读书籍"><a href="#阅读书籍" class="headerlink" title="阅读书籍"></a>阅读书籍</h3><p>2016.06-2016.12</p>
<ul>
<li>深入理解java虚拟机 （总结：感觉要在温故一遍，其实最后几章有些没有认真阅读和思考 jvm内存模型？ 类加载过程？ 类加载器？ 类加载其顺序 垃圾回收算法？ minorgc和fullgc）</li>
<li>数据结构与算法分析 （总结：好吧，其实看完当时有收获，时间久了忘了也差不多了）</li>
<li>effective java （总结：一些模棱两可的问题更加清楚了）</li>
<li>hadoop应用开发技术详解（总结：其实蛮有意思的，大数据）</li>
<li>深入剖析tomact （总结：未完，讲道理，以前对于web编程只会写，一些原理不很清楚，感觉很有用去分析一下tomact源码）</li>
</ul>
<p>2017.01.01-2017.02.28（计划）</p>
<ul>
<li>java并发编程的艺术（线程池底层如何实现？ 如何模拟一个线程池？synchronized和lock的优缺点？）</li>
<li>pro spring（待定，其实是想找一本书好好理一下spring的源码实现 aop ioc？ springmvc流程？）</li>
<li>mybatis实现原理</li>
<li>深入浅出设计模式（观察者模式如何实现？ 单例模式两种的优缺点）</li>
<li>java基础（NIO：new io思想是什么？ hashmap内部实现？ 距离finally代码不执行？system。exit nio堆外内存？ hashmap和hashset关系？ 哪些类有serialVersionUID？futuretask类有什么作用 java访问数据库过程 jdbc？ cuncurrenthashmap读写加不加锁？）</li>
<li>redis（基本应用）</li>
<li>servlet（生命周期？过滤器和监听器用到的设计模式？ 单例多线程还是多利多线程？）</li>
<li>socket网络编程</li>
<li>网络相关 TCP、ip协议（tcp三次握手？ 常用http响应码含义？）</li>
<li>算法题（二叉树？ 快排？链表 堆 （10亿个数找topk））</li>
<li>软件工程（软件的设计原则）</li>
<li>js(prototype是什么 isNAN是什么意思)</li>
<li>jsp（两种include区别）</li>
<li>jstp（常用标签）</li>
<li>mysql（常用引擎？ 事务隔离级别？ sqlserver mysql oracle分页语句？ sql92和sql99写一个a和b表关联的语句？ 复合索引？）</li>
<li>linux（常用linux命令 复制一个文件 linux实时查看日志命令）</li>
<li>maven(maven命令)</li>
</ul>
<p>ps：怎么越写越多。。。以上是要付息或者预习的。</p>
<h3 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h3><ul>
<li>机器学习</li>
<li>spark</li>
<li>python</li>
</ul>
<h3 id="实习"><a href="#实习" class="headerlink" title="实习"></a>实习</h3><p>没什么写的。有一定收获。</p>
<ul>
<li>中科院 （2016.10-至今）</li>
<li>上海卯仕（2016.06-2016.09）</li>
<li>ibm （2015.09-2016.09）</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/tomact8源码分析/" itemprop="url">
                  tomact8源码分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-31T12:08:12+08:00" content="2016-12-31">
              2016-12-31
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><h4 id="1-背景"><a href="#1-背景" class="headerlink" title="1.背景"></a>1.背景</h4><p>Tomcat作为JavaWeb领域的Web容器，现在基本上所有线上业务系统都是部署在Tomcat上。为了对平时开发的Web系统有更深入的理解，于是仔细研究了下Tomcat的源码。Servlet规范是Java领域中为服务端编程制定的规范，对于我们开发者只是关注了Servlet规范中提供的编程组件(ServletContextListener,Filer,Servlet) 等 ，但是规范中还有一些我们经常使用的接口（ServletContext,ServletRequest,ServletResponse,FilterChain）等都是由Tomcat去实现的，并且我们开发者实现的编程组件只是被Tomcat去回调而已。所以看Tomcat源码实现也有助于我们更好的理解Servlet规范及系统如何在容器中运行(一些开源的MVC框架如Struts2,Webx,SpringMVC本质无非就是这个)</p>
<p>本文内容主要参考深入剖析tomact。由于这本书是基于tomcat4的，但是tomcat的核心思想应该是没有变的，最主要的两个组件还是连接器和容器。</p>
<p>本文分析内容为tomact8.0版本。</p>
<h4 id="2-tomact8-0源码目录"><a href="#2-tomact8-0源码目录" class="headerlink" title="2.tomact8.0源码目录"></a>2.tomact8.0源码目录</h4><p><img src="http://i.imgur.com/zkkS3tQ.png" alt=""></p>
<p>简单的包介绍：</p>
<ul>
<li>javax:servlet规范的api</li>
<li>org.apache.catalina：tomact自身架构（分析重点）</li>
<li>org.apache.coyote：http,ajp协议实现相关的类</li>
<li>org.apache.el :实现el规范</li>
<li>org.apache.jasper：实现jsp规范，编译jsp文件</li>
<li>org.apache.juli ：tomact的日志系统</li>
<li>org.apache.naming ： jndi实现</li>
<li>org.apache.tomact：tomact的工具包、net、digester xml解析器</li>
</ul>
<h4 id="3-tomact体系结构"><a href="#3-tomact体系结构" class="headerlink" title="3.tomact体系结构"></a>3.tomact体系结构</h4><p>为了后面的理解，先大致说一下Tomcat的整体架构，Tomcat主要有两个组件，<strong>连接器和容器</strong>，所谓连接器就是一个http请求过来了，连接器负责接收这个请求，然后转发给容器。容器即servlet容器，容器有很多层，分别是Engine，Host，Context，Wrapper。最大的容器Engine，代表一个servlet 引擎，接下来是Host，代表一个虚拟机，然后是Context，代表一个应用，Wrapper对应一个servlet。从连接器传过来连接后，容器便会顺序经过上面的容器，最后到达特定的servlet。</p>
<p><img src="http://i.imgur.com/irZpmOV.png" alt=""></p>
<p>一个server可以有多个service，一个service包含多个连接器和一个容器，一个Engine可以由多个虚拟主机Host组成，每一个Host下面又可以由多个Web应用Context构成，每一个的Context下面可以包含多个Wrapper（Servlet的包装器）组成。如图所示</p>
<p><img src="http://i.imgur.com/TnOdb8R.png" alt=""></p>
<p>Tomcat将Engine，Host，Context，Wrapper统一抽象成Container。一个抽象的Container模块可以包含各种服务。例如，Manager管理器（Session管理），Pipeline管道（ 维护管道阀门Value ）等。Lifecycle接口统一定义了容器的生命周期，通过事件机制实现各个容器间的内部通讯。</p>
<p>而容器的核心接口Container的抽象实现中定义了一个Pipeline，一个Manager，一个Realm以及ClassLoader统一了具体容器的实现规范。</p>
<ul>
<li>连接器（Connector）组件的主要任务是为其所接收到的每一个请求（可以是HTTP协议，也可以AJP协议），委托给具体相关协议的解析类ProtocolHandler</li>
<li>解析类 ProtocolHandler，构造出Request 对象和Response 对象。然后将这两个对象传送给容器（Container）进行处理。</li>
<li>容器（Container）组件收到来自连接器（Connector）的Request 和Response对象后，负责调用Filter，最后调用Servlet的service 方法（进入我们开发的Web系统中）。</li>
</ul>
<h4 id="4-tomact，servlet规范关系"><a href="#4-tomact，servlet规范关系" class="headerlink" title="4.tomact，servlet规范关系"></a>4.tomact，servlet规范关系</h4><p>Servlet规范由一组用 Java编程语言编写的类和接口组成。Servlet规范为服务端开发人员提供了一个标准的 API以及为服务器厂商制定了相关实现规范，开发人员只需要关心Servlet规范中的编程组件（如Filter,Servlet等），其他规范接口由第三方服务器厂商(如Tomcat)去实现，三者的关系如下图，Servlet规范之于Tomcat的关系，也类似于JDBC规范与数据库驱动的关系，本质就是一套接口和一套实现的关系。对于一个Web服务器主要需要做的事情，个人认为基本由以下组件组成： [TCP连接管理] –&gt; [请求处理线程池管理] –&gt; [HTTP协议解析封装] –&gt; [Servlet规范的实现,对编程组件的回调] –&gt; [MVC框架,Web系统业务逻辑]。</p>
<p>servlet规范和web应用和web容器之间的关系</p>
<p><img src="http://i.imgur.com/LGqAoZZ.png" alt=""></p>
<p>tomact对servlet规范的实现：</p>
<p><img src="http://i.imgur.com/WU5rWPi.png" alt=""></p>
<h3 id="第一章-类加载体系"><a href="#第一章-类加载体系" class="headerlink" title="第一章 类加载体系"></a>第一章 类加载体系</h3><p>首先简单介绍下Java虚拟机规范中提到的主要类加载器：</p>
<ul>
<li>Bootstrap Loader：加载lib目录下或者System.getProperty(“sun.boot.class.path”)、或者-XBootclasspath所指定的路径或jar。</li>
<li>Extended Loader：加载lib\ext目录下或者System.getProperty(“java.ext.dirs”) 所指定的 路径或jar。在使用Java运行程序时，也可以指定其搜索路径，例如：java -Djava.ext.dirs=d:\projects\testproj\classes HelloWorld。</li>
<li>AppClass Loader：加载System.getProperty(“java.class.path”)所指定的 路径或jar。在使用Java运行程序时，也可以加上-cp来覆盖原有的Classpath设置，例如： java -cp ./lavasoft/classes HelloWorld。</li>
</ul>
<p>根据java虚拟机的双亲委派模式的原则，类加载器在加载一个类时，首先交给父类加载器加载，层层往上直到Bootstrap Loader。也就是一个类最先由Bootstrap Loader加载，如果没有加载到，则交给下一层的类加载器加载，如果没有加载到，则依次层层往下，直到最下层的类加载器。这也就是说，凡是能通过父一级类加载器加载到的类，对于子类也是可见的。因此可以利用双亲委派模式的特性，使用类加载器对不同路径下的jar包或者类进行环境隔离。</p>
<p>然后用一张图片来展示Tomcat的类加载体系：</p>
<p><img src="http://i.imgur.com/yutfn3I.png" alt=""></p>
<ul>
<li>ClassLoader：Java提供的类加载器抽象类，用户自定义的类加载器需要继承实现</li>
<li>commonLoader：Tomcat最基本的类加载器，加载路径中的class可以被Tomcat容器本身以及各个Webapp访问；</li>
<li>catalinaLoader：Tomcat容器私有的类加载器，加载路径中的class对于Webapp不可见；</li>
<li>sharedLoader：各个Webapp共享的类加载器，加载路径中的class对于所有Webapp可见，但是对于Tomcat容器不可见；</li>
<li>WebappClassLoader：各个Webapp私有的类加载器，加载路径中的class只对当前Webapp可见；</li>
</ul>
<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><p>commonLoader、catalinaLoader和sharedLoader在Tomcat容器初始化的一开始，即调用Bootstrap的init方法时创建。catalinaLoader会被设置为Tomcat主线程的线程上下文类加载器，并且使用catalinaLoader加载Tomcat容器自身容器下的class。Bootstrap的init方法的部分代码见代码清单1。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        initClassLoaders();</div><div class="line"></div><div class="line">        Thread.currentThread().setContextClassLoader(catalinaLoader);</div><div class="line"></div><div class="line">        SecurityClassLoad.securityClassLoad(catalinaLoader);</div><div class="line"></div><div class="line">        <span class="comment">// Load our startup class and call its process() method</span></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">            log.debug(<span class="string">"Loading startup class"</span>);</div><div class="line">        Class&lt;?&gt; startupClass =</div><div class="line">            catalinaLoader.loadClass</div><div class="line">            (<span class="string">"org.apache.catalina.startup.Catalina"</span>);</div><div class="line">        Object startupInstance = startupClass.newInstance();</div><div class="line"></div><div class="line">        <span class="comment">// Set the shared extensions class loader</span></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">            log.debug(<span class="string">"Setting startup class properties"</span>);</div><div class="line">        String methodName = <span class="string">"setParentClassLoader"</span>;</div><div class="line">        Class&lt;?&gt; paramTypes[] = <span class="keyword">new</span> Class[<span class="number">1</span>];</div><div class="line">        paramTypes[<span class="number">0</span>] = Class.forName(<span class="string">"java.lang.ClassLoader"</span>);</div><div class="line">        Object paramValues[] = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        paramValues[<span class="number">0</span>] = sharedLoader;</div><div class="line">        Method method =</div><div class="line">            startupInstance.getClass().getMethod(methodName, paramTypes);</div><div class="line">        method.invoke(startupInstance, paramValues);</div><div class="line"></div><div class="line">        catalinaDaemon = startupInstance;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>接下来我们关注initclassloaders方法的实现，该方法主要用来初始化commonLoader、catalinaLoader、sharedLoader。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initClassLoaders</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            commonLoader = createClassLoader(<span class="string">"common"</span>, <span class="keyword">null</span>);</div><div class="line">            <span class="keyword">if</span>( commonLoader == <span class="keyword">null</span> ) &#123;</div><div class="line">                <span class="comment">// no config file, default to this loader - we might be in a 'single' env.</span></div><div class="line">                commonLoader=<span class="keyword">this</span>.getClass().getClassLoader();</div><div class="line">            &#125;</div><div class="line">            catalinaLoader = createClassLoader(<span class="string">"server"</span>, commonLoader);</div><div class="line">            sharedLoader = createClassLoader(<span class="string">"shared"</span>, commonLoader);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            handleThrowable(t);</div><div class="line">            log.error(<span class="string">"Class loader creation threw exception"</span>, t);</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从代码中看到创建类加载器是通过调用createClassLoader方法实现的。createClassLoader的实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(String name, ClassLoader parent)</span></span></div><div class="line">        <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">        String value = CatalinaProperties.getProperty(name + <span class="string">".loader"</span>);</div><div class="line">        <span class="keyword">if</span> ((value == <span class="keyword">null</span>) || (value.equals(<span class="string">""</span>)))</div><div class="line">            <span class="keyword">return</span> parent;</div><div class="line"></div><div class="line">        value = replace(value);</div><div class="line"></div><div class="line">        List&lt;Repository&gt; repositories = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">        String[] repositoryPaths = getPaths(value);</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (String repository : repositoryPaths) &#123;</div><div class="line">            <span class="comment">// Check for a JAR URL repository</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</div><div class="line">                URL url = <span class="keyword">new</span> URL(repository);</div><div class="line">                repositories.add(</div><div class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.URL));</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</div><div class="line">                <span class="comment">// Ignore</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Local repository</span></div><div class="line">            <span class="keyword">if</span> (repository.endsWith(<span class="string">"*.jar"</span>)) &#123;</div><div class="line">                repository = repository.substring</div><div class="line">                    (<span class="number">0</span>, repository.length() - <span class="string">"*.jar"</span>.length());</div><div class="line">                repositories.add(</div><div class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.GLOB));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (repository.endsWith(<span class="string">".jar"</span>)) &#123;</div><div class="line">                repositories.add(</div><div class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.JAR));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                repositories.add(</div><div class="line">                        <span class="keyword">new</span> Repository(repository, RepositoryType.DIR));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> ClassLoaderFactory.createClassLoader(repositories, parent);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>createClassLoader方法的执行步骤如下：</p>
<ol>
<li>获取各个类加载器相应的资源配置文件（分别为common.loader、server.loader、shared.loader），从中获取类资源路径的配置信息；</li>
<li>解析类资源路径下的各个资源位置和类型，也包括对jar资源的检查；</li>
<li>调用ClassLoaderFactory.createClassLoader(locations, types, parent)方法创建ClassLoader；</li>
</ol>
<p>我们回头看看代码清单1中的SecurityClassLoad.securityClassLoad(catalinaLoader)的实现，见代码清单4.这说明加载Tomcat容器本身的类资源的确是使用catalinaLoader来完成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> org.apache.catalina.security;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">securityClassLoad</span><span class="params">(ClassLoader loader, <span class="keyword">boolean</span> requireSecurityManager)</span></span></div><div class="line">           <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (requireSecurityManager &amp;&amp; System.getSecurityManager() == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       loadCorePackage(loader);</div><div class="line">       loadCoyotePackage(loader);</div><div class="line">       loadLoaderPackage(loader);</div><div class="line">       loadRealmPackage(loader);</div><div class="line">       loadServletsPackage(loader);</div><div class="line">       loadSessionPackage(loader);</div><div class="line">       loadUtilPackage(loader);</div><div class="line">       loadValvesPackage(loader);</div><div class="line">       loadJavaxPackage(loader);</div><div class="line">       loadConnectorPackage(loader);</div><div class="line">       loadTomcatPackage(loader);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>securityClassLoad方法主要加载Tomcat容器所需的class，包括：</p>
<ul>
<li>Tomcat核心class，即org.apache.catalina.core路径下的class；</li>
<li>loadCoyotePackage</li>
<li>org.apache.catalina.loader.WebappClassLoader$PrivilegedFindResourceByName；</li>
<li>loadRealmPackage</li>
<li>loadServletsPackage</li>
<li>Tomcat有关session的class，即org.apache.catalina.session路径下的class；</li>
<li>Tomcat工具类的class，即org.apache.catalina.util路径下的class；</li>
<li>loadValvesPackage</li>
<li>javax.servlet.http.Cookie；</li>
<li>Tomcat处理请求的class，即org.apache.catalina.connector路径下的class；</li>
<li>Tomcat其它工具类的class，也是org.apache.catalina.util路径下的class；</li>
</ul>
<p>我们以加载Tomcat核心class的loadCorePackage方法为例，其实现见代码清单5所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">loadCorePackage</span><span class="params">(ClassLoader loader)</span></span></div><div class="line">            <span class="keyword">throws</span> Exception &#123;</div><div class="line">        <span class="keyword">final</span> String basePackage = <span class="string">"org.apache.catalina.core."</span>;</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"AccessLogAdapter"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"ApplicationContextFacade$1"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"ApplicationDispatcher$PrivilegedForward"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"ApplicationDispatcher$PrivilegedInclude"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">            <span class="string">"AsyncContextImpl"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">            <span class="string">"AsyncContextImpl$DebugException"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">            <span class="string">"AsyncContextImpl$1"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">            <span class="string">"AsyncListenerWrapper"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"ContainerBase$PrivilegedAddChild"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"DefaultInstanceManager$1"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"DefaultInstanceManager$2"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"DefaultInstanceManager$3"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"DefaultInstanceManager$AnnotationCacheEntry"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"DefaultInstanceManager$AnnotationCacheEntryType"</span>);</div><div class="line">        loader.loadClass</div><div class="line">            (basePackage +</div><div class="line">             <span class="string">"ApplicationHttpRequest$AttributeNamesEnumerator"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>至此，有关commonLoader、catalinaLoader和sharedLoader三个类加载器的初始化以及使用catalinaLoader加载Tomcat容器自身类资源的内容已经介绍完了，但是我们还没有看到WebappClassLoader。启动StandardContext的时候会创建WebappLoader，最终调用其startInternal方法.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.apache.catalina.core;</div><div class="line"></div><div class="line"><span class="comment">/** </span></div><div class="line"> * Start this component and implement the requirements </div><div class="line"> * of &#123;<span class="doctag">@link</span> LifecycleBase#startInternal()&#125;. </div><div class="line"> * </div><div class="line"> * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error </div><div class="line"> *  that prevents this component from being used </div><div class="line"> */  </div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="comment">// 省略前边的代码   </span></div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (getLoader() == <span class="keyword">null</span>) &#123;  </div><div class="line">        WebappLoader webappLoader = <span class="keyword">new</span> WebappLoader(getParentClassLoader());  </div><div class="line">        webappLoader.setDelegate(getDelegate());  </div><div class="line">        setLoader(webappLoader);  </div><div class="line">    &#125;  </div><div class="line">   <span class="comment">// 省略中间的代码   </span></div><div class="line">   <span class="comment">// Start our subordinate components, if any  </span></div><div class="line">   <span class="keyword">if</span> ((loader != <span class="keyword">null</span>) &amp;&amp; (loader <span class="keyword">instanceof</span> Lifecycle))  </div><div class="line">        ((Lifecycle) loader).start();   </div><div class="line">   <span class="comment">// 省略后边的代码   </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从代码清单6看到首先创建WebappLoader实例，然后调用WebappLoader的start方法，start又调用了startInternal方法，WebappLoader的startInternal的实现见代码清单7.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">            log.debug(sm.getString(<span class="string">"webappLoader.starting"</span>));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (context.getResources() == <span class="keyword">null</span>) &#123;</div><div class="line">            log.info(<span class="string">"No resources for "</span> + context);</div><div class="line">            setState(LifecycleState.STARTING);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Construct a class loader based on our current repositories list</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">            classLoader = createClassLoader();</div><div class="line">            classLoader.setResources(context.getResources());</div><div class="line">            classLoader.setDelegate(<span class="keyword">this</span>.delegate);</div><div class="line"></div><div class="line">            <span class="comment">// Configure our repositories</span></div><div class="line">            setClassPath();</div><div class="line"></div><div class="line">            setPermissions();</div><div class="line"></div><div class="line">            ((Lifecycle) classLoader).start();</div><div class="line"></div><div class="line">            String contextName = context.getName();</div><div class="line">            <span class="keyword">if</span> (!contextName.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">                contextName = <span class="string">"/"</span> + contextName;</div><div class="line">            &#125;</div><div class="line">            ObjectName cloname = <span class="keyword">new</span> ObjectName(context.getDomain() + <span class="string">":type="</span> +</div><div class="line">                    classLoader.getClass().getSimpleName() + <span class="string">",host="</span> +</div><div class="line">                    context.getParent().getName() + <span class="string">",context="</span> + contextName);</div><div class="line">            Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>)</div><div class="line">                .registerComponent(classLoader, cloname, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            t = ExceptionUtils.unwrapInvocationTargetException(t);</div><div class="line">            ExceptionUtils.handleThrowable(t);</div><div class="line">            log.error( <span class="string">"LifecycleException "</span>, t );</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(<span class="string">"start: "</span>, t);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setState(LifecycleState.STARTING);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>我们看到代码清单7中通过调用createClassLoader来创建类加载器，并且设置其资源路径为当前Webapp下的类资源。最后我们看看createClassLoader的实现，见代码清单8.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Create associated classLoader.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> WebappClassLoaderBase <span class="title">createClassLoader</span><span class="params">()</span></span></div><div class="line">       <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">       Class&lt;?&gt; clazz = Class.forName(loaderClass);</div><div class="line">       WebappClassLoaderBase classLoader = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (parentClassLoader == <span class="keyword">null</span>) &#123;</div><div class="line">           parentClassLoader = context.getParentClassLoader();</div><div class="line">       &#125;</div><div class="line">       Class&lt;?&gt;[] argTypes = &#123; ClassLoader.class &#125;;</div><div class="line">       Object[] args = &#123; parentClassLoader &#125;;</div><div class="line">       Constructor&lt;?&gt; constr = clazz.getConstructor(argTypes);</div><div class="line">       classLoader = (WebappClassLoaderBase) constr.newInstance(args);</div><div class="line"></div><div class="line">       <span class="keyword">return</span> classLoader;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这里loaderClass的值是字符串org.apache.catalina.loader.WebappClassLoader，通过反射来实例化WebappClassLoader。由于每个Webapp下的类资源由不同的WebappClassLoader负责加载，因此各个Webapp下的类资源是独立的。至此，整个Tomcat的类加载体系构建完毕。</p>
<h3 id="第二章-server-xml文件的加载和解析"><a href="#第二章-server-xml文件的加载和解析" class="headerlink" title="第二章 server.xml文件的加载和解析"></a>第二章 server.xml文件的加载和解析</h3><p>作为Java程序员，对于Tomcat的server.xml想必都不陌生。本章主要对server.xml文件是如何加载和解析进行分析。</p>
<h4 id="1-web-xml"><a href="#1-web-xml" class="headerlink" title="1.web.xml"></a>1.web.xml</h4><p>首先让我们来查看一下web.xml内容</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></div><div class="line">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee</span></div><div class="line">                      http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"</div><div class="line">  <span class="attr">version</span>=<span class="string">"3.1"</span></div><div class="line">  <span class="attr">metadata-complete</span>=<span class="string">"true"</span>&gt;</div><div class="line"></div><div class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Tomcat Documentation<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">     Tomcat Documentation.</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="2-加载过程分析"><a href="#2-加载过程分析" class="headerlink" title="2.加载过程分析"></a>2.加载过程分析</h4><p>bootstrap中load方法用于加载tomact的server.xml,实际是通过反射调用Catalina的load方法.代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">    * Load daemon.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(String[] arguments)</span></span></div><div class="line">       <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">       <span class="comment">// Call the load() method</span></div><div class="line">       String methodName = <span class="string">"load"</span>;</div><div class="line">       Object param[];</div><div class="line">       Class&lt;?&gt; paramTypes[];</div><div class="line">       <span class="keyword">if</span> (arguments==<span class="keyword">null</span> || arguments.length==<span class="number">0</span>) &#123;</div><div class="line">           paramTypes = <span class="keyword">null</span>;</div><div class="line">           param = <span class="keyword">null</span>;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           paramTypes = <span class="keyword">new</span> Class[<span class="number">1</span>];</div><div class="line">           paramTypes[<span class="number">0</span>] = arguments.getClass();</div><div class="line">           param = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">           param[<span class="number">0</span>] = arguments;</div><div class="line">       &#125;</div><div class="line">       Method method =</div><div class="line">           catalinaDaemon.getClass().getMethod(methodName, paramTypes);</div><div class="line">       <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">           log.debug(<span class="string">"Calling startup class "</span> + method);</div><div class="line">       method.invoke(catalinaDaemon, param);</div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>Catalina的load方法实现如下代码所示。其中load方法主要执行如是过程：</p>
<ol>
<li>initDirs()用于对catalina.home和catalina.base的一些检查工作。</li>
<li>initNaming()给系统设置java.naming.factory.url.pkgs和java.naming.factory.initial。</li>
<li>createStartDigester();创建并配置将要用来启动的Digester实例，并且设置一些列Rule，具体映射到server.xml。</li>
<li>FileInputStream获取conf/server.xml配置文件输入流</li>
<li>将FileInputStream封装为InputSource，并且调用Digester的parse方法进行解析。</li>
<li>initStreams()对输出流、错误流重定向</li>
<li>初始化server</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Start a new server instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> t1 = System.nanoTime();</div><div class="line"></div><div class="line">        initDirs();</div><div class="line"></div><div class="line">        <span class="comment">// Before digester - it may be needed</span></div><div class="line">        initNaming();</div><div class="line"></div><div class="line">        <span class="comment">// Create and execute our Digester</span></div><div class="line">        Digester digester = createStartDigester();</div><div class="line"></div><div class="line">        InputSource inputSource = <span class="keyword">null</span>;</div><div class="line">        InputStream inputStream = <span class="keyword">null</span>;</div><div class="line">        File file = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                file = configFile();</div><div class="line">                inputStream = <span class="keyword">new</span> FileInputStream(file);</div><div class="line">                inputSource = <span class="keyword">new</span> InputSource(file.toURI().toURL().toString());</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                    log.debug(sm.getString(<span class="string">"catalina.configFail"</span>, file), e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    inputStream = getClass().getClassLoader()</div><div class="line">                        .getResourceAsStream(getConfigFile());</div><div class="line">                    inputSource = <span class="keyword">new</span> InputSource</div><div class="line">                        (getClass().getClassLoader()</div><div class="line">                         .getResource(getConfigFile()).toString());</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                        log.debug(sm.getString(<span class="string">"catalina.configFail"</span>,</div><div class="line">                                getConfigFile()), e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// This should be included in catalina.jar</span></div><div class="line">            <span class="comment">// Alternative: don't bother with xml, just create it manually.</span></div><div class="line">            <span class="keyword">if</span> (inputStream == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    inputStream = getClass().getClassLoader()</div><div class="line">                            .getResourceAsStream(<span class="string">"server-embed.xml"</span>);</div><div class="line">                    inputSource = <span class="keyword">new</span> InputSource</div><div class="line">                    (getClass().getClassLoader()</div><div class="line">                            .getResource(<span class="string">"server-embed.xml"</span>).toString());</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                        log.debug(sm.getString(<span class="string">"catalina.configFail"</span>,</div><div class="line">                                <span class="string">"server-embed.xml"</span>), e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="keyword">if</span> (inputStream == <span class="keyword">null</span> || inputSource == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span>  (file == <span class="keyword">null</span>) &#123;</div><div class="line">                    log.warn(sm.getString(<span class="string">"catalina.configFail"</span>,</div><div class="line">                            getConfigFile() + <span class="string">"] or [server-embed.xml]"</span>));</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    log.warn(sm.getString(<span class="string">"catalina.configFail"</span>,</div><div class="line">                            file.getAbsolutePath()));</div><div class="line">                    <span class="keyword">if</span> (file.exists() &amp;&amp; !file.canRead()) &#123;</div><div class="line">                        log.warn(<span class="string">"Permissions incorrect, read permission is not allowed on the file."</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                inputSource.setByteStream(inputStream);</div><div class="line">                digester.push(<span class="keyword">this</span>);</div><div class="line">                digester.parse(inputSource);</div><div class="line">            &#125; <span class="keyword">catch</span> (SAXParseException spe) &#123;</div><div class="line">                log.warn(<span class="string">"Catalina.start using "</span> + getConfigFile() + <span class="string">": "</span> +</div><div class="line">                        spe.getMessage());</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                log.warn(<span class="string">"Catalina.start using "</span> + getConfigFile() + <span class="string">": "</span> , e);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    inputStream.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    <span class="comment">// Ignore</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        getServer().setCatalina(<span class="keyword">this</span>);</div><div class="line">        getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());</div><div class="line">        getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());</div><div class="line"></div><div class="line">        <span class="comment">// Stream redirection</span></div><div class="line">        initStreams();</div><div class="line"></div><div class="line">        <span class="comment">// Start the new server</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            getServer().init();</div><div class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</div><div class="line">            <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">"org.apache.catalina.startup.EXIT_ON_INIT_FAILURE"</span>)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> java.lang.Error(e);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                log.error(<span class="string">"Catalina.start"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> t2 = System.nanoTime();</div><div class="line">        <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</div><div class="line">            log.info(<span class="string">"Initialization processed in "</span> + ((t2 - t1) / <span class="number">1000000</span>) + <span class="string">" ms"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="3-规则"><a href="#3-规则" class="headerlink" title="3.规则"></a>3.规则</h4><p>在针对上述加载过程具体分析及正式介绍Digester的parse方法的解析过程前，我们先要掌握一些规则相关的内容。<br>Tomcat将server.xml文件中的所有元素上的属性都抽象为Rule，以Server元素为例，在内存中对应Server实例，Server实例的属性值就来自于Server元素的属性值。通过对规则（Rule）的应用，最终改变Server实例的属性值。</p>
<p>rule抽象类，结构如下：</p>
<p><img src="http://i.imgur.com/hQoWO8b.png" alt=""></p>
<p>主要接口介绍：</p>
<ul>
<li>getDigester：获取Digester实例；</li>
<li>setDigester：设置Digester实例；</li>
<li>getNamespaceURI：获取Rule所在的相对命名空间URI；</li>
<li>setNamespaceURI：设置Rule所在的相对命名空间URI；</li>
<li>begin(String namespace, String name, Attributes attributes)：此方法在遇到一个匹配的XML元素的开头时被调用，如：<server>。</server></li>
<li>body(String namespace, String name, String text)：在遇到匹配XML元素的body时，此方法被调用，如进入<server>标签内部时。</server></li>
<li>end(String namespace, String name)：此方法在遇到一个匹配的XML元素的末尾时被调用。如：。</li>
</ul>
<p>Rule目前有很多实现类，如：NodeCreateRule，AbsoluteOrderingRule、CallParamRule、ConnectorCreateRule等。下图展示了Rule的部分实现类：<br><img src="http://i.imgur.com/8oFCvId.png" alt=""></p>
<h4 id="4-SAX"><a href="#4-SAX" class="headerlink" title="4.SAX"></a>4.SAX</h4><p><strong>simple api for xml</strong></p>
<p>相比于 DOM 而言 SAX 是一种速度更快，更有效，占用内存更少的解析 XML 文件的方法。它是逐行扫描，可以做到边扫描边解析，因此 SAX 可以在解析文档的任意时刻停止解析。</p>
<p>SAX 是基于事件驱动的。</p>
<p>SAX 不用解析完整个文档，在按内容顺序解析文档过程中， SAX 会判断当前读到的字符是否符合 XML 文件语法中的某部分。如果符合某部分，则会触发事件。</p>
<p>所谓触发事件，就是调用一些回调方法。在用 SAX 解析 xml 文档时候，在读取到文档开始和结束标签时候就会回调一个事件，在读取到其他节点与内容时候也会回调一个事件。</p>
<p>在 SAX 接口中，事件源是 org.xml.sax 包中的 XMLReader ，它通过 parser() 方法来解析 XML 文档，并产生事件。事件处理器是 org.xml.sax 包中 ContentHander 、 DTDHander 、 ErrorHandler ，以及 EntityResolver 这 4 个接口。</p>
<p><img src="http://i.imgur.com/ZteQz4W.png" alt=""></p>
<p>我们用来做内容解析的回调方法一般都定义在 ContentHandler 接口中 。ContentHandler 接口常用的方法：</p>
<ul>
<li>startDocument() :当遇到文档的开头的时候，调用这个方法，可以在其中做一些预处理的工作。 </li>
<li>endDocument() :当文档结束的时候，调用这个方法，可以在其中做一些善后的工作。   </li>
<li>startElement(String namespaceURI, String localName,String qName, Attributes atts):当读到开始标签的时候，会调用这个方法。 namespaceURI 就是命名空间， localName 是不带命名空间前缀的标签名， qName 是带命名空间前缀的标签名。通过 atts 可以得到所有的属性名和相应的值。 </li>
<li>endElement(String uri, String localName, String name):在遇到结束标签的时候，调用这个方法。</li>
<li>characters(char[] ch, int start, int length):这个方法用来处理在 XML 文件中读到的内容。例如： <high data="30"> 主要目的是获取 high 标签中的值。</high></li>
</ul>
<p>使用 SAX 解析 XML 文件一般有以下五个步骤： </p>
<ol>
<li>创建一个 SAXParserFactory 对象； </li>
<li>调用 SAXParserFactory 中的 newSAXParser 方法创建一个 SAXParser 对象； </li>
<li>然后在调用 SAXParser 中的 getXMLReader 方法获取一个 XMLReader 对象；</li>
<li>实例化一个 DefaultHandler 对象；</li>
<li>连接事件源对象 XMLReader 到事件处理类 DefaultHandler 中；</li>
<li>调用 XMLReader 的 parse 方法从输入源中获取到的 xml 数据；</li>
<li>通过 DefaultHandler 返回我们需要的数据集合。</li>
</ol>
<h4 id="5-解析过程分析"><a href="#5-解析过程分析" class="headerlink" title="5.解析过程分析"></a>5.解析过程分析</h4><p>回顾第二小节讲的catalina中load方法执行步骤：</p>
<blockquote>
<p>Catalina的load方法实现如下代码所示。其中load方法主要执行如是过程：</p>
<ol>
<li>initDirs()用于对catalina.home和catalina.base的一些检查工作。</li>
<li>initNaming()给系统设置java.naming.factory.url.pkgs和java.naming.factory.initial。</li>
<li>createStartDigester();创建并配置将要用来启动的Digester实例，并且设置一些列Rule，具体映射到server.xml。</li>
<li>FileInputStream获取conf/server.xml配置文件输入流</li>
<li>将FileInputStream封装为InputSource，并且调用Digester的parse方法进行解析。</li>
<li>initStreams()对输出流、错误流重定向</li>
<li>初始化server</li>
</ol>
</blockquote>
<p>首先来查看createStartDigester方法。实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Create and configure the Digester we will be using for startup.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> Digester <span class="title">createStartDigester</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> t1=System.currentTimeMillis();</div><div class="line">        <span class="comment">// Initialize the digester</span></div><div class="line">        Digester digester = <span class="keyword">new</span> Digester();</div><div class="line">        digester.setValidating(<span class="keyword">false</span>);</div><div class="line">        digester.setRulesValidation(<span class="keyword">true</span>);</div><div class="line">        HashMap&lt;Class&lt;?&gt;, List&lt;String&gt;&gt; fakeAttributes = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">        ArrayList&lt;String&gt; attrs = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        attrs.add(<span class="string">"className"</span>);</div><div class="line">        fakeAttributes.put(Object.class, attrs);</div><div class="line">        digester.setFakeAttributes(fakeAttributes);</div><div class="line">        digester.setUseContextClassLoader(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Configure the actions we will be using</span></div><div class="line">        digester.addObjectCreate(<span class="string">"Server"</span>,</div><div class="line">                                 <span class="string">"org.apache.catalina.core.StandardServer"</span>,</div><div class="line">                                 <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server"</span>,</div><div class="line">                            <span class="string">"setServer"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.Server"</span>);</div><div class="line"></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/GlobalNamingResources"</span>,</div><div class="line">                                 <span class="string">"org.apache.catalina.deploy.NamingResourcesImpl"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/GlobalNamingResources"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server/GlobalNamingResources"</span>,</div><div class="line">                            <span class="string">"setGlobalNamingResources"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.deploy.NamingResourcesImpl"</span>);</div><div class="line"></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/Listener"</span>,</div><div class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></div><div class="line">                                 <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/Listener"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server/Listener"</span>,</div><div class="line">                            <span class="string">"addLifecycleListener"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.LifecycleListener"</span>);</div><div class="line"></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/Service"</span>,</div><div class="line">                                 <span class="string">"org.apache.catalina.core.StandardService"</span>,</div><div class="line">                                 <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/Service"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server/Service"</span>,</div><div class="line">                            <span class="string">"addService"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.Service"</span>);</div><div class="line"></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/Service/Listener"</span>,</div><div class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></div><div class="line">                                 <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/Service/Listener"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server/Service/Listener"</span>,</div><div class="line">                            <span class="string">"addLifecycleListener"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.LifecycleListener"</span>);</div><div class="line"></div><div class="line">        <span class="comment">//Executor</span></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/Service/Executor"</span>,</div><div class="line">                         <span class="string">"org.apache.catalina.core.StandardThreadExecutor"</span>,</div><div class="line">                         <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/Service/Executor"</span>);</div><div class="line"></div><div class="line">        digester.addSetNext(<span class="string">"Server/Service/Executor"</span>,</div><div class="line">                            <span class="string">"addExecutor"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.Executor"</span>);</div><div class="line"></div><div class="line"></div><div class="line">        digester.addRule(<span class="string">"Server/Service/Connector"</span>,</div><div class="line">                         <span class="keyword">new</span> ConnectorCreateRule());</div><div class="line">        digester.addRule(<span class="string">"Server/Service/Connector"</span>,</div><div class="line">                         <span class="keyword">new</span> SetAllPropertiesRule(<span class="keyword">new</span> String[]&#123;<span class="string">"executor"</span>&#125;));</div><div class="line">        digester.addSetNext(<span class="string">"Server/Service/Connector"</span>,</div><div class="line">                            <span class="string">"addConnector"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.connector.Connector"</span>);</div><div class="line"></div><div class="line"></div><div class="line">        digester.addObjectCreate(<span class="string">"Server/Service/Connector/Listener"</span>,</div><div class="line">                                 <span class="keyword">null</span>, <span class="comment">// MUST be specified in the element</span></div><div class="line">                                 <span class="string">"className"</span>);</div><div class="line">        digester.addSetProperties(<span class="string">"Server/Service/Connector/Listener"</span>);</div><div class="line">        digester.addSetNext(<span class="string">"Server/Service/Connector/Listener"</span>,</div><div class="line">                            <span class="string">"addLifecycleListener"</span>,</div><div class="line">                            <span class="string">"org.apache.catalina.LifecycleListener"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Add RuleSets for nested elements</span></div><div class="line">        digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">"Server/GlobalNamingResources/"</span>));</div><div class="line">        digester.addRuleSet(<span class="keyword">new</span> EngineRuleSet(<span class="string">"Server/Service/"</span>));</div><div class="line">        digester.addRuleSet(<span class="keyword">new</span> HostRuleSet(<span class="string">"Server/Service/Engine/"</span>));</div><div class="line">        digester.addRuleSet(<span class="keyword">new</span> ContextRuleSet(<span class="string">"Server/Service/Engine/Host/"</span>));</div><div class="line">        addClusterRuleSet(digester, <span class="string">"Server/Service/Engine/Host/Cluster/"</span>);</div><div class="line">        digester.addRuleSet(<span class="keyword">new</span> NamingRuleSet(<span class="string">"Server/Service/Engine/Host/Context/"</span>));</div><div class="line"></div><div class="line">        <span class="comment">// When the 'engine' is found, set the parentClassLoader.</span></div><div class="line">        digester.addRule(<span class="string">"Server/Service/Engine"</span>,</div><div class="line">                         <span class="keyword">new</span> SetParentClassLoaderRule(parentClassLoader));</div><div class="line">        addClusterRuleSet(digester, <span class="string">"Server/Service/Engine/Cluster/"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">long</span> t2=System.currentTimeMillis();</div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">            log.debug(<span class="string">"Digester for server.xml created "</span> + ( t2-t1 ));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (digester);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>代码清单1首先创建Digester，Digester继承了DefaultHandler2，而DefaultHandler默认实现了DefaultHandler,LexicalHandler, DeclHandler, EntityResolver2 这几个接口，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultHandler2</span> <span class="keyword">extends</span> <span class="title">DefaultHandler</span></span></div><div class="line">    <span class="keyword">implements</span> <span class="title">LexicalHandler</span>, <span class="title">DeclHandler</span>, <span class="title">EntityResolver2</span></div></pre></td></tr></table></figure>
<p>如果阅读DefaultHandler的源码，发现它的所有实现都是空实现，看来要发挥解析作用，只能依靠Digester自己了，digester中部分实现如下;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Process notification of the end of the document being reached.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> SAXException if a parsing error is to be reported</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (saxLog.isDebugEnabled()) &#123;</div><div class="line">            <span class="keyword">if</span> (getCount() &gt; <span class="number">1</span>) &#123;</div><div class="line">                saxLog.debug(<span class="string">"endDocument():  "</span> + getCount() + <span class="string">" elements left"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                saxLog.debug(<span class="string">"endDocument()"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (getCount() &gt; <span class="number">1</span>) &#123;</div><div class="line">            pop();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Fire "finish" events for all defined rules</span></div><div class="line">        Iterator&lt;Rule&gt; rules = getRules().rules().iterator();</div><div class="line">        <span class="keyword">while</span> (rules.hasNext()) &#123;</div><div class="line">            Rule rule = rules.next();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                rule.finish();</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                log.error(<span class="string">"Finish event threw exception"</span>, e);</div><div class="line">                <span class="keyword">throw</span> createSAXException(e);</div><div class="line">            &#125; <span class="keyword">catch</span> (Error e) &#123;</div><div class="line">                log.error(<span class="string">"Finish event threw error"</span>, e);</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Perform final cleanup</span></div><div class="line">        clear();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Process notification of the end of an XML element being reached.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> namespaceURI - The Namespace URI, or the empty string if the</div><div class="line">     *   element has no Namespace URI or if Namespace processing is not</div><div class="line">     *   being performed.</div><div class="line">     * <span class="doctag">@param</span> localName - The local name (without prefix), or the empty</div><div class="line">     *   string if Namespace processing is not being performed.</div><div class="line">     * <span class="doctag">@param</span> qName - The qualified XML 1.0 name (with prefix), or the</div><div class="line">     *   empty string if qualified names are not available.</div><div class="line">     * <span class="doctag">@exception</span> SAXException if a parsing error is to be reported</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endElement</span><span class="params">(String namespaceURI, String localName, String qName)</span></span></div><div class="line">            <span class="keyword">throws</span> SAXException &#123;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> debug = log.isDebugEnabled();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (debug) &#123;</div><div class="line">            <span class="keyword">if</span> (saxLog.isDebugEnabled()) &#123;</div><div class="line">                saxLog.debug(<span class="string">"endElement("</span> + namespaceURI + <span class="string">","</span> + localName + <span class="string">","</span> + qName + <span class="string">")"</span>);</div><div class="line">            &#125;</div><div class="line">            log.debug(<span class="string">"  match='"</span> + match + <span class="string">"'"</span>);</div><div class="line">            log.debug(<span class="string">"  bodyText='"</span> + bodyText + <span class="string">"'"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Parse system properties</span></div><div class="line">        bodyText = updateBodyText(bodyText);</div><div class="line"></div><div class="line">        <span class="comment">// the actual element name is either in localName or qName, depending</span></div><div class="line">        <span class="comment">// on whether the parser is namespace aware</span></div><div class="line">        String name = localName;</div><div class="line">        <span class="keyword">if</span> ((name == <span class="keyword">null</span>) || (name.length() &lt; <span class="number">1</span>)) &#123;</div><div class="line">            name = qName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Fire "body" events for all relevant rules</span></div><div class="line">        List&lt;Rule&gt; rules = matches.pop();</div><div class="line">        <span class="keyword">if</span> ((rules != <span class="keyword">null</span>) &amp;&amp; (rules.size() &gt; <span class="number">0</span>)) &#123;</div><div class="line">            String bodyText = <span class="keyword">this</span>.bodyText.toString();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Rule rule = rules.get(i);</div><div class="line">                    <span class="keyword">if</span> (debug) &#123;</div><div class="line">                        log.debug(<span class="string">"  Fire body() for "</span> + rule);</div><div class="line">                    &#125;</div><div class="line">                    rule.body(namespaceURI, name, bodyText);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    log.error(<span class="string">"Body event threw exception"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> createSAXException(e);</div><div class="line">                &#125; <span class="keyword">catch</span> (Error e) &#123;</div><div class="line">                    log.error(<span class="string">"Body event threw error"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (debug) &#123;</div><div class="line">                log.debug(<span class="string">"  No rules found matching '"</span> + match + <span class="string">"'."</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (rulesValidation) &#123;</div><div class="line">                log.warn(<span class="string">"  No rules found matching '"</span> + match + <span class="string">"'."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Recover the body text from the surrounding element</span></div><div class="line">        bodyText = bodyTexts.pop();</div><div class="line"></div><div class="line">        <span class="comment">// Fire "end" events for all relevant rules in reverse order</span></div><div class="line">        <span class="keyword">if</span> (rules != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">                <span class="keyword">int</span> j = (rules.size() - i) - <span class="number">1</span>;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Rule rule = rules.get(j);</div><div class="line">                    <span class="keyword">if</span> (debug) &#123;</div><div class="line">                        log.debug(<span class="string">"  Fire end() for "</span> + rule);</div><div class="line">                    &#125;</div><div class="line">                    rule.end(namespaceURI, name);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    log.error(<span class="string">"End event threw exception"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> createSAXException(e);</div><div class="line">                &#125; <span class="keyword">catch</span> (Error e) &#123;</div><div class="line">                    log.error(<span class="string">"End event threw error"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Recover the previous match expression</span></div><div class="line">        <span class="keyword">int</span> slash = match.lastIndexOf(<span class="string">'/'</span>);</div><div class="line">        <span class="keyword">if</span> (slash &gt;= <span class="number">0</span>) &#123;</div><div class="line">            match = match.substring(<span class="number">0</span>, slash);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            match = <span class="string">""</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>代码清单1中创建完Digester后，会调用addObjectCreate、addSetProperties、addSetNext方法陆续添加很多Rule，这些方法的实现如代码清单3：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObjectCreate</span><span class="params">(String pattern, String className,  </span></span></div><div class="line">                            String attributeName) &#123;  </div><div class="line">    addRule(pattern,  </div><div class="line">            <span class="keyword">new</span> ObjectCreateRule(className, attributeName));  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSetProperties</span><span class="params">(String pattern)</span> </span>&#123;  </div><div class="line">    addRule(pattern,  </div><div class="line">            <span class="keyword">new</span> SetPropertiesRule());  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSetNext</span><span class="params">(String pattern, String methodName,  </span></span></div><div class="line">                       String paramType) &#123;  </div><div class="line">    addRule(pattern,  </div><div class="line">            <span class="keyword">new</span> SetNextRule(methodName, paramType));  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上述代码我们看到这三个方法分别创建ObjectCreateRule、SetPropertiesRule及SetNextRule。为了简化理解我们以Server相关的Rule为例，在createStartDigester中，如代码清单4：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">digester.addObjectCreate(<span class="string">"Server"</span>,  </div><div class="line">                         <span class="string">"org.apache.catalina.core.StandardServer"</span>,  </div><div class="line">                         <span class="string">"className"</span>);  </div><div class="line">digester.addSetProperties(<span class="string">"Server"</span>);  </div><div class="line">digester.addSetNext(<span class="string">"Server"</span>,  </div><div class="line">                    <span class="string">"setServer"</span>,  </div><div class="line">                    <span class="string">"org.apache.catalina.Server"</span>);</div></pre></td></tr></table></figure>
<p>根据代码清单3的实现，我们知道最终会创建ObjectCreateRule、SetPropertiesRule及SetNextRule，并且调用addRule方法。addRule方法首先调用getRules方法获取RulesBase，然后调用RulesBase的add方法。addRule方法的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRule</span><span class="params">(String pattern, Rule rule)</span> </span>&#123;  </div><div class="line">  </div><div class="line">    rule.setDigester(<span class="keyword">this</span>);  </div><div class="line">    getRules().add(pattern, rule);  </div><div class="line">  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">public</span> Rules <span class="title">getRules</span><span class="params">()</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.rules == <span class="keyword">null</span>) &#123;  </div><div class="line">        <span class="keyword">this</span>.rules = <span class="keyword">new</span> RulesBase();  </div><div class="line">        <span class="keyword">this</span>.rules.setDigester(<span class="keyword">this</span>);  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.rules);  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>RulesBase的add方法的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Register a new Rule instance matching the specified pattern.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> pattern Nesting pattern to be matched for this Rule</div><div class="line">     * <span class="doctag">@param</span> rule Rule instance to be registered</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String pattern, Rule rule)</span> </span>&#123;</div><div class="line">        <span class="comment">// to help users who accidently add '/' to the end of their patterns</span></div><div class="line">        <span class="keyword">int</span> patternLength = pattern.length();</div><div class="line">        <span class="keyword">if</span> (patternLength&gt;<span class="number">1</span> &amp;&amp; pattern.endsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">            pattern = pattern.substring(<span class="number">0</span>, patternLength-<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        List&lt;Rule&gt; list = cache.get(pattern);</div><div class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</div><div class="line">            list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            cache.put(pattern, list);</div><div class="line">        &#125;</div><div class="line">        list.add(rule);</div><div class="line">        rules.add(rule);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.digester != <span class="keyword">null</span>) &#123;</div><div class="line">            rule.setDigester(<span class="keyword">this</span>.digester);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.namespaceURI != <span class="keyword">null</span>) &#123;</div><div class="line">            rule.setNamespaceURI(<span class="keyword">this</span>.namespaceURI);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>其中，cache的数据结构为HashMap<string,list<rule>&gt;，每个键值维护一个List<rule>，由此可知，对Server标签来说，对应的Rule列表为ObjectCreateRule、SetPropertiesRule及SetNextRule。</rule></string,list<rule></p>
<p>Digester解析XML的入口是其parse方法，其处理步骤如下：</p>
<ol>
<li>创建XMLReader ；</li>
<li>使用XMLReader解析XML。</li>
</ol>
<p>parse方法的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">parse</span><span class="params">(InputSource input)</span> <span class="keyword">throws</span> IOException, SAXException </span>&#123;  </div><div class="line">  </div><div class="line">    configure();  </div><div class="line">    getXMLReader().parse(input);  </div><div class="line">    <span class="keyword">return</span> (root);  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getXMLReader方法调用getParser创建SAXParser ，然后调用SAXParser 的getXMLReader方法创建XMLReader ，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Return the XMLReader to be used for parsing the input document.</div><div class="line">     *</div><div class="line">     * FIX ME: there is a bug in JAXP/XERCES that prevent the use of a</div><div class="line">     * parser that contains a schema with a DTD.</div><div class="line">     * <span class="doctag">@exception</span> SAXException if no XMLReader can be instantiated</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> XMLReader <span class="title">getXMLReader</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (reader == <span class="keyword">null</span>) &#123;</div><div class="line">            reader = getParser().getXMLReader();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        reader.setDTDHandler(<span class="keyword">this</span>);</div><div class="line">        reader.setContentHandler(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (entityResolver == <span class="keyword">null</span>) &#123;</div><div class="line">            reader.setEntityResolver(<span class="keyword">this</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            reader.setEntityResolver(entityResolver);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        reader.setProperty(<span class="string">"http://xml.org/sax/properties/lexical-handler"</span>, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">        reader.setErrorHandler(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">return</span> reader;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>getParser方法调用getFactory方法创建SAXParserFactory，然后调用SAXParserFactory的newSAXParser方法创建SAXParser ，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> SAXParser <span class="title">getParser</span><span class="params">()</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="comment">// Return the parser we already created (if any)  </span></div><div class="line">    <span class="keyword">if</span> (parser != <span class="keyword">null</span>) &#123;  </div><div class="line">        <span class="keyword">return</span> (parser);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="comment">// Create a new parser  </span></div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        parser = getFactory().newSAXParser();  </div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </div><div class="line">        log.error(<span class="string">"Digester.getParser: "</span>, e);  </div><div class="line">        <span class="keyword">return</span> (<span class="keyword">null</span>);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">return</span> (parser);  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>getFactory方法使用SAX的API生成SAXParserFactory实例，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Return the SAXParserFactory we will use, creating one if necessary.</div><div class="line">     * <span class="doctag">@throws</span> ParserConfigurationException</div><div class="line">     * <span class="doctag">@throws</span> SAXNotSupportedException</div><div class="line">     * <span class="doctag">@throws</span> SAXNotRecognizedException</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> SAXParserFactory <span class="title">getFactory</span><span class="params">()</span> <span class="keyword">throws</span> SAXNotRecognizedException, SAXNotSupportedException,</span></div><div class="line">            ParserConfigurationException &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</div><div class="line">            factory = SAXParserFactory.newInstance();</div><div class="line"></div><div class="line">            factory.setNamespaceAware(namespaceAware);</div><div class="line">            <span class="comment">// Preserve xmlns attributes</span></div><div class="line">            <span class="keyword">if</span> (namespaceAware) &#123;</div><div class="line">                factory.setFeature(<span class="string">"http://xml.org/sax/features/namespace-prefixes"</span>, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            factory.setValidating(validating);</div><div class="line">            <span class="keyword">if</span> (validating) &#123;</div><div class="line">                <span class="comment">// Enable DTD validation</span></div><div class="line">                factory.setFeature(<span class="string">"http://xml.org/sax/features/validation"</span>, <span class="keyword">true</span>);</div><div class="line">                <span class="comment">// Enable schema validation</span></div><div class="line">                factory.setFeature(<span class="string">"http://apache.org/xml/features/validation/schema"</span>, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (factory);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>XMLReader解析XML时，会生成事件，回调Digester的startDocument方法，解析的第一个元素是Server，此时回调Digester的startElement方法，入参Attributes list即Server上的属性，如port、shutdown等，入参qName即为Server。startElement方法的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Process notification of the start of an XML element being reached.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> namespaceURI The Namespace URI, or the empty string if the element</div><div class="line">     *   has no Namespace URI or if Namespace processing is not being performed.</div><div class="line">     * <span class="doctag">@param</span> localName The local name (without prefix), or the empty</div><div class="line">     *   string if Namespace processing is not being performed.</div><div class="line">     * <span class="doctag">@param</span> qName The qualified name (with prefix), or the empty</div><div class="line">     *   string if qualified names are not available.\</div><div class="line">     * <span class="doctag">@param</span> list The attributes attached to the element. If there are</div><div class="line">     *   no attributes, it shall be an empty Attributes object.</div><div class="line">     * <span class="doctag">@exception</span> SAXException if a parsing error is to be reported</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String namespaceURI, String localName, String qName, Attributes list)</span></span></div><div class="line">            <span class="keyword">throws</span> SAXException &#123;</div><div class="line">        <span class="keyword">boolean</span> debug = log.isDebugEnabled();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (saxLog.isDebugEnabled()) &#123;</div><div class="line">            saxLog.debug(<span class="string">"startElement("</span> + namespaceURI + <span class="string">","</span> + localName + <span class="string">","</span> + qName + <span class="string">")"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Parse system properties</span></div><div class="line">        list = updateAttributes(list);</div><div class="line"></div><div class="line">        <span class="comment">// Save the body text accumulated for our surrounding element</span></div><div class="line">        bodyTexts.push(bodyText);</div><div class="line">        bodyText = <span class="keyword">new</span> StringBuilder();</div><div class="line"></div><div class="line">        <span class="comment">// the actual element name is either in localName or qName, depending</span></div><div class="line">        <span class="comment">// on whether the parser is namespace aware</span></div><div class="line">        String name = localName;</div><div class="line">        <span class="keyword">if</span> ((name == <span class="keyword">null</span>) || (name.length() &lt; <span class="number">1</span>)) &#123;</div><div class="line">            name = qName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Compute the current matching rule</span></div><div class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder(match);</div><div class="line">        <span class="keyword">if</span> (match.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">            sb.append(<span class="string">'/'</span>);</div><div class="line">        &#125;</div><div class="line">        sb.append(name);</div><div class="line">        match = sb.toString();</div><div class="line">        <span class="keyword">if</span> (debug) &#123;</div><div class="line">            log.debug(<span class="string">"  New match='"</span> + match + <span class="string">"'"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Fire "begin" events for all relevant rules</span></div><div class="line">        List&lt;Rule&gt; rules = getRules().match(namespaceURI, match);</div><div class="line">        matches.push(rules);</div><div class="line">        <span class="keyword">if</span> ((rules != <span class="keyword">null</span>) &amp;&amp; (rules.size() &gt; <span class="number">0</span>)) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rules.size(); i++) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Rule rule = rules.get(i);</div><div class="line">                    <span class="keyword">if</span> (debug) &#123;</div><div class="line">                        log.debug(<span class="string">"  Fire begin() for "</span> + rule);</div><div class="line">                    &#125;</div><div class="line">                    rule.begin(namespaceURI, name, list);</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    log.error(<span class="string">"Begin event threw exception"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> createSAXException(e);</div><div class="line">                &#125; <span class="keyword">catch</span> (Error e) &#123;</div><div class="line">                    log.error(<span class="string">"Begin event threw error"</span>, e);</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (debug) &#123;</div><div class="line">                log.debug(<span class="string">"  No rules found matching '"</span> + match + <span class="string">"'."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>startElement方法的处理步骤如下：</p>
<ol>
<li>match刚开始为空字符串，拼接Server后变为Server。</li>
<li>调用RulesBase的match方法，返回cache中按照键值Server匹配的ObjectCreateRule、SetPropertiesRule及SetNextRule。</li>
<li>循环列表依次遍历ObjectCreateRule、SetPropertiesRule及SetNextRule，并调用它们的begin方法。</li>
</ol>
<p>ObjectCreateRule的begin方法将生成Server的实例（默认为”org.apache.catalina.core.StandardServer”，用户可以通过给Server标签指定className使用其它Server实现），最后将Server的实例压入Digester的栈中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Process the beginning of this element.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> namespace the namespace URI of the matching element, or an</div><div class="line">     *   empty string if the parser is not namespace aware or the element has</div><div class="line">     *   no namespace</div><div class="line">     * <span class="doctag">@param</span> name the local name if the parser is namespace aware, or just</div><div class="line">     *   the element name otherwise</div><div class="line">     * <span class="doctag">@param</span> attributes The attribute list for this element</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String name, Attributes attributes)</span></span></div><div class="line">            <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Identify the name of the class to instantiate</span></div><div class="line">        String realClassName = className;</div><div class="line">        <span class="keyword">if</span> (attributeName != <span class="keyword">null</span>) &#123;</div><div class="line">            String value = attributes.getValue(attributeName);</div><div class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</div><div class="line">                realClassName = value;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</div><div class="line">            digester.log.debug(<span class="string">"[ObjectCreateRule]&#123;"</span> + digester.match +</div><div class="line">                    <span class="string">"&#125;New "</span> + realClassName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (realClassName == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"No class name specified for "</span> +</div><div class="line">                    namespace + <span class="string">" "</span> + name);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Instantiate the new object and push it on the context stack</span></div><div class="line">        Class&lt;?&gt; clazz = digester.getClassLoader().loadClass(realClassName);</div><div class="line">        Object instance = clazz.newInstance();</div><div class="line">        digester.push(instance);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>SetPropertiesRule的begin方法首先将刚才压入栈中的Server实例出栈，然后给Server实例设置各个属性值，如port、shutdown等，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Process the beginning of this element.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> namespace the namespace URI of the matching element, or an</div><div class="line">     *   empty string if the parser is not namespace aware or the element has</div><div class="line">     *   no namespace</div><div class="line">     * <span class="doctag">@param</span> theName the local name if the parser is namespace aware, or just</div><div class="line">     *   the element name otherwise</div><div class="line">     * <span class="doctag">@param</span> attributes The attribute list for this element</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String theName, Attributes attributes)</span></span></div><div class="line">            <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Populate the corresponding properties of the top object</span></div><div class="line">        Object top = digester.peek();</div><div class="line">        <span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</div><div class="line">            <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">                digester.log.debug(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</div><div class="line">                                   <span class="string">"&#125; Set "</span> + top.getClass().getName() +</div><div class="line">                                   <span class="string">" properties"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                digester.log.debug(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</div><div class="line">                                   <span class="string">"&#125; Set NULL properties"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</div><div class="line">            String name = attributes.getLocalName(i);</div><div class="line">            <span class="keyword">if</span> (<span class="string">""</span>.equals(name)) &#123;</div><div class="line">                name = attributes.getQName(i);</div><div class="line">            &#125;</div><div class="line">            String value = attributes.getValue(i);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (digester.log.isDebugEnabled()) &#123;</div><div class="line">                digester.log.debug(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</div><div class="line">                        <span class="string">"&#125; Setting property '"</span> + name + <span class="string">"' to '"</span> +</div><div class="line">                        value + <span class="string">"'"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!digester.isFakeAttribute(top, name)</div><div class="line">                    &amp;&amp; !IntrospectionUtils.setProperty(top, name, value)</div><div class="line">                    &amp;&amp; digester.getRulesValidation()) &#123;</div><div class="line">                digester.log.warn(<span class="string">"[SetPropertiesRule]&#123;"</span> + digester.match +</div><div class="line">                        <span class="string">"&#125; Setting property '"</span> + name + <span class="string">"' to '"</span> +</div><div class="line">                        value + <span class="string">"' did not find a matching property."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>SetNextRule的begin不做什么动作。当遇到Server的结束标签时，还会依次调用ObjectCreateRule、SetPropertiesRule及SetNextRule的end方法，不再赘述。所有元素的解析都与Server标签同理，最终将server.xml文件中设置的元素及其属性值，构造出Tomcat中的容器，如：Server、Service、Connector等。</p>
<p>致此，web.xml解析分析完毕。</p>
<h3 id="第三章-生命周期管理"><a href="#第三章-生命周期管理" class="headerlink" title="第三章 生命周期管理"></a>第三章 生命周期管理</h3><p>从server.xml文件解析出来的各个对象都是容器，比如：Server、Service、Connector等。这些容器都具有新建、初始化完成、启动、停止、失败、销毁等状态。Tomcat的实现提供了对这些容器的生命周期管理，本章将通过对Tomcat7.0的源码阅读，深入剖析这一过程。</p>
<h4 id="1-Tomcat生命周期类接口设计"><a href="#1-Tomcat生命周期类接口设计" class="headerlink" title="1.Tomcat生命周期类接口设计"></a>1.Tomcat生命周期类接口设计</h4><p>我们先阅读图（tomact7），从中了解Tomcat涉及生命周期管理的主要类。</p>
<p><img src="http://i.imgur.com/xmgOHR4.jpg" alt=""></p>
<p>针对图中主要类进行简单介绍：</p>
<ul>
<li>Lifecycle：定义了容器生命周期、容器状态转换及容器状态迁移事件的监听器注册和移除等主要接口；</li>
<li>LifecycleBase：作为Lifecycle接口的抽象实现类，运用抽象模板模式将所有容器的生命周期及状态转换衔接起来，此外还提供了生成LifecycleEvent事件的接口；</li>
<li>LifecycleSupport：提供有关LifecycleEvent事件的监听器注册、移除，并且使用经典的监听器模式，实现事件生成后触达监听器的实现；</li>
<li>MBeanRegistration：Java JMX框架提供的注册MBean的接口，引入此接口是为了便于使用JMX提供的管理功能；</li>
<li>LifecycleMBeanBase：Tomcat提供的对MBeanRegistration的抽象实现类，运用抽象模板模式将所有容器统一注册到JMX；</li>
</ul>
<p>lifecycle继承关系：<br><img src="http://i.imgur.com/PZsO3lD.png" alt=""></p>
<h4 id="2-JMX"><a href="#2-JMX" class="headerlink" title="2.JMX"></a>2.JMX</h4><p>简单介绍一下（细节请参考其他文献）。</p>
<p>java管理程序扩展（java management extensions，简称JMX），是一个可以为Java应用程序或系统植入远程管理功能的框架。JMX的架构，如图所示。</p>
<p><img src="http://i.imgur.com/J6nqmXU.jpg" alt=""></p>
<p>这里对三个分层进行介绍：</p>
<ul>
<li>Probe Level：负责资源的检测（获取信息），包含MBeans，通常也叫做Instrumentation Level。MX管理构件（MBean）分为四种形式，分别是标准管理构件（Standard MBean）、动态管理构件（Dynamic MBean）、开放管理构件(Open Mbean)和模型管理构件(Model MBean)。</li>
<li>Agent Level：即MBeanServer，是JMX的核心，负责连接Mbeans和应用程序。 </li>
<li>Remote Management Level：通过connectors和adaptors来远程操作MBeanServer，常用的控制台，例如JConsole、VisualVM等。</li>
</ul>
<h4 id="3-容器"><a href="#3-容器" class="headerlink" title="3.容器"></a>3.容器</h4><p>容器即servlet容器，容器有很多层，分别是Engine，Host，Context，Wrapper。最大的容器Engine，代表一个servlet 引擎，接下来是Host，代表一个虚拟机，然后是Context，代表一个应用，Wrapper对应一个servlet。从连接器传过来连接后，容器便会顺序经过上面的容器，最后到达特定的servlet。</p>
<p><img src="http://i.imgur.com/irZpmOV.png" alt=""></p>
<p>一个server可以有多个service，一个service包含多个连接器和一个容器，一个Engine可以由多个虚拟主机Host组成，每一个Host下面又可以由多个Web应用Context构成，每一个的Context下面可以包含多个Wrapper（Servlet的包装器）组成。如图所示</p>
<p><img src="http://i.imgur.com/TnOdb8R.png" alt=""></p>
<p>Tomcat将Engine，Host，Context，Wrapper统一抽象成Container。一个抽象的Container模块可以包含各种服务。例如，Manager管理器（Session管理），Pipeline管道（ 维护管道阀门Value ）等。Lifecycle接口统一定义了容器的生命周期，通过事件机制实现各个容器间的内部通讯。</p>
<p>而容器的核心接口Container的抽象实现中定义了一个Pipeline，一个Manager，一个Realm以及ClassLoader统一了具体容器的实现规范。</p>
<p><strong>容器的状态</strong>：</p>
<p>目前，Tomcat的容器具有以下状态：</p>
<ul>
<li>NEW：容器刚刚创建时，即在LifecycleBase实例构造完成时的状态。</li>
<li>INITIALIZED：容器初始化完成时的状态。</li>
<li>STARTING_PREP：容器启动前的状态。</li>
<li>STARTING：容器启动过程中的状态。</li>
<li>STARTED：容器启动完成的状态。</li>
<li>STOPPING_PREP：容器停止前的状态。</li>
<li>STOPPING：容器停止过程中的状态。</li>
<li>STOPPED：容器停止完成的状态。</li>
<li>DESTROYED：容器销毁后的状态。</li>
<li>FAILED：容器启动、停止过程中出现异常的状态。</li>
<li>MUST_STOP：此状态未使用。</li>
<li>MUST_DESTROY：此状态未使用。</li>
<li>这些状态都定义在枚举类LifecycleState中。代码如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LifecycleState &#123;</div><div class="line">    NEW(<span class="keyword">false</span>, <span class="keyword">null</span>),</div><div class="line">    INITIALIZING(<span class="keyword">false</span>, Lifecycle.BEFORE_INIT_EVENT),</div><div class="line">    INITIALIZED(<span class="keyword">false</span>, Lifecycle.AFTER_INIT_EVENT),</div><div class="line">    STARTING_PREP(<span class="keyword">false</span>, Lifecycle.BEFORE_START_EVENT),</div><div class="line">    STARTING(<span class="keyword">true</span>, Lifecycle.START_EVENT),</div><div class="line">    STARTED(<span class="keyword">true</span>, Lifecycle.AFTER_START_EVENT),</div><div class="line">    STOPPING_PREP(<span class="keyword">true</span>, Lifecycle.BEFORE_STOP_EVENT),</div><div class="line">    STOPPING(<span class="keyword">false</span>, Lifecycle.STOP_EVENT),</div><div class="line">    STOPPED(<span class="keyword">false</span>, Lifecycle.AFTER_STOP_EVENT),</div><div class="line">    DESTROYING(<span class="keyword">false</span>, Lifecycle.BEFORE_DESTROY_EVENT),</div><div class="line">    DESTROYED(<span class="keyword">false</span>, Lifecycle.AFTER_DESTROY_EVENT),</div><div class="line">    FAILED(<span class="keyword">false</span>, <span class="keyword">null</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@deprecated</span> Unused. Will be removed in Tomcat 8.5.x. The state transition</div><div class="line">     *             checking in &#123;<span class="doctag">@link</span> org.apache.catalina.util.LifecycleBase&#125;</div><div class="line">     *             makes it impossible to use this state. The intended behaviour</div><div class="line">     *             can be obtained by setting the state to</div><div class="line">     *             &#123;<span class="doctag">@link</span> LifecycleState#FAILED&#125; in</div><div class="line">     *             &lt;code&gt;LifecycleBase.startInternal()&lt;/code&gt;</div><div class="line">     */</div><div class="line">    <span class="meta">@Deprecated</span></div><div class="line">    MUST_STOP(<span class="keyword">true</span>, <span class="keyword">null</span>),</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@deprecated</span> Unused. Will be removed in Tomcat 8.5.x. The state transition</div><div class="line">     *             checking in &#123;<span class="doctag">@link</span> org.apache.catalina.util.LifecycleBase&#125;</div><div class="line">     *             makes it impossible to use this state. The intended behaviour</div><div class="line">     *             can be obtained by implementing &#123;<span class="doctag">@link</span> Lifecycle.SingleUse&#125;.</div><div class="line">     */</div><div class="line">    <span class="meta">@Deprecated</span></div><div class="line">    MUST_DESTROY(<span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> available;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String lifecycleEvent;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LifecycleState</span><span class="params">(<span class="keyword">boolean</span> available, String lifecycleEvent)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.available = available;</div><div class="line">        <span class="keyword">this</span>.lifecycleEvent = lifecycleEvent;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * May the public methods other than property getters/setters and lifecycle</div><div class="line">     * methods be called for a component in this state? It returns</div><div class="line">     * &lt;code&gt;true&lt;/code&gt; for any component in any of the following states:</div><div class="line">     * &lt;ul&gt;</div><div class="line">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #STARTING&#125;&lt;/li&gt;</div><div class="line">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #STARTED&#125;&lt;/li&gt;</div><div class="line">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #STOPPING_PREP&#125;&lt;/li&gt;</div><div class="line">     * &lt;li&gt;&#123;<span class="doctag">@link</span> #MUST_STOP&#125;&lt;/li&gt;</div><div class="line">     * &lt;/ul&gt;</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> available;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     *</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLifecycleEvent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> lifecycleEvent;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-事件与监听"><a href="#4-事件与监听" class="headerlink" title="4.事件与监听"></a>4.事件与监听</h4><p>lifecycle接口结构如下：<br><img src="http://i.imgur.com/J8zYMFU.png" alt=""></p>
<p>LifecycleBase实现lifecycle接口.结构如下：<br><img src="http://i.imgur.com/fpzneEf.png" alt=""></p>
<p>lifecycleListener继承关系示意图：<br><img src="http://i.imgur.com/1IqmqEH.png" alt=""></p>
<p>每个容器由于继承自LifecycleBase，当容器状态发生变化时，都会调用fireLifecycleEvent方法，生成LifecycleEvent，并且交由此容器的事件监听器处理。LifecycleBase的fireLifecycleEvent方法的实现见代码清单1。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Used to handle firing lifecycle events. </div><div class="line"> * <span class="doctag">TODO:</span> Consider merging LifecycleSupport into this class. </div><div class="line"> */  </div><div class="line"><span class="keyword">private</span> LifecycleSupport lifecycle = <span class="keyword">new</span> LifecycleSupport(<span class="keyword">this</span>);  </div><div class="line"></div><div class="line"><span class="comment">//中间代码略</span></div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Allow sub classes to fire &#123;<span class="doctag">@link</span> Lifecycle&#125; events.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> type  Event type</div><div class="line">    * <span class="doctag">@param</span> data  Data associated with event.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</div><div class="line">       lifecycle.fireLifecycleEvent(type, data);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>LifecycleSupport的fireLifecycleEvent方法的实现，见代码清单2。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Notify all lifecycle event listeners that a particular event has</div><div class="line"> * occurred for this Container.  The default implementation performs</div><div class="line"> * this notification synchronously using the calling thread.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> type Event type</div><div class="line"> * <span class="doctag">@param</span> data Event data</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</div><div class="line">    LifecycleEvent event = <span class="keyword">new</span> LifecycleEvent(lifecycle, type, data);</div><div class="line">    <span class="keyword">for</span> (LifecycleListener listener : listeners) &#123;</div><div class="line">        listener.lifecycleEvent(event);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将事件通知给所有监听当前容器的生命周期监听器LifecycleListener，并调用LifecycleListener的lifecycleEvent方法。每个容器都维护这一个监听器缓存，其实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * The list of registered LifecycleListeners for event notifications.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;LifecycleListener&gt; listeners = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div></pre></td></tr></table></figure>
<p>那么listeners中的监听器是何时添加进来的呢？每个容器在新建、初始化、启动，销毁，被添加到父容器的过程中都会调用父类LifecycleBase的addLifecycleListener方法，addLifecycleListener的实现见代码清单3。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * &#123;<span class="doctag">@inheritDoc</span>&#125;</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line">    lifecycle.addLifecycleListener(listener);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LifecycleSupport的addLifecycleListener方法的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Add a lifecycle event listener to this component.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> listener The listener to add</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line">    listeners.add(listener);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在fireLifecycleEvent中，我们讲过容器会最终调用每个对此容器感兴趣的LifecycleListener的lifecycleEvent方法，那么LifecycleListener的lifecycleEvent方法会做些什么呢？为了简单起见，我们以监听器AprLifecycleListener为例AprLifecycleListener的lifecycleEvent方法的实现，间见如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Primary entry point for startup and shutdown events.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> event The event that has occurred</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (Lifecycle.BEFORE_INIT_EVENT.equals(event.getType())) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">                init();</div><div class="line">                <span class="keyword">for</span> (String msg : initInfoLogMessages) &#123;</div><div class="line">                    log.info(msg);</div><div class="line">                &#125;</div><div class="line">                initInfoLogMessages.clear();</div><div class="line">                <span class="keyword">if</span> (aprAvailable) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        initializeSSL();</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                        t = ExceptionUtils.unwrapInvocationTargetException(t);</div><div class="line">                        ExceptionUtils.handleThrowable(t);</div><div class="line">                        log.error(sm.getString(<span class="string">"aprListener.sslInit"</span>), t);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Failure to initialize FIPS mode is fatal</span></div><div class="line">                <span class="keyword">if</span> (!(<span class="keyword">null</span> == FIPSMode || <span class="string">"off"</span>.equalsIgnoreCase(FIPSMode)) &amp;&amp; !isFIPSModeActive()) &#123;</div><div class="line">                    Error e = <span class="keyword">new</span> Error(</div><div class="line">                            sm.getString(<span class="string">"aprListener.initializeFIPSFailed"</span>));</div><div class="line">                    <span class="comment">// Log here, because thrown error might be not logged</span></div><div class="line">                    log.fatal(e.getMessage(), e);</div><div class="line">                    <span class="keyword">throw</span> e;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Lifecycle.AFTER_DESTROY_EVENT.equals(event.getType())) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">                <span class="keyword">if</span> (!aprAvailable) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    terminateAPR();</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    t = ExceptionUtils.unwrapInvocationTargetException(t);</div><div class="line">                    ExceptionUtils.handleThrowable(t);</div><div class="line">                    log.info(sm.getString(<span class="string">"aprListener.aprDestroy"</span>));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="5-容器生命周期"><a href="#5-容器生命周期" class="headerlink" title="5.容器生命周期"></a>5.容器生命周期</h4><p>每个容器都会有自身的生命周期，其中也涉及状态的迁移，以及伴随的事件生成，本节详细介绍Tomcat中的容器生命周期实现。所有容器的转态转换（如新疆、初始化、启动、停止等）都是由外到内，由上到下进行，即先执行父容器的状态转换及相关操作，然后再执行子容器的转态转换，这个过程是层层迭代执行的。</p>
<h5 id="容器初始化"><a href="#容器初始化" class="headerlink" title="容器初始化"></a><strong>容器初始化</strong></h5><p>每个容器的init方法是自身初始化的入口，其初始化过程如图所示。</p>
<p><img src="http://i.imgur.com/ZU9Cikh.jpg" alt=""></p>
<p>根据图所示的初始化过程，我们对Tomcat的源码进行分析，其处理步骤如下：</p>
<ol>
<li>调用方调用容器父类LifecycleBase的init方法，LifecycleBase的init方法主要完成一些所有容器公共抽象出来的动作；</li>
<li>LifecycleBase的init方法调用具体容器的initInternal方法实现，此initInternal方法用于对容器本身真正的初始化；</li>
<li>具体容器的initInternal方法调用父类LifecycleMBeanBase的initInternal方法实现，此initInternal方法用于将容器托管到JMX，便于运维管理；</li>
<li>LifecycleMBeanBase的initInternal方法调用自身的register方法，将容器作为MBean注册到MBeanServer；</li>
<li>容器如果有子容器，会调用子容器的init方法；</li>
<li>容器初始化完毕，LifecycleBase会将容器的状态更改为初始化完毕，即LifecycleState.INITIALIZED。</li>
</ol>
<p>init()方法实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!state.equals(LifecycleState.NEW)) &#123;</div><div class="line">            invalidTransition(Lifecycle.BEFORE_INIT_EVENT);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            setStateInternal(LifecycleState.INITIALIZING, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            initInternal();</div><div class="line">            setStateInternal(LifecycleState.INITIALIZED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(t);</div><div class="line">            setStateInternal(LifecycleState.FAILED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</div><div class="line">                    sm.getString(<span class="string">"lifecycleBase.initFail"</span>,toString()), t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>上述代码说明，只有当前容器的状态处于LifecycleState.NEW的才可以被初始化，真正执行初始化的方法是initInternal，当初始化完毕，当前容器的状态会被更改为LifecycleState.INITIALIZED。为了简便起见，我们还是以StandardServer这个容器为例，StandardServer的initInternal方法的实现见代码清单7。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Invoke a pre-startup initialization. This is used to allow connectors</div><div class="line">     * to bind to restricted ports under Unix operating environments.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.initInternal();</div><div class="line"></div><div class="line">        <span class="comment">// Register global String cache</span></div><div class="line">        <span class="comment">// Note although the cache is global, if there are multiple Servers</span></div><div class="line">        <span class="comment">// present in the JVM (may happen when embedding) then the same cache</span></div><div class="line">        <span class="comment">// will be registered under multiple names</span></div><div class="line">        onameStringCache = register(<span class="keyword">new</span> StringCache(), <span class="string">"type=StringCache"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Register the MBeanFactory</span></div><div class="line">        MBeanFactory factory = <span class="keyword">new</span> MBeanFactory();</div><div class="line">        factory.setContainer(<span class="keyword">this</span>);</div><div class="line">        onameMBeanFactory = register(factory, <span class="string">"type=MBeanFactory"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// Register the naming resources</span></div><div class="line">        globalNamingResources.init();</div><div class="line"></div><div class="line">        <span class="comment">// Populate the extension validator with JARs from common and shared</span></div><div class="line">        <span class="comment">// class loaders</span></div><div class="line">        <span class="keyword">if</span> (getCatalina() != <span class="keyword">null</span>) &#123;</div><div class="line">            ClassLoader cl = getCatalinal().getParentClassLoader();</div><div class="line">            <span class="comment">// Walk the class loader hierarchy. Stop at the system class loader.</span></div><div class="line">            <span class="comment">// This will add the shared (if present) and common class loaders</span></div><div class="line">            <span class="keyword">while</span> (cl != <span class="keyword">null</span> &amp;&amp; cl != ClassLoader.getSystemClassLoader()) &#123;</div><div class="line">                <span class="keyword">if</span> (cl <span class="keyword">instanceof</span> URLClassLoader) &#123;</div><div class="line">                    URL[] urls = ((URLClassLoader) cl).getURLs();</div><div class="line">                    <span class="keyword">for</span> (URL url : urls) &#123;</div><div class="line">                        <span class="keyword">if</span> (url.getProtocol().equals(<span class="string">"file"</span>)) &#123;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                File f = <span class="keyword">new</span> File (url.toURI());</div><div class="line">                                <span class="keyword">if</span> (f.isFile() &amp;&amp;</div><div class="line">                                        f.getName().endsWith(<span class="string">".jar"</span>)) &#123;</div><div class="line">                                    ExtensionValidator.addSystemResource(f);</div><div class="line">                                &#125;</div><div class="line">                            &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</div><div class="line">                                <span class="comment">// Ignore</span></div><div class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                                <span class="comment">// Ignore</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                cl = cl.getParent();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Initialize our defined Services</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">            services[i].init();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>通过分析StandardServer的initInternal方法，其处理过程如下：</p>
<ol>
<li><p>将当前容器注册到JMX<br>调用父类LifecycleBase的initInternal方法（见代码清单8），为当前容器创建DynamicMBean，并注册到JMX中。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;  </div><div class="line">      </div><div class="line">    <span class="comment">// If oname is not null then registration has already happened via jiaan  </span></div><div class="line">    <span class="comment">// preRegister().  </span></div><div class="line">    <span class="keyword">if</span> (oname == <span class="keyword">null</span>) &#123;  </div><div class="line">        mserver = Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).getMBeanServer();  </div><div class="line">          </div><div class="line">        oname = register(<span class="keyword">this</span>, getObjectNameKeyProperties());  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> String <span class="title">getObjectNameKeyProperties</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">return</span> <span class="string">"type=Server"</span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>LifecycleBase的register方法会为当前容器创建对应的注册名称，以StandardServer为例，getDomain默认返回Catalina，因此StandardServer的JMX注册名称默认为Catalina:type=Server，真正的注册在registerComponent方法中实现。

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> ObjectName <span class="title">register</span><span class="params">(Object obj,  </span></span></div><div class="line">        String objectNameKeyProperties) &#123;  </div><div class="line">      </div><div class="line">    <span class="comment">// Construct an object name with the right domain  </span></div><div class="line">    StringBuilder name = <span class="keyword">new</span> StringBuilder(getDomain());  </div><div class="line">    name.append(<span class="string">':'</span>);  </div><div class="line">    name.append(objectNameKeyProperties);  </div><div class="line">  </div><div class="line">    ObjectName on = <span class="keyword">null</span>;  </div><div class="line">  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        on = <span class="keyword">new</span> ObjectName(name.toString());  </div><div class="line">          </div><div class="line">        Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(obj, on, <span class="keyword">null</span>);  </div><div class="line">    &#125; <span class="keyword">catch</span> (MalformedObjectNameException e) &#123;  </div><div class="line">        log.warn(sm.getString(<span class="string">"lifecycleMBeanBase.registerFail"</span>, obj, name),  </div><div class="line">                e);  </div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </div><div class="line">        log.warn(sm.getString(<span class="string">"lifecycleMBeanBase.registerFail"</span>, obj, name),  </div><div class="line">                e);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">return</span> on;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>

Registry的registerComponent方法会为当前容器（如StandardServer）创建DynamicMBean，并且注册到MBeanServer，见代码。

<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Register a component  </span></div><div class="line"> * XXX make it private  </div><div class="line"> *  </div><div class="line"> * <span class="doctag">@param</span> bean </div><div class="line"> * <span class="doctag">@param</span> oname </div><div class="line"> * <span class="doctag">@param</span> type </div><div class="line"> * <span class="doctag">@throws</span> Exception </div><div class="line"> */   </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerComponent</span><span class="params">(Object bean, ObjectName oname, String type)</span>  </span></div><div class="line">       <span class="keyword">throws</span> Exception  </div><div class="line">&#123;  </div><div class="line">    <span class="keyword">if</span>( log.isDebugEnabled() ) &#123;  </div><div class="line">        log.debug( <span class="string">"Managed= "</span>+ oname);  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">if</span>( bean ==<span class="keyword">null</span> ) &#123;  </div><div class="line">        log.error(<span class="string">"Null component "</span> + oname );  </div><div class="line">        <span class="keyword">return</span>;  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        <span class="keyword">if</span>( type==<span class="keyword">null</span> ) &#123;  </div><div class="line">            type=bean.getClass().getName();  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        ManagedBean managed = findManagedBean(bean.getClass(), type);  </div><div class="line">  </div><div class="line">        <span class="comment">// The real mbean is created and registered  </span></div><div class="line">        DynamicMBean mbean = managed.createMBean(bean);  </div><div class="line">  </div><div class="line">        <span class="keyword">if</span>(  getMBeanServer().isRegistered( oname )) &#123;  </div><div class="line">            <span class="keyword">if</span>( log.isDebugEnabled()) &#123;  </div><div class="line">                log.debug(<span class="string">"Unregistering existing component "</span> + oname );  </div><div class="line">            &#125;  </div><div class="line">            getMBeanServer().unregisterMBean( oname );  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        getMBeanServer().registerMBean( mbean, oname);  </div><div class="line">    &#125; <span class="keyword">catch</span>( Exception ex) &#123;  </div><div class="line">        log.error(<span class="string">"Error registering "</span> + oname, ex );  </div><div class="line">        <span class="keyword">throw</span> ex;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>将StringCache、MBeanFactory、globalNamingResources注册到JMX</p>
<p> 从代码清单7中已经列出。其中StringCache的注册名为Catalina:type=StringCache，MBeanFactory的注册名为Catalina:type=MBeanFactory，globalNamingResources的注册名为Catalina:type=NamingResources。</p>
</li>
<li><p>初始化子容器</p>
<p> 从代码清单7中看到StandardServer主要对Service子容器进行初始化，默认是StandardService。注意：个别容器并不完全遵循以上的初始化过程，比如ProtocolHandler作为Connector的子容器，其初始化过程并不是由Connector的initInternal方法调用的，而是与启动过程一道被Connector的startInternal方法所调用。</p>
</li>
</ol>
<h5 id="容器启动"><a href="#容器启动" class="headerlink" title="容器启动"></a><strong>容器启动</strong></h5><p>每个容器的start方法是自身启动的入口，其启动过程如图6所示。</p>
<p><img src="http://i.imgur.com/ss0j9ut.jpg" alt=""></p>
<p>根据图所示的启动过程，我们对Tomcat的源码进行分析，其处理步骤如下：</p>
<ol>
<li>调用方调用容器父类LifecycleBase的start方法，LifecycleBase的start方法主要完成一些所有容器公共抽象出来的动作；</li>
<li>LifecycleBase的start方法先将容器状态改为LifecycleState.STARTING_PREP，然后调用具体容器的startInternal方法实现，此startInternal方法用于对容器本身真正的初始化；</li>
<li>具体容器的startInternal方法会将容器状态改为LifecycleState.STARTING，容器如果有子容器，会调用子容器的start方法启动子容器；</li>
<li>容器启动完毕，LifecycleBase会将容器的状态更改为启动完毕，即LifecycleState.STARTED。</li>
</ol>
<p>LifecycleBase的start方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (LifecycleState.STARTING_PREP.equals(state) || LifecycleState.STARTING.equals(state) ||</div><div class="line">                LifecycleState.STARTED.equals(state)) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                Exception e = <span class="keyword">new</span> LifecycleException();</div><div class="line">                log.debug(sm.getString(<span class="string">"lifecycleBase.alreadyStarted"</span>, toString()), e);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</div><div class="line">                log.info(sm.getString(<span class="string">"lifecycleBase.alreadyStarted"</span>, toString()));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (state.equals(LifecycleState.NEW)) &#123;</div><div class="line">            init();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state.equals(LifecycleState.FAILED)) &#123;</div><div class="line">            stop();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!state.equals(LifecycleState.INITIALIZED) &amp;&amp;</div><div class="line">                !state.equals(LifecycleState.STOPPED)) &#123;</div><div class="line">            invalidTransition(Lifecycle.BEFORE_START_EVENT);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            setStateInternal(LifecycleState.STARTING_PREP, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            startInternal();</div><div class="line">            <span class="keyword">if</span> (state.equals(LifecycleState.FAILED)) &#123;</div><div class="line">                <span class="comment">// This is a 'controlled' failure. The component put itself into the</span></div><div class="line">                <span class="comment">// FAILED state so call stop() to complete the clean-up.</span></div><div class="line">                stop();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!state.equals(LifecycleState.STARTING)) &#123;</div><div class="line">                <span class="comment">// Shouldn't be necessary but acts as a check that sub-classes are</span></div><div class="line">                <span class="comment">// doing what they are supposed to.</span></div><div class="line">                invalidTransition(Lifecycle.AFTER_START_EVENT);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                setStateInternal(LifecycleState.STARTED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="comment">// This is an 'uncontrolled' failure so put the component into the</span></div><div class="line">            <span class="comment">// FAILED state and throw an exception.</span></div><div class="line">            ExceptionUtils.handleThrowable(t);</div><div class="line">            setStateInternal(LifecycleState.FAILED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(sm.getString(<span class="string">"lifecycleBase.startFail"</span>, toString()), t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上述代码说明：</p>
<ol>
<li>如果当前容器已经处于启动过程（即容器状态为LifecycleState.STARTING_PREP、LifecycleState.STARTING、LifecycleState.STARTED）中，则会产生并且用日志记录LifecycleException异常并退出。</li>
<li>如果容器依然处于LifecycleState.NEW状态，则在启动之前，首先确保初始化完毕</li>
<li>如果容器启动异常导致容器进入LifecycleState.FAILED或者LifecycleState.MUST_STOP状态，则需要调用stop方法停止容器。</li>
</ol>
<p>现在我们重点分析startInternal方法，还是以StandardServer为例，其startInternal的实现见代码所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        fireLifecycleEvent(CONFIGURE_START_EVENT, <span class="keyword">null</span>);</div><div class="line">        setState(LifecycleState.STARTING);</div><div class="line"></div><div class="line">        globalNamingResources.start();</div><div class="line"></div><div class="line">        <span class="comment">// Start our defined Services</span></div><div class="line">        <span class="keyword">synchronized</span> (servicesLock) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; services.length; i++) &#123;</div><div class="line">                services[i].start();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上述代码看到StandardServer的启动由以下步骤组成：</p>
<ol>
<li>产生CONFIGURE_START_EVENT事件；</li>
<li>将自身状态更改为LifecycleState.STARTING；</li>
<li>调用子容器Service（默认为StandardService）的start方法启动子容器。</li>
</ol>
<p>除了初始化、启动外，各个容器还有停止和销毁的生命周期，其原理与初始化、启动类似，本文不再赘述，有兴趣的读者可以自行研究。</p>
<h4 id="本章总结"><a href="#本章总结" class="headerlink" title="本章总结"></a>本章总结</h4><p>Tomcat通过将内部所有组件都抽象为容器，为容器提供统一的生命周期管理，各个子容器只需要关心各自的具体实现，这便于Tomcat以后扩展更多的容器，对于研究或者学习Tomcat的人来说，其设计清晰易懂。</p>
<h3 id="第四章-tomact的启动"><a href="#第四章-tomact的启动" class="headerlink" title="第四章 tomact的启动"></a>第四章 tomact的启动</h3><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>熟悉Tomcat的工程师们，肯定都知道Tomcat是如何启动与停止的。对于startup.sh、startup.bat、shutdown.sh、shutdown.bat等脚本或者批处理命令，大家一定知道改如何使用它，但是它们究竟是如何实现的？</p>
<p>startup.sh启动：<br><img src="http://i.imgur.com/qhuaBiA.png" alt=""></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">os400=false</div><div class="line">case "`uname`" in</div><div class="line">OS400*) os400=true;;</div><div class="line">esac</div><div class="line"></div><div class="line"># resolve links - $0 may be a softlink</div><div class="line">PRG="$0"</div><div class="line"></div><div class="line">while [ -h "$PRG" ] ; do</div><div class="line">  ls=`ls -ld "$PRG"`</div><div class="line">  link=`expr "$ls" : '.*-&gt; \(.*\)$'`</div><div class="line">  if expr "$link" : '/.*' &gt; /dev/null; then</div><div class="line">    PRG="$link"</div><div class="line">  else</div><div class="line">    PRG=`dirname "$PRG"`/"$link"</div><div class="line">  fi</div><div class="line">done</div><div class="line"></div><div class="line">PRGDIR=`dirname "$PRG"`</div><div class="line">EXECUTABLE=catalina.sh</div><div class="line"></div><div class="line"># Check that target executable exists</div><div class="line">if $os400; then</div><div class="line">  # -x will Only work on the os400 if the files are:</div><div class="line">  # 1. owned by the user</div><div class="line">  # 2. owned by the PRIMARY group of the user</div><div class="line">  # this will not work if the user belongs in secondary groups</div><div class="line">  eval</div><div class="line">else</div><div class="line">  if [ ! -x "$PRGDIR"/"$EXECUTABLE" ]; then</div><div class="line">    echo "Cannot find $PRGDIR/$EXECUTABLE"</div><div class="line">    echo "The file is absent or does not have execute permission"</div><div class="line">    echo "This file is needed to run this program"</div><div class="line">    exit 1</div><div class="line">  fi</div><div class="line">fi</div><div class="line"></div><div class="line">exec "$PRGDIR"/"$EXECUTABLE" start "$@"</div></pre></td></tr></table></figure>
<p>由上述脚本得知，执行脚本catalina.sh。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">elif [ "$1" = "start" ] ; then  </div><div class="line">  </div><div class="line"># 此处省略参数校验的脚本  </div><div class="line">  </div><div class="line">shift  </div><div class="line">touch "$CATALINA_OUT"  </div><div class="line">if [ "$1" = "-security" ] ; then  </div><div class="line">  if [ $have_tty -eq 1 ]; then  </div><div class="line">    echo "Using Security Manager"  </div><div class="line">  fi  </div><div class="line">  shift  </div><div class="line">  eval "\"$_RUNJAVA\"" "\"$LOGGING_CONFIG\"" $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \  </div><div class="line">    -Djava.endorsed.dirs="\"$JAVA_ENDORSED_DIRS\"" -classpath "\"$CLASSPATH\"" \  </div><div class="line">    -Djava.security.manager \  </div><div class="line">    -Djava.security.policy=="\"$CATALINA_BASE/conf/catalina.policy\"" \  </div><div class="line">    -Dcatalina.base="\"$CATALINA_BASE\"" \  </div><div class="line">    -Dcatalina.home="\"$CATALINA_HOME\"" \  </div><div class="line">    -Djava.io.tmpdir="\"$CATALINA_TMPDIR\"" \  </div><div class="line">    org.apache.catalina.startup.Bootstrap "$@" start \  </div><div class="line">    &gt;&gt; "$CATALINA_OUT" 2&gt;&amp;1 "&amp;"  </div><div class="line">  </div><div class="line">else  </div><div class="line">  eval "\"$_RUNJAVA\"" "\"$LOGGING_CONFIG\"" $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \  </div><div class="line">    -Djava.endorsed.dirs="\"$JAVA_ENDORSED_DIRS\"" -classpath "\"$CLASSPATH\"" \  </div><div class="line">    -Dcatalina.base="\"$CATALINA_BASE\"" \  </div><div class="line">    -Dcatalina.home="\"$CATALINA_HOME\"" \  </div><div class="line">    -Djava.io.tmpdir="\"$CATALINA_TMPDIR\"" \  </div><div class="line">    org.apache.catalina.startup.Bootstrap "$@" start \  </div><div class="line">    &gt;&gt; "$CATALINA_OUT" 2&gt;&amp;1 "&amp;"  </div><div class="line">  </div><div class="line">fi  </div><div class="line">  </div><div class="line">if [ ! -z "$CATALINA_PID" ]; then  </div><div class="line">  echo $! &gt; "$CATALINA_PID"  </div><div class="line">fi  </div><div class="line">  </div><div class="line">echo "Tomcat started."</div></pre></td></tr></table></figure>
<p>从代码清单2可以看出，最终使用Java命令执行了org.apache.catalina.startup.Bootstrap类中的main方法，参数也是start。Bootstrap的main方法的实现见代码清单3.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Main method and entry point when starting Tomcat via the provided</div><div class="line">     * scripts.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> args Command line arguments to be processed</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (daemon == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Don't set daemon until init() has completed</span></div><div class="line">            Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                bootstrap.init();</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                handleThrowable(t);</div><div class="line">                t.printStackTrace();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            daemon = bootstrap;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// When running as a service the call to stop will be on a new</span></div><div class="line">            <span class="comment">// thread so make sure the correct class loader is used to prevent</span></div><div class="line">            <span class="comment">// a range of class not found exceptions.</span></div><div class="line">            Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String command = <span class="string">"start"</span>;</div><div class="line">            <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                command = args[args.length - <span class="number">1</span>];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (command.equals(<span class="string">"startd"</span>)) &#123;</div><div class="line">                args[args.length - <span class="number">1</span>] = <span class="string">"start"</span>;</div><div class="line">                daemon.load(args);</div><div class="line">                daemon.start();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stopd"</span>)) &#123;</div><div class="line">                args[args.length - <span class="number">1</span>] = <span class="string">"stop"</span>;</div><div class="line">                daemon.stop();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"start"</span>)) &#123;</div><div class="line">                daemon.setAwait(<span class="keyword">true</span>);</div><div class="line">                daemon.load(args);</div><div class="line">                daemon.start();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stop"</span>)) &#123;</div><div class="line">                daemon.stopServer(args);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"configtest"</span>)) &#123;</div><div class="line">                daemon.load(args);</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">null</span>==daemon.getServer()) &#123;</div><div class="line">                    System.exit(<span class="number">1</span>);</div><div class="line">                &#125;</div><div class="line">                System.exit(<span class="number">0</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                log.warn(<span class="string">"Bootstrap: command \""</span> + command + <span class="string">"\" does not exist."</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="comment">// Unwrap the Exception for clearer error reporting</span></div><div class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException &amp;&amp;</div><div class="line">                    t.getCause() != <span class="keyword">null</span>) &#123;</div><div class="line">                t = t.getCause();</div><div class="line">            &#125;</div><div class="line">            handleThrowable(t);</div><div class="line">            t.printStackTrace();</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从代码清单3可以看出，当传递参数start的时候，command等于start. 启动tomact</p>
<p>main方法主要执行以下步骤：</p>
<ol>
<li>初始化Bootstrap <code>bootstrap.init();</code></li>
<li>加载、解析server.xml配置文件 <code>daemon.load(args);</code></li>
<li>启动tomact <code>daemon.start();</code></li>
</ol>
<p>以下分别来详细分析三个步骤</p>
<h5 id="步骤一-初始化Bootstrap"><a href="#步骤一-初始化Bootstrap" class="headerlink" title="步骤一 初始化Bootstrap"></a>步骤一 初始化Bootstrap</h5><p>bootstrap.init执行过程如下：</p>
<ol>
<li><code>Bootstrap bootstrap = new Bootstrap();</code>构造一个bootstrap对象，会执行静态代码块，来初始化路径。</li>
<li>初始化Tomcat的类加载器，并设置线程上下文类加载器（参照第一章）</li>
<li>用反射实例化org.apache.catalina.startup.Catalina对象，并且使用反射调用其setParentClassLoader方法，给Catalina对象设置Tomcat类加载体系的顶级加载器（Java自带的三种类加载器除外）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        initClassLoaders();</div><div class="line"></div><div class="line">        Thread.currentThread().setContextClassLoader(catalinaLoader);</div><div class="line"></div><div class="line">        SecurityClassLoad.securityClassLoad(catalinaLoader);</div><div class="line"></div><div class="line">        <span class="comment">// Load our startup class and call its process() method</span></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">            log.debug(<span class="string">"Loading startup class"</span>);</div><div class="line">        Class&lt;?&gt; startupClass =</div><div class="line">            catalinaLoader.loadClass</div><div class="line">            (<span class="string">"org.apache.catalina.startup.Catalina"</span>);</div><div class="line">        Object startupInstance = startupClass.newInstance();</div><div class="line"></div><div class="line">        <span class="comment">// Set the shared extensions class loader</span></div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">            log.debug(<span class="string">"Setting startup class properties"</span>);</div><div class="line">        String methodName = <span class="string">"setParentClassLoader"</span>;</div><div class="line">        Class&lt;?&gt; paramTypes[] = <span class="keyword">new</span> Class[<span class="number">1</span>];</div><div class="line">        paramTypes[<span class="number">0</span>] = Class.forName(<span class="string">"java.lang.ClassLoader"</span>);</div><div class="line">        Object paramValues[] = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">        paramValues[<span class="number">0</span>] = sharedLoader;</div><div class="line">        Method method =</div><div class="line">            startupInstance.getClass().getMethod(methodName, paramTypes);</div><div class="line">        method.invoke(startupInstance, paramValues);</div><div class="line"></div><div class="line">        catalinaDaemon = startupInstance;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h5 id="步骤二-加载、解析server-xml配置文件"><a href="#步骤二-加载、解析server-xml配置文件" class="headerlink" title="步骤二 加载、解析server.xml配置文件"></a>步骤二 加载、解析server.xml配置文件</h5><p>当传递参数start的时候，会调用Bootstrap的load方法（见代码清单5），其作用是用反射调用catalinaDaemon（类型是Catalina）的load方法加载和解析server.xml配置文件。参照第二章。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Load daemon.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(String[] arguments)</span></span></div><div class="line">       <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">       <span class="comment">// Call the load() method</span></div><div class="line">       String methodName = <span class="string">"load"</span>;</div><div class="line">       Object param[];</div><div class="line">       Class&lt;?&gt; paramTypes[];</div><div class="line">       <span class="keyword">if</span> (arguments==<span class="keyword">null</span> || arguments.length==<span class="number">0</span>) &#123;</div><div class="line">           paramTypes = <span class="keyword">null</span>;</div><div class="line">           param = <span class="keyword">null</span>;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           paramTypes = <span class="keyword">new</span> Class[<span class="number">1</span>];</div><div class="line">           paramTypes[<span class="number">0</span>] = arguments.getClass();</div><div class="line">           param = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">           param[<span class="number">0</span>] = arguments;</div><div class="line">       &#125;</div><div class="line">       Method method =</div><div class="line">           catalinaDaemon.getClass().getMethod(methodName, paramTypes);</div><div class="line">       <span class="keyword">if</span> (log.isDebugEnabled())</div><div class="line">           log.debug(<span class="string">"Calling startup class "</span> + method);</div><div class="line">       method.invoke(catalinaDaemon, param);</div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h5 id="步骤三-启动Tomcat"><a href="#步骤三-启动Tomcat" class="headerlink" title="步骤三 启动Tomcat"></a>步骤三 启动Tomcat</h5><p>当传递参数start的时候，调用Bootstrap的load方法之后会接着调用start方法（见代码清单6）启动Tomcat，此方法实际是用反射调用了catalinaDaemon（类型是Catalina）的start方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Start the Catalina daemon.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span></div><div class="line">    <span class="keyword">throws</span> Exception &#123;</div><div class="line">    <span class="keyword">if</span>( catalinaDaemon==<span class="keyword">null</span> ) init();</div><div class="line"></div><div class="line">    Method method = catalinaDaemon.getClass().getMethod(<span class="string">"start"</span>, (Class [] )<span class="keyword">null</span>);</div><div class="line">    method.invoke(catalinaDaemon, (Object [])<span class="keyword">null</span>);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>catalina类结构如下：</p>
<p><img src="http://i.imgur.com/msNYutk.png" alt=""></p>
<p>Catalina的start方法（见代码清单7）的执行步骤如下:</p>
<ol>
<li>验证Server容器是否已经实例化。如果没有实例化Server容器，还会再次调用Catalina的load方法加载和解析server.xml，这也说明Tomcat只允许Server容器通过配置在server.xml的方式生成，用户也可以自己实现Server接口创建自定义的Server容器以取代默认的StandardServer</li>
<li>启动Server容器，有关容器的启动过程的分析可以参考《生命周期管理》该章的内容。</li>
<li>设置关闭钩子。这么说可能有些不好理解，那就换个说法。Tomcat本身可能由于所在机器断点，程序bug甚至内存溢出导致进程退出，但是Tomcat可能需要在退出的时候做一些清理工作，比如：内存清理、对象销毁等。这些清理动作需要封装在一个Thread的实现中，然后将此Thread对象作为参数传递给Runtime的addShutdownHook方法即可。</li>
<li>最后调用Catalina的await方法循环等待接收Tomcat的shutdown命令。</li>
<li>如果Tomcat运行正常且没有收到shutdown命令，是不会向下执行stop方法的，当接收到shutdown命令，Catalina的await方法会退出循环等待，然后顺序执行stop方法停止Tomcat。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Start a new server instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (getServer() == <span class="keyword">null</span>) &#123;</div><div class="line">            load();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (getServer() == <span class="keyword">null</span>) &#123;</div><div class="line">            log.fatal(<span class="string">"Cannot start server. Server instance is not configured."</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> t1 = System.nanoTime();</div><div class="line"></div><div class="line">        <span class="comment">// Start the new server</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            getServer().start();</div><div class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</div><div class="line">            log.fatal(sm.getString(<span class="string">"catalina.serverStartFail"</span>), e);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                getServer().destroy();</div><div class="line">            &#125; <span class="keyword">catch</span> (LifecycleException e1) &#123;</div><div class="line">                log.debug(<span class="string">"destroy() failed for failed Server "</span>, e1);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> t2 = System.nanoTime();</div><div class="line">        <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</div><div class="line">            log.info(<span class="string">"Server startup in "</span> + ((t2 - t1) / <span class="number">1000000</span>) + <span class="string">" ms"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Register shutdown hook</span></div><div class="line">        <span class="keyword">if</span> (useShutdownHook) &#123;</div><div class="line">            <span class="keyword">if</span> (shutdownHook == <span class="keyword">null</span>) &#123;</div><div class="line">                shutdownHook = <span class="keyword">new</span> CatalinaShutdownHook();</div><div class="line">            &#125;</div><div class="line">            Runtime.getRuntime().addShutdownHook(shutdownHook);</div><div class="line"></div><div class="line">            <span class="comment">// If JULI is being used, disable JULI's shutdown hook since</span></div><div class="line">            <span class="comment">// shutdown hooks run in parallel and log messages may be lost</span></div><div class="line">            <span class="comment">// if JULI's hook completes before the CatalinaShutdownHook()</span></div><div class="line">            LogManager logManager = LogManager.getLogManager();</div><div class="line">            <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</div><div class="line">                ((ClassLoaderLogManager) logManager).setUseShutdownHook(</div><div class="line">                        <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (await) &#123;</div><div class="line">            await();</div><div class="line">            stop();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>Catalina的await方法（见代码清单8）实际只是代理执行了Server容器的await方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Await and shutdown.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    getServer().await();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以Server的默认实现StandardServer为例，其await方法的执行步骤如下：</p>
<ol>
<li>创建socket连接的服务端对象ServerSocket；</li>
<li>循环等待接收客户端发出的命令，如果接收到的命令与SHUTDOWN匹配（由于使用了equals，所以shutdown命令必须是大写的），那么退出循环等待。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Wait until a proper shutdown command is received, then return.</div><div class="line">     * This keeps the main thread alive - the thread pool listening for http</div><div class="line">     * connections is daemon threads.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Negative values - don't wait on port - tomcat is embedded or we just don't like ports</span></div><div class="line">        <span class="keyword">if</span>( port == -<span class="number">2</span> ) &#123;</div><div class="line">            <span class="comment">// undocumented yet - for embedding apps that are around, alive.</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>( port==-<span class="number">1</span> ) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                awaitThread = Thread.currentThread();</div><div class="line">                <span class="keyword">while</span>(!stopAwait) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Thread.sleep( <span class="number">10000</span> );</div><div class="line">                    &#125; <span class="keyword">catch</span>( InterruptedException ex ) &#123;</div><div class="line">                        <span class="comment">// continue and check the flag</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                awaitThread = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Set up a server socket to wait on</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            awaitSocket = <span class="keyword">new</span> ServerSocket(port, <span class="number">1</span>,</div><div class="line">                    InetAddress.getByName(address));</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            log.error(<span class="string">"StandardServer.await: create["</span> + address</div><div class="line">                               + <span class="string">":"</span> + port</div><div class="line">                               + <span class="string">"]: "</span>, e);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            awaitThread = Thread.currentThread();</div><div class="line"></div><div class="line">            <span class="comment">// Loop waiting for a connection and a valid command</span></div><div class="line">            <span class="keyword">while</span> (!stopAwait) &#123;</div><div class="line">                ServerSocket serverSocket = awaitSocket;</div><div class="line">                <span class="keyword">if</span> (serverSocket == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Wait for the next connection</span></div><div class="line">                Socket socket = <span class="keyword">null</span>;</div><div class="line">                StringBuilder command = <span class="keyword">new</span> StringBuilder();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    InputStream stream;</div><div class="line">                    <span class="keyword">long</span> acceptStartTime = System.currentTimeMillis();</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        socket = serverSocket.accept();</div><div class="line">                        socket.setSoTimeout(<span class="number">10</span> * <span class="number">1000</span>);  <span class="comment">// Ten seconds</span></div><div class="line">                        stream = socket.getInputStream();</div><div class="line">                    &#125; <span class="keyword">catch</span> (SocketTimeoutException ste) &#123;</div><div class="line">                        <span class="comment">// This should never happen but bug 56684 suggests that</span></div><div class="line">                        <span class="comment">// it does.</span></div><div class="line">                        log.warn(sm.getString(<span class="string">"standardServer.accept.timeout"</span>,</div><div class="line">                                Long.valueOf(System.currentTimeMillis() - acceptStartTime)), ste);</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125; <span class="keyword">catch</span> (AccessControlException ace) &#123;</div><div class="line">                        log.warn(<span class="string">"StandardServer.accept security exception: "</span></div><div class="line">                                + ace.getMessage(), ace);</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        <span class="keyword">if</span> (stopAwait) &#123;</div><div class="line">                            <span class="comment">// Wait was aborted with socket.close()</span></div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        log.error(<span class="string">"StandardServer.await: accept: "</span>, e);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// Read a set of characters from the socket</span></div><div class="line">                    <span class="keyword">int</span> expected = <span class="number">1024</span>; <span class="comment">// Cut off to avoid DoS attack</span></div><div class="line">                    <span class="keyword">while</span> (expected &lt; shutdown.length()) &#123;</div><div class="line">                        <span class="keyword">if</span> (random == <span class="keyword">null</span>)</div><div class="line">                            random = <span class="keyword">new</span> Random();</div><div class="line">                        expected += (random.nextInt() % <span class="number">1024</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">while</span> (expected &gt; <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">int</span> ch = -<span class="number">1</span>;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            ch = stream.read();</div><div class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                            log.warn(<span class="string">"StandardServer.await: read: "</span>, e);</div><div class="line">                            ch = -<span class="number">1</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// Control character or EOF (-1) terminates loop</span></div><div class="line">                        <span class="keyword">if</span> (ch &lt; <span class="number">32</span> || ch == <span class="number">127</span>) &#123;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        command.append((<span class="keyword">char</span>) ch);</div><div class="line">                        expected--;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="comment">// Close the socket now that we are done with it</span></div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</div><div class="line">                            socket.close();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                        <span class="comment">// Ignore</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Match against our command string</span></div><div class="line">                <span class="keyword">boolean</span> match = command.toString().equals(shutdown);</div><div class="line">                <span class="keyword">if</span> (match) &#123;</div><div class="line">                    log.info(sm.getString(<span class="string">"standardServer.shutdownViaPort"</span>));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125; <span class="keyword">else</span></div><div class="line">                    log.warn(<span class="string">"StandardServer.await: Invalid command '"</span></div><div class="line">                            + command.toString() + <span class="string">"' received"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            ServerSocket serverSocket = awaitSocket;</div><div class="line">            awaitThread = <span class="keyword">null</span>;</div><div class="line">            awaitSocket = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="comment">// Close the server socket and return</span></div><div class="line">            <span class="keyword">if</span> (serverSocket != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    serverSocket.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    <span class="comment">// Ignore</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>本章小结</p>
<p>至此，Tomcat启动完毕。<br>以下是一个tomact启动过程时序图：</p>
<p><img src="http://i.imgur.com/mL0bxFk.png" alt=""></p>
<h3 id="第五章-tomact的停止"><a href="#第五章-tomact的停止" class="headerlink" title="第五章 tomact的停止"></a>第五章 tomact的停止</h3><p>分析：</p>
<p>我们停止Tomcat的命令如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sh shutdown.sh</div></pre></td></tr></table></figure>
<p>所以，将从shell脚本shutdown.sh开始分析Tomcat的停止过程。shutdown.sh的脚本代码见代码:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">os400=false  </div><div class="line">case "`uname`" in  </div><div class="line">OS400*) os400=true;;  </div><div class="line">esac  </div><div class="line">  </div><div class="line"># resolve links - $0 may be a softlink  </div><div class="line">PRG="$0"  </div><div class="line">  </div><div class="line">while [ -h "$PRG" ] ; do  </div><div class="line">  ls=`ls -ld "$PRG"`  </div><div class="line">  link=`expr "$ls" : '.*-&gt; .∗$'`  </div><div class="line">  if expr "$link" : '/.*' &gt; /dev/null; then  </div><div class="line">    PRG="$link"  </div><div class="line">  else  </div><div class="line">    PRG=`dirname "$PRG"`/"$link"  </div><div class="line">  fi  </div><div class="line">done  </div><div class="line">  </div><div class="line">PRGDIR=`dirname "$PRG"`  </div><div class="line">EXECUTABLE=catalina.sh  </div><div class="line">  </div><div class="line"># Check that target executable exists  </div><div class="line">if $os400; then  </div><div class="line">  # -x will Only work on the os400 if the files are:  </div><div class="line">  # 1. owned by the user  </div><div class="line">  # 2. owned by the PRIMARY group of the user  </div><div class="line">  # this will not work if the user belongs in secondary groups  </div><div class="line">  eval  </div><div class="line">else  </div><div class="line">  if [ ! -x "$PRGDIR"/"$EXECUTABLE" ]; then  </div><div class="line">    echo "Cannot find $PRGDIR/$EXECUTABLE"  </div><div class="line">    echo "The file is absent or does not have execute permission"  </div><div class="line">    echo "This file is needed to run this program"  </div><div class="line">    exit 1  </div><div class="line">  fi  </div><div class="line">fi  </div><div class="line">  </div><div class="line">exec "$PRGDIR"/"$EXECUTABLE" stop "$@"</div></pre></td></tr></table></figure>
<p>执行脚本catalina.sh</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">elif [ "$1" = "stop" ] ; then  </div><div class="line">  </div><div class="line">  #省略参数校验脚本  </div><div class="line">  </div><div class="line">  eval "\"$_RUNJAVA\"" $LOGGING_MANAGER $JAVA_OPTS \  </div><div class="line">    -Djava.endorsed.dirs="\"$JAVA_ENDORSED_DIRS\"" -classpath "\"$CLASSPATH\"" \  </div><div class="line">    -Dcatalina.base="\"$CATALINA_BASE\"" \  </div><div class="line">    -Dcatalina.home="\"$CATALINA_HOME\"" \  </div><div class="line">    -Djava.io.tmpdir="\"$CATALINA_TMPDIR\"" \  </div><div class="line">    org.apache.catalina.startup.Bootstrap "$@" stop</div></pre></td></tr></table></figure>
<p>从代码可以看出，最终使用java命令执行了org.apache.catalina.startup.Bootstrap类中的main方法，参数是stop。</p>
<p>此时main方法主要执行以下步骤</p>
<ol>
<li>初始化bootstrap（参照上一章）</li>
<li><p>停止服务</p>
<p> 通过调用Bootstrap的stopServer方法停止Tomcat，其实质是用反射调用catalinaDaemon（类型是Catalina）的stopServer方法。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Stop the standalone server.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopServer</span><span class="params">()</span></span></div><div class="line">    <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">    Method method =</div><div class="line">        catalinaDaemon.getClass().getMethod(<span class="string">"stopServer"</span>, (Class []) <span class="keyword">null</span>);</div><div class="line">    method.invoke(catalinaDaemon, (Object []) <span class="keyword">null</span>);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> Catalina的stopServer方法（见代码清单13）的执行步骤如下：</p>
<ul>
<li>创建Digester解析server.xml文件（此处只解析标签），以构造出Server容器（此时Server容器的子容器没有被实例化）；</li>
<li><p>从实例化的Server容器获取Server的socket监听端口和地址，然后创建Socket对象连接启动Tomcat时创建的ServerSocket，最后向ServerSocket发送SHUTDOWN命令。根据代码清单9的内容，ServerSocket循环等待接收到SHUTDOWN命令后，最终调用stop方法停止Tomcat。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopServer</span><span class="params">(String[] arguments)</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (arguments != <span class="keyword">null</span>) &#123;</div><div class="line">           arguments(arguments);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Server s = getServer();</div><div class="line">       <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">// Create and execute our Digester</span></div><div class="line">           Digester digester = createStopDigester();</div><div class="line">           File file = configFile();</div><div class="line">           <span class="keyword">try</span> (FileInputStream fis = <span class="keyword">new</span> FileInputStream(file)) &#123;</div><div class="line">               InputSource is =</div><div class="line">                   <span class="keyword">new</span> InputSource(file.toURI().toURL().toString());</div><div class="line">               is.setByteStream(fis);</div><div class="line">               digester.push(<span class="keyword">this</span>);</div><div class="line">               digester.parse(is);</div><div class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">               log.error(<span class="string">"Catalina.stop: "</span>, e);</div><div class="line">               System.exit(<span class="number">1</span>);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// Server object already present. Must be running as a service</span></div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               s.stop();</div><div class="line">           &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</div><div class="line">               log.error(<span class="string">"Catalina.stop: "</span>, e);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Stop the existing server</span></div><div class="line">       s = getServer();</div><div class="line">       <span class="keyword">if</span> (s.getPort()&gt;<span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">try</span> (Socket socket = <span class="keyword">new</span> Socket(s.getAddress(), s.getPort());</div><div class="line">                   OutputStream stream = socket.getOutputStream()) &#123;</div><div class="line">               String shutdown = s.getShutdown();</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; shutdown.length(); i++) &#123;</div><div class="line">                   stream.write(shutdown.charAt(i));</div><div class="line">               &#125;</div><div class="line">               stream.flush();</div><div class="line">           &#125; <span class="keyword">catch</span> (ConnectException ce) &#123;</div><div class="line">               log.error(sm.getString(<span class="string">"catalina.stopServer.connectException"</span>,</div><div class="line">                                      s.getAddress(),</div><div class="line">                                      String.valueOf(s.getPort())));</div><div class="line">               log.error(<span class="string">"Catalina.stop: "</span>, ce);</div><div class="line">               System.exit(<span class="number">1</span>);</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">               log.error(<span class="string">"Catalina.stop: "</span>, e);</div><div class="line">               System.exit(<span class="number">1</span>);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           log.error(sm.getString(<span class="string">"catalina.stopServer"</span>));</div><div class="line">           System.exit(<span class="number">1</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>最后，我们看看Catalina的stop方法（见代码清单14）的实现，其执行步骤如下：</p>
</li>
<li><p>将启动过程中添加的关闭钩子移除。Tomcat启动过程辛辛苦苦添加的关闭钩子为什么又要去掉呢？因为关闭钩子是为了在JVM异常退出后，进行资源的回收工作。主动停止Tomcat时调用的stop方法里已经包含了资源回收的内容，所以不再需要这个钩子了。<br>-停止Server容器。有关容器的停止内容，请阅读《T生命周期管理》一章。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Stop an existing server instance.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Remove the ShutdownHook first so that server.stop()</span></div><div class="line">            <span class="comment">// doesn't get invoked twice</span></div><div class="line">            <span class="keyword">if</span> (useShutdownHook) &#123;</div><div class="line">                Runtime.getRuntime().removeShutdownHook(shutdownHook);</div><div class="line"></div><div class="line">                <span class="comment">// If JULI is being used, re-enable JULI's shutdown to ensure</span></div><div class="line">                <span class="comment">// log messages are not lost</span></div><div class="line">                LogManager logManager = LogManager.getLogManager();</div><div class="line">                <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</div><div class="line">                    ((ClassLoaderLogManager) logManager).setUseShutdownHook(</div><div class="line">                            <span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(t);</div><div class="line">            <span class="comment">// This will fail on JDK 1.2. Ignoring, as Tomcat can run</span></div><div class="line">            <span class="comment">// fine without the shutdown hook.</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Shut down the server</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Server s = getServer();</div><div class="line">            LifecycleState state = s.getState();</div><div class="line">            <span class="keyword">if</span> (LifecycleState.STOPPING_PREP.compareTo(state) &lt;= <span class="number">0</span></div><div class="line">                    &amp;&amp; LifecycleState.DESTROYED.compareTo(state) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// Nothing to do. stop() was already called</span></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                s.stop();</div><div class="line">                s.destroy();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</div><div class="line">            log.error(<span class="string">"Catalina.stop"</span>, e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<p>本章小结</p>
<p>通过对Tomcat源码的分析我们了解到Tomcat的启动和停止都离不开org.apache.catalina.startup.Bootstrap。当停止Tomcat时，已经启动的Tomcat作为socket服务端，停止脚本启动的Bootstrap进程作为socket客户端向服务端发送shutdown命令，两个进程通过共享server.xml里Server标签的端口以及地址信息打通了socket的通信。</p>
<h3 id="第六章-请求原理分析-Tomcat处理请求前作的初始化和准备工作"><a href="#第六章-请求原理分析-Tomcat处理请求前作的初始化和准备工作" class="headerlink" title="第六章 请求原理分析-Tomcat处理请求前作的初始化和准备工作"></a>第六章 请求原理分析-Tomcat处理请求前作的初始化和准备工作</h3><h4 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h4><p>谈起Tomcat的诞生，最早可以追溯到1995年。近20年来，Tomcat始终是使用最广泛的Web服务器，由于其使用Java语言开发，所以广为Java程序员所熟悉。很多人早期的J2EE项目，由程序员自己实现Jsp页面或者Servlet接受请求，后来借助Struts1、Struts2、spring等中间件后，实际也是利用Filter或者Servlet处理请求，大家肯定要问了，这些Servlet处理的请求来自哪里？Tomcat作为Web服务器是怎样将HTTP请求交给Servlet的呢？</p>
<p>本章就Tomcat对HTTP的请求处理细节进行分析。</p>
<h4 id="2-connector"><a href="#2-connector" class="headerlink" title="2.connector"></a>2.connector</h4><p>根据《生命周期管理》一章的内容，我们知道Tomcat中有很多容器，包括Server、Service、Connector等。其中Connector正是与HTTP请求处理相关的容器。Service是Server的子容器，而Connector又是Service的子容器。那么这三个容器的初始化顺序为：Server-&gt;Service-&gt;Connector。Connector的实现分为以下几种：</p>
<ul>
<li>Http Connector：基于HTTP协议，负责建立HTTP连接。它又分为BIO Http Connector（是Tomcat的默认Connector）与NIO Http Connector两种，后者提供非阻塞IO与长连接Comet支持。</li>
<li>AJP Connector：基于AJP协议，AJP是专门设计用于Tomcat与HTTP服务器通信定制的协议，能提供较高的通信速度和效率。如与Apache服务器集成时，采用这个协议。</li>
<li>APR HTTP Connector：用C实现，通过JNI调用的。主要提升对静态资源（如HTML、图片、CSS、JS等）的访问性能。现在这个库已独立出来可用在任何项目中。由于APR性能较前两类有很大提升。现在我们直接来看Connector的initInternal方法吧。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.initInternal();</div><div class="line"></div><div class="line">        <span class="comment">// Initialize adapter</span></div><div class="line">        adapter = <span class="keyword">new</span> CoyoteAdapter(<span class="keyword">this</span>);</div><div class="line">        protocolHandler.setAdapter(adapter);</div><div class="line"></div><div class="line">        <span class="comment">// Make sure parseBodyMethodsSet has a default</span></div><div class="line">        <span class="keyword">if</span>( <span class="keyword">null</span> == parseBodyMethodsSet ) &#123;</div><div class="line">            setParseBodyMethods(getParseBodyMethods());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (protocolHandler.isAprRequired() &amp;&amp;</div><div class="line">                !AprLifecycleListener.isAprAvailable()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(</div><div class="line">                    sm.getString(<span class="string">"coyoteConnector.protocolHandlerNoApr"</span>,</div><div class="line">                            getProtocolHandlerClassName()));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            protocolHandler.init();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</div><div class="line">                (sm.getString</div><div class="line">                 (<span class="string">"coyoteConnector.protocolHandlerInitializationFailed"</span>), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上述代码说明了Connector的初始化步骤如下：</p>
<ol>
<li><strong>步骤一 构造网络协议处理的CoyoteAdapter</strong></li>
</ol>
<p>代码中构造了CoyoteAdapter对象，并且将其设置为ProtocolHandler的Adapter。ProtocolHandler是做什么的呢？Tomcat处理HTTP请求，需要有一个ServerSocket监听网络端口来完成任务。接口ProtocolHandler被设计成控制网络端口监听组件运行，负责组件的生命周期控制，这个接口实际并没有定义网络端口监听功能的规范，而是用于负责维护组件的生命周期。从ProtocolHandler的名字来看，它应该是网络协议的处理者，但它实际不负责这个功能，而是将其交给org.apache.coyote.Adapter来完成，这么设计估计是为了方便维护和拓展新功能。</p>
<p>Http11Protocol是ProtocolHandler接口的一个实现(是Connector的默认处理协议),被设计用来处理HTTP1.1网络协议的请求,通过该类可以完成在某个网络端口上面的监听,同时以HTTP1.1的协议来解析请求内容，然后将请求传递到Connector所寄居的Container容器pipeline流水工作线上处理。</p>
<p>此处的ProtocolHandler是何时生成的呢？还记得《第三章——SERVER.XML文件的加载与解析》一文中的Digester和Rule吗？Digester在解析到标签的时候，会执行startElement方法，startElement中会调用Rule的begin(String namespace, String name, Attributes attributes)方法，Connector对应的Rule就包括了ConnectorCreateRule。ConnectorCreateRule的begin方法的实现见代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span>  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">(String namespace, String name, Attributes attributes)</span>  </span></div><div class="line">        <span class="keyword">throws</span> Exception &#123;  </div><div class="line">    Service svc = (Service)digester.peek();  </div><div class="line">    Executor ex = <span class="keyword">null</span>;  </div><div class="line">    <span class="keyword">if</span> ( attributes.getValue(<span class="string">"executor"</span>)!=<span class="keyword">null</span> ) &#123;  </div><div class="line">        ex = svc.getExecutor(attributes.getValue(<span class="string">"executor"</span>));  </div><div class="line">    &#125;  </div><div class="line">    Connector con = <span class="keyword">new</span> Connector(attributes.getValue(<span class="string">"protocol"</span>));  </div><div class="line">    <span class="keyword">if</span> ( ex != <span class="keyword">null</span> )  _setExecutor(con,ex);  </div><div class="line">      </div><div class="line">    digester.push(con);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码调用了Connector的构造器，传递的参数为属性protocol。我们知道server.xml中默认的Connector有两个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;Connector port=<span class="string">"8080"</span> protocol=<span class="string">"HTTP/1.1"</span>   </div><div class="line">           connectionTimeout=<span class="string">"20000"</span>   </div><div class="line">           redirectPort=<span class="string">"8443"</span> /&gt;  </div><div class="line">&lt;!-- Define an AJP <span class="number">1.3</span> Connector on port <span class="number">8009</span> --&gt;  </div><div class="line">&lt;Connector port=<span class="string">"8009"</span> protocol=<span class="string">"AJP/1.3"</span> redirectPort=<span class="string">"8443"</span> /&gt;</div></pre></td></tr></table></figure>
<p>从server.xml可以看到两个Connector都有属性protocol。</p>
<p>connector的构造器如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Connector</span><span class="params">(String protocol)</span> </span>&#123;</div><div class="line">    setProtocol(protocol);</div><div class="line">    <span class="comment">// Instantiate protocol handler</span></div><div class="line">    ProtocolHandler p = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Class&lt;?&gt; clazz = Class.forName(protocolHandlerClassName);</div><div class="line">        p = (ProtocolHandler) clazz.newInstance();</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        log.error(sm.getString(</div><div class="line">                <span class="string">"coyoteConnector.protocolHandlerInstantiationFailed"</span>), e);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">this</span>.protocolHandler = p;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!Globals.STRICT_SERVLET_COMPLIANCE) &#123;</div><div class="line">        URIEncoding = <span class="string">"UTF-8"</span>;</div><div class="line">        URIEncodingLower = URIEncoding.toLowerCase(Locale.ENGLISH);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>setProtocol方法根据protocol参数的不同，调用setProtocolHandlerClassName方法（见代码清单5）设置protocolHandlerClassName属性。以HTTP/1.1为例，由于默认情况下Apr不可用，所以protocolHandlerClassName会被设置为org.apache.coyote.http11.Http11Protocol，那么反射生成的protocolHandler就是Http11Protocol实例。Tomcat默认还会配置协议是AJP/1.3的Connector，那么此Connector的protocolHandler就是org.apache.coyote.ajp.AjpProtocol。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProtocol</span><span class="params">(String protocol)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (AprLifecycleListener.isAprAvailable()) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"HTTP/1.1"</span>.equals(protocol)) &#123;</div><div class="line">                setProtocolHandlerClassName</div><div class="line">                    (<span class="string">"org.apache.coyote.http11.Http11AprProtocol"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"AJP/1.3"</span>.equals(protocol)) &#123;</div><div class="line">                setProtocolHandlerClassName</div><div class="line">                    (<span class="string">"org.apache.coyote.ajp.AjpAprProtocol"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol != <span class="keyword">null</span>) &#123;</div><div class="line">                setProtocolHandlerClassName(protocol);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                setProtocolHandlerClassName</div><div class="line">                    (<span class="string">"org.apache.coyote.http11.Http11AprProtocol"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"HTTP/1.1"</span>.equals(protocol)) &#123;</div><div class="line">                setProtocolHandlerClassName</div><div class="line">                    (<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"AJP/1.3"</span>.equals(protocol)) &#123;</div><div class="line">                setProtocolHandlerClassName</div><div class="line">                    (<span class="string">"org.apache.coyote.ajp.AjpNioProtocol"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (protocol != <span class="keyword">null</span>) &#123;</div><div class="line">                setProtocolHandlerClassName(protocol);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>除此之外，ProtocolHandler还有其它实现，如图1所示。</p>
<p><img src="http://i.imgur.com/xUrR6F8.png" alt=""></p>
<p>图1中有关ProtocolHandler的实现类都在org.apache.coyote包中 。前面所说的BIO Http Connector实际就是Http11Protocol，NIO Http Connector实际就是Http11NioProtocol，AJP Connector包括AjpProtocol和AjpAprProtocol，APR HTTP Connector包括AjpAprProtocol、Http11AprProtocol.</p>
<ol>
<li><strong>Connector的启动</strong></li>
</ol>
<p>根据《生命周期管理》一章的内容，我们知道Tomcat中有很多容器。ProtocolHandler的初始化稍微有些特殊，Server、Service、Connector这三个容器的初始化顺序为：Server-&gt;Service-&gt;Connector。值得注意的是，ProtocolHandler作为Connector的子容器，其初始化过程并不是由Connector的initInternal方法调用的，而是与启动过程一道被Connector的startInternal方法所调用。由于本文的目的是分析请求，所以直接从Connector的startInternal方法（见代码清单6）开始。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Begin processing requests via this Connector.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if a fatal startup error occurs</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Validate settings before starting</span></div><div class="line">        <span class="keyword">if</span> (getPort() &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException(sm.getString(</div><div class="line">                    <span class="string">"coyoteConnector.invalidPort"</span>, Integer.valueOf(getPort())));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setState(LifecycleState.STARTING);</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            protocolHandler.start();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            String errPrefix = <span class="string">""</span>;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.service != <span class="keyword">null</span>) &#123;</div><div class="line">                errPrefix += <span class="string">"service.getName(): \""</span> + <span class="keyword">this</span>.service.getName() + <span class="string">"\"; "</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</div><div class="line">                (errPrefix + <span class="string">" "</span> + sm.getString</div><div class="line">                 (<span class="string">"coyoteConnector.protocolHandlerStartFailed"</span>), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>代码清单6说明了Connector的startInternal方法的执行顺序如下：</p>
<ol>
<li>将Connector容器的状态更改为启动中（LifecycleState.STARTING）；</li>
<li>初始化ProtocolHandler；</li>
<li>启动ProtocolHandler；</li>
<li>初始化MapperListener。</li>
</ol>
<h6 id="初始化ProtocolHandler"><a href="#初始化ProtocolHandler" class="headerlink" title="初始化ProtocolHandler"></a>初始化ProtocolHandler</h6><p>简单起见，我们以Http11Protocol为例剖析ProtocolHandler的init方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ------------------------------------------------------- Lifecycle methods</span></div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * <span class="doctag">NOTE:</span> There is no maintenance of state or checking for valid transitions</div><div class="line">     * within this class. It is expected that the connector will maintain state</div><div class="line">     * and prevent invalid state transitions.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (getLog().isInfoEnabled())</div><div class="line">            getLog().info(sm.getString(<span class="string">"abstractProtocolHandler.init"</span>,</div><div class="line">                    getName()));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (oname == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Component not pre-registered so register it</span></div><div class="line">            oname = createObjectName();</div><div class="line">            <span class="keyword">if</span> (oname != <span class="keyword">null</span>) &#123;</div><div class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(<span class="keyword">this</span>, oname,</div><div class="line">                    <span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.domain != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                tpOname = <span class="keyword">new</span> ObjectName(domain + <span class="string">":"</span> +</div><div class="line">                        <span class="string">"type=ThreadPool,name="</span> + getName());</div><div class="line">                Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(endpoint,</div><div class="line">                        tpOname, <span class="keyword">null</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                getLog().error(sm.getString(</div><div class="line">                        <span class="string">"abstractProtocolHandler.mbeanRegistrationFailed"</span>,</div><div class="line">                        tpOname, getName()), e);</div><div class="line">            &#125;</div><div class="line">            rgOname=<span class="keyword">new</span> ObjectName(domain +</div><div class="line">                    <span class="string">":type=GlobalRequestProcessor,name="</span> + getName());</div><div class="line">            Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(</div><div class="line">                    getHandler().getGlobal(), rgOname, <span class="keyword">null</span> );</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String endpointName = getName();</div><div class="line">        endpoint.setName(endpointName.substring(<span class="number">1</span>, endpointName.length()-<span class="number">1</span>));</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            endpoint.init();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">            getLog().error(sm.getString(<span class="string">"abstractProtocolHandler.initError"</span>,</div><div class="line">                    getName()), ex);</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="comment">// SSL implementation needs to be in place before end point is</span></div><div class="line">        <span class="comment">// initialized</span></div><div class="line">        sslImplementation = SSLImplementation.getInstance(sslImplementationName);</div><div class="line">        <span class="keyword">super</span>.init();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initSsl</span><span class="params">(SocketWrapper&lt;Socket&gt; socket,</span></span></div><div class="line">                Processor&lt;Socket&gt; processor) &#123;</div><div class="line">            <span class="keyword">if</span> (proto.isSSLEnabled() &amp;&amp; (proto.sslImplementation != <span class="keyword">null</span>)) &#123;</div><div class="line">                processor.setSslSupport(</div><div class="line">                        proto.sslImplementation.getSSLSupport(</div><div class="line">                                socket.getSocket()));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                processor.setSslSupport(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>从上述代码可以查看Http11Protocol的初始化步骤如下：</p>
<ol>
<li>设置JIoEndpoint的名称</li>
<li>设置JIoEndpoint的Handler</li>
<li>配置ServerSocketFactory</li>
</ol>
<h6 id="启动ProtocolHandler"><a href="#启动ProtocolHandler" class="headerlink" title="启动ProtocolHandler"></a>启动ProtocolHandler</h6><p>我们继续以Http11Protocol为例，剖析ProtocolHandler的start方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (getLog().isInfoEnabled())</div><div class="line">            getLog().info(sm.getString(<span class="string">"abstractProtocolHandler.start"</span>,</div><div class="line">                    getName()));</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            endpoint.start();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">            getLog().error(sm.getString(<span class="string">"abstractProtocolHandler.startError"</span>,</div><div class="line">                    getName()), ex);</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>最后调用JIoEndpoint的start方法（见代码清单11）创建接受请求的线程池并创建一定数量的接收请求线程。 endpoint start方法执行如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="keyword">if</span> (bindState == BindState.UNBOUND) &#123;</div><div class="line">           bind();</div><div class="line">           bindState = BindState.BOUND_ON_START;</div><div class="line">       &#125;</div><div class="line">       startInternal();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (!running) &#123;</div><div class="line">           running = <span class="keyword">true</span>;</div><div class="line">           paused = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">           <span class="comment">// Create worker collection</span></div><div class="line">           <span class="keyword">if</span> (getExecutor() == <span class="keyword">null</span>) &#123;</div><div class="line">               createExecutor();</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           initializeConnectionLatch();</div><div class="line"></div><div class="line">           startAcceptorThreads();</div><div class="line"></div><div class="line">           <span class="comment">// Start async timeout thread</span></div><div class="line">           setAsyncTimeout(<span class="keyword">new</span> AsyncTimeout());</div><div class="line">           Thread timeoutThread = <span class="keyword">new</span> Thread(getAsyncTimeout(), getName() + <span class="string">"-AsyncTimeout"</span>);</div><div class="line">           timeoutThread.setPriority(threadPriority);</div><div class="line">           timeoutThread.setDaemon(<span class="keyword">true</span>);</div><div class="line">           timeoutThread.start();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>从代码中可以看出上述代码主要做以下工作：</p>
<ol>
<li>创建线程池与任务队列</li>
</ol>
<p>如果JIoEndpoint尚未处于运行中（即running等于true），才会创建线程池和任务队列。如果尚未创建线程池（即调用getExecutor方法等于null），则需要调用createExecutor方法（见代码清单12）创建线程池和任务队列TaskQueue。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createExecutor</span><span class="params">()</span> </span>&#123;</div><div class="line">    internalExecutor = <span class="keyword">true</span>;</div><div class="line">    TaskQueue taskqueue = <span class="keyword">new</span> TaskQueue();</div><div class="line">    TaskThreadFactory tf = <span class="keyword">new</span> TaskThreadFactory(getName() + <span class="string">"-exec-"</span>, daemon, getThreadPriority());</div><div class="line">    executor = <span class="keyword">new</span> ThreadPoolExecutor(getMinSpareThreads(), getMaxThreads(), <span class="number">60</span>, TimeUnit.SECONDS,taskqueue, tf);</div><div class="line">    taskqueue.setParent( (ThreadPoolExecutor) executor);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>创建接收请线程</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startAcceptorThreads</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> count = getAcceptorThreadCount();</div><div class="line">        acceptors = <span class="keyword">new</span> Acceptor[count];</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">            acceptors[i] = createAcceptor();</div><div class="line">            String threadName = getName() + <span class="string">"-Acceptor-"</span> + i;</div><div class="line">            acceptors[i].setThreadName(threadName);</div><div class="line">            Thread t = <span class="keyword">new</span> Thread(acceptors[i], threadName);</div><div class="line">            t.setPriority(getAcceptorThreadPriority());</div><div class="line">            t.setDaemon(getDaemon());</div><div class="line">            t.start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>如果JIoEndpoint尚未处于运行中（即running等于true），才会创建接收请求线程。从代码可以看出接收请求线程的数量主要由acceptorThreadCount控制，代码清单9已经告诉我们acceptorThreadCount的默认值为1，但是我们可以通过给Connector增加acceptorThreadCount属性来修改接收请求线程的数量。这些接收请求线程的主要工作由Acceptor完成，Acceptor的实质是一个Runnable.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> <span class="keyword">enum</span> AcceptorState &#123;</div><div class="line">            NEW, RUNNING, PAUSED, ENDED</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">protected</span> <span class="keyword">volatile</span> AcceptorState state = AcceptorState.NEW;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> AcceptorState <span class="title">getState</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> String threadName;</div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setThreadName</span><span class="params">(<span class="keyword">final</span> String threadName)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.threadName = threadName;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> String <span class="title">getThreadName</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> threadName;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>本章总结</p>
<p>至此本章结束</p>
<h3 id="第七章-Tomcat一次完整请求的处理流程"><a href="#第七章-Tomcat一次完整请求的处理流程" class="headerlink" title="第七章 Tomcat一次完整请求的处理流程"></a>第七章 Tomcat一次完整请求的处理流程</h3><h4 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h4><p>上一章介绍了请求前的准备工作，这一章讲解tomact一次完成请求的处理流程。</p>
<p>Tomcat一次完整请求处理的重点功能如下：</p>
<ol>
<li><p>接收Socket请求，把请求转发到线程池，由线程池分配一个线程来处理。</p>
</li>
<li><p>获取Socket数据包之后，解析HTTP协议，翻译成Tomcat内部的Request和Response对象，再映射相应Container。</p>
</li>
<li><p>Request和Response对象进入Tomcat中的Container容器的各级Piepline管道去流式执行，最终会流到StandardWrapperValve这个阀门。</p>
</li>
<li><p>在 StandardWrapperValve这个阀门中，把当前请求的Filter及Servlet封装成FilterChain, 最终执行FilterChain, 回调Web应用，完成响应。</p>
</li>
</ol>
<p>请求处理框架如下所示：</p>
<p><img src="http://i.imgur.com/0uqOq7A.jpg" alt=""></p>
<ul>
<li>Acceptor：负责从ServerSocket中接收新的连接，并将Socket转交给SocketProcessor处理。Acceptor是JIoEndpoint的内部类，Acceptor线程的默认数量为1，我们可以在server.xml的Connector配置中增加acceptorThreadCount的大小。</li>
<li>SocketProcessor：负责对Acceptor转交的Socket进行处理，包括给Socket设置属性、读取请求行和请求头等，最终将处理交给Engine的Pipeline处理。</li>
<li>ThreadPool：执行SocketProcessor的线程池，此线程池默认的最小线程数minSpareThreads等于10，最大线程数maxThreads等于200，我们可以在server.xml的Connector配置中调整它们的大小。</li>
<li>Pipeline：SocketProcessor线程最后会将请求进一步交给Engine容器的Pipeline，管道Pipeline包括一系列的valve，如：StandardEngineValve、AccessLogValve、ErrorReportValve、StandardHostValve、 StandardContextValve、 StandardWrapperValve，它们就像地下水管中的一个个阀门，每一个都会对请求数据做不同的处理。</li>
<li>FilterChain：管道Pipeline的最后一个valve是StandardWrapperValve，它会负责生成Servlet和Filter实例，并将它们组织成对请求处理的链条，这里正是Tomcat与J2EE规范相结合的部分。</li>
</ul>
<p>默认情况下，Tomcat只有一个Acceptor线程，Acceptor不断循环从ServerSocket中获取Socket，当并发数大的情况下，这里会不会有性能问题？我想说的是，Acceptor的实现非常轻量级，它只负责两个动作：获取Socket和将Socket转交给SocketProcessor线程处理。另外，我们可以通过在server.xml的Connector配置中增加acceptorThreadCount的值，让我们同时可以拥有多个Acceptor线程。虽然我们可以修改maxThreads配置把SocketProcessor的线程数设置的很大，但是我们需要区别对待：</p>
<p>如果你部署在Tomcat上的Web服务主要用于计算，那么CPU的开销势必会很大，那么线程数不宜设置的过大，一般以CPU核数<em>2——CPU核数</em>3最佳。当然如果计算量非常大，就已经超出了Tomcat的使用范畴，我想此时，选择离线计算框架Hadoop或者实时计算框架Storm、Spark才是更好的选择。</p>
<p>如果部署在Tomcat上的Web服务主要是为了提供数据库访问，此时I/O的开销会很大，而CPU利用率反而低，此时应该将线程数设置的大一些，但是如果设置的过大，CPU为了给成百上千个线程分配时间片，造成CPU的精力都分散在线程切换上，反而造成性能下降。具体多大，需要对系统性能调优得出。</p>
<p>原理就讲这么多，下面具体分析下Tomcat处理请求的具体实现。</p>
<h4 id="接受请求"><a href="#接受请求" class="headerlink" title="接受请求"></a>接受请求</h4><p>JIoEndpoint类结构：<br><img src="http://i.imgur.com/OjxF6fh.png" alt=""></p>
<p>JIoEndpoint的内部类Acceptor，Acceptor实现了Runnable接口。Acceptor作为后台线程不断循环，每次循环都会接收来自浏览器的Socket连接（用户在浏览器输入HTTP请求地址后，浏览器底层实际使用Socket通信的），最后将Socket交给外部类JIoEndpoint的processSocket方法处理。</p>
<p>JIoEndpoint的Acceptor线程在接收到用户的请求之后，调用processSocket方法。该方法主要是从Executor请求处理线程池中获取一个线程，然后启用一个新线程执行Socket请求，JIoEndpoint的processSocket()方法的核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Process a new connection from a new client. Wraps the socket so</div><div class="line">    * keep-alive and other attributes can be tracked and then passes the socket</div><div class="line">    * to the executor for processing.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@param</span> socket    The socket associated with the client.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@return</span>          &lt;code&gt;true&lt;/code&gt; if the socket is passed to the</div><div class="line">    *                  executor, &lt;code&gt;false&lt;/code&gt; if something went wrong or</div><div class="line">    *                  if the endpoint is shutting down. Returning</div><div class="line">    *                  &lt;code&gt;false&lt;/code&gt; is an indication to close the socket</div><div class="line">    *                  immediately.</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">processSocket</span><span class="params">(Socket socket)</span> </span>&#123;</div><div class="line">       <span class="comment">// Process the request from this socket</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           SocketWrapper&lt;Socket&gt; wrapper = <span class="keyword">new</span> SocketWrapper&lt;&gt;(socket);</div><div class="line">           wrapper.setKeepAliveLeft(getMaxKeepAliveRequests());</div><div class="line">           wrapper.setSecure(isSSLEnabled());</div><div class="line">           <span class="comment">// During shutdown, executor may be null - avoid NPE</span></div><div class="line">           <span class="keyword">if</span> (!running) &#123;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">           &#125;</div><div class="line">           getExecutor().execute(<span class="keyword">new</span> SocketProcessor(wrapper));</div><div class="line">       &#125; <span class="keyword">catch</span> (RejectedExecutionException x) &#123;</div><div class="line">           log.warn(<span class="string">"Socket processing request was rejected for:"</span>+socket,x);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">           ExceptionUtils.handleThrowable(t);</div><div class="line">           <span class="comment">// This means we got an OOM or similar creating a thread, or that</span></div><div class="line">           <span class="comment">// the pool and its queue are full</span></div><div class="line">           log.error(sm.getString(<span class="string">"endpoint.process.fail"</span>), t);</div><div class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>上述代码主要做以下工作：</p>
<ol>
<li>把Socket包装成SocketWrapper</li>
<li>给SocketWrapper设置连接保持时间keepAliveLeft。这个值是通过调用父类AbstractEndpoint的getMaxKeepAliveRequests方法（见代码清单2）获得的</li>
<li>创建SocketProcessor（此类也是JIoEndpoint的内部类，而且也实现了Runnable接口，见如下代码），并使用线程池。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * This class is the equivalent of the Worker, but will simply use in an</div><div class="line">     * external Executor thread pool.</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketProcessor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">protected</span> SocketWrapper&lt;Socket&gt; socket = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">protected</span> SocketStatus status = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SocketProcessor</span><span class="params">(SocketWrapper&lt;Socket&gt; socket)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (socket==<span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">            <span class="keyword">this</span>.socket = socket;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SocketProcessor</span><span class="params">(SocketWrapper&lt;Socket&gt; socket, SocketStatus status)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>(socket);</div><div class="line">            <span class="keyword">this</span>.status = status;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">boolean</span> launch = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">synchronized</span> (socket) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    SocketState state = SocketState.OPEN;</div><div class="line">                    handler.beforeHandshake(socket);</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// SSL handshake</span></div><div class="line">                        serverSocketFactory.handshake(socket.getSocket());</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                        ExceptionUtils.handleThrowable(t);</div><div class="line">                        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                            log.debug(sm.getString(<span class="string">"endpoint.err.handshake"</span>), t);</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// Tell to close the socket</span></div><div class="line">                        state = SocketState.CLOSED;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> ((state != SocketState.CLOSED)) &#123;</div><div class="line">                        <span class="keyword">if</span> (status == <span class="keyword">null</span>) &#123;</div><div class="line">                            state = handler.process(socket, SocketStatus.OPEN_READ);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            state = handler.process(socket,status);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (state == SocketState.CLOSED) &#123;</div><div class="line">                        <span class="comment">// Close socket</span></div><div class="line">                        <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</div><div class="line">                            log.trace(<span class="string">"Closing socket:"</span>+socket);</div><div class="line">                        &#125;</div><div class="line">                        countDownConnection();</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            socket.getSocket().close();</div><div class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                            <span class="comment">// Ignore</span></div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.OPEN ||</div><div class="line">                            state == SocketState.UPGRADING  ||</div><div class="line">                            state == SocketState.UPGRADED)&#123;</div><div class="line">                        socket.setKeptAlive(<span class="keyword">true</span>);</div><div class="line">                        socket.access();</div><div class="line">                        launch = <span class="keyword">true</span>;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.LONG) &#123;</div><div class="line">                        socket.access();</div><div class="line">                        waitingRequests.add(socket);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (launch) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            getExecutor().execute(<span class="keyword">new</span> SocketProcessor(socket, SocketStatus.OPEN_READ));</div><div class="line">                        &#125; <span class="keyword">catch</span> (RejectedExecutionException x) &#123;</div><div class="line">                            log.warn(<span class="string">"Socket reprocessing request was rejected for:"</span>+socket,x);</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                <span class="comment">//unable to handle connection at this time</span></div><div class="line">                                handler.process(socket, SocketStatus.DISCONNECT);</div><div class="line">                            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                                countDownConnection();</div><div class="line">                            &#125;</div><div class="line"></div><div class="line"></div><div class="line">                        &#125; <span class="keyword">catch</span> (NullPointerException npe) &#123;</div><div class="line">                            <span class="keyword">if</span> (running) &#123;</div><div class="line">                                log.error(sm.getString(<span class="string">"endpoint.launch.fail"</span>),</div><div class="line">                                        npe);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            socket = <span class="keyword">null</span>;</div><div class="line">            <span class="comment">// Finish up this request</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>SocketProcessor线程专门用于处理Acceptor转交的Socket，其执行步骤如下:</p>
<ol>
<li>调用handler的process方法处理请求。当处理Http11Protocol协议时，handler默认为Http11Protocol的内部类Http11ConnectionHandler；</li>
<li>请求处理完毕后，如果state等于SocketState.CLOSED，则关闭Socket；如果state等于SocketState.OPEN，则保持连接；如果state等于SocketState.LONG，则会作为长连接对待。</li>
</ol>
<p>在Http11ConnectionHandler中会根据当前请求的协议类型去创建相应的协议处理器，我们这里分析的是HTTP协议，所以会创建Http11Processor去执行process()方法， 拿到Socket数据包后解析生成Tomcat内部的Request对象与Response对象。其中Request对象只是解析Header部分内容，请求参数等做延迟处理，接着就开始调用CoyoteAdapter类进入容器处理， </p>
<p>AbstractHttp11Processor中process方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Process pipelined HTTP requests using the specified input and output</div><div class="line">     * streams.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> socketWrapper Socket from which the HTTP requests will be read</div><div class="line">     *               and the HTTP responses will be written.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> IOException error during an I/O operation</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapper&lt;S&gt; socketWrapper)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException &#123;</div><div class="line">        RequestInfo rp = request.getRequestProcessor();</div><div class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_PARSE);</div><div class="line"></div><div class="line">        <span class="comment">// Setting up the I/O</span></div><div class="line">        setSocketWrapper(socketWrapper);</div><div class="line">        getInputBuffer().init(socketWrapper, endpoint);</div><div class="line">        getOutputBuffer().init(socketWrapper, endpoint);</div><div class="line"></div><div class="line">        <span class="comment">// Flags</span></div><div class="line">        keepAlive = <span class="keyword">true</span>;</div><div class="line">        comet = <span class="keyword">false</span>;</div><div class="line">        openSocket = <span class="keyword">false</span>;</div><div class="line">        sendfileInProgress = <span class="keyword">false</span>;</div><div class="line">        readComplete = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (endpoint.getUsePolling()) &#123;</div><div class="line">            keptAlive = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            keptAlive = socketWrapper.isKeptAlive();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (disableKeepAlive()) &#123;</div><div class="line">            socketWrapper.setKeepAliveLeft(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (!getErrorState().isError() &amp;&amp; keepAlive &amp;&amp; !comet &amp;&amp; !isAsync() &amp;&amp;</div><div class="line">                upgradeToken == <span class="keyword">null</span> &amp;&amp; !endpoint.isPaused()) &#123;</div><div class="line"></div><div class="line">            <span class="comment">// Parsing the request header</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                setRequestLineReadTimeout();</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (!getInputBuffer().parseRequestLine(keptAlive)) &#123;</div><div class="line">                    <span class="keyword">if</span> (handleIncompleteRequestLineRead()) &#123;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (endpoint.isPaused()) &#123;</div><div class="line">                    <span class="comment">// 503 - Service unavailable</span></div><div class="line">                    response.setStatus(<span class="number">503</span>);</div><div class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, <span class="keyword">null</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    keptAlive = <span class="keyword">true</span>;</div><div class="line">                    <span class="comment">// Set this every time in case limit has been changed via JMX</span></div><div class="line">                    request.getMimeHeaders().setLimit(endpoint.getMaxHeaderCount());</div><div class="line">                    request.getCookies().setLimit(getMaxCookieCount());</div><div class="line">                    <span class="comment">// Currently only NIO will ever return false here</span></div><div class="line">                    <span class="keyword">if</span> (!getInputBuffer().parseHeaders()) &#123;</div><div class="line">                        <span class="comment">// We've read part of the request, don't recycle it</span></div><div class="line">                        <span class="comment">// instead associate it with the socket</span></div><div class="line">                        openSocket = <span class="keyword">true</span>;</div><div class="line">                        readComplete = <span class="keyword">false</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (!disableUploadTimeout) &#123;</div><div class="line">                        setSocketTimeout(connectionUploadTimeout);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</div><div class="line">                    getLog().debug(</div><div class="line">                            sm.getString(<span class="string">"http11processor.header.parse"</span>), e);</div><div class="line">                &#125;</div><div class="line">                setErrorState(ErrorState.CLOSE_NOW, e);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                ExceptionUtils.handleThrowable(t);</div><div class="line">                UserDataHelper.Mode logMode = userDataHelper.getNextMode();</div><div class="line">                <span class="keyword">if</span> (logMode != <span class="keyword">null</span>) &#123;</div><div class="line">                    String message = sm.getString(</div><div class="line">                            <span class="string">"http11processor.header.parse"</span>);</div><div class="line">                    <span class="keyword">switch</span> (logMode) &#123;</div><div class="line">                        <span class="keyword">case</span> INFO_THEN_DEBUG:</div><div class="line">                            message += sm.getString(</div><div class="line">                                    <span class="string">"http11processor.fallToDebug"</span>);</div><div class="line">                            <span class="comment">//$FALL-THROUGH$</span></div><div class="line">                        <span class="keyword">case</span> INFO:</div><div class="line">                            getLog().info(message, t);</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        <span class="keyword">case</span> DEBUG:</div><div class="line">                            getLog().debug(message, t);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 400 - Bad Request</span></div><div class="line">                response.setStatus(<span class="number">400</span>);</div><div class="line">                setErrorState(ErrorState.CLOSE_CLEAN, t);</div><div class="line">                getAdapter().log(request, response, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!getErrorState().isError()) &#123;</div><div class="line">                <span class="comment">// Setting up filters, and parse some request headers</span></div><div class="line">                rp.setStage(org.apache.coyote.Constants.STAGE_PREPARE);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    prepareRequest();</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    ExceptionUtils.handleThrowable(t);</div><div class="line">                    <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</div><div class="line">                        getLog().debug(sm.getString(</div><div class="line">                                <span class="string">"http11processor.request.prepare"</span>), t);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// 500 - Internal Server Error</span></div><div class="line">                    response.setStatus(<span class="number">500</span>);</div><div class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, t);</div><div class="line">                    getAdapter().log(request, response, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (maxKeepAliveRequests == <span class="number">1</span>) &#123;</div><div class="line">                keepAlive = <span class="keyword">false</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxKeepAliveRequests &gt; <span class="number">0</span> &amp;&amp;</div><div class="line">                    socketWrapper.decrementKeepAlive() &lt;= <span class="number">0</span>) &#123;</div><div class="line">                keepAlive = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Process the request in the adapter</span></div><div class="line">            <span class="keyword">if</span> (!getErrorState().isError()) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    rp.setStage(org.apache.coyote.Constants.STAGE_SERVICE);</div><div class="line">                    getAdapter().service(request, response);</div><div class="line">                    <span class="comment">// Handle when the response was committed before a serious</span></div><div class="line">                    <span class="comment">// error occurred.  Throwing a ServletException should both</span></div><div class="line">                    <span class="comment">// set the status to 500 and set the errorException.</span></div><div class="line">                    <span class="comment">// If we fail here, then the response is likely already</span></div><div class="line">                    <span class="comment">// committed, so we can't try and set headers.</span></div><div class="line">                    <span class="keyword">if</span>(keepAlive &amp;&amp; !getErrorState().isError() &amp;&amp; !isAsync() &amp;&amp;</div><div class="line">                            statusDropsConnection(response.getStatus())) &#123;</div><div class="line">                        setErrorState(ErrorState.CLOSE_CLEAN, <span class="keyword">null</span>);</div><div class="line">                    &#125;</div><div class="line">                    setCometTimeouts(socketWrapper);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedIOException e) &#123;</div><div class="line">                    setErrorState(ErrorState.CLOSE_NOW, e);</div><div class="line">                &#125; <span class="keyword">catch</span> (HeadersTooLargeException e) &#123;</div><div class="line">                    getLog().error(sm.getString(<span class="string">"http11processor.request.process"</span>), e);</div><div class="line">                    <span class="comment">// The response should not have been committed but check it</span></div><div class="line">                    <span class="comment">// anyway to be safe</span></div><div class="line">                    <span class="keyword">if</span> (response.isCommitted()) &#123;</div><div class="line">                        setErrorState(ErrorState.CLOSE_NOW, e);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        response.reset();</div><div class="line">                        response.setStatus(<span class="number">500</span>);</div><div class="line">                        setErrorState(ErrorState.CLOSE_CLEAN, e);</div><div class="line">                        response.setHeader(<span class="string">"Connection"</span>, <span class="string">"close"</span>); <span class="comment">// <span class="doctag">TODO:</span> Remove</span></div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                    ExceptionUtils.handleThrowable(t);</div><div class="line">                    getLog().error(sm.getString(<span class="string">"http11processor.request.process"</span>), t);</div><div class="line">                    <span class="comment">// 500 - Internal Server Error</span></div><div class="line">                    response.setStatus(<span class="number">500</span>);</div><div class="line">                    setErrorState(ErrorState.CLOSE_CLEAN, t);</div><div class="line">                    getAdapter().log(request, response, <span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Finish the handling of the request</span></div><div class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_ENDINPUT);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet) &#123;</div><div class="line">                <span class="keyword">if</span> (getErrorState().isError()) &#123;</div><div class="line">                    <span class="comment">// If we know we are closing the connection, don't drain</span></div><div class="line">                    <span class="comment">// input. This way uploading a 100GB file doesn't tie up the</span></div><div class="line">                    <span class="comment">// thread if the servlet has rejected it.</span></div><div class="line">                    getInputBuffer().setSwallowInput(<span class="keyword">false</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Need to check this again here in case the response was</span></div><div class="line">                    <span class="comment">// committed before the error that requires the connection</span></div><div class="line">                    <span class="comment">// to be closed occurred.</span></div><div class="line">                    checkExpectationAndResponseStatus();</div><div class="line">                &#125;</div><div class="line">                endRequest();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_ENDOUTPUT);</div><div class="line"></div><div class="line">            <span class="comment">// If there was an error, make sure the request is counted as</span></div><div class="line">            <span class="comment">// and error, and update the statistics counter</span></div><div class="line">            <span class="keyword">if</span> (getErrorState().isError()) &#123;</div><div class="line">                response.setStatus(<span class="number">500</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet || getErrorState().isError()) &#123;</div><div class="line">                request.updateCounters();</div><div class="line">                <span class="keyword">if</span> (getErrorState().isIoAllowed()) &#123;</div><div class="line">                    getInputBuffer().nextRequest();</div><div class="line">                    getOutputBuffer().nextRequest();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!disableUploadTimeout) &#123;</div><div class="line">                <span class="keyword">if</span>(endpoint.getSoTimeout() &gt; <span class="number">0</span>) &#123;</div><div class="line">                    setSocketTimeout(endpoint.getSoTimeout());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    setSocketTimeout(<span class="number">0</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (breakKeepAliveLoop(socketWrapper)) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (getErrorState().isError() || endpoint.isPaused()) &#123;</div><div class="line">            <span class="keyword">return</span> SocketState.CLOSED;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isAsync() || comet) &#123;</div><div class="line">            <span class="keyword">return</span> SocketState.LONG;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUpgrade()) &#123;</div><div class="line">            <span class="keyword">return</span> SocketState.UPGRADING;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (sendfileInProgress) &#123;</div><div class="line">                <span class="keyword">return</span> SocketState.SENDFILE;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (openSocket) &#123;</div><div class="line">                    <span class="keyword">if</span> (readComplete) &#123;</div><div class="line">                        <span class="keyword">return</span> SocketState.OPEN;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">return</span> SocketState.LONG;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">return</span> SocketState.CLOSED;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>由代码可知，Http11Processor的process方法主要执行以下操作：</p>
<ol>
<li>设置SocketWrapper  </li>
<li>获取Socket中的inputStream设置到inputBuffer,也就是设置到Request中 </li>
<li>获取Socket中的outputStream设置到outputBuffer,也就是设置到Response中</li>
<li>解析HTTP请求的method,requestURI,protocol等//parseRequestLine(keptAlive)</li>
<li>解析HTTP请求的报头headers  //parseHeaders()</li>
<li>准备Request,根据已解析的信息做一些过滤//prepareRequest();</li>
<li>调用CoyoteAdapter的service方法,传入org.apache.coyote.Request对象及org.apache.coyote.Response对象//adapter.service(request, response); </li>
</ol>
<p>service方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Service method.</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(org.apache.coyote.Request req,</span></span></div><div class="line">                        org.apache.coyote.Response res)</div><div class="line">        <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">        Request request = (Request) req.getNote(ADAPTER_NOTES);</div><div class="line">        Response response = (Response) res.getNote(ADAPTER_NOTES);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">            <span class="comment">// Create objects</span></div><div class="line">            request = connector.createRequest();</div><div class="line">            request.setCoyoteRequest(req);</div><div class="line">            response = connector.createResponse();</div><div class="line">            response.setCoyoteResponse(res);</div><div class="line"></div><div class="line">            <span class="comment">// Link objects</span></div><div class="line">            request.setResponse(response);</div><div class="line">            response.setRequest(request);</div><div class="line"></div><div class="line">            <span class="comment">// Set as notes</span></div><div class="line">            req.setNote(ADAPTER_NOTES, request);</div><div class="line">            res.setNote(ADAPTER_NOTES, response);</div><div class="line"></div><div class="line">            <span class="comment">// Set query string encoding</span></div><div class="line">            req.getParameters().setQueryStringEncoding</div><div class="line">                (connector.getURIEncoding());</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (connector.getXpoweredBy()) &#123;</div><div class="line">            response.addHeader(<span class="string">"X-Powered-By"</span>, POWERED_BY);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> comet = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">boolean</span> async = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">boolean</span> postParseSuccess = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Parse and set Catalina and configuration specific</span></div><div class="line">            <span class="comment">// request parameters</span></div><div class="line">            req.getRequestProcessor().setWorkerThreadName(THREAD_NAME.get());</div><div class="line">            postParseSuccess = postParseRequest(req, request, res, response);</div><div class="line">            <span class="keyword">if</span> (postParseSuccess) &#123;</div><div class="line">                <span class="comment">//check valves if we support async</span></div><div class="line">                request.setAsyncSupported(connector.getService().getContainer().getPipeline().isAsyncSupported());</div><div class="line">                <span class="comment">// Calling the container</span></div><div class="line">                connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (request.isComet()) &#123;</div><div class="line">                    <span class="keyword">if</span> (!response.isClosed() &amp;&amp; !response.isError()) &#123;</div><div class="line">                        comet = <span class="keyword">true</span>;</div><div class="line">                        res.action(ActionCode.COMET_BEGIN, <span class="keyword">null</span>);</div><div class="line">                        <span class="keyword">if</span> (request.getAvailable() || (request.getContentLength() &gt; <span class="number">0</span> &amp;&amp; (!request.isParametersParsed()))) &#123;</div><div class="line">                            <span class="comment">// Invoke a read event right away if there are available bytes</span></div><div class="line">                            event(req, res, SocketStatus.OPEN_READ);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">// Clear the filter chain, as otherwise it will not be reset elsewhere</span></div><div class="line">                        <span class="comment">// since this is a Comet request</span></div><div class="line">                        request.setFilterChain(<span class="keyword">null</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (request.isAsync()) &#123;</div><div class="line">                async = <span class="keyword">true</span>;</div><div class="line">                ReadListener readListener = req.getReadListener();</div><div class="line">                <span class="keyword">if</span> (readListener != <span class="keyword">null</span> &amp;&amp; request.isFinished()) &#123;</div><div class="line">                    <span class="comment">// Possible the all data may have been read during service()</span></div><div class="line">                    <span class="comment">// method so this needs to be checked here</span></div><div class="line">                    ClassLoader oldCL = <span class="keyword">null</span>;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        oldCL = request.getContext().bind(<span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">                        <span class="keyword">if</span> (req.sendAllDataReadEvent()) &#123;</div><div class="line">                            req.getReadListener().onAllDataRead();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        request.getContext().unbind(<span class="keyword">false</span>, oldCL);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                Throwable throwable =</div><div class="line">                        (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</div><div class="line"></div><div class="line">                <span class="comment">// If an async request was started, is not going to end once</span></div><div class="line">                <span class="comment">// this container thread finishes and an error occurred, trigger</span></div><div class="line">                <span class="comment">// the async error process</span></div><div class="line">                <span class="keyword">if</span> (!request.isAsyncCompleting() &amp;&amp; throwable != <span class="keyword">null</span>) &#123;</div><div class="line">                    request.getAsyncContextInternal().setErrorState(throwable, <span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!comet) &#123;</div><div class="line">                request.finishRequest();</div><div class="line">                response.finishResponse();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="comment">// Ignore</span></div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// Access log</span></div><div class="line">            <span class="keyword">if</span> (!async &amp;&amp; !comet) &#123;</div><div class="line">                <span class="keyword">if</span> (postParseSuccess) &#123;</div><div class="line">                    <span class="comment">// Log only if processing was invoked.</span></div><div class="line">                    <span class="comment">// If postParseRequest() failed, it has already logged it.</span></div><div class="line">                    <span class="comment">// If context is null this was the start of a comet request</span></div><div class="line">                    <span class="comment">// that failed and has already been logged.</span></div><div class="line">                    request.getMappingData().context.logAccess(</div><div class="line">                            request, response,</div><div class="line">                            System.currentTimeMillis() - req.getStartTime(),</div><div class="line">                            <span class="keyword">false</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            req.getRequestProcessor().setWorkerThreadName(<span class="keyword">null</span>);</div><div class="line">            AtomicBoolean error = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">            res.action(ActionCode.IS_ERROR, error);</div><div class="line"></div><div class="line">            <span class="comment">// Recycle the wrapper request and response</span></div><div class="line">            <span class="keyword">if</span> (!comet &amp;&amp; !async || error.get()) &#123;</div><div class="line">                request.recycle();</div><div class="line">                response.recycle();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Clear converters so that the minimum amount of memory</span></div><div class="line">                <span class="comment">// is used by this processor</span></div><div class="line">                request.clearEncoders();</div><div class="line">                response.clearEncoders();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上述代码可以看出，CoyoteAdapter的service方法的执行步骤如下：</p>
<ol>
<li>创建Request与Response对象并且关联起来；</li>
<li>调用postParseRequest方法（见代码清单10）对请求进行解析；//postParseSuccess = postParseRequest(req, request, res, response);  </li>
<li>将真正的请求处理交给Engine的Pipeline去处理，代码：connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);//开始调用Tomcat的容器，首先调用StandardEngine容器中管道Pipeline中的第一个Valve,传入connector.Request和connector.Response</li>
<li>完成此次请求 // request.finishRequest();  </li>
<li>完成此次响应,并提交响应信息,如果response已经提交则直接返回，否则提交response  // response.finishResponse();  </li>
</ol>
<p>其中postParseRequest()方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Perform the necessary processing after the HTTP headers have been parsed</div><div class="line">     * to enable the request/response pair to be passed to the start of the</div><div class="line">     * container pipeline for processing.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> req      The coyote request object</div><div class="line">     * <span class="doctag">@param</span> request  The catalina request object</div><div class="line">     * <span class="doctag">@param</span> res      The coyote response object</div><div class="line">     * <span class="doctag">@param</span> response The catalina response object</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> &lt;code&gt;true&lt;/code&gt; if the request should be passed on to the start</div><div class="line">     *         of the container pipeline, otherwise &lt;code&gt;false&lt;/code&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@throws</span> IOException If there is insufficient space in a buffer while</div><div class="line">     *                     processing headers</div><div class="line">     * <span class="doctag">@throws</span> ServletException If the supported methods of the target servlet</div><div class="line">     *                          can not be determined</div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">postParseRequest</span><span class="params">(org.apache.coyote.Request req, Request request,</span></span></div><div class="line">            org.apache.coyote.Response res, Response response) <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// If the processor has set the scheme (AJP will do this) use this to</span></div><div class="line">        <span class="comment">// set the secure flag as well. If the processor hasn't set it, use the</span></div><div class="line">        <span class="comment">// settings from the connector</span></div><div class="line">        <span class="keyword">if</span> (! req.scheme().isNull()) &#123;</div><div class="line">            <span class="comment">// use processor specified scheme to determine secure state</span></div><div class="line">            request.setSecure(req.scheme().equals(<span class="string">"https"</span>));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// use connector scheme and secure configuration, (defaults to</span></div><div class="line">            <span class="comment">// "http" and false respectively)</span></div><div class="line">            req.scheme().setString(connector.getScheme());</div><div class="line">            request.setSecure(connector.getSecure());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// At this point the Host header has been processed.</span></div><div class="line">        <span class="comment">// Override if the proxyPort/proxyHost are set</span></div><div class="line">        String proxyName = connector.getProxyName();</div><div class="line">        <span class="keyword">int</span> proxyPort = connector.getProxyPort();</div><div class="line">        <span class="keyword">if</span> (proxyPort != <span class="number">0</span>) &#123;</div><div class="line">            req.setServerPort(proxyPort);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (proxyName != <span class="keyword">null</span>) &#123;</div><div class="line">            req.serverName().setString(proxyName);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        MessageBytes undecodedURI = req.requestURI();</div><div class="line"></div><div class="line">        <span class="comment">// Check for ping OPTIONS * request</span></div><div class="line">        <span class="keyword">if</span> (undecodedURI.equals(<span class="string">"*"</span>)) &#123;</div><div class="line">            <span class="keyword">if</span> (req.method().equalsIgnoreCase(<span class="string">"OPTIONS"</span>)) &#123;</div><div class="line">                StringBuilder allow = <span class="keyword">new</span> StringBuilder();</div><div class="line">                allow.append(<span class="string">"GET, HEAD, POST, PUT, DELETE"</span>);</div><div class="line">                <span class="comment">// Trace if allowed</span></div><div class="line">                <span class="keyword">if</span> (connector.getAllowTrace()) &#123;</div><div class="line">                    allow.append(<span class="string">", TRACE"</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Always allow options</span></div><div class="line">                allow.append(<span class="string">", OPTIONS"</span>);</div><div class="line">                res.setHeader(<span class="string">"Allow"</span>, allow.toString());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                res.setStatus(<span class="number">404</span>);</div><div class="line">                res.setMessage(<span class="string">"Not found"</span>);</div><div class="line">            &#125;</div><div class="line">            connector.getService().getContainer().logAccess(</div><div class="line">                    request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        MessageBytes decodedURI = req.decodedURI();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (undecodedURI.getType() == MessageBytes.T_BYTES) &#123;</div><div class="line">            <span class="comment">// Copy the raw URI to the decodedURI</span></div><div class="line">            decodedURI.duplicate(undecodedURI);</div><div class="line"></div><div class="line">            <span class="comment">// Parse the path parameters. This will:</span></div><div class="line">            <span class="comment">//   - strip out the path parameters</span></div><div class="line">            <span class="comment">//   - convert the decodedURI to bytes</span></div><div class="line">            parsePathParameters(req, request);</div><div class="line"></div><div class="line">            <span class="comment">// URI decoding</span></div><div class="line">            <span class="comment">// %xx decoding of the URL</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                req.getURLDecoder().convert(decodedURI, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</div><div class="line">                res.setStatus(<span class="number">400</span>);</div><div class="line">                res.setMessage(<span class="string">"Invalid URI: "</span> + ioe.getMessage());</div><div class="line">                connector.getService().getContainer().logAccess(</div><div class="line">                        request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Normalization</span></div><div class="line">            <span class="keyword">if</span> (!normalize(req.decodedURI())) &#123;</div><div class="line">                res.setStatus(<span class="number">400</span>);</div><div class="line">                res.setMessage(<span class="string">"Invalid URI"</span>);</div><div class="line">                connector.getService().getContainer().logAccess(</div><div class="line">                        request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Character decoding</span></div><div class="line">            convertURI(decodedURI, request);</div><div class="line">            <span class="comment">// Check that the URI is still normalized</span></div><div class="line">            <span class="keyword">if</span> (!checkNormalize(req.decodedURI())) &#123;</div><div class="line">                res.setStatus(<span class="number">400</span>);</div><div class="line">                res.setMessage(<span class="string">"Invalid URI character encoding"</span>);</div><div class="line">                connector.getService().getContainer().logAccess(</div><div class="line">                        request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">/* The URI is chars or String, and has been sent using an in-memory</span></div><div class="line">             * protocol handler. The following assumptions are made:</div><div class="line">             * - req.requestURI() has been set to the 'original' non-decoded,</div><div class="line">             *   non-normalized URI</div><div class="line">             * - req.decodedURI() has been set to the decoded, normalized form</div><div class="line">             *   of req.requestURI()</div><div class="line">             */</div><div class="line">            decodedURI.toChars();</div><div class="line">            <span class="comment">// Remove all path parameters; any needed path parameter should be set</span></div><div class="line">            <span class="comment">// using the request object rather than passing it in the URL</span></div><div class="line">            CharChunk uriCC = decodedURI.getCharChunk();</div><div class="line">            <span class="keyword">int</span> semicolon = uriCC.indexOf(<span class="string">';'</span>);</div><div class="line">            <span class="keyword">if</span> (semicolon &gt; <span class="number">0</span>) &#123;</div><div class="line">                decodedURI.setChars</div><div class="line">                    (uriCC.getBuffer(), uriCC.getStart(), semicolon);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Request mapping.</span></div><div class="line">        MessageBytes serverName;</div><div class="line">        <span class="keyword">if</span> (connector.getUseIPVHosts()) &#123;</div><div class="line">            serverName = req.localName();</div><div class="line">            <span class="keyword">if</span> (serverName.isNull()) &#123;</div><div class="line">                <span class="comment">// well, they did ask for it</span></div><div class="line">                res.action(ActionCode.REQ_LOCAL_NAME_ATTRIBUTE, <span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            serverName = req.serverName();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Version for the second mapping loop and</span></div><div class="line">        <span class="comment">// Context that we expect to get for that version</span></div><div class="line">        String version = <span class="keyword">null</span>;</div><div class="line">        Context versionContext = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">boolean</span> mapRequired = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (mapRequired) &#123;</div><div class="line">            <span class="comment">// This will map the the latest version by default</span></div><div class="line">            connector.getService().getMapper().map(serverName, decodedURI,</div><div class="line">                    version, request.getMappingData());</div><div class="line"></div><div class="line">            <span class="comment">// If there is no context at this point, it is likely no ROOT context</span></div><div class="line">            <span class="comment">// has been deployed</span></div><div class="line">            <span class="keyword">if</span> (request.getContext() == <span class="keyword">null</span>) &#123;</div><div class="line">                res.setStatus(<span class="number">404</span>);</div><div class="line">                res.setMessage(<span class="string">"Not found"</span>);</div><div class="line">                <span class="comment">// No context, so use host</span></div><div class="line">                Host host = request.getHost();</div><div class="line">                <span class="comment">// Make sure there is a host (might not be during shutdown)</span></div><div class="line">                <span class="keyword">if</span> (host != <span class="keyword">null</span>) &#123;</div><div class="line">                    host.logAccess(request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Now we have the context, we can parse the session ID from the URL</span></div><div class="line">            <span class="comment">// (if any). Need to do this before we redirect in case we need to</span></div><div class="line">            <span class="comment">// include the session id in the redirect</span></div><div class="line">            String sessionID;</div><div class="line">            <span class="keyword">if</span> (request.getServletContext().getEffectiveSessionTrackingModes()</div><div class="line">                    .contains(SessionTrackingMode.URL)) &#123;</div><div class="line"></div><div class="line">                <span class="comment">// Get the session ID if there was one</span></div><div class="line">                sessionID = request.getPathParameter(</div><div class="line">                        SessionConfig.getSessionUriParamName(</div><div class="line">                                request.getContext()));</div><div class="line">                <span class="keyword">if</span> (sessionID != <span class="keyword">null</span>) &#123;</div><div class="line">                    request.setRequestedSessionId(sessionID);</div><div class="line">                    request.setRequestedSessionURL(<span class="keyword">true</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Look for session ID in cookies and SSL session</span></div><div class="line">            parseSessionCookiesId(request);</div><div class="line">            parseSessionSslId(request);</div><div class="line"></div><div class="line">            sessionID = request.getRequestedSessionId();</div><div class="line"></div><div class="line">            mapRequired = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (version != <span class="keyword">null</span> &amp;&amp; request.getContext() == versionContext) &#123;</div><div class="line">                <span class="comment">// We got the version that we asked for. That is it.</span></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                version = <span class="keyword">null</span>;</div><div class="line">                versionContext = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                Context[] contexts = request.getMappingData().contexts;</div><div class="line">                <span class="comment">// Single contextVersion means no need to remap</span></div><div class="line">                <span class="comment">// No session ID means no possibility of remap</span></div><div class="line">                <span class="keyword">if</span> (contexts != <span class="keyword">null</span> &amp;&amp; sessionID != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// Find the context associated with the session</span></div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = (contexts.length); i &gt; <span class="number">0</span>; i--) &#123;</div><div class="line">                        Context ctxt = contexts[i - <span class="number">1</span>];</div><div class="line">                        <span class="keyword">if</span> (ctxt.getManager().findSession(sessionID) != <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="comment">// We found a context. Is it the one that has</span></div><div class="line">                            <span class="comment">// already been mapped?</span></div><div class="line">                            <span class="keyword">if</span> (!ctxt.equals(request.getMappingData().context)) &#123;</div><div class="line">                                <span class="comment">// Set version so second time through mapping</span></div><div class="line">                                <span class="comment">// the correct context is found</span></div><div class="line">                                version = ctxt.getWebappVersion();</div><div class="line">                                versionContext = ctxt;</div><div class="line">                                <span class="comment">// Reset mapping</span></div><div class="line">                                request.getMappingData().recycle();</div><div class="line">                                mapRequired = <span class="keyword">true</span>;</div><div class="line">                                <span class="comment">// Recycle cookies and session info in case the</span></div><div class="line">                                <span class="comment">// correct context is configured with different</span></div><div class="line">                                <span class="comment">// settings</span></div><div class="line">                                request.recycleSessionInfo();</div><div class="line">                                request.recycleCookieInfo(<span class="keyword">true</span>);</div><div class="line">                            &#125;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!mapRequired &amp;&amp; request.getContext().getPaused()) &#123;</div><div class="line">                <span class="comment">// Found a matching context but it is paused. Mapping data will</span></div><div class="line">                <span class="comment">// be wrong since some Wrappers may not be registered at this</span></div><div class="line">                <span class="comment">// point.</span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">1000</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    <span class="comment">// Should never happen</span></div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Reset mapping</span></div><div class="line">                request.getMappingData().recycle();</div><div class="line">                mapRequired = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Possible redirect</span></div><div class="line">        MessageBytes redirectPathMB = request.getMappingData().redirectPath;</div><div class="line">        <span class="keyword">if</span> (!redirectPathMB.isNull()) &#123;</div><div class="line">            String redirectPath = URLEncoder.DEFAULT.encode(redirectPathMB.toString(), <span class="string">"UTF-8"</span>);</div><div class="line">            String query = request.getQueryString();</div><div class="line">            <span class="keyword">if</span> (request.isRequestedSessionIdFromURL()) &#123;</div><div class="line">                <span class="comment">// This is not optimal, but as this is not very common, it</span></div><div class="line">                <span class="comment">// shouldn't matter</span></div><div class="line">                redirectPath = redirectPath + <span class="string">";"</span> +</div><div class="line">                        SessionConfig.getSessionUriParamName(</div><div class="line">                            request.getContext()) +</div><div class="line">                    <span class="string">"="</span> + request.getRequestedSessionId();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (query != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// This is not optimal, but as this is not very common, it</span></div><div class="line">                <span class="comment">// shouldn't matter</span></div><div class="line">                redirectPath = redirectPath + <span class="string">"?"</span> + query;</div><div class="line">            &#125;</div><div class="line">            response.sendRedirect(redirectPath);</div><div class="line">            request.getContext().logAccess(request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Filter trace method</span></div><div class="line">        <span class="keyword">if</span> (!connector.getAllowTrace()</div><div class="line">                &amp;&amp; req.method().equalsIgnoreCase(<span class="string">"TRACE"</span>)) &#123;</div><div class="line">            Wrapper wrapper = request.getWrapper();</div><div class="line">            String header = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (wrapper != <span class="keyword">null</span>) &#123;</div><div class="line">                String[] methods = wrapper.getServletMethods();</div><div class="line">                <span class="keyword">if</span> (methods != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;methods.length; i++) &#123;</div><div class="line">                        <span class="keyword">if</span> (<span class="string">"TRACE"</span>.equals(methods[i])) &#123;</div><div class="line">                            <span class="keyword">continue</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (header == <span class="keyword">null</span>) &#123;</div><div class="line">                            header = methods[i];</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            header += <span class="string">", "</span> + methods[i];</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            res.setStatus(<span class="number">405</span>);</div><div class="line">            res.addHeader(<span class="string">"Allow"</span>, header);</div><div class="line">            res.setMessage(<span class="string">"TRACE method is not allowed"</span>);</div><div class="line">            request.getContext().logAccess(request, response, <span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        doConnectorAuthenticationAuthorization(req, request);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从上述代码可以看出，postParseRequest方法的执行步骤如下：</p>
<ol>
<li>解析请求url中的参数；</li>
<li>URI decoding的转换（为了保证URL的可移植、完整性、可读性，通过ASCII字符集的有限子集对任意字符或数据进行编码、解码）；</li>
<li>调用normalize方法判断请求路径中是否存在”\”, “//“, “/./“和”/../“，如果存在则处理结束；</li>
<li>调用convertURI方法将字节转换为字符；</li>
<li>调用checkNormalize方法判断uri是否存在”\”, “//“, “/./“和”/../“，如果存在则处理结束；</li>
<li>调用Connector的getMapper方法获取Mapper，然后调用Mapper的map方法（见代码清单11）对host和context进行匹配（比如<a href="http://localhost:8080/manager/status会匹配host：localhost，context：/manager），其实质是调用internalMap方法；" target="_blank" rel="external">http://localhost:8080/manager/status会匹配host：localhost，context：/manager），其实质是调用internalMap方法；</a></li>
<li>使用ApplicationSessionCookieConfig.getSessionUriParamName获取sessionid的key，然后获取sessionid；</li>
<li>调用parseSessionCookiesId和parseSessionSslId方法查找cookie或者SSL中的sessionid。</li>
</ol>
<p>现在回到CoyoteAdapter的service方法执行的第三步 3. 将真正的请求处理交给Engine的Pipeline去处理，代码：connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);//开始调用Tomcat的容器，首先调用StandardEngine容器中管道Pipeline中的第一个Valve,传入connector.Request和connector.Response</p>
<p>下面介绍一下管道：</p>
<p>管道</p>
<p>在Tomcat中管道Pipeline是一个接口，定义了使得一组阀门Valve按照顺序执行的规范，Pipeline中定义的接口如下：<br><img src="http://i.imgur.com/N2yZT8t.png" alt=""></p>
<ul>
<li>getBasic：获取管道的基础阀门；</li>
<li>setBasic：设置管道的基础阀门；</li>
<li>addValve：添加阀门；</li>
<li>getValves：获取阀门集合；</li>
<li>removeValve：移除阀门；</li>
<li>getFirst：获取第一个阀门；</li>
<li>isAsyncSupported：当管道中的所有阀门都支持异步时返回ture，否则返回false；</li>
<li>getContainer：获取管道相关联的容器，比如StandardEngine；</li>
<li>setContainer：设置管道相关联的容器。</li>
</ul>
<p>Engine、Host、Context及Wrapper等容器都定义了自身的Pipeline，每个Pipeline都包含一到多个Valve。Valve定义了各个阀门的接口规范，其类继承体系如图所示。</p>
<p><img src="http://i.imgur.com/ebCzPSy.png" alt=""></p>
<ul>
<li>Valve：定义了管道中阀门的接口规范，getNext和setNext分别用于获取或者设置当前阀门的下游阀门，invoke方法用来应用当前阀门的操作。</li>
<li>ValveBase：Valve接口的基本实现，ValveBase与Valve的具体实现采用抽象模板模式将管道中的阀门串联起来。</li>
<li>StandardEngineValve：StandardEngine中的唯一阀门，主要用于从request中选择其host映射的Host容器StandardHost。</li>
<li>AccessLogValve：StandardHost中的第一个阀门，主要用于管道执行结束之后记录日志信息。</li>
<li>ErrorReportValve：StandardHost中紧跟AccessLogValve的阀门，主要用于管道执行结束后，从request对象中获取异常信息，并封装到response中以便将问题展现给访问者。</li>
<li>StandardHostValve：StandardHost中最后的阀门，主要用于从request中选择其context映射的Context容器StandardContext以及访问request中的Session以更新会话的最后访问时间。</li>
<li>StandardContextValve：StandardContext中的唯一阀门，主要作用是禁止任何对WEB-INF或META-INF目录下资源的重定向访问，对应用程序热部署功能的实现，从request中获得StandardWrapper。</li>
<li>StandardWrapperValve：StandardWrapper中的唯一阀门，主要作用包括调用StandardWrapper的loadServlet方法生成Servlet实例和调用ApplicationFilterFactory生成Filter链。</li>
</ul>
<p>有了以上对Tomcat的管道设计的讲述，我们下面详细剖析其实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</div></pre></td></tr></table></figure>
<p>getContainer方法获取到的实际是StandardService中的StandardEngine容器,StandardEngine继承自ContainerBase，所以这里的getPipeline方法实际是ContainerBase实现的.</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Pipeline pipeline =  </div><div class="line">    CatalinaFactory.getFactory().createPipeline(<span class="keyword">this</span>);  </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Pipeline <span class="title">getPipeline</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>.pipeline);  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的CatalinaFactory采用单例模式实现，要获取CatalinaFactory实例，只能通过调用getFactory方法，见代码清单2。createPipeline方法中创建了StandardPipeline，StandardPipeline是Pipeline的标准实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CatalinaFactory</span> </span>&#123;  </div><div class="line">      </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CatalinaFactory factory = <span class="keyword">new</span> CatalinaFactory();  </div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CatalinaFactory <span class="title">getFactory</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> factory;  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">CatalinaFactory</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="comment">// Hide the default constructor  </span></div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDefaultPipelineClassName</span><span class="params">()</span> </span>&#123;  </div><div class="line">        <span class="keyword">return</span> StandardPipeline.class.getName();  </div><div class="line">    &#125;  </div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> Pipeline <span class="title">createPipeline</span><span class="params">(Container container)</span> </span>&#123;  </div><div class="line">        Pipeline pipeline = <span class="keyword">new</span> StandardPipeline();  </div><div class="line">        pipeline.setContainer(container);  </div><div class="line">        <span class="keyword">return</span> pipeline;  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码清单1随后调用了StandardPipeline的getFirst方法（见代码清单3）用来获取管道中的第一个Valve ，由于Tomcat并没有为StandardEngine的StandardPipeline设置first，因此将返回StandardPipeline的basic。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Valve <span class="title">getFirst</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>) &#123;  </div><div class="line">        <span class="keyword">return</span> first;  </div><div class="line">    &#125;  </div><div class="line">      </div><div class="line">    <span class="keyword">return</span> basic;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码清单3中的basic的类型是StandardEngineValve，那么它是何时添加到StandardEngine的StandardPipeline中的呢？还记得《server.xml文件的加载与解析》中介绍过的ObjectCreateRule？在执行ObjectCreateRule的begin方法时，会反射调用StandardEngine的构造器生成StandardEngine的实例，StandardEngine的构造器中就会给其StandardPipeline设置basic为StandardEngineValve</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Create a new StandardEngine component with the default basic Valve. </div><div class="line"> */  </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">StandardEngine</span><span class="params">()</span> </span>&#123;  </div><div class="line">  </div><div class="line">    <span class="keyword">super</span>();  </div><div class="line">    pipeline.setBasic(<span class="keyword">new</span> StandardEngineValve());  </div><div class="line">    <span class="comment">/* Set the jmvRoute using the system property jvmRoute */</span>  </div><div class="line">    <span class="keyword">try</span> &#123;  </div><div class="line">        setJvmRoute(System.getProperty(<span class="string">"jvmRoute"</span>));  </div><div class="line">    &#125; <span class="keyword">catch</span>(Exception ex) &#123;  </div><div class="line">    &#125;  </div><div class="line">    <span class="comment">// By default, the engine will hold the reloading thread  </span></div><div class="line">    backgroundProcessorDelay = <span class="number">10</span>;  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代码清单1中最后调用了StandardEngineValve的invoke方法（见代码清单5）正式将请求交给管道处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Select the appropriate child Host to process this request,</div><div class="line">     * based on the requested server name.  If no matching Host can</div><div class="line">     * be found, return an appropriate HTTP error.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request Request to be processed</div><div class="line">     * <span class="doctag">@param</span> response Response to be produced</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> IOException if an input/output error occurred</div><div class="line">     * <span class="doctag">@exception</span> ServletException if a servlet error occurred</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Select the Host to be used for this Request</span></div><div class="line">        Host host = request.getHost();</div><div class="line">        <span class="keyword">if</span> (host == <span class="keyword">null</span>) &#123;</div><div class="line">            response.sendError</div><div class="line">                (HttpServletResponse.SC_BAD_REQUEST,</div><div class="line">                 sm.getString(<span class="string">"standardEngine.noHost"</span>,</div><div class="line">                              request.getServerName()));</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</div><div class="line">            request.setAsyncSupported(host.getPipeline().isAsyncSupported());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Ask this Host to process this request</span></div><div class="line">        host.getPipeline().getFirst().invoke(request, response);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上述代码首先调用request的getHost方法（实质是通过request映射的Context容器获取父容器得到，获取Host容器，</p>
<p>StandardHost默认情况下配置了ErrorReportValve阀门与StandardHostValue阀门。ErrorReportValve用于处理错误日志。StandardHostValue则选择相应的Context容器，并且把当前Web应用的WebappClassLoader设置为线程上下文类加载器，保证我们的Web应用中拿到的当前线程类加载器为此应用的类加载器， StandardHostValve的invoke()方法的核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Select the appropriate child Context to process this request,</div><div class="line">     * based on the specified request URI.  If no matching Context can</div><div class="line">     * be found, return an appropriate HTTP error.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request Request to be processed</div><div class="line">     * <span class="doctag">@param</span> response Response to be produced</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> IOException if an input/output error occurred</div><div class="line">     * <span class="doctag">@exception</span> ServletException if a servlet error occurred</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Select the Context to be used for this Request</span></div><div class="line">        Context context = request.getContext();</div><div class="line">        <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</div><div class="line">            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR,</div><div class="line">                 sm.getString(<span class="string">"standardHost.noContext"</span>));</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</div><div class="line">            request.setAsyncSupported(context.getPipeline().isAsyncSupported());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> asyncAtStart = request.isAsync();</div><div class="line">        <span class="keyword">boolean</span> asyncDispatching = request.isAsyncDispatching();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            context.bind(Globals.IS_SECURITY_ENABLED, MY_CLASSLOADER);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!asyncAtStart &amp;&amp; !context.fireRequestInitEvent(request)) &#123;</div><div class="line">                <span class="comment">// Don't fire listeners during async processing (the listener</span></div><div class="line">                <span class="comment">// fired for the request that called startAsync()).</span></div><div class="line">                <span class="comment">// If a request init listener throws an exception, the request</span></div><div class="line">                <span class="comment">// is aborted.</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Ask this Context to process this request. Requests that are in</span></div><div class="line">            <span class="comment">// async mode and are not being dispatched to this resource must be</span></div><div class="line">            <span class="comment">// in error and have been routed here to check for application</span></div><div class="line">            <span class="comment">// defined error pages.</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (!asyncAtStart || asyncDispatching) &#123;</div><div class="line">                    context.getPipeline().getFirst().invoke(request, response);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Make sure this request/response is here because an error</span></div><div class="line">                    <span class="comment">// report is required.</span></div><div class="line">                    <span class="keyword">if</span> (!response.isErrorReportRequired()) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(sm.getString(<span class="string">"standardHost.asyncStateError"</span>));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                ExceptionUtils.handleThrowable(t);</div><div class="line">                container.getLogger().error(<span class="string">"Exception Processing "</span> + request.getRequestURI(), t);</div><div class="line">                <span class="comment">// If a new error occurred while trying to report a previous</span></div><div class="line">                <span class="comment">// error allow the original error to be reported.</span></div><div class="line">                <span class="keyword">if</span> (!response.isErrorReportRequired()) &#123;</div><div class="line">                    request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, t);</div><div class="line">                    throwable(request, response, t);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Now that the request/response pair is back under container</span></div><div class="line">            <span class="comment">// control lift the suspension so that the error handling can</span></div><div class="line">            <span class="comment">// complete and/or the container can flush any remaining data</span></div><div class="line">            response.setSuspended(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">            Throwable t = (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</div><div class="line"></div><div class="line">            <span class="comment">// Protect against NPEs if the context was destroyed during a</span></div><div class="line">            <span class="comment">// long running request.</span></div><div class="line">            <span class="keyword">if</span> (!context.getState().isAvailable()) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Look for (and render if found) an application level error page</span></div><div class="line">            <span class="keyword">if</span> (response.isErrorReportRequired()) &#123;</div><div class="line">                <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</div><div class="line">                    throwable(request, response, t);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    status(request, response);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!request.isAsync() &amp;&amp; (!asyncAtStart || !response.isErrorReportRequired())) &#123;</div><div class="line">                context.fireRequestDestroyEvent(request);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// Access a session (if present) to update last accessed time, based</span></div><div class="line">            <span class="comment">// on a strict interpretation of the specification</span></div><div class="line">            <span class="keyword">if</span> (ACCESS_SESSION) &#123;</div><div class="line">                request.getSession(<span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            context.unbind(Globals.IS_SECURITY_ENABLED, MY_CLASSLOADER);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上述代码主要执行以下步骤：</p>
<ol>
<li><p>得到此次请求所对应的StandardContext容器//Context context = request.getContext();</p>
</li>
<li><p>调用StandardContext容器中管道Pipeline中的第一个Valve//context.getPipeline().getFirst().invoke(request, response);</p>
</li>
</ol>
<p>StandardContext默认情况下配置了StandardContextValve阀门。对于WEB-INF与META-INF目录禁止访问的控制，之后获取一个此请求的Wrapper容器， StandardContextValve的invoke()方法核核心代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Select the appropriate child Wrapper to process this request,</div><div class="line">     * based on the specified request URI.  If no matching Wrapper can</div><div class="line">     * be found, return an appropriate HTTP error.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request Request to be processed</div><div class="line">     * <span class="doctag">@param</span> response Response to be produced</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> IOException if an input/output error occurred</div><div class="line">     * <span class="doctag">@exception</span> ServletException if a servlet error occurred</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Disallow any direct access to resources under WEB-INF or META-INF</span></div><div class="line">        MessageBytes requestPathMB = request.getRequestPathMB();</div><div class="line">        <span class="keyword">if</span> ((requestPathMB.startsWithIgnoreCase(<span class="string">"/META-INF/"</span>, <span class="number">0</span>))</div><div class="line">                || (requestPathMB.equalsIgnoreCase(<span class="string">"/META-INF"</span>))</div><div class="line">                || (requestPathMB.startsWithIgnoreCase(<span class="string">"/WEB-INF/"</span>, <span class="number">0</span>))</div><div class="line">                || (requestPathMB.equalsIgnoreCase(<span class="string">"/WEB-INF"</span>))) &#123;</div><div class="line">            response.sendError(HttpServletResponse.SC_NOT_FOUND);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Select the Wrapper to be used for this Request</span></div><div class="line">        Wrapper wrapper = request.getWrapper();</div><div class="line">        <span class="keyword">if</span> (wrapper == <span class="keyword">null</span> || wrapper.isUnavailable()) &#123;</div><div class="line">            response.sendError(HttpServletResponse.SC_NOT_FOUND);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Acknowledge the request</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            response.sendAcknowledgement();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</div><div class="line">            container.getLogger().error(sm.getString(</div><div class="line">                    <span class="string">"standardContextValve.acknowledgeException"</span>), ioe);</div><div class="line">            request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, ioe);</div><div class="line">            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</div><div class="line">            request.setAsyncSupported(wrapper.getPipeline().isAsyncSupported());</div><div class="line">        &#125;</div><div class="line">        wrapper.getPipeline().getFirst().invoke(request, response);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>得到此请求所对应的StandardWrapper容器</li>
<li>调用StandardWrapper容器中管道Pipeline中第一个Valve的invoke()方法</li>
</ol>
<p>StandardWrapper容器默认情况下配置了StandardWrapperValve阀门，主要是找到当前请求的需要拦截的过滤器Filter及初始化当前请求的Servlet对象，最终会封装在FilterChain对象中，责任链方式执行， StandardWrapperValve的invoke()方法的核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Invoke the servlet we are managing, respecting the rules regarding</div><div class="line">     * servlet lifecycle and SingleThreadModel support.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request Request to be processed</div><div class="line">     * <span class="doctag">@param</span> response Response to be produced</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> IOException if an input/output error occurred</div><div class="line">     * <span class="doctag">@exception</span> ServletException if a servlet error occurred</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Initialize local variables we may need</span></div><div class="line">        <span class="keyword">boolean</span> unavailable = <span class="keyword">false</span>;</div><div class="line">        Throwable throwable = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// This should be a Request attribute...</span></div><div class="line">        <span class="keyword">long</span> t1=System.currentTimeMillis();</div><div class="line">        requestCount.incrementAndGet();</div><div class="line">        StandardWrapper wrapper = (StandardWrapper) getContainer();</div><div class="line">        Servlet servlet = <span class="keyword">null</span>;</div><div class="line">        Context context = (Context) wrapper.getParent();</div><div class="line"></div><div class="line">        <span class="comment">// Check for the application being marked unavailable</span></div><div class="line">        <span class="keyword">if</span> (!context.getState().isAvailable()) &#123;</div><div class="line">            response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</div><div class="line">                           sm.getString(<span class="string">"standardContext.isUnavailable"</span>));</div><div class="line">            unavailable = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Check for the servlet being marked unavailable</span></div><div class="line">        <span class="keyword">if</span> (!unavailable &amp;&amp; wrapper.isUnavailable()) &#123;</div><div class="line">            container.getLogger().info(sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</div><div class="line">                    wrapper.getName()));</div><div class="line">            <span class="keyword">long</span> available = wrapper.getAvailable();</div><div class="line">            <span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</div><div class="line">                response.setDateHeader(<span class="string">"Retry-After"</span>, available);</div><div class="line">                response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</div><div class="line">                        sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</div><div class="line">                                wrapper.getName()));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</div><div class="line">                response.sendError(HttpServletResponse.SC_NOT_FOUND,</div><div class="line">                        sm.getString(<span class="string">"standardWrapper.notFound"</span>,</div><div class="line">                                wrapper.getName()));</div><div class="line">            &#125;</div><div class="line">            unavailable = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Allocate a servlet instance to process this request</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (!unavailable) &#123;</div><div class="line">                servlet = wrapper.allocate();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (UnavailableException e) &#123;</div><div class="line">            container.getLogger().error(</div><div class="line">                    sm.getString(<span class="string">"standardWrapper.allocateException"</span>,</div><div class="line">                            wrapper.getName()), e);</div><div class="line">            <span class="keyword">long</span> available = wrapper.getAvailable();</div><div class="line">            <span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</div><div class="line">                response.setDateHeader(<span class="string">"Retry-After"</span>, available);</div><div class="line">                response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</div><div class="line">                           sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</div><div class="line">                                        wrapper.getName()));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</div><div class="line">                response.sendError(HttpServletResponse.SC_NOT_FOUND,</div><div class="line">                           sm.getString(<span class="string">"standardWrapper.notFound"</span>,</div><div class="line">                                        wrapper.getName()));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">            container.getLogger().error(sm.getString(<span class="string">"standardWrapper.allocateException"</span>,</div><div class="line">                             wrapper.getName()), StandardWrapper.getRootCause(e));</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(e);</div><div class="line">            container.getLogger().error(sm.getString(<span class="string">"standardWrapper.allocateException"</span>,</div><div class="line">                             wrapper.getName()), e);</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">            servlet = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Identify if the request is Comet related now that the servlet has been allocated</span></div><div class="line">        <span class="keyword">boolean</span> comet = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">if</span> (servlet <span class="keyword">instanceof</span> CometProcessor &amp;&amp; Boolean.TRUE.equals(request.getAttribute(</div><div class="line">                Globals.COMET_SUPPORTED_ATTR))) &#123;</div><div class="line">            comet = <span class="keyword">true</span>;</div><div class="line">            request.setComet(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        MessageBytes requestPathMB = request.getRequestPathMB();</div><div class="line">        DispatcherType dispatcherType = DispatcherType.REQUEST;</div><div class="line">        <span class="keyword">if</span> (request.getDispatcherType()==DispatcherType.ASYNC) dispatcherType = DispatcherType.ASYNC;</div><div class="line">        request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,dispatcherType);</div><div class="line">        request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,</div><div class="line">                requestPathMB);</div><div class="line">        <span class="comment">// Create the filter chain for this request</span></div><div class="line">        ApplicationFilterChain filterChain =</div><div class="line">                ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</div><div class="line"></div><div class="line">        <span class="comment">// Call the filter chain for this request</span></div><div class="line">        <span class="comment">// <span class="doctag">NOTE:</span> This also calls the servlet's service() method</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> ((servlet != <span class="keyword">null</span>) &amp;&amp; (filterChain != <span class="keyword">null</span>)) &#123;</div><div class="line">                <span class="comment">// Swallow output if needed</span></div><div class="line">                <span class="keyword">if</span> (context.getSwallowOutput()) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        SystemLogHandler.startCapture();</div><div class="line">                        <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</div><div class="line">                            request.getAsyncContextInternal().doInternalDispatch();</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (comet) &#123;</div><div class="line">                            filterChain.doFilterEvent(request.getEvent());</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            filterChain.doFilter(request.getRequest(),</div><div class="line">                                    response.getResponse());</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                        String log = SystemLogHandler.stopCapture();</div><div class="line">                        <span class="keyword">if</span> (log != <span class="keyword">null</span> &amp;&amp; log.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">                            context.getLogger().info(log);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</div><div class="line">                        request.getAsyncContextInternal().doInternalDispatch();</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (comet) &#123;</div><div class="line">                        filterChain.doFilterEvent(request.getEvent());</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        filterChain.doFilter</div><div class="line">                            (request.getRequest(), response.getResponse());</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (ClientAbortException e) &#123;</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            container.getLogger().error(sm.getString(</div><div class="line">                    <span class="string">"standardWrapper.serviceException"</span>, wrapper.getName(),</div><div class="line">                    context.getName()), e);</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (UnavailableException e) &#123;</div><div class="line">            container.getLogger().error(sm.getString(</div><div class="line">                    <span class="string">"standardWrapper.serviceException"</span>, wrapper.getName(),</div><div class="line">                    context.getName()), e);</div><div class="line">            <span class="comment">//            throwable = e;</span></div><div class="line">            <span class="comment">//            exception(request, response, e);</span></div><div class="line">            wrapper.unavailable(e);</div><div class="line">            <span class="keyword">long</span> available = wrapper.getAvailable();</div><div class="line">            <span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</div><div class="line">                response.setDateHeader(<span class="string">"Retry-After"</span>, available);</div><div class="line">                response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</div><div class="line">                           sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</div><div class="line">                                        wrapper.getName()));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</div><div class="line">                response.sendError(HttpServletResponse.SC_NOT_FOUND,</div><div class="line">                            sm.getString(<span class="string">"standardWrapper.notFound"</span>,</div><div class="line">                                        wrapper.getName()));</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Do not save exception in 'throwable', because we</span></div><div class="line">            <span class="comment">// do not want to do exception(request, response, e) processing</span></div><div class="line">        &#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">            Throwable rootCause = StandardWrapper.getRootCause(e);</div><div class="line">            <span class="keyword">if</span> (!(rootCause <span class="keyword">instanceof</span> ClientAbortException)) &#123;</div><div class="line">                container.getLogger().error(sm.getString(</div><div class="line">                        <span class="string">"standardWrapper.serviceExceptionRoot"</span>,</div><div class="line">                        wrapper.getName(), context.getName(), e.getMessage()),</div><div class="line">                        rootCause);</div><div class="line">            &#125;</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(e);</div><div class="line">            container.getLogger().error(sm.getString(</div><div class="line">                    <span class="string">"standardWrapper.serviceException"</span>, wrapper.getName(),</div><div class="line">                    context.getName()), e);</div><div class="line">            throwable = e;</div><div class="line">            exception(request, response, e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Release the filter chain (if any) for this request</span></div><div class="line">        <span class="keyword">if</span> (filterChain != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (request.isComet()) &#123;</div><div class="line">                <span class="comment">// If this is a Comet request, then the same chain will be used for the</span></div><div class="line">                <span class="comment">// processing of all subsequent events.</span></div><div class="line">                filterChain.reuse();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                filterChain.release();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Deallocate the allocated servlet instance</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (servlet != <span class="keyword">null</span>) &#123;</div><div class="line">                wrapper.deallocate(servlet);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(e);</div><div class="line">            container.getLogger().error(sm.getString(<span class="string">"standardWrapper.deallocateException"</span>,</div><div class="line">                             wrapper.getName()), e);</div><div class="line">            <span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</div><div class="line">                throwable = e;</div><div class="line">                exception(request, response, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If this servlet has been marked permanently unavailable,</span></div><div class="line">        <span class="comment">// unload it and release this instance</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> ((servlet != <span class="keyword">null</span>) &amp;&amp;</div><div class="line">                (wrapper.getAvailable() == Long.MAX_VALUE)) &#123;</div><div class="line">                wrapper.unload();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(e);</div><div class="line">            container.getLogger().error(sm.getString(<span class="string">"standardWrapper.unloadException"</span>,</div><div class="line">                             wrapper.getName()), e);</div><div class="line">            <span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</div><div class="line">                throwable = e;</div><div class="line">                exception(request, response, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">long</span> t2=System.currentTimeMillis();</div><div class="line"></div><div class="line">        <span class="keyword">long</span> time=t2-t1;</div><div class="line">        processingTime += time;</div><div class="line">        <span class="keyword">if</span>( time &gt; maxTime) maxTime=time;</div><div class="line">        <span class="keyword">if</span>( time &lt; minTime) minTime=time;</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上述代码执行过程如下：</p>
<ol>
<li>得到StandardWrapper容器  ，每个请求都会对应相应的StandardWrapper及StandardWrapperValve对象//StandardWrapper wrapper = (StandardWrapper) getContainer();  </li>
<li>得到此请求的StandardContext对象  //Context context = (Context) wrapper.getParent();  </li>
<li>得到所请求的Servlet对象//Servlet servlet = null;  </li>
<li>从StandardWrapper容器获取一个Servlet对象, Servlet对象的创建及初始化init都在这里执行//servlet = wrapper.allocate(); </li>
<li>创建ApplicationFilterFactory对象// ApplicationFilterFactory factory = ApplicationFilterFactory.getInstance()</li>
<li>创建此次请求的ApplicationFilterChain对象，并设置所请求的Servlet对象.每个请求都会创建一个ApplicationFilterChain对象,包装了所请求的Servlet对象及一系列拦截的过滤器Filter对象//ApplicationFilterChain filterChain = factory.createFilterChain(request, wrapper, servlet);  </li>
<li>调用ApplicationFilterChain的doFilter方法.传入org.apache.catalina.connector.RequestFacade及org.apache.catalina.connector.ResponseFacade对象,开始进行请求处理 //filterChain.doFilter(request.getRequest(),response.getResponse());</li>
<li>调用ApplicationFilterChain的release方法清空对Servlet、Filter的引用。</li>
<li>执行完后把Servlet实例回收到Servlet实例池  // wrapper.deallocate(servlet);  </li>
</ol>
<p>allocate 方法执行如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Allocate an initialized instance of this Servlet that is ready to have</div><div class="line">    * its &lt;code&gt;service()&lt;/code&gt; method called.  If the servlet class does</div><div class="line">    * not implement &lt;code&gt;SingleThreadModel&lt;/code&gt;, the (only) initialized</div><div class="line">    * instance may be returned immediately.  If the servlet class implements</div><div class="line">    * &lt;code&gt;SingleThreadModel&lt;/code&gt;, the Wrapper implementation must ensure</div><div class="line">    * that this instance is not allocated again until it is deallocated by a</div><div class="line">    * call to &lt;code&gt;deallocate()&lt;/code&gt;.</div><div class="line">    *</div><div class="line">    * <span class="doctag">@exception</span> ServletException if the servlet init() method threw</div><div class="line">    *  an exception</div><div class="line">    * <span class="doctag">@exception</span> ServletException if a loading error occurs</div><div class="line">    */</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> Servlet <span class="title">allocate</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line"></div><div class="line">       <span class="comment">// If we are currently unloading this servlet, throw an exception</span></div><div class="line">       <span class="keyword">if</span> (unloading) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(sm.getString(<span class="string">"standardWrapper.unloading"</span>, getName()));</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">boolean</span> newInstance = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">       <span class="comment">// If not SingleThreadedModel, return the same instance every time</span></div><div class="line">       <span class="keyword">if</span> (!singleThreadModel) &#123;</div><div class="line">           <span class="comment">// Load and initialize our instance if necessary</span></div><div class="line">           <span class="keyword">if</span> (instance == <span class="keyword">null</span> || !instanceInitialized) &#123;</div><div class="line">               <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                   <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">                       <span class="keyword">try</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">                               log.debug(<span class="string">"Allocating non-STM instance"</span>);</div><div class="line">                           &#125;</div><div class="line"></div><div class="line">                           <span class="comment">// Note: We don't know if the Servlet implements</span></div><div class="line">                           <span class="comment">// SingleThreadModel until we have loaded it.</span></div><div class="line">                           instance = loadServlet();</div><div class="line">                           newInstance = <span class="keyword">true</span>;</div><div class="line">                           <span class="keyword">if</span> (!singleThreadModel) &#123;</div><div class="line">                               <span class="comment">// For non-STM, increment here to prevent a race</span></div><div class="line">                               <span class="comment">// condition with unload. Bug 43683, test case</span></div><div class="line">                               <span class="comment">// #3</span></div><div class="line">                               countAllocated.incrementAndGet();</div><div class="line">                           &#125;</div><div class="line">                       &#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">                           <span class="keyword">throw</span> e;</div><div class="line">                       &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                           ExceptionUtils.handleThrowable(e);</div><div class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(sm.getString(<span class="string">"standardWrapper.allocate"</span>), e);</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">if</span> (!instanceInitialized) &#123;</div><div class="line">                       initServlet(instance);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (singleThreadModel) &#123;</div><div class="line">               <span class="keyword">if</span> (newInstance) &#123;</div><div class="line">                   <span class="comment">// Have to do this outside of the sync above to prevent a</span></div><div class="line">                   <span class="comment">// possible deadlock</span></div><div class="line">                   <span class="keyword">synchronized</span> (instancePool) &#123;</div><div class="line">                       instancePool.push(instance);</div><div class="line">                       nInstances++;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</div><div class="line">                   log.trace(<span class="string">"  Returning non-STM instance"</span>);</div><div class="line">               &#125;</div><div class="line">               <span class="comment">// For new instances, count will have been incremented at the</span></div><div class="line">               <span class="comment">// time of creation</span></div><div class="line">               <span class="keyword">if</span> (!newInstance) &#123;</div><div class="line">                   countAllocated.incrementAndGet();</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span> instance;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">synchronized</span> (instancePool) &#123;</div><div class="line">           <span class="keyword">while</span> (countAllocated.get() &gt;= nInstances) &#123;</div><div class="line">               <span class="comment">// Allocate a new instance if possible, or else wait</span></div><div class="line">               <span class="keyword">if</span> (nInstances &lt; maxInstances) &#123;</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       instancePool.push(loadServlet());</div><div class="line">                       nInstances++;</div><div class="line">                   &#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">                       <span class="keyword">throw</span> e;</div><div class="line">                   &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                       ExceptionUtils.handleThrowable(e);</div><div class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(sm.getString(<span class="string">"standardWrapper.allocate"</span>), e);</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       instancePool.wait();</div><div class="line">                   &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                       <span class="comment">// Ignore</span></div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</div><div class="line">               log.trace(<span class="string">"  Returning allocated STM instance"</span>);</div><div class="line">           &#125;</div><div class="line">           countAllocated.incrementAndGet();</div><div class="line">           <span class="keyword">return</span> instancePool.pop();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>调用StandardWrapper的allocate方法分配org.apache.catalina.servlets.DefaultServlet的实例处理访问包括<em>.html、</em>.htm、<em>.gif、</em>.jpg、<em>.jpeg等资源的request，分配org.apache.jasper.servlet.JspServlet的实例处理访问</em>.jpg页面的request。简单提下这些Servlet实例是在StandardContext启动的时候调用StandardWrapper的load方法用反射生成的</p>
<p>根据以上分析，我们看到StandardEngine容器的Pipeline中只有一个Valve（StandardEngineValve），而StandardHost容器中有三个Valve（分别是AccessLogValve、ErrorReportValve和StandardHostValve），此外StandardContext容器中有一个Valve（StandardContextValve），StandardWrapper中也只有一个Valve（StandardWrapperValve）。这些阀门Valve通过invoke方法彼此串联起来，最终构成的执行顺序十分类似于一个管道，最终形成的管道正如图2一样，这也许是Pipeline名字的由来。</p>
<p><img src="http://i.imgur.com/UuQzlWQ.png" alt=""></p>
<p>接着上述分析。createFilterChain  方法实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Construct and return a FilterChain implementation that will wrap the</div><div class="line">     * execution of the specified servlet instance.  If we should not execute</div><div class="line">     * a filter chain at all, return &lt;code&gt;null&lt;/code&gt;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request The servlet request we are processing</div><div class="line">     * <span class="doctag">@param</span> servlet The servlet instance to be wrapped</div><div class="line"></div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title">createFilterChain</span></span></div><div class="line">        <span class="params">(ServletRequest request, Wrapper wrapper, Servlet servlet)</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// get the dispatcher type</span></div><div class="line">        DispatcherType dispatcher = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (request.getAttribute(Globals.DISPATCHER_TYPE_ATTR) != <span class="keyword">null</span>) &#123;</div><div class="line">            dispatcher = (DispatcherType) request.getAttribute(</div><div class="line">                    Globals.DISPATCHER_TYPE_ATTR);</div><div class="line">        &#125;</div><div class="line">        String requestPath = <span class="keyword">null</span>;</div><div class="line">        Object attribute = request.getAttribute(</div><div class="line">                Globals.DISPATCHER_REQUEST_PATH_ATTR);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (attribute != <span class="keyword">null</span>)&#123;</div><div class="line">            requestPath = attribute.toString();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If there is no servlet to execute, return null</span></div><div class="line">        <span class="keyword">if</span> (servlet == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> (<span class="keyword">null</span>);</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> comet = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Create and initialize a filter chain object</span></div><div class="line">        ApplicationFilterChain filterChain = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (request <span class="keyword">instanceof</span> Request) &#123;</div><div class="line">            Request req = (Request) request;</div><div class="line">            comet = req.isComet();</div><div class="line">            <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</div><div class="line">                <span class="comment">// Security: Do not recycle</span></div><div class="line">                filterChain = <span class="keyword">new</span> ApplicationFilterChain();</div><div class="line">                <span class="keyword">if</span> (comet) &#123;</div><div class="line">                    req.setFilterChain(filterChain);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                filterChain = (ApplicationFilterChain) req.getFilterChain();</div><div class="line">                <span class="keyword">if</span> (filterChain == <span class="keyword">null</span>) &#123;</div><div class="line">                    filterChain = <span class="keyword">new</span> ApplicationFilterChain();</div><div class="line">                    req.setFilterChain(filterChain);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Request dispatcher in use</span></div><div class="line">            filterChain = <span class="keyword">new</span> ApplicationFilterChain();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        filterChain.setServlet(servlet);</div><div class="line"></div><div class="line">        filterChain.setSupport</div><div class="line">            (((StandardWrapper)wrapper).getInstanceSupport());</div><div class="line"></div><div class="line">        <span class="comment">// Acquire the filter mappings for this Context</span></div><div class="line">        StandardContext context = (StandardContext) wrapper.getParent();</div><div class="line">        FilterMap filterMaps[] = context.findFilterMaps();</div><div class="line"></div><div class="line">        <span class="comment">// If there are no filter mappings, we are done</span></div><div class="line">        <span class="keyword">if</span> ((filterMaps == <span class="keyword">null</span>) || (filterMaps.length == <span class="number">0</span>))</div><div class="line">            <span class="keyword">return</span> (filterChain);</div><div class="line"></div><div class="line">        <span class="comment">// Acquire the information we will need to match filter mappings</span></div><div class="line">        String servletName = wrapper.getName();</div><div class="line"></div><div class="line">        <span class="comment">// Add the relevant path-mapped filters to this filter chain</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!matchFiltersURL(filterMaps[i], requestPath))</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</div><div class="line">                context.findFilterConfig(filterMaps[i].getFilterName());</div><div class="line">            <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// FIXME - log configuration problem</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">boolean</span> isCometFilter = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (comet) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    isCometFilter = filterConfig.getFilter() <span class="keyword">instanceof</span> CometFilter;</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="comment">// Note: The try catch is there because getFilter has a lot of</span></div><div class="line">                    <span class="comment">// declared exceptions. However, the filter is allocated much</span></div><div class="line">                    <span class="comment">// earlier</span></div><div class="line">                    Throwable t = ExceptionUtils.unwrapInvocationTargetException(e);</div><div class="line">                    ExceptionUtils.handleThrowable(t);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (isCometFilter) &#123;</div><div class="line">                    filterChain.addFilter(filterConfig);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                filterChain.addFilter(filterConfig);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Add filters that match on servlet name second</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (!matchDispatcher(filterMaps[i] ,dispatcher)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!matchFiltersServlet(filterMaps[i], servletName))</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</div><div class="line">                context.findFilterConfig(filterMaps[i].getFilterName());</div><div class="line">            <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// FIXME - log configuration problem</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">boolean</span> isCometFilter = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (comet) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    isCometFilter = filterConfig.getFilter() <span class="keyword">instanceof</span> CometFilter;</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    <span class="comment">// Note: The try catch is there because getFilter has a lot of</span></div><div class="line">                    <span class="comment">// declared exceptions. However, the filter is allocated much</span></div><div class="line">                    <span class="comment">// earlier</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (isCometFilter) &#123;</div><div class="line">                    filterChain.addFilter(filterConfig);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                filterChain.addFilter(filterConfig);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Return the completed filter chain</span></div><div class="line">        <span class="keyword">return</span> (filterChain);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>我们整理下整个创建Filter职责链的过程：</p>
<ol>
<li>从request中获取请求的类型（Tomcat目前提供的请求类型有REQUEST、FORWARD、INCLUDE、ASYNC及ERROR五种）与路径；</li>
<li>创建ApplicationFilterChain并设置给当前request；</li>
<li>给ApplicationFilterChain设置Servlet，即DefaultServlet；</li>
<li>从StandardContext中获取当前Context的filterMaps；</li>
<li>如果filterMaps为空，则说明当前Context没有配置Filter，否则会将filterMaps中的Filter全部添加到ApplicationFilterChain中的Filter职责链中。</li>
</ol>
<p>调用ApplicationFilterChain的doFilter方法，执行ApplicationFilterChain中维护的Filter职责链。Filter职责链是对职责链模式的经典应用，我们先通过图3来介绍其执行流程。</p>
<p><img src="http://i.imgur.com/VT42GFV.png" alt=""></p>
<p>这里对图3的执行过程进行介绍：</p>
<ol>
<li>StandardWrapperValve的invoke方法在创建完ApplicationFilterChain后，第一次调用ApplicationFilterChain的doFilter方法；</li>
<li>如果ApplicationFilterChain自身维护的Filter数组中还有没有执行的Filter，则取出此Filter并执行Filter的doFilter方法（即第3步），否则执行Servlet的service方法处理请求（即第4步）；</li>
<li>每个Filter首先执行自身的过滤功能，最后在执行结束前会回调ApplicationFilterChain的doFilter方法，此时会将执行流程交给第2步；</li>
<li>Servlet的service实际会调用自身的doGet、doHead、doPost、doPut、doDelete等方法。</li>
</ol>
<p>第2步对应了图3中M.N这个标记的M部分，第3步则对应N的部分。本文最后从源码实现级别分析Filter职责链的执行过程，首先来看ApplicationFilterChain的doFilter方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Invoke the next filter in this chain, passing the specified request</div><div class="line">     * and response.  If there are no more filters in this chain, invoke</div><div class="line">     * the &lt;code&gt;service()&lt;/code&gt; method of the servlet itself.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> request The servlet request we are processing</div><div class="line">     * <span class="doctag">@param</span> response The servlet response we are creating</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> IOException if an input/output error occurs</div><div class="line">     * <span class="doctag">@exception</span> ServletException if a servlet exception occurs</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response)</span></span></div><div class="line">        <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</div><div class="line">            <span class="keyword">final</span> ServletRequest req = request;</div><div class="line">            <span class="keyword">final</span> ServletResponse res = response;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                java.security.AccessController.doPrivileged(</div><div class="line">                    <span class="keyword">new</span> java.security.PrivilegedExceptionAction&lt;Void&gt;() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span></span></div><div class="line">                            <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line">                            internalDoFilter(req,res);</div><div class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                );</div><div class="line">            &#125; <span class="keyword">catch</span>( PrivilegedActionException pe) &#123;</div><div class="line">                Exception e = pe.getException();</div><div class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ServletException)</div><div class="line">                    <span class="keyword">throw</span> (ServletException) e;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException)</div><div class="line">                    <span class="keyword">throw</span> (IOException) e;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException)</div><div class="line">                    <span class="keyword">throw</span> (RuntimeException) e;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e.getMessage(), e);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            internalDoFilter(request,response);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>看到ApplicationFilterChain的doFilter方法主要调用了internalDoFilter方法.方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">internalDoFilter</span><span class="params">(ServletRequest request,</span></span></div><div class="line">                               ServletResponse response)</div><div class="line">     <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">     <span class="comment">// Call the next filter if there is one</span></div><div class="line">     <span class="keyword">if</span> (pos &lt; n) &#123;</div><div class="line">         ApplicationFilterConfig filterConfig = filters[pos++];</div><div class="line">         Filter filter = <span class="keyword">null</span>;</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">             filter = filterConfig.getFilter();</div><div class="line">             support.fireInstanceEvent(InstanceEvent.BEFORE_FILTER_EVENT,</div><div class="line">                                       filter, request, response);</div><div class="line"></div><div class="line">             <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="string">"false"</span>.equalsIgnoreCase(</div><div class="line">                     filterConfig.getFilterDef().getAsyncSupported())) &#123;</div><div class="line">                 request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</div><div class="line">                         Boolean.FALSE);</div><div class="line">             &#125;</div><div class="line">             <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</div><div class="line">                 <span class="keyword">final</span> ServletRequest req = request;</div><div class="line">                 <span class="keyword">final</span> ServletResponse res = response;</div><div class="line">                 Principal principal =</div><div class="line">                     ((HttpServletRequest) req).getUserPrincipal();</div><div class="line"></div><div class="line">                 Object[] args = <span class="keyword">new</span> Object[]&#123;req, res, <span class="keyword">this</span>&#125;;</div><div class="line">                 SecurityUtil.doAsPrivilege</div><div class="line">                     (<span class="string">"doFilter"</span>, filter, classType, args, principal);</div><div class="line"></div><div class="line">             &#125; <span class="keyword">else</span> &#123;</div><div class="line">                 filter.doFilter(request, response, <span class="keyword">this</span>);</div><div class="line">             &#125;</div><div class="line"></div><div class="line">             support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</div><div class="line">                                       filter, request, response);</div><div class="line">         &#125; <span class="keyword">catch</span> (IOException | ServletException | RuntimeException e) &#123;</div><div class="line">             <span class="keyword">if</span> (filter != <span class="keyword">null</span>)</div><div class="line">                 support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</div><div class="line">                                           filter, request, response, e);</div><div class="line">             <span class="keyword">throw</span> e;</div><div class="line">         &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">             e = ExceptionUtils.unwrapInvocationTargetException(e);</div><div class="line">             ExceptionUtils.handleThrowable(e);</div><div class="line">             <span class="keyword">if</span> (filter != <span class="keyword">null</span>)</div><div class="line">                 support.fireInstanceEvent(InstanceEvent.AFTER_FILTER_EVENT,</div><div class="line">                                           filter, request, response, e);</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> ServletException</div><div class="line">               (sm.getString(<span class="string">"filterChain.filter"</span>), e);</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">return</span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="comment">// We fell off the end of the chain -- call the servlet instance</span></div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">         <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</div><div class="line">             lastServicedRequest.set(request);</div><div class="line">             lastServicedResponse.set(response);</div><div class="line">         &#125;</div><div class="line"></div><div class="line">         support.fireInstanceEvent(InstanceEvent.BEFORE_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response);</div><div class="line">         <span class="keyword">if</span> (request.isAsyncSupported()</div><div class="line">                 &amp;&amp; !support.getWrapper().isAsyncSupported()) &#123;</div><div class="line">             request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR,</div><div class="line">                     Boolean.FALSE);</div><div class="line">         &#125;</div><div class="line">         <span class="comment">// Use potentially wrapped request from this point</span></div><div class="line">         <span class="keyword">if</span> ((request <span class="keyword">instanceof</span> HttpServletRequest) &amp;&amp;</div><div class="line">             (response <span class="keyword">instanceof</span> HttpServletResponse)) &#123;</div><div class="line"></div><div class="line">             <span class="keyword">if</span>( Globals.IS_SECURITY_ENABLED ) &#123;</div><div class="line">                 <span class="keyword">final</span> ServletRequest req = request;</div><div class="line">                 <span class="keyword">final</span> ServletResponse res = response;</div><div class="line">                 Principal principal =</div><div class="line">                     ((HttpServletRequest) req).getUserPrincipal();</div><div class="line">                 Object[] args = <span class="keyword">new</span> Object[]&#123;req, res&#125;;</div><div class="line">                 SecurityUtil.doAsPrivilege(<span class="string">"service"</span>,</div><div class="line">                                            servlet,</div><div class="line">                                            classTypeUsedInService,</div><div class="line">                                            args,</div><div class="line">                                            principal);</div><div class="line">             &#125; <span class="keyword">else</span> &#123;</div><div class="line">                 servlet.service(request, response);</div><div class="line">             &#125;</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">             servlet.service(request, response);</div><div class="line">         &#125;</div><div class="line">         support.fireInstanceEvent(InstanceEvent.AFTER_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response);</div><div class="line">     &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">         support.fireInstanceEvent(InstanceEvent.AFTER_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response, e);</div><div class="line">         <span class="keyword">throw</span> e;</div><div class="line">     &#125; <span class="keyword">catch</span> (ServletException e) &#123;</div><div class="line">         support.fireInstanceEvent(InstanceEvent.AFTER_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response, e);</div><div class="line">         <span class="keyword">throw</span> e;</div><div class="line">     &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">         support.fireInstanceEvent(InstanceEvent.AFTER_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response, e);</div><div class="line">         <span class="keyword">throw</span> e;</div><div class="line">     &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">         ExceptionUtils.handleThrowable(e);</div><div class="line">         support.fireInstanceEvent(InstanceEvent.AFTER_SERVICE_EVENT,</div><div class="line">                                   servlet, request, response, e);</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> ServletException</div><div class="line">           (sm.getString(<span class="string">"filterChain.servlet"</span>), e);</div><div class="line">     &#125; <span class="keyword">finally</span> &#123;</div><div class="line">         <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</div><div class="line">             lastServicedRequest.set(<span class="keyword">null</span>);</div><div class="line">             lastServicedResponse.set(<span class="keyword">null</span>);</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>从上述代码，我们可以看到ApplicationFilterChain最后会执行Servlet的service方法，此service方法实际是所有Servlet的父类HttpServlet实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest req, ServletResponse res)</span></span></div><div class="line">    <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line"></div><div class="line">    HttpServletRequest  request;</div><div class="line">    HttpServletResponse response;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        request = (HttpServletRequest) req;</div><div class="line">        response = (HttpServletResponse) res;</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"non-HTTP request or response"</span>);</div><div class="line">    &#125;</div><div class="line">    service(request, response);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>service方法调用重载的service方法，后者通过判断HttpServletRequest对象的HTTP Method，调用不同的方法，如GET、DELETE、POST等,实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></div><div class="line">       <span class="keyword">throws</span> ServletException, IOException &#123;</div><div class="line"></div><div class="line">       String method = req.getMethod();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (method.equals(METHOD_GET)) &#123;</div><div class="line">           <span class="keyword">long</span> lastModified = getLastModified(req);</div><div class="line">           <span class="keyword">if</span> (lastModified == -<span class="number">1</span>) &#123;</div><div class="line">               <span class="comment">// servlet doesn't support if-modified-since, no reason</span></div><div class="line">               <span class="comment">// to go through further expensive logic</span></div><div class="line">               doGet(req, resp);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">long</span> ifModifiedSince;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE);</div><div class="line">               &#125; <span class="keyword">catch</span> (IllegalArgumentException iae) &#123;</div><div class="line">                   <span class="comment">// Invalid date header - proceed as if none was set</span></div><div class="line">                   ifModifiedSince = -<span class="number">1</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (ifModifiedSince &lt; (lastModified / <span class="number">1000</span> * <span class="number">1000</span>)) &#123;</div><div class="line">                   <span class="comment">// If the servlet mod time is later, call doGet()</span></div><div class="line">                   <span class="comment">// Round down to the nearest second for a proper compare</span></div><div class="line">                   <span class="comment">// A ifModifiedSince of -1 will always be less</span></div><div class="line">                   maybeSetLastModified(resp, lastModified);</div><div class="line">                   doGet(req, resp);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_HEAD)) &#123;</div><div class="line">           <span class="keyword">long</span> lastModified = getLastModified(req);</div><div class="line">           maybeSetLastModified(resp, lastModified);</div><div class="line">           doHead(req, resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_POST)) &#123;</div><div class="line">           doPost(req, resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_PUT)) &#123;</div><div class="line">           doPut(req, resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_DELETE)) &#123;</div><div class="line">           doDelete(req, resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_OPTIONS)) &#123;</div><div class="line">           doOptions(req,resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_TRACE)) &#123;</div><div class="line">           doTrace(req,resp);</div><div class="line"></div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//</span></div><div class="line">           <span class="comment">// Note that this means NO servlet supports whatever</span></div><div class="line">           <span class="comment">// method was requested, anywhere on this server.</span></div><div class="line">           <span class="comment">//</span></div><div class="line"></div><div class="line">           String errMsg = lStrings.getString(<span class="string">"http.method_not_implemented"</span>);</div><div class="line">           Object[] errArgs = <span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">           errArgs[<span class="number">0</span>] = method;</div><div class="line">           errMsg = MessageFormat.format(errMsg, errArgs);</div><div class="line"></div><div class="line">           resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>以doGet方法为例，见代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span></span></div><div class="line">    <span class="keyword">throws</span> ServletException, IOException</div><div class="line">&#123;</div><div class="line">    String protocol = req.getProtocol();</div><div class="line">    String msg = lStrings.getString(<span class="string">"http.method_get_not_supported"</span>);</div><div class="line">    <span class="keyword">if</span> (protocol.endsWith(<span class="string">"1.1"</span>)) &#123;</div><div class="line">        resp.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, msg);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        resp.sendError(HttpServletResponse.SC_BAD_REQUEST, msg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不对啊！为什么doGet方法的实现只是返回了400和405错误呢？因为这是抽象类HttpServlet的默认实现，用户必须实现自身的Servlet或者使用默认的DefaultServlet。 </p>
<p>本章小结：</p>
<p>至此，Tomcat有关请求流程的主要内容已经讲解完毕。</p>
<p>时序图如下：<br><img src="http://i.imgur.com/6cwwtkA.png" alt=""></p>
<h3 id="第八章-Tomcat中的设计模式及connector图解"><a href="#第八章-Tomcat中的设计模式及connector图解" class="headerlink" title="第八章 Tomcat中的设计模式及connector图解"></a>第八章 Tomcat中的设计模式及connector图解</h3><h4 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h4><p>Tomcat虽然代码比较庞大，但是整体还是设计的比较优雅，特别是很多组件化的设计思路，其中涉及到的一些常用的设计模式值得我们学习及借鉴：</p>
<p>单例模式<br>    详见前几章</p>
<p>工厂模式<br>    详见前几章</p>
<p>责任链模式<br>        Tomcat中有两个地方比较明显的使用了责任链模式，一、Tomcat中的ApplicationFilterChain实现了Filter拦截和实际Servlet的请求，是典型的责任链模式。其他开源框架中类似的设计还有Struts2中的DefaultActionInvocation实现Interceptor拦截和Action的调用。spring AOP中ReflectiveMethodInvocation实现MethodInceptor方法拦截和target的调用。二、Tomcat中的Pipeline-Valve模式也是责任链模式的一种变种，从Engine到Host再到Context一直到Wrapper都是通过一个链来传递请求。</p>
<p>观察者模式<br>        Tomcat通过LifecycleListener对组件生命周期组件Lifecycle进行监听就是典型的观察者模式，各个组件在其生命期中会有各种各样行为，而这些行为都会触发相应的事件，Tomcat就是通过侦听这些事件达到对这些行为进行扩展的目的。在看组件的init和start过程中会看到大量如：lifecycle.fireLifecycleEvent(AFTER_START_EVENT,null);这样的代码，这就是对某一类型事件的触发，如果你想在其中加入自己的行为，就只用注册相应类型的事件即可。</p>
<p>门面模式<br>      门面设计模式在 Tomcat 中有多处使用，在 Request 和 Response 对象封装中(RequestFacade,ResponseFacade)、ApplicationContext 到ApplicationContextFacade等都用到了这种设计模式。这种设计模式主要用在一个大的系统中有多个子系统组成时，这多个子系统肯定要涉及到相互通信，但是每个子系统又不能将自己的内部数据过多的暴露给其它系统，不然就没有必要划分子系统了。每个子系统都会设计一个门面，把别的系统感兴趣的数据封装起来，通过这个门面来进行访问。</p>
<p>模板方法模式</p>
<p>  模板方法模式是我们平时开发当中常用的一种模式，把通用的骨架抽象到父类中，子类去实现特地的某些步骤。Tomcat及Servlet规范API中也大量的使用了这种模式，比如Tomcat中的ContainerBase中对于生命周期的一些方法init,start,stop和Servlet规范API中的GenericServlet中的service抽象骨架模板方法均使用了模板方法模式。</p>
<h4 id="connector"><a href="#connector" class="headerlink" title="connector"></a>connector</h4><p> 前面也已经经介绍过，Connector组件是Service容器中的一部分。它主要是接收，解析HTTP请求，然后调用本Service下的相关Servlet。由于Tomcat从架构上采用的是一个分层结构，因此根据解析过的HTTP请求，定位到相应Servlet也是一个相对比较复杂的过程，整个Connector实现了从接收Socket到调用Servlet的全过程。先来看一下Connector的功能逻辑：</p>
<p>·        接收Socket</p>
<p>·        从Socket获取数据包，并解析成HttpServletRequest对象</p>
<p>·        从Engine容器开始走调用流程，经过各层Valve，最后调用Servlet完成业务逻辑</p>
<p>·        返回Response，关闭Socket</p>
<p>可以看出，整个Connector组件是Tomcat运行主干，目前Connector支持的协议是HTTP和AJP，本文主要是针对HTTP协议的Connector进行阐述。先来看一下Connector的配置，在server.xml里；</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"80"</span> <span class="attr">URIEncoding</span>=<span class="string">"UTF-8"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span>   </span></div><div class="line"><span class="attr">connectionTimeout</span>=<span class="string">"20000"</span>   </div><div class="line"> <span class="attr">redirectPort</span>=<span class="string">"7443"</span> /&gt;</div></pre></td></tr></table></figure>
<p>熟悉的80端口不必说了。”protocol”这里是指这个Connector支持的协议。针对HTTP协议而言，这个属性可以配置的值有： </p>
<p>·        HTTP/1.1</p>
<p>·        org.apache.coyote.http11.Http11Protocol –BIO实现</p>
<p>·        org.apache.coyote.http11.Http11NioProtocol –NIO实现</p>
<p>配置”HTTP/1.1”和”org.apache.coyote.http11.Http11Protocol”的效果是一样的，因此Connector的HTTP协议实现缺省是支持BIO的。无论是BIO还是NIO都是实现一个org.apache.coyote.ProtocolHandler接口，因此如果需要定制化，也必须实现这个接口。 接下来再来看看默认状态下HTTP Connector的架构及其消息流。</p>
<p><img src="http://i.imgur.com/Wrkl7ew.png" alt=""></p>
<p> 可以看见Connector中三大块 </p>
<ul>
<li><p>Http11Protocol</p>
</li>
<li><p>Mapper</p>
</li>
<li><p>CoyoteAdapter</p>
</li>
</ul>
<p>Http11Protocol </p>
<pre><code>类完全路径org.apache.coyote.http11.Http11Protocol，这是支持HTTP的BIO实现。Http11Protocol包含了JIoEndpoint对象及Http11ConnectionHandler对象。 
</code></pre><p>Http11ConnectionHandler对象维护了一个Http11Processor对象池，Http11Processor对象会调用CoyoteAdapter完成HTTPr Request的解析和分派。<br>JIoEndpoint维护了两个线程，Acceptor请求接收线程及Executor请求处理线程池。Acceptor是接收Socket，然后从 Executor请求处理线程池中找出空闲的线程处理socket，如果 Executor请求处理线程池没有空闲线程，请求会被放入阻塞队列等待有空闲线程。</p>
<p>Mapper </p>
<pre><code>类完全路径org.apache.tomcat.util.http.mapper.Mapper，此对象维护了一个从Host到Wrapper的各级容器的快照。它主要是为了，当HTTP Request被解析后，能够将HTTP Request绑定到相应的Host,Context,Wrapper(Servlet)，进行业务处理；
</code></pre><p>CoyoteAdapter </p>
<pre><code>类完全路径org.apache.catalina.connector.CoyoteAdapter，此对象负责将http request解析成HttpServletRequest对象，之后绑定相应的容器，然后从Engine开始逐层调用Valve直至该Servlet。比如根据Request中的JSESSIONID绑定服务器端的相应Session。这个JSESSIONID按照优先级或是从Request URL中获取，或是从Cookie中获取，然后再Session池中找到相应匹配的Session对象，然后将其封装到HttpServletRequest对象，所有这些都是在CoyoteAdapter中完成的。看一下将Request解析为HttpServletRequest对象后，开始调用Servlet的代码； 
</code></pre><p>Tomcat的Connector组件工作具体序列图入下：</p>
<p><img src="http://i.imgur.com/3LHxHc4.png" alt=""></p>
<p>本章小结</p>
<p>至此本章结束</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/31/tomact1/" itemprop="url">
                  tomact1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-31T12:08:12+08:00" content="2016-12-31">
              2016-12-31
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文内容只要参考深入剖析tomact。由于这本书是基于tomcat4的，所以我的文章也是基于tomcat4的，但是tomcat的核心思想应该是没有变的，最主要的两个组件还是连接器和容器。本文内容主要为了学习。</p>
<h3 id="第一章：tomact服务启动"><a href="#第一章：tomact服务启动" class="headerlink" title="第一章：tomact服务启动"></a>第一章：tomact服务启动</h3><p>为了后面的理解，先大致说一下Tomcat的整体架构，Tomcat主要有两个组件，连接器和容器，所谓连接器就是一个http请求过来了，连接器负责接收这个请求，然后转发给容器。容器即servlet容器，容器有很多层，分别是Engine，Host，Context，Wrapper。最大的容器Engine，代表一个servlet 引擎，接下来是Host，代表一个虚拟机，然后是Context，代表一个应用，Wrapper对应一个servlet。从连接器传过来连接后，容器便会顺序经过上面的容器，最后到达特定的servlet。要说明的是Engine，Host两种容器在不是必须的。实际上一个简单的tomcat只要连接器和容器就可以了，但tomcat的实现为了统一管理连接器和容器等组件，额外添加了服务器组件（server）和服务组件（service）。</p>
<p>一个server可以有多个service，一个service包含多个连接器和一个容器，当然还有一些其他的东西，看下面的图就很容易理解Tomcat的架构了：</p>
<p><img src="http://i.imgur.com/irZpmOV.png" alt=""></p>
<p>一个父组件又可以包含多个子组件，这些被统一管理的组件都实现了Lifecycle接口。只要一个组件启动了，那么他的所有子组件也会跟着启动，比如一个server启动了，它的所有子service都会跟着启动，service启动了，它的所有连接器和容器等子组件也跟着启动了，这样，tomcat要启动，只要启动server就行了，其他的组件都会跟随着启动。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/27/tomact源码分析1/" itemprop="url">
                  tomact源码分析1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-27T13:33:17+08:00" content="2016-12-27">
              2016-12-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/tomact/" itemprop="url" rel="index">
                    <span itemprop="name">tomact</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="tomact源码分析1-简单的server实现"><a href="#tomact源码分析1-简单的server实现" class="headerlink" title="tomact源码分析1-简单的server实现"></a>tomact源码分析1-简单的server实现</h3><h4 id="1-HTTP-请求"><a href="#1-HTTP-请求" class="headerlink" title="1.HTTP 请求"></a>1.HTTP 请求</h4><p>一个 HTTP 请求包括三个组成部分：</p>
<ul>
<li>方法—统一资源标识符(URI)—协议/版本</li>
<li>请求的头部</li>
<li>主体内容</li>
</ul>
<p>ps:方法（7种）：GET, POST,HEAD, OPTIONS, PUT, DELETE 和 TRACE。头部结束和内容之间有一个空行</p>
<p>examples</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">POST /examples/default.jsp HTTP/1.1</div><div class="line">Accept: text/plain; text/html</div><div class="line">Accept-Language: en-gb</div><div class="line">Connection: Keep-Alive</div><div class="line">Host: localhost</div><div class="line">User-Agent: Mozilla/4.0 (compatible; MSIE 4.01; Windows 98)</div><div class="line">Content-Length: 33</div><div class="line">Content-Type: application/x-www-form-urlencoded</div><div class="line">Accept-Encoding: gzip, deflate</div><div class="line"></div><div class="line">lastName=Franks&amp;firstName=Michael</div></pre></td></tr></table></figure>
<h4 id="2-HTTP-响应"><a href="#2-HTTP-响应" class="headerlink" title="2.HTTP 响应"></a>2.HTTP 响应</h4><p>examples：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 200 OK</div><div class="line">Server: Microsoft-IIS/4.0</div><div class="line">Date: Mon, 5 Jan 2004 13:13:33 GMT</div><div class="line">Content-Type: text/html</div><div class="line">Last-Modified: Mon, 5 Jan 2004 13:13:12 GMT</div><div class="line">Content-Length: 112</div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>HTTP Response Example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">Welcome to Brainy Software</div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="3-socket-amp-amp-ServerSocket"><a href="#3-socket-amp-amp-ServerSocket" class="headerlink" title="3.socket&amp;&amp;ServerSocket"></a>3.socket&amp;&amp;ServerSocket</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Socket</span> <span class="params">(java.lang.String host, <span class="keyword">int</span> port)</span></span></div></pre></td></tr></table></figure>
<p>socket类代表一个客户端套接字</p>
<p>serversocket是一个服务器套接字。用来等待来自客户端的连接请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ServerSocket</span><span class="params">(<span class="keyword">int</span> port, <span class="keyword">int</span> backLog, InetAddress bindingAddress)</span></span>;</div></pre></td></tr></table></figure>
<h4 id="4-server例子"><a href="#4-server例子" class="headerlink" title="4.server例子"></a>4.server例子</h4><p>该部分主要分为3个类。是一个最最基础的server实现。</p>
<p>server：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ex01;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.net.Socket;</div><div class="line"><span class="keyword">import</span> java.net.ServerSocket;</div><div class="line"><span class="keyword">import</span> java.net.InetAddress;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpServer</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/** WEB_ROOT is the directory where our HTML and other files reside.</span></div><div class="line">   *  For this package, WEB_ROOT is the "webroot" directory under the working</div><div class="line">   *  directory.</div><div class="line">   *  The working directory is the location in the file system</div><div class="line">   *  from where the java command was invoked.</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_ROOT =</div><div class="line">    System.getProperty(<span class="string">"user.dir"</span>) + File.separator  + <span class="string">"webroot"</span>;</div><div class="line"></div><div class="line">  <span class="comment">// shutdown command</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SHUTDOWN_COMMAND = <span class="string">"/SHUTDOWN"</span>;</div><div class="line"></div><div class="line">  <span class="comment">// the shutdown command received</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> shutdown = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    HttpServer server = <span class="keyword">new</span> HttpServer();</div><div class="line">    System.out.println(WEB_ROOT);</div><div class="line">    server.await();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</div><div class="line">    ServerSocket serverSocket = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">int</span> port = <span class="number">8080</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      serverSocket =  <span class="keyword">new</span> ServerSocket(port, <span class="number">1</span>, InetAddress.getByName(<span class="string">"127.0.0.1"</span>));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">      System.exit(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Loop waiting for a request</span></div><div class="line">    <span class="keyword">while</span> (!shutdown) &#123;</div><div class="line">      Socket socket = <span class="keyword">null</span>;</div><div class="line">      InputStream input = <span class="keyword">null</span>;</div><div class="line">      OutputStream output = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        socket = serverSocket.accept();</div><div class="line">        input = socket.getInputStream();</div><div class="line">        output = socket.getOutputStream();</div><div class="line"></div><div class="line">        <span class="comment">// create Request object and parse</span></div><div class="line">        Request request = <span class="keyword">new</span> Request(input);</div><div class="line">        request.parse();</div><div class="line"></div><div class="line">        <span class="comment">// create Response object</span></div><div class="line">        Response response = <span class="keyword">new</span> Response(output);</div><div class="line">        response.setRequest(request);</div><div class="line">        response.sendStaticResource();</div><div class="line"></div><div class="line">        <span class="comment">// Close the socket</span></div><div class="line">        socket.close();</div><div class="line"></div><div class="line">        <span class="comment">//check if the previous URI is a shutdown command</span></div><div class="line">        shutdown = request.getUri().equals(SHUTDOWN_COMMAND);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>request:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ex01;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> InputStream input;</div><div class="line">  <span class="keyword">private</span> String uri;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(InputStream input)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.input = input;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Read a set of characters from the socket</span></div><div class="line">    StringBuffer request = <span class="keyword">new</span> StringBuffer(<span class="number">2048</span>);</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      i = input.read(buffer);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      e.printStackTrace();</div><div class="line">      i = -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;i; j++) &#123;</div><div class="line">      request.append((<span class="keyword">char</span>) buffer[j]);</div><div class="line">    &#125;</div><div class="line">    System.out.print(request.toString());</div><div class="line">    uri = parseUri(request.toString());</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">parseUri</span><span class="params">(String requestString)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> index1, index2;</div><div class="line">    index1 = requestString.indexOf(<span class="string">' '</span>);</div><div class="line">    <span class="keyword">if</span> (index1 != -<span class="number">1</span>) &#123;</div><div class="line">      index2 = requestString.indexOf(<span class="string">' '</span>, index1 + <span class="number">1</span>);</div><div class="line">      <span class="keyword">if</span> (index2 &gt; index1)</div><div class="line">        <span class="keyword">return</span> requestString.substring(index1 + <span class="number">1</span>, index2);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getUri</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> uri;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>response:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> ex01;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.OutputStream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.FileInputStream;</div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">  HTTP Response = Status-Line</div><div class="line">    *(( general-header | response-header | entity-header ) CRLF)</div><div class="line">    CRLF</div><div class="line">    [ message-body ]</div><div class="line">    Status-Line = HTTP-Version SP Status-Code SP Reason-Phrase CRLF</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1024</span>;</div><div class="line">  Request request;</div><div class="line">  OutputStream output;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(OutputStream output)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.output = output;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRequest</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.request = request;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendStaticResource</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER_SIZE];</div><div class="line">    FileInputStream fis = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      File file = <span class="keyword">new</span> File(HttpServer.WEB_ROOT, request.getUri());</div><div class="line">      <span class="keyword">if</span> (file.exists()) &#123;</div><div class="line">        fis = <span class="keyword">new</span> FileInputStream(file);</div><div class="line">        <span class="keyword">int</span> ch = fis.read(bytes, <span class="number">0</span>, BUFFER_SIZE);</div><div class="line">        <span class="keyword">while</span> (ch!=-<span class="number">1</span>) &#123;</div><div class="line">          output.write(bytes, <span class="number">0</span>, ch);</div><div class="line">          ch = fis.read(bytes, <span class="number">0</span>, BUFFER_SIZE);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// file not found</span></div><div class="line">        String errorMessage = <span class="string">"HTTP/1.1 404 File Not Found\r\n"</span> +</div><div class="line">          <span class="string">"Content-Type: text/html\r\n"</span> +</div><div class="line">          <span class="string">"Content-Length: 23\r\n"</span> +</div><div class="line">          <span class="string">"\r\n"</span> +</div><div class="line">          <span class="string">"&lt;h1&gt;File Not Found&lt;/h1&gt;"</span>;</div><div class="line">        output.write(errorMessage.getBytes());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      <span class="comment">// thrown if cannot instantiate a File object</span></div><div class="line">      System.out.println(e.toString() );</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">finally</span> &#123;</div><div class="line">      <span class="keyword">if</span> (fis!=<span class="keyword">null</span>)</div><div class="line">        fis.close();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/26/pat1011/" itemprop="url">
                  pat1011
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-26T20:50:35+08:00" content="2016-12-26">
              2016-12-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1011.World Cup Betting (20)</p>
<p>With the 2010 FIFA World Cup running, football fans the world over were becoming increasingly excited as the best players from the best teams doing battles for the World Cup trophy in South Africa. Similarly, football betting fans were putting their money where their mouths were, by laying all manner of World Cup bets.</p>
<p>Chinese Football Lottery provided a “Triple Winning” game. The rule of winning was simple: first select any three of the games. Then for each selected game, bet on one of the three possible results – namely W for win, T for tie, and L for lose. There was an odd assigned to each result. The winner’s odd would be the product of the three odds times 65%.</p>
<p>For example, 3 games’ odds are given as the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> W    T    L</div><div class="line">1.1  2.5  1.7</div><div class="line">1.2  3.0  1.6</div><div class="line">4.1  1.2  1.1</div></pre></td></tr></table></figure>
<p>To obtain the maximum profit, one must buy W for the 3rd game, T for the 2nd game, and T for the 1st game. If each bet takes 2 yuans, then the maximum profit would be <code>(4.1*3.0*2.5*65%-1)*2 = 37.98</code> yuans (accurate up to 2 decimal places).</p>
<p>Input</p>
<p>Each input file contains one test case. Each case contains the betting information of 3 games. Each game occupies a line with three distinct odds corresponding to W, T and L.</p>
<p>Output</p>
<p>For each test case, print in one line the best bet of each game, and the maximum profit accurate up to 2 decimal places. The characters and the number must be separated by one space.</p>
<p>Sample Input</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1.1 2.5 1.7</div><div class="line">1.2 3.0 1.6</div><div class="line">4.1 1.2 1.1</div></pre></td></tr></table></figure>
<p>Sample Output</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">T T W 37.98</div></pre></td></tr></table></figure>
<p>思路：属于简单送分题。按照思路，直接写程序就好。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> pat;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Scanner;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">t11</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		String[] s=&#123;<span class="string">"W"</span>,<span class="string">"T"</span>,<span class="string">"L"</span>&#125;;</div><div class="line">		String[] ss=<span class="keyword">new</span> String[<span class="number">3</span>];</div><div class="line">		Scanner sc= <span class="keyword">new</span> Scanner(System.in);</div><div class="line">		<span class="keyword">double</span> sum=<span class="number">1</span>;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)&#123;</div><div class="line">			<span class="keyword">double</span> x=<span class="number">0</span>;</div><div class="line">			<span class="keyword">int</span> index=<span class="number">0</span>;</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;<span class="number">3</span>;j++)&#123;</div><div class="line">				<span class="keyword">double</span> t=sc.nextDouble();</div><div class="line">				<span class="keyword">if</span>(x&lt;t)&#123;</div><div class="line">					x=t;</div><div class="line">					index=j;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			ss[i]=s[index];</div><div class="line">			sum*=x;	</div><div class="line">		&#125;</div><div class="line">		sc.close();</div><div class="line">		<span class="keyword">for</span>(String str:ss)</div><div class="line">			System.out.print(str+<span class="string">" "</span>);</div><div class="line">		System.out.printf(<span class="string">"%.2f"</span>,(sum*<span class="number">0.65</span>-<span class="number">1</span>)*<span class="number">2</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/26/pat1010/" itemprop="url">
                  pat1010
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-26T20:43:07+08:00" content="2016-12-26">
              2016-12-26
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1010.Radix (25)</p>
<p>Given a pair of positive integers, for example, 6 and 110, can this equation 6 = 110 be true? The answer is “yes”, if 6 is a decimal number and 110 is a binary number.</p>
<p>Now for any pair of positive integers N1 and N2, your task is to find the radix of one number while that of the other is given.</p>
<p>Input Specification:</p>
<p>Each input file contains one test case. Each case occupies a line which contains 4 positive integers:<br>N1 N2 tag radix<br>Here N1 and N2 each has no more than 10 digits. A digit is less than its radix and is chosen from the set {0-9, a-z} where 0-9 represent the decimal numbers 0-9, and a-z represent the decimal numbers 10-35. The last number “radix” is the radix of N1 if “tag” is 1, or of N2 if “tag” is 2.</p>
<p>Output Specification:</p>
<p>For each test case, print in one line the radix of the other number so that the equation N1 = N2 is true. If the equation is impossible, print “Impossible”. If the solution is not unique, output the smallest possible radix.</p>
<p>Sample Input 1:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">6 110 1 10</div></pre></td></tr></table></figure></p>
<p>Sample Output 1:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2</div></pre></td></tr></table></figure></p>
<p>Sample Input 2:<br><figure class="highlight plain"><figcaption><span>ab 1 2```</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Sample Output 2:</div><div class="line">```Impossible</div></pre></td></tr></table></figure></p>
<p>思路：如果a等于b，第二个进制数应该大于b中最大的数字，小于等于a的值+1。并且基数有可能很大，所以要声明long。</p>
<p>解答：<br>C++版本</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stack&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;map&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;math.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;functional&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> uLL;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF = <span class="number">1</span>&lt;&lt;<span class="number">30</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn = <span class="number">1e5</span> + <span class="number">50</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">toint</span><span class="params">(<span class="keyword">char</span> c)</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> ans;</div><div class="line">	<span class="keyword">if</span>(c &gt; <span class="string">'9'</span>) ans = c-<span class="string">'a'</span>+<span class="number">10</span>;</div><div class="line">	<span class="keyword">else</span> ans = c-<span class="string">'0'</span>;</div><div class="line">	<span class="keyword">return</span> ans;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">uLL <span class="title">change</span><span class="params">(<span class="built_in">string</span> s, uLL r)</span></span>&#123;</div><div class="line">	uLL ans = <span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; s[i]; i++)  ans = ans*r + toint(s[i]);</div><div class="line">	<span class="keyword">return</span> ans;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findmax</span><span class="params">(<span class="built_in">string</span> s)</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> ans=<span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; s[i]; i++) <span class="keyword">if</span>(ans &lt; toint(s[i])) ans = toint(s[i]);</div><div class="line">	<span class="keyword">return</span> ans;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> tag,r;</div><div class="line">	uLL x,y;</div><div class="line">	<span class="built_in">string</span> a,b;</div><div class="line">	<span class="built_in">cin</span>&gt;&gt;a&gt;&gt;b&gt;&gt;tag&gt;&gt;r;</div><div class="line">	<span class="keyword">if</span>(tag==<span class="number">2</span>) swap(a,b);</div><div class="line">	x = change(a,r);</div><div class="line">	<span class="keyword">for</span>(uLL l=findmax(b)+<span class="number">1</span>, r = x+<span class="number">1</span>; l &lt;= r; )&#123;</div><div class="line">		uLL m = l+r &gt;&gt; <span class="number">1</span>;</div><div class="line">		y = change(b,m);</div><div class="line">		<span class="keyword">if</span>(y==x) &#123; <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>,m); <span class="keyword">return</span> <span class="number">0</span>; &#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(y&gt;x) r = m<span class="number">-1</span>;</div><div class="line">		<span class="keyword">else</span> l = m+<span class="number">1</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"Impossible\n"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>java测试用例没有全部通过。我不知道什么原因。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> pat;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Scanner;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">t10_2</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">toint</span><span class="params">(<span class="keyword">char</span> c)</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> c&gt;<span class="string">'9'</span>?c-<span class="string">'a'</span>+<span class="number">10</span>:c-<span class="string">'0'</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">change</span><span class="params">(String s,<span class="keyword">long</span> radix)</span></span>&#123;</div><div class="line">		<span class="keyword">long</span> ans=<span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;s.length();i++)&#123;</div><div class="line">			ans=ans*radix+toint(s.charAt(i));</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> ans;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">findmax</span><span class="params">(String s)</span></span>&#123;</div><div class="line">		<span class="keyword">int</span> ans=<span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;s.length();i++)</div><div class="line">			<span class="keyword">if</span>(ans&lt;toint(s.charAt(i))) ans=toint(s.charAt(i));</div><div class="line">		<span class="keyword">return</span> ans;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">static</span> <span class="keyword">long</span> tag,r;</div><div class="line">	<span class="keyword">static</span> String a,b;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">long</span> x,y;</div><div class="line">		Scanner sc=<span class="keyword">new</span> Scanner(System.in);</div><div class="line">		a=sc.next();</div><div class="line">		b=sc.next();</div><div class="line">		tag=sc.nextInt();</div><div class="line">		r=sc.nextLong();</div><div class="line">		sc.close();</div><div class="line">		<span class="keyword">if</span>(tag==<span class="number">2</span>)&#123;</div><div class="line">			String tmp=a;a=b;b=tmp;</div><div class="line">		&#125;</div><div class="line">		x=change(a, r);		</div><div class="line">		<span class="keyword">long</span> left=findmax(b)+<span class="number">1</span>,right=x+<span class="number">1</span>;</div><div class="line">		<span class="keyword">while</span>(left&lt;=right)&#123;</div><div class="line">			<span class="keyword">long</span> middle=(left+right)&gt;&gt;<span class="number">1</span>;</div><div class="line">			y=change(b, middle);</div><div class="line">			<span class="keyword">if</span>(x==y)&#123;System.out.println(middle);  <span class="keyword">return</span>;&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(y&gt;x) right=middle-<span class="number">1</span>;</div><div class="line">			<span class="keyword">else</span> left=middle+<span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">		System.out.println(<span class="string">"Impossible"</span>);</div><div class="line">		<span class="keyword">return</span> ;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/24/memcached/" itemprop="url">
                  memcached
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-24T13:21:48+08:00" content="2016-12-24">
              2016-12-24
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原理：</p>
<ol>
<li>Memcached是danga的一个项目，最早是为LiveJournal服务的，后来被很多大型网站采用。www.danga.com</li>
<li>一种缓存技术，可以把你的数据放入内存，从而通过内存访问，提速。维护了一张大的hashtable表，该表是在内存中的，表结构：key    value。</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/24/redis/" itemprop="url">
                  redis
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-24T12:35:12+08:00" content="2016-12-24">
              2016-12-24
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://www.yiibai.com/redis/redis_quick_guide.html" target="_blank" rel="external">http://www.yiibai.com/redis/redis_quick_guide.html</a></p>
<p>Redis是一个速度非常快的非关系数据库，它可以存储键与5种不同类型的值之间的映射，可以将存储在内存的键值对数据持久化到硬盘，可以使用复制特性来扩展读性能，还可以使用客户端分片来扩展写性能。</p>
<p>安装：<br><a href="http://www.cnblogs.com/sandea/p/5782192.html" target="_blank" rel="external">http://www.cnblogs.com/sandea/p/5782192.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">wget http://download.redis.io/releases/redis-3.2.3.tar.gz</div><div class="line"></div><div class="line">tar -zxvf redis-3.2.3.tar.gz</div><div class="line"></div><div class="line">mv redis-3.2.3 redis</div><div class="line">cd redis</div><div class="line">make MALLOC=libc</div><div class="line">make install</div></pre></td></tr></table></figure>
<h3 id="1-特点"><a href="#1-特点" class="headerlink" title="1.特点"></a>1.特点</h3><p><img src="http://i.imgur.com/7VRR2Xz.png" alt=""></p>
<p>Redis 有三个主要使其有别于其它很多竞争对手的特点：</p>
<ul>
<li>Redis是完全在内存中保存数据的数据库，使用磁盘只是为了持久性目的； </li>
<li>Redis相比许多键值数据存储系统有相对丰富的数据类型； </li>
<li>Redis可以将数据复制到任意数量的从服务器中； </li>
</ul>
<p>Redis优点</p>
<ul>
<li>异常快速 : Redis是非常快的，每秒可以执行大约110000设置操作，81000个/每秒的读取操作。</li>
<li>支持丰富的数据类型 : Redis支持最大多数开发人员已经知道如列表，集合，可排序集合，哈希等数据类型。这使得在应用中很容易解决的各种问题，因为我们知道哪些问题处理使用哪种数据类型更好解决。</li>
<li>操作都是原子的 : 所有 Redis 的操作都是原子，从而确保当两个客户同时访问 Redis 服务器得到的是更新后的值（最新值）。</li>
<li>MultiUtility工具：Redis是一个多功能实用工具，可以在很多如：缓存，消息传递队列中使用（Redis原生支持发布/订阅），在应用程序中，如：Web应用程序会话，网站页面点击数等任何短暂的数据；</li>
</ul>
<h3 id="2-redis中数据结构"><a href="#2-redis中数据结构" class="headerlink" title="2.redis中数据结构"></a>2.redis中数据结构</h3><p>5种:string list set hash zset</p>
<h3 id="3-事务"><a href="#3-事务" class="headerlink" title="3.事务"></a>3.事务</h3><p>Redis事务允许一组命令在单一步骤中执行。事务有两个属性，说明如下：</p>
<ul>
<li>在一个事务中的所有命令作为单个独立的操作顺序执行。在Redis事务中的执行过程中而另一客户机发出的请求，这是不可以的；</li>
<li>Redis事务是原子的。原子意味着要么所有的命令都执行，要么都不执行；</li>
</ul>
<p>Redis 事务由指令 MULTI 发起的，之后传递需要在事务中和整个事务中，最后由 EXEC 命令执行所有命令的列表。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:6379&gt; MULTI</div><div class="line">OK</div><div class="line">redis 127.0.0.1:6379&gt; SET tutorial redis</div><div class="line">QUEUED</div><div class="line">redis 127.0.0.1:6379&gt; GET tutorial</div><div class="line">QUEUED</div><div class="line">redis 127.0.0.1:6379&gt; INCR visitors</div><div class="line">QUEUED</div><div class="line">redis 127.0.0.1:6379&gt; EXEC</div><div class="line"></div><div class="line">1) OK</div><div class="line">2) &quot;redis&quot;</div><div class="line">3) (integer) 1</div></pre></td></tr></table></figure>
<h3 id="4-持久化"><a href="#4-持久化" class="headerlink" title="4.持久化"></a>4.持久化</h3><p>Redis提供两种不同的持久化方法来将数据存储到硬盘里面。一种方法叫快照，它可以将存在于某一时刻的所有数据都写入硬盘里面。另一种方法叫只追加文件（AOF)，它会在执行写命令时，将被执行的写命令复制到硬盘里面。这两种持久化方法既可以同时使用，又可以单独使用，在某些情况下甚至两种方法都不是用，具体选择哪种持久化方法需要根据用户的数据以及应用来决定。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/24/zookeeper/" itemprop="url">
                  zookeeper
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-24T10:37:01+08:00" content="2016-12-24">
              2016-12-24
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://cailin.iteye.com/blog/2014486/" target="_blank" rel="external">http://cailin.iteye.com/blog/2014486/</a></p>
<p>ps：未完待续</p>
<p>ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，它包含一个简单的原语集，分布式应用程序可以基于它<strong>实现同步服务，配置维护和命名服务</strong>等。Zookeeper是hadoop的一个子项目，其发展历程无需赘述。在分布式应用中，由于工程师不能很好地使用锁机制，以及基于消息的协调机制不适合在某些应用中使用，因此需要有一种可靠的、可扩展的、分布式的、可配置的协调机制来统一系统的状态。Zookeeper的目的就在于此。本文简单分析zookeeper的工作原理，对于如何使用zookeeper不是本文讨论的重点。</p>
<p>Zookeeper 从设计模式角度来看，是一个基于观察者模式设计的分布式服务管理框。</p>
<p>功能：</p>
<ul>
<li>统一命名服务（Name Service）：<br>分布式应用中，通常需要有一套完整的命名规则，既能够产生唯一的名称又便于人识别和记住。<br>Name Service 已经是 Zookeeper 内置的功能，你只要调用 Zookeeper 的 API 就能实现。如调用 create 接口就可以很容易创建一个目录节点。</li>
<li>配置管理</li>
<li>集群管理</li>
</ul>
<h4 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h4><p>Zookeeper中的角色主要有以下三类，如下表所示：<br><img src="http://i.imgur.com/NxWbDV8.jpg" alt=""></p>
<h4 id="设计目的"><a href="#设计目的" class="headerlink" title="设计目的"></a>设计目的</h4><p>1.最终一致性：client不论连接到哪个Server，展示给它都是同一个视图，这是zookeeper最重要的性能。</p>
<p>2 .可靠性：具有简单、健壮、良好的性能，如果消息m被到一台服务器接受，那么它将被所有的服务器接受。</p>
<p>3 .实时性：Zookeeper保证客户端将在一个时间间隔范围内获得服务器的更新信息，或者服务器失效的信息。但由于网络延时等原因，Zookeeper不能保证两个客户端能同时得到刚更新的数据，如果需要最新数据，应该在读数据之前调用sync()接口。</p>
<p>4 .等待无关（wait-free）：慢的或者失效的client不得干预快速的client的请求，使得每个client都能有效的等待。</p>
<p>5.原子性：更新只能成功或者失败，没有中间状态。</p>
<p>6 .顺序性：包括全局有序和偏序两种：全局有序是指如果在一台服务器上消息a在消息b前发布，则在所有Server上消息a都将在消息b前被发布；偏序是指如果一个消息b在消息a后被同一个发送者发布，a必将排在b前面。</p>
<h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><p>Zookeeper的核心是原子广播，这个机制保证了各个Server之间的同步。实现这个机制的协议叫做Zab协议。Zab协议有两种模式，它们分别是恢复模式（选主）和广播模式（同步）。当服务启动或者在领导者崩溃后，Zab就进入了恢复模式，当领导者被选举出来，且大多数Server完成了和leader的状态同步以后，恢复模式就结束了。状态同步保证了leader和Server具有相同的系统状态。</p>
<p>为了保证事务的顺序一致性，zookeeper采用了递增的事务id号（zxid）来标识事务。所有的提议（proposal）都在被提出的时候加上了zxid。实现中zxid是一个64位的数字，它高32位是epoch用来标识leader关系是否改变，每次一个leader被选出来，它都会有一个新的epoch，标识当前属于那个leader的统治时期。低32位用于递增计数。</p>
<p>每个Server在工作过程中有三种状态：</p>
<ul>
<li>LOOKING：当前Server不知道leader是谁，正在搜寻</li>
<li>LEADING：当前Server即为选举出来的leader</li>
<li>FOLLOWING：leader已经选举出来，当前Server与之同步</li>
</ul>
<h4 id="选主流程"><a href="#选主流程" class="headerlink" title="选主流程"></a>选主流程</h4><p>当leader崩溃或者leader失去大多数的follower，这时候zk进入恢复模式，恢复模式需要重新选举出一个新的leader，让所有的Server都恢复到一个正确的状态。Zk的选举算法有两种：一种是基于basic paxos实现的，另外一种是基于fast paxos算法实现的。系统默认的选举算法为fast paxos。先介绍basic paxos流程：</p>
<ol>
<li><p>选举线程由当前Server发起选举的线程担任，其主要功能是对投票结果进行统计，并选出推荐的Server；</p>
</li>
<li><p>选举线程首先向所有Server发起一次询问(包括自己)；</p>
</li>
<li><p>选举线程收到回复后，验证是否是自己发起的询问(验证zxid是否一致)，然后获取对方的id(myid)，并存储到当前询问对象列表中，最后获取对方提议的leader相关信息(id,zxid)，并将这些信息存储到当次选举的投票记录表中；</p>
</li>
<li><p>收到所有Server回复以后，就计算出zxid最大的那个Server，并将这个Server相关信息设置成下一次要投票的Server；</p>
</li>
<li><p>线程将当前zxid最大的Server设置为当前Server要推荐的Leader，如果此时获胜的Server获得n/2 + 1的Server票数， 设置当前推荐的leader为获胜的Server，将根据获胜的Server相关信息设置自己的状态，否则，继续这个过程，直到leader被选举出来。</p>
</li>
</ol>
<p>通过流程分析我们可以得出：要使Leader获得多数Server的支持，则Server总数必须是奇数2n+1，且<strong>存活的Server的数目不得少于n+1</strong>.</p>
<p>每个Server启动后都会重复以上流程。在恢复模式下，如果是刚从崩溃状态恢复的或者刚启动的server还会从磁盘快照中恢复数据和会话信息，zk会记录事务日志并定期进行快照，方便在恢复时进行状态恢复。选主的具体流程图如下所示：<br><img src="http://i.imgur.com/Vbcg5ge.jpg" alt=""></p>
<p>fast paxos流程是在选举过程中，某Server首先向所有Server提议自己要成为leader，当其它Server收到提议以后，解决epoch和zxid的冲突，并接受对方的提议，然后向对方发送接受提议完成的消息，重复这个流程，最后一定能选举出Leader。其流程图如下所示：</p>
<p><img src="http://i.imgur.com/6faX072.jpg" alt=""></p>
<h4 id="同步过程"><a href="#同步过程" class="headerlink" title="同步过程"></a>同步过程</h4><p>选完leader以后，zk就进入状态同步过程。</p>
<ol>
<li><p>leader等待server连接；</p>
</li>
<li><p>Follower连接leader，将最大的zxid发送给leader；</p>
</li>
<li><p>Leader根据follower的zxid确定同步点；</p>
</li>
<li><p>完成同步后通知follower 已经成为uptodate状态；</p>
</li>
<li><p>Follower收到uptodate消息后，又可以重新接受client的请求进行服务了</p>
</li>
</ol>
<p><img src="http://i.imgur.com/uOAy55a.jpg" alt=""></p>
<h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><p>leader工作流程：</p>
<p>Leader主要有三个功能：</p>
<ol>
<li>恢复数据；</li>
<li>维持与Learner的心跳，接收Learner请求并判断Learner的请求消息类型；</li>
<li>Learner的消息类型主要有PING消息、REQUEST消息、ACK消息、REVALIDATE消息，根据不同的消息类型，进行不同的处理。</li>
</ol>
<p>PING消息是指Learner的心跳信息；REQUEST消息是Follower发送的提议信息，包括写请求及同步请求；ACK消息是Follower的对提议的回复，超过半数的Follower通过，则commit该提议；REVALIDATE消息是用来延长SESSION有效时间。</p>
<p>follower工作流程<br>Follower主要有四个功能：</p>
<ol>
<li>向Leader发送请求（PING消息、REQUEST消息、ACK消息、REVALIDATE消息）；</li>
<li>接收Leader消息并进行处理；</li>
<li>接收Client的请求，如果为写请求，发送给Leader进行投票；</li>
<li>返回Client结果。</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/23/pat1009/" itemprop="url">
                  pat1009
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-12-23T12:06:37+08:00" content="2016-12-23">
              2016-12-23
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1009.Product of Polynomials (25)</p>
<p>This time, you are supposed to find A*B where A and B are two polynomials.</p>
<p>Input Specification:</p>
<p>Each input file contains one test case. Each case occupies 2 lines, and each line contains the information of a polynomial: K N1 aN1 N2 aN2 … NK aNK, where K is the number of nonzero terms in the polynomial, Ni and aNi (i=1, 2, …, K) are the exponents and coefficients, respectively. It is given that 1 &lt;= K &lt;= 10, 0 &lt;= NK &lt; … &lt; N2 &lt; N1 &lt;=1000.</p>
<p>Output Specification:</p>
<p>For each test case you should output the product of A and B in one line, with the same format as the input. Notice that there must be NO extra space at the end of each line. Please be accurate up to 1 decimal place.</p>
<p>Sample Input</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">2 1 2.4 0 3.2</div><div class="line">2 2 1.5 1 0.5</div></pre></td></tr></table></figure>
<p>Sample Output</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">3 3 3.6 2 6.0 1 1.6</div></pre></td></tr></table></figure>
<p>思路：正常按照多项式乘法计算就行，注意如果系数是0，那么这一项就是0.运算的时候要过滤到该项。</p>
<p>解答：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> pat;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Scanner;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">t9_2</span> </span>&#123;</div><div class="line">	<span class="keyword">static</span> <span class="keyword">double</span>[] a= <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">1004</span>];</div><div class="line">	<span class="keyword">static</span> <span class="keyword">double</span>[] b= <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">1004</span>];</div><div class="line">	<span class="keyword">static</span> <span class="keyword">double</span>[] c= <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">1004</span>*<span class="number">1004</span>];</div><div class="line">	<span class="keyword">static</span> <span class="keyword">int</span> n1,n2;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Scanner sc= <span class="keyword">new</span> Scanner(System.in);</div><div class="line">		n1=sc.nextInt();</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n1;i++)&#123;</div><div class="line">			<span class="keyword">int</span> e=sc.nextInt();</div><div class="line">			<span class="keyword">double</span> c=sc.nextDouble();</div><div class="line">			a[e]=c;</div><div class="line">		</div><div class="line">		&#125;</div><div class="line">		n2=sc.nextInt();</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n2;i++)&#123;</div><div class="line">			<span class="keyword">int</span> e=sc.nextInt();</div><div class="line">			<span class="keyword">double</span> c=sc.nextDouble();</div><div class="line">			b[e]=c;</div><div class="line">		&#125;</div><div class="line">		sc.close();</div><div class="line">		</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;a.length;i++)&#123;</div><div class="line">			<span class="keyword">if</span>(a[i]!=<span class="number">0</span>)&#123;</div><div class="line">				<span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;b.length;j++)&#123;</div><div class="line">					<span class="keyword">if</span>(b[j]!=<span class="number">0</span>)&#123;</div><div class="line">						c[i+j]+=a[i]*b[j];</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;			</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">int</span> count=<span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;c.length;i++) <span class="keyword">if</span>(c[i]!=<span class="number">0</span>) count++;</div><div class="line">		System.out.print(count);</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=c.length-<span class="number">1</span>;i&gt;=<span class="number">0</span>;i--) </div><div class="line">			<span class="keyword">if</span>(c[i]!=<span class="number">0</span>) &#123;</div><div class="line">				System.out.print(<span class="string">" "</span>+i+<span class="string">" "</span>);</div><div class="line">				System.out.printf(<span class="string">"%.1f"</span>,c[i]);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Loren" />
          <p class="site-author-name" itemprop="name">Loren</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">78</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Loren</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.lazyload/1.9.3/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  

  

  

  

  


</body>
</html>
